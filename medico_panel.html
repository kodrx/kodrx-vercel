
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KodRx - Panel Médico</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    button { margin-top: 10px; }
    #qrSection img { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Bienvenido, Doctor</h1>
  <form id="formularioReceta">
    <label>Nombre del paciente: <input id="nombrePaciente" required></label><br>
    <label>Edad del paciente: <input id="edadPaciente" required></label><br>
    <label>Signos vitales: <input id="signosVitales"></label><br>
    <div id="medicamentosContainer"></div>
    <button type="button" onclick="agregarMedicamento()">Agregar medicamento</button><br>
    <button type="button" onclick="guardarReceta()">Guardar y generar QR</button>
  </form>

  <div id="qrSection" class="hidden">
    <h3>Receta generada</h3>
    <img id="codigoQR" alt="QR de la receta"/>
    <br>
    <a id="descargarQR" download="receta_qr.png">Descargar QR</a><br>
    <button onclick="nuevaReceta()">Nueva receta</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBIjaOe4HcGNDk0xrqen8etBv0RyjyOJHw",
      authDomain: "kodrx-105b9.firebaseapp.com",
      databaseURL: "https://kodrx-105b9-default-rtdb.firebaseio.com",
      projectId: "kodrx-105b9",
      storageBucket: "kodrx-105b9.appspot.com",
      messagingSenderId: "239675098141",
      appId: "1:239675098141:web:152ae3741b0ac79db7f2f4"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let uid = "";
    let nombreMedico = "";
    let cedula = "";

    auth.onAuthStateChanged(user => {
      if (user) {
        uid = user.uid;
        db.ref("usuarios/" + uid).once("value").then(snapshot => {
          const datos = snapshot.val();
          if (datos && datos.verificado) {
            nombreMedico = datos.nombre;
            cedula = datos.cedula;
          } else {
            window.location.href = "verificacion_en_proceso.html";
          }
        });
      } else {
        window.location.href = "login.html";
      }
    });

    function agregarMedicamento() {
      const div = document.createElement("div");
      div.innerHTML = `
        <input placeholder="Nombre" required>
        <input placeholder="Dosis" required>
        <input placeholder="Duración" required>
      `;
      document.getElementById("medicamentosContainer").appendChild(div);
    }

    function guardarReceta() {
      const nombre = document.getElementById("nombrePaciente").value;
      const edad = document.getElementById("edadPaciente").value;
      const signos = document.getElementById("signosVitales").value;

      const medicamentos = Array.from(document.querySelectorAll("#medicamentosContainer > div")).map(div => {
        const inputs = div.querySelectorAll("input");
        return {
          nombre: inputs[0].value,
          dosis: inputs[1].value,
          duracion: inputs[2].value
        };
      });

      const receta = {
        nombre_paciente: nombre,
        edad_paciente: edad,
        signos_vitales: signos,
        medicamentos,
        uid_medico: uid,
        nombre_medico: nombreMedico,
        cedula_medico: cedula,
        timestamp: new Date().toISOString(),
        surtido: false
      };

      const recetaRef = db.ref("recetas").push();
      recetaRef.set(receta).then(() => {
        const qrURL = `https://kodrx.app/verificar_debug.html?id=${recetaRef.key}&uid=${uid}`;
        const qrImg = document.getElementById("codigoQR");
        const qrDownload = document.getElementById("descargarQR");
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrURL)}`;
        qrDownload.href = qrImg.src;
        document.getElementById("qrSection").classList.remove("hidden");

        document.getElementById("formularioReceta").reset();
        document.getElementById("medicamentosContainer").innerHTML = "";
        document.getElementById("formularioReceta").classList.add("hidden");
      });
    }

    function nuevaReceta() {
      document.getElementById("formularioReceta").classList.remove("hidden");
      document.getElementById("qrSection").classList.add("hidden");
      document.getElementById("codigoQR").src = "";
    }
  </script>
</body>
</html>
