
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KodRx | Escanear Receta Médica</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 0; }
    header { background: #001b44; color: white; padding: 1rem; text-align: center; font-size: 1.2rem; }
    header span { color: #00c7a0; font-weight: bold; }
    #scanner { width: 100%; max-width: 400px; margin: 20px auto; }
    #resultado, #acciones { max-width: 600px; margin: 1rem auto; background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    button { margin: 0.5rem; padding: 0.7rem 1rem; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .btn-completo { background: #0062ff; color: white; }
    .btn-parcial { background: orange; color: white; }
    .oculto { display: none; }
  </style>
</head>
<body>
<header><span>KodRx</span> | Escanear Receta Médica</header>

<div id="scanner"></div>

<div id="resultado" class="oculto">
  <h3>Receta escaneada</h3>
  <p><strong>Nombre del paciente:</strong> <span id="nombrePaciente"></span></p>
  <p><strong>Edad del paciente:</strong> <span id="edadPaciente"></span></p>
  <p><strong>Fecha:</strong> <span id="fechaReceta"></span></p>
  <p><strong>Médico:</strong> <span id="nombreMedico"></span></p>
  <p><strong>Cédula profesional:</strong> <span id="cedulaMedico"></span></p>
  <div><strong>Medicamentos:</strong><ul id="listaMedicamentos"></ul></div>
  <div id="acciones">
    <button class="btn-completo" onclick="surtir(true)">Surtida Completamente</button>
    <button class="btn-parcial" onclick="surtir(false)">Surtida Parcialmente</button>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBIjaOe4HcGNDk0xrqen8etBv0RyjyOJHw",
    authDomain: "kodrx-105b9.firebaseapp.com",
    databaseURL: "https://kodrx-105b9-default-rtdb.firebaseio.com",
    projectId: "kodrx-105b9",
    storageBucket: "kodrx-105b9.appspot.com",
    messagingSenderId: "239675098141",
    appId: "1:239675098141:web:152ae3741b0ac79db7f2f4"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let recetaActual = null;
  let recetaId = null;

  function mostrarReceta(data) {
    recetaActual = data;
    document.getElementById("nombrePaciente").innerText = data.nombre_paciente || "N/A";
    document.getElementById("edadPaciente").innerText = data.edad_paciente || "N/A";
    document.getElementById("fechaReceta").innerText = new Date(data.timestamp).toLocaleString();
    document.getElementById("nombreMedico").innerText = data.nombre_medico || "N/A";
    document.getElementById("cedulaMedico").innerText = data.cedula_medico || "N/A";

    const lista = document.getElementById("listaMedicamentos");
    lista.innerHTML = "";
    (data.medicamentos || []).forEach(m => {
      const li = document.createElement("li");
      li.textContent = `${m.nombre || "?"} - ${m.dosis || "?"}, ${m.duracion || "?"}`;
      lista.appendChild(li);
    });

    document.getElementById("resultado").classList.remove("oculto");
  }

  function surtir(completo) {
    if (!recetaId || !recetaActual) return alert("Receta no cargada.");
    const user = firebase.auth().currentUser;
    const datosSurtido = {
      surtido: true,
      surtido_parcial: !completo,
      surtida_por: user?.email || "Farmacia desconocida"
    };
    db.ref("recetas/" + recetaId).update(datosSurtido).then(() => {
      alert(completo ? "Receta marcada como surtida completamente." : "Receta marcada como surtida parcialmente.");
      location.reload();
    });
  }

  function escanearQR() {
    const html5QrCode = new Html5Qrcode("scanner");
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, qrCodeMessage => {
      html5QrCode.stop();
      const url = new URL(qrCodeMessage);
      recetaId = url.searchParams.get("id");
      const uid = url.searchParams.get("uid");
      if (!recetaId || !uid) return alert("QR inválido.");

      db.ref("recetas/" + recetaId).once("value").then(snapshot => {
        const data = snapshot.val();
        if (!data) return alert("Receta no encontrada.");
        mostrarReceta(data);
      });
    });
  }

  firebase.auth().onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "farmacia_login.html";
    } else {
      escanearQR();
    }
  });
</script>
</body>
</html>
