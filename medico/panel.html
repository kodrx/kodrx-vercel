<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Panel para Medico</title>
  <link rel="stylesheet" href="/estilos/global.css" />
  <script src="/componentes/header.js" defer></script>

<script src="/medico/qrcode.min.js"></script>


</head>

  <main>
   <section class="botonera">
  <button class="btn ghost" onclick="location.reload()"> Nueva receta</button>
  <button class="btn ghost" onclick="window.location.href='historial.html'">Historial</button>
  <button class="btn primary" onclick="window.location.href='#'">Acceder IA cl√≠nica</button>
  <button id="btnLogout" class="btn ghost">Cerrar sesi√≥n</button>

     <!-- usa exactamente estos IDs / types -->


</section>


    <form id="generarRecetaForm" class="form-login">
      <h2>Generar nueva receta</h2>

      <label for="nombrePaciente">Nombre del paciente:</label>
      <input type="text" id="nombrePaciente" required>

      <label for="edad">Edad:</label>
      <input type="number" id="edad" required>

      <label for="sexo">Sexo:</label>
      <select id="sexo">
        <option value="Masculino">Masculino</option>
        <option value="Femenino">Femenino</option>
        <option value="Otro">Otro</option>
      </select>

      <label for="talla">Talla (cm):</label>
      <input type="number" id="talla">

      <label for="peso">Peso (kg):</label>
      <input type="number" id="peso">

      <label for="imc">IMC:</label>
      <input type="text" id="imc" disabled>

      <label for="temperatura">Temperatura (¬∞C):</label>
      <input type="text" id="temperatura">

      <label for="presion">Presi√≥n arterial:</label>
      <input type="text" id="presion">

      <label for="observaciones">Observaciones:</label>
      <textarea id="observaciones"></textarea>

      <label for="diagnostico">Diagn√≥stico:</label>
      <textarea id="diagnostico"></textarea>

      <h3>Medicamentos</h3>
      <div id="medicamentosContainer"></div>

      <!-- usa exactamente estos IDs / types -->
<button id="btnAgregarMedicamento" type="button">Agregar medicamento</button>
<button id="btnGenerar" type="button">Generar receta</button>

    </form>

    <div id="qrContainer" style="margin-top: 20px;"></div>
  </main>

 <!-- Scripts -->
  <script src="/medico/autocomplete.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script type="module" src="/firebase-init.js"></script>

 
<script type="module">
console.log('[panel] boot');

import { db, auth } from "/firebase-init.js";
import {
  collection, addDoc, doc, getDoc, updateDoc, 
  serverTimestamp, Timestamp
} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  // Exponer a window para que los vea el script inline cl√°sico:
  window.db = db;
  window.auth = auth;
  window.__fs = { collection, addDoc, updateDoc, doc, getDoc, serverTimestamp, Timestamp };
  


  

;(() => {
  console.log('[panel] unified inline boot');

  // ==== CONFIG RUTA DE VISTA ====
  const VER_RECETA_PATH = '/medico/ver-receta.html'; // ‚Üê cambia a '/public/ver-receta.html' si aplica

  // ==== HELPERS B√ÅSICOS ====
  const byId = (id)=> document.getElementById(id);
  const q    = (sel)=> document.querySelector(sel);

  // Evita doble-bindeos
  if (window.__KODRX_PANEL_LOCK__) { console.log('[panel] locked, skipping'); return; }
  window.__KODRX_PANEL_LOCK__ = true;

  // Firestore lazy (usa window.__fs si ya existe)
  async function fs(){
    if (window.__fs) return window.__fs;
    const mod = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
    const { collection, addDoc, updateDoc, getDoc, doc, serverTimestamp, Timestamp } = mod;
    return (window.__fs = { collection, addDoc, updateDoc, getDoc, doc, serverTimestamp, Timestamp });
  }

  // IMC auxiliar
  function computeIMC(peso, talla){
    const p = parseFloat(peso), t = parseFloat(talla)/100;
    if (!p || !t) return '';
    const v = p/(t*t);
    return (Math.round(v*100)/100).toFixed(2);
  }

  // === Medicamentos UI ===
  let medsHost = null;
  function ensureMedsContainer(){
    if (medsHost && medsHost.isConnected) return medsHost;
    medsHost = byId('medicamentosContainer') || q('[data-meds]');
    if (!medsHost){
      medsHost = document.createElement('div');
      medsHost.id = 'medicamentosContainer';
      (byId('generarRecetaForm') || byId('formReceta') || document.body).appendChild(medsHost);
    }
    return medsHost;
  }
  function agregarMedicamento(){
    const host = ensureMedsContainer();
    const row = document.createElement('div');
    row.className = 'medicamento';
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '1fr 1fr 1fr auto';
    row.style.gap = '8px';
    row.innerHTML = `
      <input type="text" class="nombre"   placeholder="Nombre del medicamento">
      <input type="text" class="dosis"    placeholder="Dosis">
      <input type="text" class="duracion" placeholder="Duraci√≥n">
      <button type="button" class="rm" title="Eliminar">üóëÔ∏è</button>`;
    row.querySelector('.rm').onclick = () => row.remove();
    host.appendChild(row);
    // autocompletado opcional
    if (typeof window.iniciarAutocompletado === 'function') {
      const input = row.querySelector('.nombre');
      setTimeout(()=>window.iniciarAutocompletado(input), 50);
    }
  }
  window.agregarMedicamento = window.agregarMedicamento || agregarMedicamento;

 function bindButton(btn, fn){
  if (!btn) return false;
  btn.type = 'button';
  // fuerza habilitado por si alg√∫n CSS/atributo lo dej√≥ ‚Äúgris‚Äù
  btn.disabled = false;
  btn.removeAttribute('disabled');
  btn.classList?.remove?.('disabled','is-disabled');
  btn.style.pointerEvents = 'auto';
  btn.style.opacity = '';

  if (!btn.__bound){
    btn.addEventListener('click', (e)=>{ e.preventDefault(); fn(); }, {capture:true});
    btn.__bound = true;
  }
  return true;
}

  function bindUI(){
    ensureMedsContainer();
    const addOk = bindButton(byId('btnAgregarMedicamento') || q('[data-add-med], .add-med'), agregarMedicamento);
    const genOk = bindButton(byId('btnGenerar') || q('[data-generate], .generate'), generarReceta);
    console.log('[panel] UI bound', {addOk, genOk});
  }

  function generarReceta(){
    const form = byId('generarRecetaForm') || byId('formReceta') || q('form');
    if (!form) return console.warn('[panel] No se encontr√≥ el formulario');
    if (form.__busy) return;
    form.__busy = true; setTimeout(()=>{ form.__busy=false; }, 4000);
    if (form.requestSubmit) form.requestSubmit(); else form.dispatchEvent(new Event('submit', {cancelable:true}));
  }
  window.generarReceta = window.generarReceta || generarReceta;

  // === SUBMIT (√öNICO handler) ===
  async function kodrxSubmit(e){
    e?.preventDefault?.();
    console.log('[panel] submit hit');

    const btnGen  = byId('btnGenerar') || q('[data-generate], .generate');
    const prevTxt = btnGen?.textContent;
    if (btnGen){ btnGen.disabled = true; btnGen.textContent = 'Guardando‚Ä¶'; }

    try{
      // 1) Lee formulario (sin jQuery)
      const nombrePaciente = byId('nombrePaciente')?.value?.trim() || '';
      const edad           = parseInt(byId('edad')?.value||'',10) || null;
      const sexo           = byId('sexo')?.value || '';
      const talla          = byId('talla')?.value || '';
      const peso           = byId('peso')?.value || '';
      const imc            = byId('imc')?.value || computeIMC(peso,talla) || '';
      const temperatura    = byId('temperatura')?.value || '';
      const presion        = byId('presion')?.value || '';
      const observaciones  = byId('observaciones')?.value?.trim() || '';
      const diagnostico    = byId('diagnostico')?.value?.trim() || '';

      if (!nombrePaciente){ alert('Falta el nombre del paciente'); byId('nombrePaciente')?.focus(); return; }

      const medicamentos = [...document.querySelectorAll('#medicamentosContainer .medicamento')].map(row=>{
        const get = (cls)=> row.querySelector('.'+cls)?.value?.trim() || '';
        const nombre   = get('nombre');
        const dosis    = get('dosis');
        const duracion = get('duracion');
        const ini = nombre.split(/\s+/).map(w=>w[0]||'').join('').slice(0,3).toUpperCase();
        return { nombre, dosis, duracion, ini };
      });

      if (!medicamentos.length){
        if(!confirm('No agregaste medicamentos. ¬øContinuar?')) return;
      }

      // 2) Usuario y Firestore
      const usr = window.auth?.currentUser;
      if (!usr){ alert('No hay sesi√≥n. Inicia sesi√≥n de nuevo.'); return; }
      const { collection, addDoc, updateDoc, getDoc, doc, serverTimestamp, Timestamp } = await fs();
      if (!window.db){ alert('Firestore no inicializado. Recarga la p√°gina.'); return; }

      // 3) Datos del m√©dico (opcional)
      let m = {};
      try{
        const ms = await getDoc(doc(window.db, 'medicos', usr.uid));
        if (ms.exists()) m = ms.data();
      }catch{}

      const medicoDomicilio = (m.direccion ||
        `${m.calle||''} ${m.numero||''}, ${m.colonia||''}, ${m.municipio||''}, ${m.estado||''}, CP ${m.cp||''}`)
        .replace(/\s+,/g,',').replace(/,\s*,/g,', ').trim();

      const medsIniciales = medicamentos.map(x=>x.ini).join('-');

      // 4) Documento de receta
      const recetaData = {
        nombrePaciente, edad, sexo, peso, talla, imc, temperatura, presion,
        observaciones, diagnostico,
        medicamentos, medsIniciales,

        medicoNombre: m.nombre || usr.displayName || '',
        medicoGenero: m.genero || '',
        medicoCedula: m.cedula || '',
        medicoEspecialidad: m.especialidad || 'General',
        medicoTelefono: m.telefono || '',
        medicoDomicilio,

        medicoUid: usr.uid,
        medicoEmail: usr.email || '',
        correo: usr.email || '',

        timestamp: (Timestamp?.now?.() ?? new Date()),
        blockchain: { status:'pendiente' },
        hash: null, bloque: null
      };

      const ref = await addDoc(collection(window.db, 'recetas'), recetaData);
      console.log('[panel] receta creada:', ref.id);

      // 5) Sellado v√≠a proxy (no bloqueante)
      try{
        const recetaResumen = medicamentos.map(m => `${m.nombre} ${m.dosis} por ${m.duracion}`).join(', ');
        const payload = {
          receta: recetaResumen,
          medico: recetaData.medicoNombre || '',
          cedula: recetaData.medicoCedula || '',
          medicamentos,
          iniciales: medicamentos.map(x=>x.ini),
          idReceta: ref.id,
          timestamp: Math.floor(Date.now()/1000)
        };

        const resp = await fetch('/api/bloques', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        let raw = {}; try{ raw = await resp.json(); }catch{}
        console.log('[BC][raw]', raw);

        const toNum = v => (typeof v==='number'&&Number.isFinite(v)) ? v : (/^\d+$/.test(String(v??'')) ? Number(v) : NaN);
        const block = [raw?.bloque?.index, raw?.index, raw?.bloqueIndex, raw?.block].map(toNum).find(Number.isFinite);
        const hash  = raw?.bloque?.hash || raw?.hash || raw?.blockHash || raw?.txid || null;

        const updates = {};
        if (resp.ok && Number.isFinite(block) && hash) {
          updates.blockchain = { status:'ok', block, hash, at: serverTimestamp() };
          updates.bloque = block; updates.hash = hash;
        } else if (raw?.url || raw?.consultaUrl) {
          updates.urlBlockchain = raw.url || raw.consultaUrl;
          updates.blockchain = { status:'simulado' };
        }

        if (Object.keys(updates).length){
          try{ await updateDoc(doc(window.db, 'recetas', ref.id), updates); }
          catch(e){ console.warn('[BC] Firestore update fall√≥ (UI igual se actualiza):', e?.message||e); }
        }
      }catch(e){
        console.error('[BC] error /api/bloques:', e?.message||e);
      }

      // 6) Redirecci√≥n
      const goto = new URL(VER_RECETA_PATH, location.origin);
      goto.searchParams.set('id', ref.id);
      location.href = goto.href;

    }catch(err){
      console.error('[panel] error al guardar receta', err);
      alert('No se pudo generar la receta. Revisa los campos e intenta de nuevo.');
    }finally{
      if (btnGen){ btnGen.disabled = false; btnGen.textContent = prevTxt || 'Generar receta'; }
    }
  }
  window.kodrxSubmit = kodrxSubmit;

  // === ENGANCHAR (√∫nico) ===
function bindSubmit(){
  // 1) Localiza el form
  let form = document.getElementById('generarRecetaForm')
        || document.getElementById('formReceta')
        || document.querySelector('form');
  if (!form) return console.warn('[panel] No se encontr√≥ formulario');

  // 2) (Opcional) limpiar listeners previos clonando una sola vez
  if (!form.__kodrxCleaned){
    const cloned = form.cloneNode(true);          // copia DOM
    form.parentNode.replaceChild(cloned, form);   // sustituye
    form = cloned;
    form.__kodrxCleaned = true;
  }

  // 3) Vincula el submit si a√∫n no est√°
  if (!form.__kodrxSubmitBound){
    form.addEventListener('submit', kodrxSubmit, {capture:true});
    form.__kodrxSubmitBound = true;
  }

  // 4) Re-cablea los botones usando el *form actual*
  const addBtn =
    form.querySelector('#btnAgregarMedicamento')
    || form.querySelector('[data-add-med], .add-med');
  bindButton(addBtn, agregarMedicamento);

  const genBtn =
    form.querySelector('#btnGenerar')
    || form.querySelector('[data-generate], .generate')
    || form.querySelector('[type=submit]');
  bindButton(genBtn, generarReceta);

  console.log('[panel] submit bound (clean) + buttons rebound');
}
  // === ARRANQUE ===
  function start(){
    bindUI();
    bindSubmit();
    // exp√≥n helpers por si necesitas desde consola
    window.kodrxForceBind = ()=>{ bindUI(); bindSubmit(); };
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start, {once:true});
  else start();

  

})();
</script>



</body>
</html>

