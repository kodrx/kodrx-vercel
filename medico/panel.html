<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Panel para Medico</title>
  <link rel="stylesheet" href="/estilos/global.css" />
  <script src="/componentes/header.js" defer></script>

<script src="/medico/qrcode.min.js"></script>


</head>

  <main>
   <section class="botonera">
  <button class="btn ghost" onclick="location.reload()"> Nueva receta</button>
  <button class="btn ghost" onclick="window.location.href='historial.html'">Historial</button>
  <button class="btn primary" onclick="window.location.href='#'">Acceder IA cl√≠nica</button>
  <button id="btnLogout" class="btn ghost">Cerrar sesi√≥n</button>

     <!-- usa exactamente estos IDs / types -->


</section>


    <form id="generarRecetaForm" class="form-login">
      <h2>Generar nueva receta</h2>

      <label for="nombrePaciente">Nombre del paciente:</label>
      <input type="text" id="nombrePaciente" required>

      <label for="edad">Edad:</label>
      <input type="number" id="edad" required>

      <label for="sexo">Sexo:</label>
      <select id="sexo">
        <option value="Masculino">Masculino</option>
        <option value="Femenino">Femenino</option>
        <option value="Otro">Otro</option>
      </select>

      <label for="talla">Talla (cm):</label>
      <input type="number" id="talla">

      <label for="peso">Peso (kg):</label>
      <input type="number" id="peso">

      <label for="imc">IMC:</label>
      <input type="text" id="imc" disabled>

      <label for="temperatura">Temperatura (¬∞C):</label>
      <input type="text" id="temperatura">

      <label for="presion">Presi√≥n arterial:</label>
      <input type="text" id="presion">

      <label for="observaciones">Observaciones:</label>
      <textarea id="observaciones"></textarea>

      <label for="diagnostico">Diagn√≥stico:</label>
      <textarea id="diagnostico"></textarea>

      <h3>Medicamentos</h3>
      <div id="medicamentosContainer"></div>

      <!-- usa exactamente estos IDs / types -->
<button id="btnAgregarMedicamento" type="button">Agregar medicamento</button>
<button id="btnGenerar" type="button">Generar receta</button>

    </form>

    <div id="qrContainer" style="margin-top: 20px;"></div>
  </main>

  <!-- Scripts -->
  <script src="/medico/autocomplete.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script type="module" src="/firebase-init.js"></script>

  <script>
    // C√°lculo autom√°tico de IMC
    document.getElementById("peso").addEventListener("input", calcularIMC);
    document.getElementById("talla").addEventListener("input", calcularIMC);

    function calcularIMC() {
      const peso = parseFloat(document.getElementById("peso").value);
      const talla = parseFloat(document.getElementById("talla").value) / 100;
      if (!isNaN(peso) && !isNaN(talla) && talla > 0) {
        const imc = peso / (talla * talla);
        document.getElementById("imc").value = imc.toFixed(2);
      }
    }
  </script>
<script type="module">
console.log('[panel] boot');

import { db, auth } from "/firebase-init.js";
import {
  collection, addDoc, doc, getDoc, updateDoc, 
  serverTimestamp, Timestamp
} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  // Exponer a window para que los vea el script inline cl√°sico:
  window.db = db;
  window.auth = auth;
  window.__fs = { collection, addDoc, updateDoc, doc, getDoc, serverTimestamp, Timestamp };
  
/* ---------- estado ---------- */
const state = { user:null, medico:null };

/* ---------- helpers UI ---------- */
function $(sel,root=document){ return root.querySelector(sel); }
function $all(sel,root=document){ return Array.from(root.querySelectorAll(sel)); }

function ensureMedsContainer(){
  let el = document.getElementById('medicamentosContainer') || $('[data-meds]');
  if (!el){ el = document.createElement('div'); el.id='medicamentosContainer'; document.body.appendChild(el); }
  return el;
}
const medsContainer = ensureMedsContainer();

function iniciarAutocompletadoSiExiste(input){
  if (typeof window.iniciarAutocompletado === 'function'){
    setTimeout(()=> window.iniciarAutocompletado(input), 50);
  }
}

function agregarMedicamento(){
  const wrap = document.createElement('div');
  wrap.className = 'medicamento';
  wrap.style.cssText = 'position:relative; display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:8px; margin-bottom:8px;';

  const nombre   = Object.assign(document.createElement('input'), {type:'text',  placeholder:'Nombre',   className:'nombre'});
  const dosis    = Object.assign(document.createElement('input'), {type:'text',  placeholder:'Dosis',    className:'dosis'});
  const duracion = Object.assign(document.createElement('input'), {type:'text',  placeholder:'Duraci√≥n', className:'duracion'});
  const delBtn   = Object.assign(document.createElement('button'),{type:'button', textContent:'üóëÔ∏è'});
  delBtn.style.cssText='padding:.4rem .6rem;'; delBtn.onclick = ()=> wrap.remove();

  wrap.append(nombre,dosis,duracion,delBtn);
  medsContainer.appendChild(wrap);
  iniciarAutocompletadoSiExiste(nombre);
}

function leerMedicamentos(){
  return $all('.medicamento').map(row=>{
    const nombre   = $('.nombre', row)?.value?.trim() || '';
    const dosis    = $('.dosis', row)?.value?.trim() || '';
    const duracion = $('.duracion', row)?.value?.trim() || '';
    if(!nombre && !dosis && !duracion) return null;
    return { nombre, dosis, duracion };
  }).filter(Boolean);
}

function computeIMC(peso, tallaCm){
  const p = parseFloat(peso), t = parseFloat(tallaCm);
  if (!p || !t) return '';
  const m = t/100;
  const imc = p/(m*m);
  return (Math.round(imc*100)/100).toFixed(2);
}

function inicialesDeMeds(meds){
  // ‚Äúiniciales‚Äù amigables para blockchain, p.ej. AMO-IBU-PAR
  return (meds||[])
    .map(m=> (m?.nombre||'').trim().split(/\s+/).map(w=>w[0]||'').join('').slice(0,3).toUpperCase())
    .filter(s=>s).join('-');
}

/* ---------- bind de UI ---------- */
function bindUI(){
  const btnAdd = document.getElementById('btnAgregarMedicamento') || document.querySelector('[data-add-med], .add-med');
  const btnGen = document.getElementById('btnGenerar') || document.querySelector('[data-generate], .generate');

  if (btnAdd && !btnAdd.__bound){ btnAdd.type='button'; btnAdd.addEventListener('click', (e)=>{ e.preventDefault(); agregarMedicamento(); }); btnAdd.__bound=true; }
  if (btnGen && !btnGen.__bound){ btnGen.type='button'; btnGen.addEventListener('click', (e)=>{ e.preventDefault(); onSubmit(); }); btnGen.__bound=true; }

  // IMC en vivo
  const peso  = document.getElementById('peso');
  const talla = document.getElementById('talla');
  const imcEl = document.getElementById('imc');
  if (peso && talla && imcEl){
    const upd = ()=> imcEl.value = computeIMC(peso.value, talla.value);
    peso.addEventListener('input', upd); talla.addEventListener('input', upd);
  }
}

/* ---------- auth + carga del m√©dico ---------- */
onAuthStateChanged(auth, async (user)=>{
  if (!user){ alert('Inicia sesi√≥n para generar recetas'); location.href='/acceso.html'; return; }
  state.user = user;
  try{
    const medSnap = await getDoc(doc(db,'medicos', user.uid));
    if (!medSnap.exists()){ alert('Perfil de m√©dico no encontrado'); return; }
    state.medico = medSnap.data();
    console.log('[panel] m√©dico:', state.medico?.nombre || '(sin nombre)');
  }catch(err){
    console.error('[panel] error leyendo /medicos/{uid}', err);
    alert('No se pudo leer tu perfil de m√©dico.');
  }
});

async function onSubmit(e){
  e?.preventDefault?.();

  // bot√≥n
  const btnGen  = document.getElementById('btnGenerar') || document.querySelector('[data-generate], .generate');
  const prevTxt = btnGen?.textContent;
  if (btnGen){ btnGen.disabled = true; btnGen.textContent = 'Guardando‚Ä¶'; }

  // helper para leer inputs por id
  const $ = (id) => document.getElementById(id);

  try {
    // --------- 1) Datos del formulario ----------
    const nombrePaciente = $('#nombrePaciente')?.value?.trim() || '';
    const edad           = parseInt($('#edad')?.value||'',10) || null;
    const sexo           = $('#sexo')?.value || '';
    const talla          = $('#talla')?.value || '';
    const peso           = $('#peso')?.value || '';
    const imc            = $('#imc')?.value || '';
    const temperatura    = $('#temperatura')?.value || '';
    const presion        = $('#presion')?.value || '';
    const observaciones  = $('#observaciones')?.value?.trim() || '';
    const diagnostico    = $('#diagnostico')?.value?.trim() || '';

    if (!nombrePaciente){ alert('Falta el nombre del paciente'); return; }

    // medicamentos
    const leerMedicamentos = () =>
      [...document.querySelectorAll('#medicamentosContainer .medicamento')].map(row => {
        const get = cls => row.querySelector('.'+cls)?.value?.trim() || '';
        const nombre   = get('nombre');
        const dosis    = get('dosis');
        const duracion = get('duracion');
        const ini = nombre.split(/\s+/).map(w=>w[0]||'').join('').slice(0,3).toUpperCase();
        return { nombre, dosis, duracion, ini };
      });

    const medicamentos = leerMedicamentos();
    if (!medicamentos.length){
      if (!confirm('No agregaste medicamentos. ¬øContinuar?')) return;
    }

    // --------- 2) Contexto m√©dico / sesi√≥n ----------
    const usr = window.auth?.currentUser;
    if (!usr){ alert('No hay sesi√≥n. Inicia sesi√≥n de nuevo.'); return; }

    const { collection, addDoc, updateDoc, doc, getDoc, serverTimestamp, Timestamp } = window.__fs || {};
    if (!collection){ alert('Firestore no carg√≥. Recarga la p√°gina.'); return; }

    // carga ficha del m√©dico
    let m = {};
    try{
      const ms = await getDoc(doc(window.db, 'medicos', u.uid));
      if (ms.exists()) m = ms.data();
    }catch{}

    const medicoDomicilio = (m.direccion ||
      `${m.calle||''} ${m.numero||''}, ${m.colonia||''}, ${m.municipio||''}, ${m.estado||''}, CP ${m.cp||''}`)
      .replace(/\s+,/g,',').replace(/,\s*,/g,', ').trim();

    const medsIniciales = (window.inicialesDeMeds
      ? inicialesDeMeds(medicamentos)
      : medicamentos.map(x=>x.nombre.split(/\s+/).map(w=>w[0]||'').join('').slice(0,3).toUpperCase()).join('-'));

    // --------- 3) Documento receta ----------
    const recetaData = {
      // legacy flatten (pantalla)
      nombrePaciente, edad, sexo, peso, talla, imc, temperatura, presion,
      observaciones, diagnostico,
      medicamentos,
      medsIniciales,

      // m√©dico (flatten)
      medicoNombre: m.nombre || usr.displayName || '',
      medicoGenero: m.genero || '',
      medicoCedula: m.cedula || '',
      medicoEspecialidad: m.especialidad || 'General',
      medicoTelefono: m.telefono || '',
      medicoDomicilio,

      // √≠ndices
      medicoUid: usr.uid,
      medicoEmail: usr.email || '',
      correo: usr.email || '',

      timestamp: (Timestamp?.now?.() ?? new Date()),
      blockchain: { status: 'pendiente' },
      hash: null, bloque: null
    };

    // guardar
    const ref = await addDoc(collection(window.db, 'recetas'), recetaData);
    console.log('[panel] receta creada:', ref.id);

    // --------- 4) Sellado v√≠a proxy /api/bloques ----------
    try {
      const recetaResumen = medicamentos.map(m => `${m.nombre} ${m.dosis} por ${m.duracion}`).join(', ');
      const payload = {
        receta: recetaResumen,                    // requerido por tu proxy
        medico: recetaData.medicoNombre || '',   // requerido
        cedula: recetaData.medicoCedula || '',   // requerido
        medicamentos,
        iniciales: medicamentos.map(x=>x.ini),
        idReceta: ref.id,
        timestamp: Math.floor(Date.now()/1000)
      };

      const resp = await fetch('/api/bloques', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      let raw = {};
      try{ raw = await resp.json(); }catch{}
      console.log('[BC][raw]', raw);

      // normaliza respuesta
      const toNum  = v => (typeof v==='number'&&Number.isFinite(v)) ? v : (/^\d+$/.test(String(v??'')) ? Number(v) : NaN);
      const block  = [raw?.bloque?.index, raw?.index, raw?.bloqueIndex, raw?.block].map(toNum).find(Number.isFinite);
      const hash   =  raw?.bloque?.hash || raw?.hash || raw?.blockHash || raw?.txid || null;

      // una sola escritura de updates
      const updates = {};
      if (resp.ok && Number.isFinite(block) && hash) {
        updates.blockchain = { status:'ok', block, hash, at: serverTimestamp() };
        updates.bloque = block; updates.hash = hash;
      } else if (raw?.url || raw?.consultaUrl) {
        updates.urlBlockchain = raw.url || raw.consultaUrl;
        updates.blockchain = { status:'simulado' };
      }

      if (Object.keys(updates).length){
        try{
          await updateDoc(doc(window.db, 'recetas', ref.id), updates);
        }catch(e){
          console.warn('[BC] Firestore update fall√≥ (UI igual se actualiza):', e?.message || e);
        }
      }
    } catch (e) {
      console.error('Error al sellar v√≠a /api/bloques:', e?.message || e);
    }




    
    // Redirecci√≥n a ver-receta con el ID
  const goto = new URL('/medico/ver-receta.html', location.origin); // ajusta la ruta si es /public/
goto.searchParams.set('id', ref.id);
 location.href = goto.href;

  }catch(err){
    console.error('[panel] error al guardar receta', err);
    alert('No se pudo generar la receta. Revisa los campos e intenta de nuevo.');
  }finally{
    if (btnGen){ btnGen.disabled=false; btnGen.textContent = prevTxt || 'Generar receta'; }
  }
}

/* ---------- ready ---------- */
if (document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', ()=>{ bindUI(); }, {once:true});
}else{
  bindUI();
}

// exp√≥n si necesitas dispararlos desde consola
window.agregarMedicamento = window.agregarMedicamento || agregarMedicamento;
window.kodrxPanelSubmit  = onSubmit;

console.log('[panel] ready');


</script>

<script>
;(() => {
  console.log('[panel][hotfix] bindUI v2');

  const $ = s => document.querySelector(s);
  let medsHost = null;

  function ensureMedsContainer(){
    if (medsHost && medsHost.isConnected) return medsHost;
    medsHost = document.getElementById('medicamentosContainer')
          || document.querySelector('[data-meds]');
    if (!medsHost){
      medsHost = document.createElement('div');
      medsHost.id = 'medicamentosContainer';
      (document.getElementById('generarRecetaForm')
        || document.getElementById('formReceta')
        || document.body).appendChild(medsHost);
    }
    return medsHost;
  }

  // expone agregarMedicamento si no existe
  window.agregarMedicamento = window.agregarMedicamento || function agregarMedicamento(){
    const host = ensureMedsContainer();
    const row = document.createElement('div');
    row.className = 'medicamento';
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '1fr 1fr 1fr auto';
    row.style.gap = '8px';
    row.innerHTML = `
      <input type="text" class="nombre"   placeholder="Nombre del medicamento">
      <input type="text" class="dosis"    placeholder="Dosis">
      <input type="text" class="duracion" placeholder="Duraci√≥n">
      <button type="button" class="rm" title="Eliminar">üóëÔ∏è</button>`;
    row.querySelector('.rm').onclick = () => row.remove();
    host.appendChild(row);
    if (typeof window.iniciarAutocompletado === 'function') {
      const input = row.querySelector('.nombre');
      setTimeout(()=>window.iniciarAutocompletado(input), 50);
    }
  };

  function generarReceta(){
    const form = document.getElementById('generarRecetaForm')
             || document.getElementById('formReceta')
             || document.querySelector('form');
    if (!form) return console.warn('[panel] No se encontr√≥ el formulario');
    if (form.__busy) return;
    form.__busy = true; setTimeout(()=>{ form.__busy = false; }, 5000);
    if (form.requestSubmit) form.requestSubmit(); else form.submit();
  }
  window.generarReceta = window.generarReceta || generarReceta;

  function bindButton(btn, fn){
    if (!btn) return false;
    btn.type = 'button';
    btn.disabled = false;
    btn.removeAttribute('aria-busy');
    btn.style.pointerEvents = '';
    btn.style.opacity = '';
    if (!btn.__bound){
      btn.addEventListener('click', e => { e.preventDefault(); fn(); }, {capture:true});
      btn.__bound = true;
    }
    return true;
  }

  function bindUI(){
    ensureMedsContainer();
    const addOk = bindButton(
      document.getElementById('btnAgregarMedicamento')
      || document.querySelector('[data-add-med], .add-med'),
      window.agregarMedicamento
    );
    const genOk = bindButton(
      document.getElementById('btnGenerar')
      || document.querySelector('[data-generate], .generate'),
      window.generarReceta
    );
    console.log('[panel][hotfix] bindUI:', { addOk, genOk });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindUI, { once:true });
  } else {
    bindUI();
  }
  window.kodrxBindUI = bindUI; // por si quieres re-binder desde la consola
})();
</script>
<script>
;(() => {
  console.log('[panel] submit bind (safe)');

  const $ = (id) => document.getElementById(id);

  async function kodrxSubmit(e){
    e?.preventDefault?.();

    const btnGen  = $('#btnGenerar') || document.querySelector('[data-generate], .generate');
    const prevTxt = btnGen?.textContent;
    if (btnGen){ btnGen.disabled = true; btnGen.textContent = 'Guardando‚Ä¶'; }

    try {
      // 1) Datos del form
      const nombrePaciente = $('#nombrePaciente')?.value?.trim() || '';
      const edad           = parseInt($('#edad')?.value||'',10) || null;
      const sexo           = $('#sexo')?.value || '';
      const talla          = $('#talla')?.value || '';
      const peso           = $('#peso')?.value || '';
      const imc            = $('#imc')?.value || '';
      const temperatura    = $('#temperatura')?.value || '';
      const presion        = $('#presion')?.value || '';
      const observaciones  = $('#observaciones')?.value?.trim() || '';
      const diagnostico    = $('#diagnostico')?.value?.trim() || '';

      if (!nombrePaciente){ alert('Falta el nombre del paciente'); return; }

      const medicamentos = [...document.querySelectorAll('#medicamentosContainer .medicamento')].map(row => {
        const get = cls => row.querySelector('.'+cls)?.value?.trim() || '';
        const nombre   = get('nombre');
        const dosis    = get('dosis');
        const duracion = get('duracion');
        const ini = nombre.split(/\s+/).map(w=>w[0]||'').join('').slice(0,3).toUpperCase();
        return { nombre, dosis, duracion, ini };
      });

      if (!medicamentos.length){
        if (!confirm('No agregaste medicamentos. ¬øContinuar?')) return;
      }

      // 2) Usuario / m√©dico (RENOMBRADO: usr)
      const usr = window.auth?.currentUser;
      if (!usr){ alert('No hay sesi√≥n. Inicia sesi√≥n de nuevo.'); return; }

      const { collection, addDoc, updateDoc, doc, getDoc, serverTimestamp, Timestamp } = window.__fs || {};
      if (!collection){ alert('Firestore no carg√≥. Recarga la p√°gina.'); return; }

      let m = {};
      try{
        const ms = await getDoc(doc(window.db, 'medicos', usr.uid));
        if (ms.exists()) m = ms.data();
      }catch{}

      const medicoDomicilio = (m.direccion ||
        `${m.calle||''} ${m.numero||''}, ${m.colonia||''}, ${m.municipio||''}, ${m.estado||''}, CP ${m.cp||''}`)
        .replace(/\s+,/g,',').replace(/,\s*,/g,', ').trim();

      const medsIniciales = medicamentos.map(x=>x.nombre.split(/\s+/).map(w=>w[0]||'').join('').slice(0,3).toUpperCase()).join('-');

      // 3) Documento receta
      const recetaData = {
        nombrePaciente, edad, sexo, peso, talla, imc, temperatura, presion,
        observaciones, diagnostico,
        medicamentos, medsIniciales,

        medicoNombre: m.nombre || usr.displayName || '',
        medicoGenero: m.genero || '',
        medicoCedula: m.cedula || '',
        medicoEspecialidad: m.especialidad || 'General',
        medicoTelefono: m.telefono || '',
        medicoDomicilio,

        medicoUid: usr.uid,
        medicoEmail: usr.email || '',
        correo: usr.email || '',

        timestamp: (Timestamp?.now?.() ?? new Date()),
        blockchain: { status:'pendiente' },
        hash: null, bloque: null
      };

      const ref = await addDoc(collection(window.db, 'recetas'), recetaData);
      console.log('[panel] receta creada:', ref.id);

      // 4) Sellado v√≠a proxy (opcional/no bloqueante)
      try {
        const recetaResumen = medicamentos.map(m => `${m.nombre} ${m.dosis} por ${m.duracion}`).join(', ');
        const payload = {
          receta: recetaResumen,
          medico: recetaData.medicoNombre || '',
          cedula: recetaData.medicoCedula || '',
          medicamentos,
          iniciales: medicamentos.map(x=>x.ini),
          idReceta: ref.id,
          timestamp: Math.floor(Date.now()/1000)
        };

        const resp = await fetch('/api/bloques', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        let raw = {}; try{ raw = await resp.json(); }catch{}
        console.log('[BC][raw]', raw);

        const toNum = v => (typeof v==='number'&&Number.isFinite(v))
                           ? v : (/^\d+$/.test(String(v??'')) ? Number(v) : NaN);
        const block = [raw?.bloque?.index, raw?.index, raw?.bloqueIndex, raw?.block].map(toNum).find(Number.isFinite);
        const hash  =  raw?.bloque?.hash || raw?.hash || raw?.blockHash || raw?.txid || null;

        const updates = {};
        if (resp.ok && Number.isFinite(block) && hash) {
          updates.blockchain = { status:'ok', block, hash, at: serverTimestamp() };
          updates.bloque = block; updates.hash = hash;
        } else if (raw?.url || raw?.consultaUrl) {
          updates.urlBlockchain = raw.url || raw.consultaUrl;
          updates.blockchain = { status:'simulado' };
        }

        if (Object.keys(updates).length){
          try{ await updateDoc(doc(window.db, 'recetas', ref.id), updates); }
          catch(e){ console.warn('[BC] Firestore update fall√≥ (UI igual se actualiza):', e?.message||e); }
        }
      } catch (e) {
        console.error('Error al sellar v√≠a /api/bloques:', e?.message || e);
      }

      // 5) Redirigir (ajusta la ruta si tu ver-receta est√° en /medico/)
      const VER_RECETA_PATH = '/public/ver-receta.html';
      const goto = new URL(VER_RECETA_PATH, location.origin);
      goto.searchParams.set('id', ref.id);
      location.href = goto.href;

    } catch (err) {
      console.error('[panel] error al guardar receta', err);
      alert('No se pudo generar la receta. Revisa los campos e intenta de nuevo.');
    } finally {
      if (btnGen){ btnGen.disabled = false; btnGen.textContent = prevTxt || 'Generar receta'; }
    }
  }

  function bindSubmit(){
    const form = document.getElementById('generarRecetaForm')
             || document.getElementById('formReceta')
             || document.querySelector('form');
    if (!form) return console.warn('[panel] No se encontr√≥ formulario');
    if (!form.__kodrxSubmitBound){
      form.addEventListener('submit', kodrxSubmit, { capture:true });
      form.__kodrxSubmitBound = true;
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindSubmit, { once:true });
  } else {
    bindSubmit();
  }
})();
</script>
<script>
(() => {
  console.log('[submit-fixer] boot');

  // Seguro contra jQuery: NO usamos $
  const byId = (id)=> document.getElementById(id);

  async function kodrxSubmit(e){
    e?.preventDefault?.();
    console.log('[submit-fixer] handler hit');

    // Lee de DOM directo (sin $)
    const elNombre = byId('nombrePaciente');
    const nombrePaciente = (elNombre?.value || '').trim();
    console.log('[submit-fixer] nombrePaciente el:', elNombre, 'valor:', nombrePaciente);

    if (!nombrePaciente){
      alert('Falta el nombre del paciente');
      elNombre?.focus();
      return;
    }

    // üëâ aqu√≠ solo validamos que el submit funciona.
    // Si quieres, por ahora loguea el resto de campos:
    const dump = (id)=> (byId(id)?.value ?? '(no-field)');
    console.log('[submit-fixer] otros campos:',
      { edad: dump('edad'), sexo: dump('sexo'), talla: dump('talla'),
        peso: dump('peso'), imc: dump('imc'), temperatura: dump('temperatura'),
        presion: dump('presion'), observaciones: dump('observaciones'), diagnostico: dump('diagnostico') }
    );

    alert('Submit OK (hotfix). Ya podemos reenganchar tu flujo real aqu√≠.');
    // ‚ö†Ô∏è Importante: deja esto como ‚Äúprueba‚Äù para confirmar que el submit entra.
    // Despu√©s reemplazamos el contenido con tu onSubmit completo.
  }

  window.kodrxSubmit = kodrxSubmit;

  function bind(){
    // Encuentra el form
    let form = document.getElementById('generarRecetaForm')
            || document.getElementById('formReceta')
            || document.querySelector('form');

    if (!form){ console.warn('[submit-fixer] no hay <form>'); return; }

    // Si hab√≠a listeners viejos y quieres resetearlos ‚Äúduro‚Äù, descomenta:
    // const clone = form.cloneNode(true); form.parentNode.replaceChild(clone, form); form = clone;

    if (!form.__kodrxBound){
      form.addEventListener('submit', kodrxSubmit, {capture:true});
      form.__kodrxBound = true;
      console.log('[submit-fixer] bound on', form.id || form.tagName);
    }

    // Asegura que el bot√≥n dispare el submit correcto
    const btn = document.getElementById('btnGenerar')
            || document.querySelector('[type=submit], [data-generate], .generate');

    if (btn && !btn.__wired){
      btn.addEventListener('click', (ev)=>{
        const f = form;
        if (f?.requestSubmit) f.requestSubmit();
        else f?.dispatchEvent(new Event('submit', {cancelable:true}));
      }, {capture:true});
      btn.__wired = true;
      console.log('[submit-fixer] bot√≥n cableado');
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bind, {once:true});
  } else {
    bind();
  }

  // util por si quieres reintentar desde consola
  window.kodrxForceBind = bind;
})();
</script>




</body>
</html>

