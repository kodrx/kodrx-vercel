<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Panel para Medico</title>
  <link rel="stylesheet" href="/estilos/global.css" />
  <script src="/componentes/header.js" defer></script>

<script src="/medico/qrcode.min.js"></script>


</head>

  <main>
   <section class="botonera">
  <button class="btn ghost" onclick="location.reload()"> Nueva receta</button>
  <button class="btn ghost" onclick="window.location.href='historial.html'">Historial</button>
  <button class="btn primary" onclick="window.location.href='#'">Acceder IA cl√≠nica</button>
  <button id="btnLogout" class="btn ghost">Cerrar sesi√≥n</button>

     <!-- usa exactamente estos IDs / types -->


</section>


    <form id="generarRecetaForm" class="form-login">
      <h2>Generar nueva receta</h2>

      <label for="nombrePaciente">Nombre del paciente:</label>
      <input type="text" id="nombrePaciente" required>

      <label for="edad">Edad:</label>
      <input type="number" id="edad" required>

      <label for="sexo">Sexo:</label>
      <select id="sexo">
        <option value="Masculino">Masculino</option>
        <option value="Femenino">Femenino</option>
        <option value="Otro">Otro</option>
      </select>

      <label for="talla">Talla (cm):</label>
      <input type="number" id="talla">

      <label for="peso">Peso (kg):</label>
      <input type="number" id="peso">

      <label for="imc">IMC:</label>
      <input type="text" id="imc" disabled>

      <label for="temperatura">Temperatura (¬∞C):</label>
      <input type="text" id="temperatura">

      <label for="presion">Presi√≥n arterial:</label>
      <input type="text" id="presion">

      <label for="observaciones">Observaciones:</label>
      <textarea id="observaciones"></textarea>

      <label for="diagnostico">Diagn√≥stico:</label>
      <textarea id="diagnostico"></textarea>

      <h3>Medicamentos</h3>
      <div id="medicamentosContainer"></div>

      <!-- usa exactamente estos IDs / types -->
<button id="btnAgregarMedicamento" type="button">Agregar medicamento</button>
<button id="btnGenerar" type="button">Generar receta</button>

    </form>

    <div id="qrContainer" style="margin-top: 20px;"></div>
  </main>

  <!-- Scripts -->
  <script src="/medico/autocomplete.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script type="module" src="/firebase-init.js"></script>

  <script>
    // C√°lculo autom√°tico de IMC
    document.getElementById("peso").addEventListener("input", calcularIMC);
    document.getElementById("talla").addEventListener("input", calcularIMC);

    function calcularIMC() {
      const peso = parseFloat(document.getElementById("peso").value);
      const talla = parseFloat(document.getElementById("talla").value) / 100;
      if (!isNaN(peso) && !isNaN(talla) && talla > 0) {
        const imc = peso / (talla * talla);
        document.getElementById("imc").value = imc.toFixed(2);
      }
    }
  </script>

<script>
/* ==== KODRX inline GEN v3 (meds ini + medsSig + blockchain) ==== */
(() => {
  if (window.__KODRX_INLINE_GEN_V3__) return; window.__KODRX_INLINE_GEN_V3__=true;

  // üëâ Si ya tienes endpoint real, ponlo aqu√≠:
  // window.BC_ISSUE_URL = 'https://tu-backend/issue';

  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
  const val= (sel)=>($(sel)?.value ?? '').toString().trim();

  // Firebase lazy
  let auth, db, fs, onAuthStateChanged, currentUser=null;
  async function ensureImports(){
    if (auth && db && fs) return;
    const core   = await import('/firebase-init.js');
    const _fs    = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
    const _auth  = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js');
    auth = core.auth; db = core.db; fs = _fs; onAuthStateChanged = _auth.onAuthStateChanged;
    onAuthStateChanged(auth, u => { currentUser = u || null; });
  }
  const ensureUser = ()=> currentUser || auth?.currentUser || null;

  // Contenedor/filas de medicamentos
  let medsContainer;
  function ensureMedsContainer(){
    if (medsContainer && document.contains(medsContainer)) return medsContainer;
    medsContainer = document.getElementById('medicamentosContainer') || document.querySelector('[data-meds]');
    if (!medsContainer){ const d=document.createElement('div'); d.id='medicamentosContainer'; document.body.appendChild(d); medsContainer=d; }
    return medsContainer;
  }
  function agregarMedicamento(){
    const cont = ensureMedsContainer();
    const row = document.createElement('div');
    row.className='medicamento'; row.style.cssText='display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;margin:6px 0';
    const n = Object.assign(document.createElement('input'), { placeholder:'Nombre',   className:'nombre'   });
    const d = Object.assign(document.createElement('input'), { placeholder:'Dosis',    className:'dosis'    });
    const u = Object.assign(document.createElement('input'), { placeholder:'Duraci√≥n', className:'duracion' });
    const x = document.createElement('button'); x.type='button'; x.textContent='üóëÔ∏è'; x.style.padding='6px 10px'; x.onclick=()=>row.remove();
    row.append(n,d,u,x); cont.appendChild(row);
    if (typeof window.iniciarAutocompletado==='function') setTimeout(()=>window.iniciarAutocompletado(n),60);
  }
  function collectMeds(){
    const out=[]; $$('#medicamentosContainer .medicamento, [data-meds] .medicamento').forEach(r=>{
      const nombre=(r.querySelector('.nombre')?.value??'').trim();
      const dosis =(r.querySelector('.dosis') ?.value??'').trim();
      const dur   =(r.querySelector('.duracion')?.value??'').trim();
      if (nombre) out.push({ nombre, dosis: dosis||'‚Äî', duracion: dur||'‚Äî' });
    }); return out;
  }

  // Iniciales / firma corta
  const STOP_ES=new Set(['DE','DEL','LA','EL','LOS','LAS','Y','CON','PARA','POR','A','EN','UN','UNA','UNO','AL','LO']);
  const asciiUp=s=>(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toUpperCase();
  const medInitials=nombre=>{
    const t=asciiUp(nombre).replace(/[^A-Z0-9\s]/g,' ').trim().split(/\s+/); const L=[];
    for(const w of t){ if(!w||STOP_ES.has(w)) continue; L.push(w[0]); if(L.length>=4) break; }
    return L.join('')||asciiUp(nombre).slice(0,3)||'X';
  };
  const buildMedsSignature=meds=>{
    try{ return (meds||[]).map(m=>(m.ini||medInitials(m.nombre||'')).slice(0,4)).filter(Boolean).join('.').slice(0,120); }
    catch{ return ''; }
  };
  async function sha256Hex(str){
    const dig=await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return [...new Uint8Array(dig)].map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  async function issueOnChain({recetaId, recetaData, medsSig}){
    const payload={ id:recetaId, ts:Date.now(), medicoUid:recetaData.medicoUid, paciente:recetaData.nombrePaciente||'', medsSig:medsSig||'' };
    const URL_BC=window.BC_ISSUE_URL||'/api/bc/issue';
    try{
      const r=await fetch(URL_BC,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!r.ok) throw new Error('HTTP '+r.status); const j=await r.json(); if(!j?.hash) throw new Error('Respuesta BC inv√°lida');
      return {status:'ok', ...j};  // {network, tx, block, hash}
    }catch{
      return {status:'simulado', network:'sim', tx:null, block:null, hash:(await sha256Hex(JSON.stringify(payload))).slice(0,40)};
    }
  }

  async function onSubmitReceta(ev){
    ev?.preventDefault?.();
    const btn = document.getElementById('btnGenerar') || document.querySelector('button[type="submit"]');
    if (btn){ btn.disabled=true; btn.textContent='Guardando‚Ä¶'; }
    try{
      await ensureImports();
      const { addDoc, updateDoc, collection, doc, getDoc, serverTimestamp } = fs;

      const u = ensureUser(); if(!u) throw new Error('Inicia sesi√≥n');

      // m√©dico (opcional)
      let medico={}; try{ const snap=await getDoc(doc(db,'medicos',u.uid)); medico=snap.exists()?(snap.data()||{}):{}; }catch{}

      // datos del form
      const base = {
        nombrePaciente: val('#nombrePaciente'),
        edad: Number(val('#edad'))||null,
        sexo: val('#sexo'),
        talla: Number(val('#talla'))||null,
        peso: Number(val('#peso'))||null,
        imc: val('#imc'),
        temperatura: val('#temperatura'),
        presion: val('#presion'),
        observaciones: val('#observaciones'),
        diagnostico: val('#diagnostico'),

        medicoUid: u.uid, medicoEmail: u.email||'', correo: u.email||'',
        medicoNombre: medico?.nombre||'', medicoCedula: medico?.cedula||'',
        medicoEspecialidad: medico?.especialidad||'General', medicoTelefono: medico?.telefono||'',
        medicoDomicilio: `${medico?.calle||''} ${medico?.numero||''}, ${medico?.colonia||''}, ${medico?.municipio||''}, ${medico?.estado||''}, CP ${medico?.cp||''}`.replace(/\s+/g,' ').trim(),
        timestamp: serverTimestamp()
      };
      if(!base.nombrePaciente) throw new Error('Falta nombre del paciente');
      if(!base.edad) throw new Error('Falta edad');

      // meds
      const raw = collectMeds();
      const meds = raw.map(m=>({ nombre:m.nombre, dosis:m.dosis||'‚Äî', duracion:m.duracion||'‚Äî', ini: medInitials(m.nombre||'') }));
      const medsSig = buildMedsSignature(meds);

      // crea receta con estado inicial
      const recetaRef = await addDoc(collection(db,'recetas'), { ...base, medsSig, blockchain:{ status:'pendiente', medsSig } });

      // subcolecci√≥n
      for(const m of meds){ await addDoc(collection(db,'recetas', recetaRef.id, 'medicamentos'), m); }

      // sellar en BC (real o simulado) y persistir
      try{
        const bc = await issueOnChain({ recetaId: recetaRef.id, recetaData: base, medsSig });
        await updateDoc(doc(db,'recetas', recetaRef.id), {
          bloque: bc.block ?? null, hash: bc.hash ?? null,
          blockchain: { status: bc.status, network: bc.network||null, tx: bc.tx||null, block: bc.block||null, hash: bc.hash||null, medsSig, at: serverTimestamp() }
        });
      }catch(e){ console.error('[gen] update blockchain error', e); }

      if (btn){ btn.disabled=false; btn.textContent='Generar receta'; }
      location.href = '/public/ver-receta.html?id='+encodeURIComponent(recetaRef.id);

    }catch(e){
      console.error('[gen] error:', e);
      alert(e?.message||'No se pudo generar la receta.');
      if (btn){ btn.disabled=false; btn.textContent='Generar receta'; }
    }
  }

  function bindUI(){
    const form  = $('#generarRecetaForm') || $('form');
    const addBtn= $('#btnAgregarMedicamento') || document.querySelector('[data-add-med], .add-med');
    const genBtn= $('#btnGenerar') || document.querySelector('[data-generate], .generate');
    addBtn?.setAttribute('type','button'); genBtn?.setAttribute('type','button');
    if(addBtn && !addBtn.__b){ addBtn.addEventListener('click',e=>{e.preventDefault();agregarMedicamento();},{capture:true}); addBtn.__b=true; }
    if(genBtn && !genBtn.__b){ genBtn.addEventListener('click',e=>{e.preventDefault(); form?.requestSubmit?form.requestSubmit():form?.submit();},{capture:true}); genBtn.__b=true; }
    if(form && !form.__b){ form.addEventListener('submit', onSubmitReceta); form.__b=true; }
  }
  document.readyState==='loading'?document.addEventListener('DOMContentLoaded',bindUI,{once:true}):bindUI();

  // Debug helpers
  window.agregarMedicamento = agregarMedicamento;
})();
</script>




</body>
</html>

