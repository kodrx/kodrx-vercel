<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Panel para Medico</title>
  <link rel="stylesheet" href="/estilos/global.css" />
  <script src="/componentes/header.js" defer></script>

<script src="/medico/qrcode.min.js"></script>


</head>

  <main>
   <section class="botonera">
  <button class="btn ghost" onclick="location.reload()"> Nueva receta</button>
  <button class="btn ghost" onclick="window.location.href='historial.html'">Historial</button>
  <button class="btn primary" onclick="window.location.href='#'">Acceder IA cl√≠nica</button>
  <button id="btnLogout" class="btn ghost">Cerrar sesi√≥n</button>

     <!-- usa exactamente estos IDs / types -->


</section>


    <form id="generarRecetaForm" class="form-login">
      <h2>Generar nueva receta</h2>

      <label for="nombrePaciente">Nombre del paciente:</label>
      <input type="text" id="nombrePaciente" required>

      <label for="edad">Edad:</label>
      <input type="number" id="edad" required>

      <label for="sexo">Sexo:</label>
      <select id="sexo">
        <option value="Masculino">Masculino</option>
        <option value="Femenino">Femenino</option>
        <option value="Otro">Otro</option>
      </select>

      <label for="talla">Talla (cm):</label>
      <input type="number" id="talla">

      <label for="peso">Peso (kg):</label>
      <input type="number" id="peso">

      <label for="imc">IMC:</label>
      <input type="text" id="imc" disabled>

      <label for="temperatura">Temperatura (¬∞C):</label>
      <input type="text" id="temperatura">

      <label for="presion">Presi√≥n arterial:</label>
      <input type="text" id="presion">

      <label for="observaciones">Observaciones:</label>
      <textarea id="observaciones"></textarea>

      <label for="diagnostico">Diagn√≥stico:</label>
      <textarea id="diagnostico"></textarea>

      <h3>Medicamentos</h3>
      <div id="medicamentosContainer"></div>

      <!-- usa exactamente estos IDs / types -->
<button id="btnAgregarMedicamento" type="button">Agregar medicamento</button>
<button id="btnGenerar" type="button">Generar receta</button>

    </form>

    <div id="qrContainer" style="margin-top: 20px;"></div>
  </main>

  <!-- Scripts -->
  <script src="/medico/autocomplete.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script type="module" src="/firebase-init.js"></script>

  <script>
    // C√°lculo autom√°tico de IMC
    document.getElementById("peso").addEventListener("input", calcularIMC);
    document.getElementById("talla").addEventListener("input", calcularIMC);

    function calcularIMC() {
      const peso = parseFloat(document.getElementById("peso").value);
      const talla = parseFloat(document.getElementById("talla").value) / 100;
      if (!isNaN(peso) && !isNaN(talla) && talla > 0) {
        const imc = peso / (talla * talla);
        document.getElementById("imc").value = imc.toFixed(2);
      }
    }
  </script>
<script type="module">
console.log('[panel] boot');

import { db, auth } from "/firebase-init.js";
import {
  collection, addDoc, doc, getDoc,
  serverTimestamp, Timestamp
} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  // Exponer a window para que los vea el script inline cl√°sico:
  window.db = db;
  window.auth = auth;
  window.__fs = { collection, addDoc, updateDoc, doc, getDoc, serverTimestamp, Timestamp };
  
/* ---------- estado ---------- */
const state = { user:null, medico:null };

/* ---------- helpers UI ---------- */
function $(sel,root=document){ return root.querySelector(sel); }
function $all(sel,root=document){ return Array.from(root.querySelectorAll(sel)); }

function ensureMedsContainer(){
  let el = document.getElementById('medicamentosContainer') || $('[data-meds]');
  if (!el){ el = document.createElement('div'); el.id='medicamentosContainer'; document.body.appendChild(el); }
  return el;
}
const medsContainer = ensureMedsContainer();

function iniciarAutocompletadoSiExiste(input){
  if (typeof window.iniciarAutocompletado === 'function'){
    setTimeout(()=> window.iniciarAutocompletado(input), 50);
  }
}

function agregarMedicamento(){
  const wrap = document.createElement('div');
  wrap.className = 'medicamento';
  wrap.style.cssText = 'position:relative; display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:8px; margin-bottom:8px;';

  const nombre   = Object.assign(document.createElement('input'), {type:'text',  placeholder:'Nombre',   className:'nombre'});
  const dosis    = Object.assign(document.createElement('input'), {type:'text',  placeholder:'Dosis',    className:'dosis'});
  const duracion = Object.assign(document.createElement('input'), {type:'text',  placeholder:'Duraci√≥n', className:'duracion'});
  const delBtn   = Object.assign(document.createElement('button'),{type:'button', textContent:'üóëÔ∏è'});
  delBtn.style.cssText='padding:.4rem .6rem;'; delBtn.onclick = ()=> wrap.remove();

  wrap.append(nombre,dosis,duracion,delBtn);
  medsContainer.appendChild(wrap);
  iniciarAutocompletadoSiExiste(nombre);
}

function leerMedicamentos(){
  return $all('.medicamento').map(row=>{
    const nombre   = $('.nombre', row)?.value?.trim() || '';
    const dosis    = $('.dosis', row)?.value?.trim() || '';
    const duracion = $('.duracion', row)?.value?.trim() || '';
    if(!nombre && !dosis && !duracion) return null;
    return { nombre, dosis, duracion };
  }).filter(Boolean);
}

function computeIMC(peso, tallaCm){
  const p = parseFloat(peso), t = parseFloat(tallaCm);
  if (!p || !t) return '';
  const m = t/100;
  const imc = p/(m*m);
  return (Math.round(imc*100)/100).toFixed(2);
}

function inicialesDeMeds(meds){
  // ‚Äúiniciales‚Äù amigables para blockchain, p.ej. AMO-IBU-PAR
  return (meds||[])
    .map(m=> (m?.nombre||'').trim().split(/\s+/).map(w=>w[0]||'').join('').slice(0,3).toUpperCase())
    .filter(s=>s).join('-');
}

/* ---------- bind de UI ---------- */
function bindUI(){
  const btnAdd = document.getElementById('btnAgregarMedicamento') || document.querySelector('[data-add-med], .add-med');
  const btnGen = document.getElementById('btnGenerar') || document.querySelector('[data-generate], .generate');

  if (btnAdd && !btnAdd.__bound){ btnAdd.type='button'; btnAdd.addEventListener('click', (e)=>{ e.preventDefault(); agregarMedicamento(); }); btnAdd.__bound=true; }
  if (btnGen && !btnGen.__bound){ btnGen.type='button'; btnGen.addEventListener('click', (e)=>{ e.preventDefault(); onSubmit(); }); btnGen.__bound=true; }

  // IMC en vivo
  const peso  = document.getElementById('peso');
  const talla = document.getElementById('talla');
  const imcEl = document.getElementById('imc');
  if (peso && talla && imcEl){
    const upd = ()=> imcEl.value = computeIMC(peso.value, talla.value);
    peso.addEventListener('input', upd); talla.addEventListener('input', upd);
  }
}

/* ---------- auth + carga del m√©dico ---------- */
onAuthStateChanged(auth, async (user)=>{
  if (!user){ alert('Inicia sesi√≥n para generar recetas'); location.href='/acceso.html'; return; }
  state.user = user;
  try{
    const medSnap = await getDoc(doc(db,'medicos', user.uid));
    if (!medSnap.exists()){ alert('Perfil de m√©dico no encontrado'); return; }
    state.medico = medSnap.data();
    console.log('[panel] m√©dico:', state.medico?.nombre || '(sin nombre)');
  }catch(err){
    console.error('[panel] error leyendo /medicos/{uid}', err);
    alert('No se pudo leer tu perfil de m√©dico.');
  }
});

/* ---------- submit ---------- */
async function onSubmit(){
  const btnGen = document.getElementById('btnGenerar') || document.querySelector('[data-generate], .generate');
  if (btnGen){ btnGen.disabled = true; var prevTxt = btnGen.textContent; btnGen.textContent = 'Guardando‚Ä¶'; }

  try{
    // campos del formulario
    const nombrePaciente = $('#nombrePaciente')?.value?.trim() || '';
    const edad           = parseInt($('#edad')?.value||'',10) || null;
    const sexo           = $('#sexo')?.value || '';
    const talla          = $('#talla')?.value || '';
    const peso           = $('#peso')?.value || '';
    const imc            = $('#imc')?.value || computeIMC(peso,talla) || '';
    const temperatura    = $('#temperatura')?.value || '';
    const presion        = $('#presion')?.value || '';
    const observaciones  = $('#observaciones')?.value?.trim() || '';
    const diagnostico    = $('#diagnostico')?.value?.trim() || '';
    const medicamentos   = leerMedicamentos();

    if (!nombrePaciente){ alert('Falta el nombre del paciente'); return; }
    if (!medicamentos.length){ if(!confirm('No agregaste medicamentos. ¬øContinuar?')) return; }

    // prepara datos m√©dico (compatibles con ver-receta)
    const m = state.medico || {};
    const medicoDomicilio = `${m.calle||''} ${m.numero||''}, ${m.colonia||''}, ${m.municipio||''}, ${m.estado||''}, CP ${m.cp||''}`.replace(/\s+,/g,',').replace(/,\s*,/g,', ').trim();

    // iniciales para blockchain
    const medsIniciales = inicialesDeMeds(medicamentos);

    const recetaData = {
      // paciente (flatten + compat)
      nombrePaciente, edad, sexo, peso, talla, imc, temperatura, presion,
      observaciones, diagnostico,
      medicamentos,            // arreglo de {nombre,dosis,duracion}
      medsIniciales,           // p.ej. AMO-IBU-PAR

      // m√©dico (flatten para vista actual)
      medicoNombre: m.nombre || '',
      medicoGenero: m.genero || '',
      medicoCedula: m.cedula || '',
      medicoEspecialidad: m.especialidad || 'General',
      medicoTelefono: m.telefono || '',
      medicoDomicilio,

      // √≠ndices/seguimiento
      medicoUid: state.user?.uid || '',
      medicoEmail: state.user?.email || '',
      correo: state.user?.email || '',       // compat historiales previos
      timestamp: serverTimestamp(),

      // blockchain: pendiente (ver-receta actualiza badge/qr)
      blockchain: { status:'pendiente' },
      hash: null,
      bloque: null
    };


// tras crear la receta
const ref = await addDoc(collection(db, 'recetas'), recetaData);
console.log('[panel] receta creada:', ref.id);

// === Sellado v√≠a proxy /api/bloques (mismo origen) ===
try {
  const meds = Array.isArray(recetaData.medicamentos) ? recetaData.medicamentos : [];
  const iniciales =
    recetaData.medsIniciales ||
    meds.map(m => String(m?.nombre||'').trim().split(/\s+/).map(w => w[0]||'').join('').slice(0,3).toUpperCase());

  const recetaResumen = meds.map(m => `${m.nombre} ${m.dosis} por ${m.duracion}`).join(', ');

  const payload = {
    receta: recetaResumen,                          // ‚Üê requerido por tu proxy
    medico: recetaData.medicoNombre || '',          // ‚Üê requerido
    cedula: recetaData.medicoCedula || '',          // ‚Üê requerido
    medicamentos: meds,
    iniciales,                                      // array est√° bien
    idReceta: ref.id,
    timestamp: Math.floor(Date.now()/1000)
  };

  const resp = await fetch('/api/bloques', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  let raw = {};
  try { raw = await resp.json(); } catch {}
  console.log('[BC][raw]', raw);

  // Acepta varios shapes de respuesta
  const toNum = v => (typeof v === 'number' && Number.isFinite(v)) ? v : (/^\d+$/.test(String(v??'')) ? Number(v) : NaN);
  const block = [raw?.bloque?.index, raw?.index, raw?.bloqueIndex, raw?.block].map(toNum).find(Number.isFinite);
  const hash  = raw?.bloque?.hash || raw?.hash || raw?.blockHash || raw?.txid || null;

  if (resp.ok && Number.isFinite(block) && hash) {
    // tras obtener `resp` y `raw`, y calcular `block` y `hash`‚Ä¶
const updates = {};

if (resp.ok && Number.isFinite(block) && hash) {
  updates.blockchain = { status: 'ok', block, hash, at: serverTimestamp() };
  updates.bloque = block;
  updates.hash = hash;
  console.log('[BC] listo para guardar:', { block, hash });
} else if (raw?.url || raw?.consultaUrl) {
  updates.urlBlockchain = raw.url || raw.consultaUrl;
  updates.blockchain = { status: 'simulado' };
  console.warn('‚ö† Respuesta BC sin block/hash; guardando URL de consulta');
} else {
  console.warn('‚ö† Respuesta BC sin datos utilizables', { raw });
}

// Una sola escritura a Firestore (si hay algo que actualizar)
try {
  if (Object.keys(updates).length) {
    await updateDoc(doc(db, 'recetas', ref.id), updates);
  }
} catch (e) {
  console.warn('[BC] Firestore update fall√≥ (UI igual se actualiza):', e?.message || e);
}

// =====================================================



    
    // Redirecci√≥n a ver-receta con el ID
    const u = new URL('/medico/ver-receta.html', location.origin);
    u.searchParams.set('id', ref.id);
    // feedback m√≠nimo antes de irnos
    alert('Receta creada: ' + ref.id);
    location.href = u.href;

  }catch(err){
    console.error('[panel] error al guardar receta', err);
    alert('No se pudo generar la receta. Revisa los campos e intenta de nuevo.');
  }finally{
    if (btnGen){ btnGen.disabled=false; btnGen.textContent = prevTxt || 'Generar receta'; }
  }
}

/* ---------- ready ---------- */
if (document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', ()=>{ bindUI(); }, {once:true});
}else{
  bindUI();
}

// exp√≥n si necesitas dispararlos desde consola
window.agregarMedicamento = window.agregarMedicamento || agregarMedicamento;
window.kodrxPanelSubmit  = onSubmit;

console.log('[panel] ready');


</script>

<script>
;(() => {
  console.log('[panel][hotfix] bindUI v2');

  const $ = s => document.querySelector(s);
  let medsHost = null;

  function ensureMedsContainer(){
    if (medsHost && medsHost.isConnected) return medsHost;
    medsHost = document.getElementById('medicamentosContainer')
          || document.querySelector('[data-meds]');
    if (!medsHost){
      medsHost = document.createElement('div');
      medsHost.id = 'medicamentosContainer';
      (document.getElementById('generarRecetaForm')
        || document.getElementById('formReceta')
        || document.body).appendChild(medsHost);
    }
    return medsHost;
  }

  // expone agregarMedicamento si no existe
  window.agregarMedicamento = window.agregarMedicamento || function agregarMedicamento(){
    const host = ensureMedsContainer();
    const row = document.createElement('div');
    row.className = 'medicamento';
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '1fr 1fr 1fr auto';
    row.style.gap = '8px';
    row.innerHTML = `
      <input type="text" class="nombre"   placeholder="Nombre del medicamento">
      <input type="text" class="dosis"    placeholder="Dosis">
      <input type="text" class="duracion" placeholder="Duraci√≥n">
      <button type="button" class="rm" title="Eliminar">üóëÔ∏è</button>`;
    row.querySelector('.rm').onclick = () => row.remove();
    host.appendChild(row);
    if (typeof window.iniciarAutocompletado === 'function') {
      const input = row.querySelector('.nombre');
      setTimeout(()=>window.iniciarAutocompletado(input), 50);
    }
  };

  function generarReceta(){
    const form = document.getElementById('generarRecetaForm')
             || document.getElementById('formReceta')
             || document.querySelector('form');
    if (!form) return console.warn('[panel] No se encontr√≥ el formulario');
    if (form.__busy) return;
    form.__busy = true; setTimeout(()=>{ form.__busy = false; }, 5000);
    if (form.requestSubmit) form.requestSubmit(); else form.submit();
  }
  window.generarReceta = window.generarReceta || generarReceta;

  function bindButton(btn, fn){
    if (!btn) return false;
    btn.type = 'button';
    btn.disabled = false;
    btn.removeAttribute('aria-busy');
    btn.style.pointerEvents = '';
    btn.style.opacity = '';
    if (!btn.__bound){
      btn.addEventListener('click', e => { e.preventDefault(); fn(); }, {capture:true});
      btn.__bound = true;
    }
    return true;
  }

  function bindUI(){
    ensureMedsContainer();
    const addOk = bindButton(
      document.getElementById('btnAgregarMedicamento')
      || document.querySelector('[data-add-med], .add-med'),
      window.agregarMedicamento
    );
    const genOk = bindButton(
      document.getElementById('btnGenerar')
      || document.querySelector('[data-generate], .generate'),
      window.generarReceta
    );
    console.log('[panel][hotfix] bindUI:', { addOk, genOk });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindUI, { once:true });
  } else {
    bindUI();
  }
  window.kodrxBindUI = bindUI; // por si quieres re-binder desde la consola
})();
</script>

<script>
;(() => {
  console.log('[panel] submit bind');

  const $ = s => document.querySelector(s);

  function pickForm(){
    return document.getElementById('generarRecetaForm')
        || document.getElementById('formReceta')
        || document.querySelector('form');
  }

  async function onSubmit(e){
    e.preventDefault();
    const form = e.currentTarget;
    if (form.__busy) return;
    form.__busy = true;

    try{
      // --- Recolecci√≥n de datos del form ---
      const v = id => (document.getElementById(id)?.value ?? '').trim();

      const nombrePaciente = v('nombrePaciente');
      const edad          = v('edad');
      const sexo          = v('sexo');
      const talla         = v('talla');
      const peso          = v('peso');
      const imc           = v('imc');
      const temperatura   = v('temperatura');
      const presion       = v('presion');
      const observaciones = v('observaciones');
      const diagnostico   = v('diagnostico');

      // medicamentos (de filas .medicamento)
      const meds = [...document.querySelectorAll('#medicamentosContainer .medicamento')].map(row => {
        const get = cls => row.querySelector('.'+cls)?.value?.trim() || '';
        const nombre   = get('nombre');
        const dosis    = get('dosis');
        const duracion = get('duracion');
        // iniciales (3 chars m√°x) p/ blockchain
        const ini = nombre.split(/\s+/).map(w=>w[0]||'').join('').slice(0,3).toUpperCase();
        return { nombre, dosis, duracion, ini };
      });

      // --- Cargar m√©dico actual (desde Firestore) ---
      const u = window.auth?.currentUser;
      if (!u) { alert('No hay sesi√≥n. Inicia sesi√≥n de nuevo.'); return; }

      const { doc, getDoc, collection, addDoc, updateDoc, serverTimestamp } = window.__fs || {};
      if (!doc) { alert('Firestore no carg√≥. Recarga la p√°gina.'); return; }

      let medico = {};
      try{
        const mSnap = await getDoc(doc(window.db, 'medicos', u.uid));
        if (mSnap.exists()) medico = mSnap.data();
      }catch{}

      const recetaData = {
        nombrePaciente,
        paciente: {
          nombre: nombrePaciente,
          edad, sexo, talla, peso, imc, temperatura, presion
        },
        observaciones,
        diagnostico,
        medicamentos: meds,
        medsIniciales: meds.map(m=>m.ini).join('-'),
        medicoNombre: medico.nombre || (u.displayName || ''),
        medicoCedula: medico.cedula || '',
        medicoEspecialidad: medico.especialidad || 'General',
        medicoTelefono: medico.telefono || '',
        medicoDomicilio: medico.direccion || [
          medico.calle, medico.numero, medico.colonia, medico.municipio, medico.estado, `CP ${medico.cp||''}`
        ].filter(Boolean).join(', '),
        correo: u.email || '',
        uidMedico: u.uid,
        timestamp: (window.__fs?.Timestamp || Date).now ? (window.__fs?.Timestamp.now?.() ?? new Date()) : new Date()
      };

      // --- Guardar receta ---
      const ref = await addDoc(collection(window.db, 'recetas'), recetaData);
      console.log('[panel] receta creada:', ref.id);

      // --- Sellar v√≠a proxy /api/bloques (requerido: receta, medico, cedula) ---
      try{
        const recetaResumen = meds.map(m => `${m.nombre} ${m.dosis} por ${m.duracion}`).join(', ');
        const payload = {
          receta: recetaResumen,
          medico: recetaData.medicoNombre || '',
          cedula: recetaData.medicoCedula || '',
          medicamentos: meds,
          iniciales: meds.map(m=>m.ini),
          idReceta: ref.id,
          timestamp: Math.floor(Date.now()/1000)
        };

        const resp = await fetch('/api/bloques', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        let raw = {};
        try { raw = await resp.json(); } catch {}
        console.log('[BC][raw]', raw);

        const toNum = v => (typeof v==='number'&&Number.isFinite(v)) ? v : (/^\d+$/.test(String(v??'')) ? Number(v) : NaN);
        const block = [raw?.bloque?.index, raw?.index, raw?.bloqueIndex, raw?.block].map(toNum).find(Number.isFinite);
        const hash  = raw?.bloque?.hash || raw?.hash || raw?.blockHash || raw?.txid || null;

        const updates = {};
        if (resp.ok && Number.isFinite(block) && hash) {
          updates.blockchain = { status:'ok', block, hash, at: serverTimestamp() };
          updates.bloque = block;
          updates.hash = hash;
        } else if (raw?.url || raw?.consultaUrl) {
          updates.urlBlockchain = raw.url || raw.consultaUrl;
          updates.blockchain = { status:'simulado' };
        }

        if (Object.keys(updates).length){
          try{ await updateDoc(doc(window.db,'recetas',ref.id), updates); }
          catch(e){ console.warn('[BC] Firestore update fall√≥:', e?.message||e); }
        }
      }catch(e){
        console.error(' Error al sellar v√≠a /api/bloques:', e?.message||e);
      }

      // --- Navegar a ver-receta ---
      location.href = `/public/ver-receta.html?id=${encodeURIComponent(ref.id)}`;

    } catch(err){
      console.error(' Error al guardar la receta:', err);
      alert('No se pudo generar la receta. Revisa los campos e intenta de nuevo.');
    } finally {
      form.__busy = false;
    }
  }

  function bindSubmit(){
    const form = pickForm();
    if (!form) return console.warn('[panel] No se encontr√≥ formulario');
    if (!form.__kodrxSubmitBound){
      form.addEventListener('submit', onSubmit, { capture:true });
      form.__kodrxSubmitBound = true;
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindSubmit, { once:true });
  } else {
    bindSubmit();
  }
})();
</script>


</body>
</html>

