<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Panel para Medico</title>
  <link rel="stylesheet" href="/estilos/global.css" />
  <script src="/componentes/header.js" defer></script>

<script src="/medico/qrcode.min.js"></script>


</head>

  <main>
   <section class="botonera">
  <button class="btn ghost" onclick="location.reload()"> Nueva receta</button>
  <button class="btn ghost" onclick="window.location.href='historial.html'">Historial</button>
  <button class="btn primary" onclick="window.location.href='#'">Acceder IA clínica</button>
  <button id="btnLogout" class="btn ghost">Cerrar sesión</button>

     <!-- usa exactamente estos IDs / types -->


</section>


    <form id="generarRecetaForm" class="form-login">
      <h2>Generar nueva receta</h2>

      <label for="nombrePaciente">Nombre del paciente:</label>
      <input type="text" id="nombrePaciente" required>

      <label for="edad">Edad:</label>
      <input type="number" id="edad" required>

      <label for="sexo">Sexo:</label>
      <select id="sexo">
        <option value="Masculino">Masculino</option>
        <option value="Femenino">Femenino</option>
        <option value="Otro">Otro</option>
      </select>

      <label for="talla">Talla (cm):</label>
      <input type="number" id="talla">

      <label for="peso">Peso (kg):</label>
      <input type="number" id="peso">

      <label for="imc">IMC:</label>
      <input type="text" id="imc" disabled>

      <label for="temperatura">Temperatura (°C):</label>
      <input type="text" id="temperatura">

      <label for="presion">Presión arterial:</label>
      <input type="text" id="presion">

      <label for="observaciones">Observaciones:</label>
      <textarea id="observaciones"></textarea>

      <label for="diagnostico">Diagnóstico:</label>
      <textarea id="diagnostico"></textarea>

      <h3>Medicamentos</h3>
      <div id="medicamentosContainer"></div>

      <!-- usa exactamente estos IDs / types -->
<button id="btnAgregarMedicamento" type="button">Agregar medicamento</button>
<button id="btnGenerar" type="button">Generar receta</button>

    </form>

    <div id="qrContainer" style="margin-top: 20px;"></div>
  </main>

  <!-- Scripts -->
  <script src="/medico/autocomplete.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script type="module" src="/firebase-init.js"></script>
  <script type="module" src="/medico/panel-medico-master.js"></script>
  <script>
    // Cálculo automático de IMC
    document.getElementById("peso").addEventListener("input", calcularIMC);
    document.getElementById("talla").addEventListener("input", calcularIMC);

    function calcularIMC() {
      const peso = parseFloat(document.getElementById("peso").value);
      const talla = parseFloat(document.getElementById("talla").value) / 100;
      if (!isNaN(peso) && !isNaN(talla) && talla > 0) {
        const imc = peso / (talla * talla);
        document.getElementById("imc").value = imc.toFixed(2);
      }
    }
  </script>
  <script type="module">
console.log('[nueva] guard boot');

function when(sel){
  return new Promise(res=>{
    const el = document.querySelector(sel);
    if (el) return res(el);
    const mo = new MutationObserver(()=>{
      const el2 = document.querySelector(sel);
      if (el2){ mo.disconnect(); res(el2); }
    });
    mo.observe(document, {childList:true, subtree:true});
  });
}

function bindClick(sel, fn){
  when(sel).then(el=>{
    el.addEventListener('click', ev=>{
      console.log('[nueva] click', sel);
      ev.preventDefault(); ev.stopPropagation();
      fn(ev);
    }, {capture:true});
    console.log('[nueva] bound', sel);
  });
}

bindClick('#btnAgregarMedicamento', async ()=>{
  if (typeof window.agregarMedicamento === 'function') {
    return window.agregarMedicamento();
  }
  // Fallback mínimo: toma campos típicos y dibuja una lista
  const nombre = document.querySelector('#medNombre')?.value?.trim();
  const dosis  = document.querySelector('#medDosis')?.value?.trim();
  const dur    = document.querySelector('#medDuracion')?.value?.trim();
  if (!nombre){ alert('Falta nombre del medicamento'); return; }
  const item = { nombre, dosis: dosis||'—', duracion: dur||'—' };
  const ul = document.querySelector('#listaMeds') || (()=> {
    const u = document.createElement('ul'); u.id='listaMeds';
    (document.querySelector('#medsBox')||document.body).appendChild(u);
    return u;
  })();
  const li = document.createElement('li');
  li.textContent = `${item.nombre} — ${item.dosis} — ${item.duracion}`;
  ul.appendChild(li);
  // guarda en window para luego
  window.__MEDS__ = window.__MEDS__ || [];
  window.__MEDS__.push(item);
});

bindClick('#btnGenerar', async ()=>{
  if (typeof window.generarReceta === 'function') {
    return window.generarReceta();
  }

  // Fallback mínimo para crear la receta y redirigir a ver-receta
  const { auth, db } = await import('/firebase-init.js');
  const { addDoc, collection, serverTimestamp, doc, setDoc } =
    await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');

  const u = auth.currentUser;
  if (!u){ alert('Inicia sesión'); return; }

  const receta = {
    medicoUid: u.uid,
    medicoEmail: u.email || '',
    pacienteNombre: document.querySelector('#pacienteNombre')?.value?.trim() || 'Sin nombre',
    diagnostico: document.querySelector('#diagnostico')?.value?.trim() || '',
    presion: document.querySelector('#presion')?.value?.trim() || '',
    temperatura: document.querySelector('#temperatura')?.value?.trim() || '',
    observaciones: document.querySelector('#observaciones')?.value?.trim() || '',
    timestamp: serverTimestamp()
  };

  const ref = await addDoc(collection(db,'recetas'), receta);

  // subcolección medicamentos (si capturaste con el fallback)
  const meds = Array.isArray(window.__MEDS__) ? window.__MEDS__ : [];
  for (const m of meds) {
    await setDoc(doc(collection(db, 'recetas', ref.id, 'medicamentos')), {
      nombre: m.nombre, dosis: m.dosis, duracion: m.duracion
    });
  }

  alert('Receta creada: ' + ref.id);
  location.href = '/public/ver-receta.html?id=' + ref.id;
});
</script>

</body>
</html>

