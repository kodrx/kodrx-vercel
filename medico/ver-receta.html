<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KodRx | Receta Digital</title>

<style>
/* ===== Layout general ===== */
html, body { height:100%; }
body { min-height:100dvh; display:flex; flex-direction:column; }
.receta-root { flex:1 0 auto; display:flex; flex-direction:column; }
.receta-wrap{
  /* lo que ya tenías */
  flex:1 0 auto;
  max-width:940px;
  margin:16px auto;
  padding:12px;

  /* lo que faltaba → grid de 2 columnas */
  display:grid !important;
  grid-template-columns: minmax(0,1fr) 340px;
  gap:16px;
  align-items:start;
}
/* evita que el contenido rompa el grid */
.col-left, .col-right{ min-width:0; }
/* Header */
.receta-header{grid-column:1/-1;background:#F0F5FF;color:#0b1b2b;padding:14px 16px;border-radius:12px;font-weight:700}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;margin-left:8px}
.badge.ok{background:#e7f6e8;color:#0b8b2b}
.badge.warn{background:#fff3cd;color:#7a5a00}

/* Acciones */
.actions{grid-column:1/-1;display:flex;gap:12px;padding:8px 0;flex-wrap:wrap}
button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.primary{background:#0b5bd3;color:#fff}
.ghost{background:#eef2ff;color:#0b1b2b;border:1px solid #dbe3ff}

/* Cards / contenido */
.card{background:#f8fafc;border:1px solid #e0e7f0;border-radius:14px;padding:12px}
.card .title{color:#6b7280;font-weight:800;letter-spacing:.02em;margin:2px 0 8px;text-transform:uppercase}
.kv{color:#111827;font-size:14px;line-height:1.35}
.kv b{color:#6b7280;margin-right:6px}
.card,.kv,.sub{overflow-wrap:anywhere;word-break:break-word}

/* Columna derecha */
.col-right{display:flex;flex-direction:column;gap:16px}
.meds{white-space:pre-wrap;font-size:14px;line-height:1.35;color:#111827}

/* QRs */
.qr-frame{border:2px solid #0b5bd3;border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:center;background:#fff}
.qr-legend{color:#0b5bd3;font-weight:700;font-size:12px;text-align:center;margin-top:6px}
.qr-main img{width:220px;height:220px}
.qr-chain img{width:110px;height:110px}

/* Código de barras (pantalla) */
#panelBarcode canvas{max-width:100%}

/* Hash + footer */
.hash{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;color:#374151;font-size:12px}
 .footer{
  /* si el padre es grid, ocupa todo; si no, también :) */
  grid-column: 1 / -1;

  background:#0b5bd3;
  color:#fff;
  border-radius:12px;
  padding:12px 16px;
  text-align:center;
  font-weight:700;

  /* claves para que quede pegado abajo en layout flex-col */
  margin-top:auto;
  display:block;
  width:100%;
  align-self:stretch;
}
.qr-frame.qr-main  { width:260px; height:260px; }
  .qr-frame.qr-chain { width:220px; height:220px; }
  #barcodeCanvas     { width:300px; height:80px; display:block; }
/* Responsive */
@media (max-width:920px){
  .receta-wrap{ grid-template-columns:1fr; }
  .qr-main img{width:200px;height:200px}
  .qr-chain img{width:100px;height:100px}
}
@media (max-width:520px){
  .qr-main img{width:180px;height:180px}
  .qr-chain img{width:90px;height:90px}
}

/* En impresión ocultamos botones; preferimos imprimir el PDF generado */
@media print{ .actions{display:none!important} }
</style>
</head>


<body>
  <div class="receta-root"><!-- wrapper para sticky footer -->

    <div class="receta-wrap"><!-- ÚNICO grid de 2 columnas -->

      <!-- Acciones (ocupa ambas columnas) -->
     <section class="card actions" style="gap:8px; padding:12px">
  <button id="btnVolver" type="button" class="btn">Regresar</button>
  <button id="btnDescargar" type="button" class="btn">Descargar PDF</button>
  <button id="btnImprimir"  type="button" class="btn">Imprimir</button>
</section>
      <!-- Header (ocupa ambas columnas) -->
      <div class="receta-header">
        KodRx — Receta médica digital
        <span id="badgeOrigen" class="badge warn">MOCK</span>
      </div>


      <!-- Columna IZQUIERDA -->
      <div class="col-left" style="display:flex;flex-direction:column;gap:16px">
        <section class="card">
          <div class="title">MÉDICO</div>
          <div class="kv" id="doctorNombre">—</div>
          <div class="kv"><b>Cédula:</b> <span id="doctorCedula">—</span> &nbsp;&nbsp; <b>Especialidad:</b> <span id="doctorEsp">—</span></div>
          <div class="kv"><b>Tel:</b> <span id="doctorTel">—</span></div>
          <div class="kv"><b>Dirección:</b> <span id="doctorDir">—</span></div>
        </section>

        <section class="card">
          <div class="title">PACIENTE</div>
          <div class="kv" id="pacienteNombre">—</div>
          <div class="kv sub" style="margin-top:6px">
            <span id="fechaEmision">—</span> &nbsp;&nbsp; <span id="recetaId">ID: —</span>
          </div>
          <div class="kv" style="margin-top:8px">
            <b>Edad:</b> <span id="pacEdad">—</span> &nbsp;&nbsp; <b>Sexo:</b> <span id="pacSexo">—</span>
          </div>
          <div class="kv"><b>Peso:</b> <span id="pacPeso">—</span> &nbsp;&nbsp; <b>Talla:</b> <span id="pacTalla">—</span></div>
          <div class="kv"><b>Temp:</b> <span id="pacTemp">—</span> &nbsp;&nbsp; <b>PA:</b> <span id="pacPresion">—</span></div>
          <div class="kv"><b>IMC:</b> <span id="pacIMC">—</span></div>
        </section>

        <section class="card">
          <div class="title">OBSERVACIONES</div>
          <div class="kv" id="obsTexto">—</div>
        </section>

        <section class="card">
          <div class="title">DIAGNÓSTICO</div>
          <div class="kv" id="diagTexto">—</div>
        </section>
      </div><!-- /.col-left -->

      <!-- Columna DERECHA -->
      <div class="col-right">
        <section class="card">
          <div class="title">MEDICAMENTOS</div>
          <pre class="meds" id="listaMedsDerecha">—</pre>
        </section>

        <section class="card" style="text-align:center">
          <div class="qr-frame qr-main"><div id="qrMain"></div></div>
          <div class="qr-legend">Receta</div>
        </section>

        <section class="card" id="panelBarcode">
          <div class="title">CÓDIGO DE BARRAS (ID)</div>
          <div style="display:flex;justify-content:center">
            <canvas id="barcodeCanvas" width="300" height="80"></canvas>
          </div>
          <div class="sub" style="text-align:center;margin-top:4px">
            <span id="barcodeLabel">—</span>
          </div>
        </section>

        <section class="card">
          <div class="title">HASH</div>
          <div class="hash" id="hashTexto">hash: —</div>
        </section>

        <section class="card" style="text-align:center">
          <div class="qr-frame qr-chain"><div id="qrChain"></div></div>
          <div class="qr-legend">
            Blockchain<br>
            <span id="blockNum" style="color:#111827;font-weight:800"></span><br>
            <span class="sub" style="color:#6b7280;font-weight:400">Para consultar bloque visitar kodrx.app</span>
          </div>
        </section>
      </div><!-- /.col-right -->
    </div><!-- /.receta-wrap -->

    <!-- Pill de estado (lo ocultamos desde JS al terminar verificación) -->
    <p id="bcStatus" class="pill" style="display:none;">Verificando blockchain…</p>

    <!-- Footer -->
    <div class="footer">
      Creada con KodRx. Plataforma digital de recetas verificadas con trazabilidad tecnológica.
    </div>
  </div><!-- /.receta-root -->

</body>
</html>



<!-- jsPDF (UMD) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
;(() => {
  'use strict';
  if (window.__KODRX_VER_INLINE_V7__) return;
  window.__KODRX_VER_INLINE_V7__ = true;

  /* ===== utils ===== */
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  const setText = (selOrEl, val)=>{
    const el = typeof selOrEl==='string' ? document.querySelector(selOrEl) : selOrEl;
    if (!el) return;
    const txt = (val ?? '—').toString();
    if (el.textContent !== txt) el.textContent = txt;
  };
  const setClass = (el, cls)=>{ if (el && el.className !== cls) el.className = cls; };
  function normalize(raw0){
    const raw = raw0 || {};
    const bc  = raw.blockchain || {};
    const blk = (Number.isFinite(raw.bloque) && raw.bloque>0) ? raw.bloque : (bc.block ?? null);
    const hash= bc.hash ?? raw.hash ?? null;
    const status = bc.status || (blk ? 'ok' : (hash ? 'simulado' : 'pendiente'));
    const nombrePaciente = raw.nombrePaciente ?? raw.pacienteNombre ?? raw.paciente ?? '—';
    return {
      ...raw,
      nombrePaciente,
      bloque: blk,
      hash,
      medsSig: bc.medsSig ?? raw.medsSig ?? '',
      blockchain: { ...bc, status, block: bc.block ?? blk, hash }
    };
  }
  function prefixMed(nombre, genero){
    if (!nombre) return '—';
    const g=(genero||'').toLowerCase();
    return (g.startsWith('f')?'Dra. ':'Dr. ')+nombre;
  }
async function ensureLibs(){
  const jobs = [];
  if (!window.QRCode){
    jobs.push(new Promise((res,rej)=>{ const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';
      s.onload=res; s.onerror=rej; document.head.appendChild(s); }));
  }
  if (!window.JsBarcode){
    jobs.push(new Promise((res,rej)=>{ const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js';
      s.onload=res; s.onerror=rej; document.head.appendChild(s); }));
  }
  if (jobs.length) await Promise.allSettled(jobs);
}
  function qrDivToDataURL(div){
    if (!div) return '';
    const img=div.querySelector('img'); if (img?.src) return img.src;
    const c=div.querySelector('canvas'); return c ? c.toDataURL('image/png') : '';
  }
  async function hydrateIfNeeded(){
    if (window.RECETA_ACTUAL && (window.RECETA_ACTUAL.blockchain || window.RECETA_ACTUAL.hash || window.RECETA_ACTUAL.bloque)) return;
    try{
      const id = new URLSearchParams(location.search).get('id');
      if (!id) return;
      const core = await import('/firebase-init.js');
      const fs   = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
      const snap = await fs.getDoc(fs.doc(core.db,'recetas',id));
      if (snap.exists()) window.RECETA_ACTUAL = { id:snap.id, ...(window.RECETA_ACTUAL||{}), ...(snap.data()||{}) };
    }catch(e){ console.warn('[ver] hydrate warn', e); }
  }

  /* ===== badge ===== */
  function computeBadge(r){
    const bc=r.blockchain||{};
    const hasBlock = Number.isFinite(r.bloque) || typeof r.bloque==='string' ||
                     Number.isFinite(bc.block) || typeof bc.block==='string' || typeof bc.tx==='string';
    if (bc.status==='ok' || hasBlock) return {text:'SELLADO EN BLOCKCHAIN', cls:'badge ok', bg:'#16a34a', fg:'#fff'};
    if (bc.status==='simulado' || r.hash) return {text:'SELLADO SIMULADO', cls:'badge warn', bg:'#f59e0b', fg:'#111'};
    return {text:'PENDIENTE', cls:'badge warn', bg:'#9ca3af', fg:'#111'};
  }
  function paintBadge(r){
    const el=document.getElementById('badgeOrigen'); if(!el) return;
    const st=computeBadge(r);
    setText(el, st.text); setClass(el, st.cls);
    el.style.background=st.bg; el.style.color=st.fg;
  }

  /* ===== render ===== */
  async function renderOnce(){
    for (let i=0;i<100;i++){ if (window.RECETA_ACTUAL) break; await sleep(80); }
    await hydrateIfNeeded();
    const r0 = window.RECETA_ACTUAL; if (!r0) return;
    const r  = window.RECETA_ACTUAL = normalize(r0);

    // fecha / id
    const ts = r?.timestamp?.seconds ? new Date(r.timestamp.seconds*1000) :
               (r?.timestamp?.toDate ? r.timestamp.toDate() : new Date());
    setText('#fechaEmision', ts.toLocaleString('es-MX'));
    setText('#recetaId',    'ID: ' + (r.id || '—'));

    // médico
    setText('#doctorNombre', prefixMed(r.medicoNombre, r.medicoGenero||r.genero));
    setText('#doctorCedula', r.medicoCedula || '—');
    setText('#doctorEsp',    r.medicoEspecialidad || 'General');
    setText('#doctorTel',    r.medicoTelefono || '—');
    setText('#doctorDir',    r.medicoDomicilio || '—');

    // paciente
    setText('#pacienteNombre', r.nombrePaciente);
    setText('#pacEdad',        r.edad ?? '—');
    setText('#pacSexo',        r.sexo || '—');
    setText('#pacPeso',        r.peso ?? '—');
    setText('#pacTalla',       r.talla ?? '—');
    setText('#pacTemp',        r.temperatura ?? '—');
    setText('#pacPresion',     r.presion ?? '—');
    setText('#pacIMC',         r.imc ?? '—');

    // diag / obs
    setText('#obsTexto',  r.observaciones || r.nota || '—');
    setText('#diagTexto', r.diagnostico  || r.diagnosis || '—');

    // hash / bloque + badge
    const bloqueTxt = (Number.isFinite(r.bloque)||typeof r.bloque==='string') ? ('#'+r.bloque)
                   : ((r.blockchain?.status==='simulado' || r.hash) ? 'Simulado' : '—');
    setText('#blockNum',  bloqueTxt);
    setText('#hashTexto', 'hash: ' + (r.hash || r.blockchain?.hash || '—'));
    paintBadge(r);

    
    // medicamentos
    if (!Array.isArray(r.medicamentos) || !r.medicamentos.length){
      try{
        const core = await import('/firebase-init.js');
        const fs   = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
        const medsSnap = await fs.getDocs(fs.collection(fs.doc(core.db,'recetas', r.id),'medicamentos'));
        r.medicamentos = medsSnap.docs.map(d=>d.data());
      }catch(e){ console.warn('[ver] meds subcol warn', e); }
    }
    const pre=document.getElementById('listaMedsDerecha');
    if (pre){
      if (!r.medicamentos?.length) setText(pre,'—');
      else {
        const lines=r.medicamentos.map((m,i)=>`${i+1}. ${m?.nombre||'—'}\n   Dosis: ${m?.dosis||'—'}   Duración: ${m?.duracion||'—'}`).join('\n\n');
        setText(pre, lines);
      }
    }

    // libs + QRs/barcode
    await ensureLibs();
    const qrMainDiv  = document.getElementById('qrMain');
    const qrChainDiv = document.getElementById('qrChain');
    const canvas     = document.getElementById('barcodeCanvas');
    const label      = document.getElementById('barcodeLabel');

    // QR principal (ver-receta)
    if (qrMainDiv && !qrMainDiv.querySelector('canvas, img')) {
      const verURL = location.origin + '/public/ver-receta.html?id=' + encodeURIComponent(r.id);
      new QRCode(qrMainDiv, { text: verURL, width: 260, height: 260, correctLevel: QRCode.CorrectLevel.M });
    }
    // QR blockchain → verificador SOLO ?id=<bloque> (fallback hash)
    if (qrChainDiv && !qrChainDiv.querySelector('canvas, img')) {
      const bc  = r.blockchain || {};
      const blk = String(bc.block ?? r.bloque ?? '').trim();
      const h   = String(bc.hash  ?? r.hash  ?? '').trim();
      let verifyURL = '';
      if (blk)      verifyURL = 'https://kodrx-blockchain.onrender.com/verificar.html?id=' + encodeURIComponent(blk);
      else if (h)   verifyURL = 'https://kodrx-blockchain.onrender.com/verificar.html?id=' + encodeURIComponent(h);
      else          qrChainDiv.innerHTML = '<div style="opacity:.6;font:12px system-ui">sin datos</div>';
      if (verifyURL){
        new QRCode(qrChainDiv, { text: verifyURL, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.M });
      }
    }

    // leyenda bajo #blockNum
    {
  const legendHolder = document.querySelector('.qr-legend .sub');
  const text = 'Para consultar bloque visitar kodrx.app';
  if (legendHolder) legendHolder.textContent = text;
  else document.getElementById('blockNum')?.insertAdjacentHTML(
    'afterend','<br><span class="sub" style="color:#6b7280;font-weight:400">'+text+'</span>'
  );
}

    // barcode
    if (canvas && canvas.getContext && !canvas.__done){
      try{ JsBarcode(canvas, r.id, {format:'CODE128', displayValue:false, margin:0, width:2, height:70}); canvas.__done=true; }catch(e){}
    }
    if (label) setText(label, r.id || '—');

    // export QRS → PDF
    const qrMainData  = qrDivToDataURL(qrMainDiv);
    const qrChainData = qrDivToDataURL(qrChainDiv);
    const barcodeData = (()=>{
      try{ return canvas ? canvas.toDataURL('image/png') : ''; }catch{ return ''; }
    })();
window.QRS = {
  get qrMain(){  return (function(d){ if(!d) return ''; const i=d.querySelector('img'); if(i?.src) return i.src; const c=d.querySelector('canvas'); return c?c.toDataURL('image/png'):''; })(document.getElementById('qrMain')); },
  get qrChain(){ return (function(d){ if(!d) return ''; const i=d.querySelector('img'); if(i?.src) return i.src; const c=d.querySelector('canvas'); return c?c.toDataURL('image/png'):''; })(document.getElementById('qrChain')); },
  get barcode(){ try{ const c=document.getElementById('barcodeCanvas'); return c?c.toDataURL('image/png'):''; }catch{return ''} }
};

    // apaga spinners “verificando…”
    ['#badgeVerificando','#spinnerVerificando','#panelVerificando','[data-role="verificando"]','.verificando','.spinner-verify']
      .forEach(sel => document.querySelectorAll(sel).forEach(el => el.style.display='none'));

    console.log('[ver] render ok');
  }

  /* ===== PDF ===== */
 function prefixMedico(nombre,genero){
    if(!nombre) return '—';
    const g=(genero||'').toLowerCase();
    return (g.startsWith('f')?'Dra. ':'Dr. ')+nombre;
  }
  function hashSimulado(receta){
    try{
      const base = JSON.stringify({id:receta?.id, meds:receta?.medicamentos||[], t:receta?.timestamp||null});
      let h=0; for(let i=0;i<base.length;i++){ h=(h*31+base.charCodeAt(i))>>>0; }
      return ('00000000'+h.toString(16)).slice(-8)+'-'+btoa(unescape(encodeURIComponent(receta?.id||''))).replace(/=+$/,'');
    }catch{ return '—'; }
  }
  async function ensureJsBarcode(){
    if (window.JsBarcode) return;
    await new Promise((res,rej)=>{
      const s=document.createElement('script');
      s.src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js";
      s.onload=res; s.onerror=rej; document.head.appendChild(s);
    });
  }

  // Adaptador: mapea tu receta "actual" a la estructura legacy que esperaba tu generador antiguo
  function adaptLegacy(receta){
    const r = receta || {};
    const medico = {
      nombre: r.medicoNombre || '—',
      genero: r.medicoGenero || r.genero || '',
      cedula: r.medicoCedula || '—',
      especialidad: r.medicoEspecialidad || 'General',
      telefono: r.medicoTelefono || '',
      direccion: r.medicoDomicilio || ''
    };
    const paciente = {
      nombre: r.nombrePaciente || r.pacienteNombre || r.paciente || '—',
      edad:   r.edad ?? '—',
      sexo:   r.sexo || '—',
      peso:   r.peso ?? '—',
      talla:  r.talla ?? '—',
      temperatura: r.temperatura ?? '—',
      presion:     r.presion ?? '—',
      imc:         r.imc ?? '—'
    };
    const blockchain = r.blockchain || {};
    return {
      ...r,
      medico, paciente,
      hash: r.hash || blockchain.hash || null,
      bloque: (blockchain.block ?? r.bloque ?? null),
    };
  }

  // Generador "legacy" con paneles/columnas. Usa QRs desde el DOM (ya renderizados en la vista)
  window.generarPDF = async function generarPDF(recetaIn, qrsIn, {mode='save'}={}){
    // Cargar jsPDF si hace falta
    const jsPDF = await (async ()=>{
      if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
      await new Promise((res,rej)=>{ const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
        s.onload=res; s.onerror=rej; document.head.appendChild(s); });
      return window.jspdf?.jsPDF;
    })();
    if (!jsPDF){ alert('No se pudo cargar jsPDF'); return; }

    // Adaptar receta y QRs
    const receta = adaptLegacy(recetaIn);
    const qrs = {
      mainQRUrl : qrsIn?.mainQRUrl || qrsIn?.qrMain  || (window.QRS?.qrMain  || ''),
      chainQRUrl: qrsIn?.chainQRUrl|| qrsIn?.qrChain || (window.QRS?.qrChain || '')
    };

    const { jsPDF:Cls } = window.jspdf;
    const doc = new Cls({ unit:'pt', format:'letter', compress:true }); // 612 x 792
    const W = doc.internal.pageSize.getWidth(), H = doc.internal.pageSize.getHeight();

    // Geometría y estilo
    const Mx=40, gutter=16, CW=W-2*Mx, colW=(CW-gutter)/2, leftX=Mx, rightX=Mx+colW+gutter;
    const footerH=52, My=50, availYMax=H-My-footerH-10;

    const COLORS={panelFill:[248,250,252],panelStroke:[224,231,240],text:[17,24,39],sub:[55,65,81],label:[107,114,128],brand:[11,91,211]};
    const FONT='helvetica'; doc.setFont(FONT,'normal');

    // Utils de layout
    function header(){
      const headY=18, headH=50;
      doc.setFillColor(240,245,255); doc.roundedRect(18,headY,W-36,headH,9,9,'F');
      doc.setTextColor(11,27,43); doc.setFont(FONT,'bold'); doc.setFontSize(13);
      doc.text('KodRx — Receta médica digital', Mx, headY+30);
      doc.setFont(FONT,'normal'); return headY+headH+12;
    }
    function footer(){
      doc.setFillColor(...COLORS.brand); doc.rect(18,H-18-footerH,W-36,footerH,'F');
      doc.setTextColor(255,255,255); doc.setFont(FONT,'bold'); doc.setFontSize(10.5);
      doc.text('Creada con KodRx. Tecnología que verifica, salud que protege.', W/2, H-22, {align:'center'});
    }
    function wrap(txt,w){ return doc.splitTextToSize(String(txt??'—'),w); }
    function sectionBox(x,y,w,contentH,title){
      const padX=10,padY=10,titleH=18,boxH=contentH+padY*2+titleH;
      const yClamped=Math.min(y, availYMax - boxH);
      doc.setFillColor(...COLORS.panelFill); doc.setDrawColor(...COLORS.panelStroke); doc.setLineWidth(0.8);
      doc.roundedRect(x,yClamped,w,boxH,8,8,'FD');
      doc.setTextColor(...COLORS.label); doc.setFont(FONT,'bold'); doc.setFontSize(10);
      doc.text(title,x+padX,yClamped+14);
      doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.text);
      return {cx:x+padX, cy:yClamped+14+padY, ny:yClamped+boxH+10, innerH:contentH};
    }
    function drawClamp(x,y,maxW,maxH,text,lineH=11){
      const lines=wrap(text,maxW); let used=0,lastY=y;
      for(let i=0;i<lines.length;i++){
        if(used+lineH>maxH){
          if(i>0){const prev=lines[i-1];
            doc.text(prev.length>1?prev.slice(0,prev.length-1)+'…':prev+'…',x,lastY);
          }
          return;
        }
        lastY=y+used+lineH; doc.text(lines[i],x,lastY); used+=lineH;
      }
    }
    function fechaStr(ts){
      try{
        if(ts&&typeof ts.toDate==='function') ts=ts.toDate();
        else if(ts&&typeof ts.seconds==='number') ts=new Date(ts.seconds*1000+Math.floor((ts.nanoseconds||0)/1e6));
        else if(!(ts instanceof Date)) ts=new Date(ts);
        return ts.toLocaleString('es-MX',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
      }catch{ return ''; }
    }
    function medsText(meds){ if(!Array.isArray(meds)||!meds.length) return '—';
      return meds.map((m,i)=>`${i+1}. ${m.nombre}\n   Dosis: ${m.dosis}\n   Duración: ${m.duracion}`).join('\n\n'); }
    function blockNumber(r){
      if (r?.bloque!=null) return String(r.bloque);
      if (r?.blockchain?.block!=null) return String(r.blockchain.block);
      try{const u=new URL(r.urlBlockchain); return u.searchParams.get('id')||u.searchParams.get('block')||'—';}catch{return '—';}
    }

    const startY=header(); let yL=startY,yR=startY;

    // MÉDICO
    { const Hfixed=90; const s=sectionBox(leftX,yL,colW,Hfixed,'MÉDICO');
      doc.setFont(FONT,'bold'); doc.setFontSize(11.5);
      const nom=receta.medico?.nombre?prefixMedico(receta.medico.nombre,receta.medico.genero):'—';
      drawClamp(s.cx,s.cy,colW-16,26,nom,13);
      let cy=s.cy+26+6; doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.sub);
      const info=`Cédula: ${receta.medico?.cedula||'—'}    Especialidad: ${receta.medico?.especialidad||'—'}\nTel: ${receta.medico?.telefono||'—'}\nDirección: ${receta.medico?.direccion||'—'}`;
      drawClamp(s.cx,cy,colW-16,Hfixed-(cy-s.cy),info,13); yL=s.ny; }

    // PACIENTE
    { const Hfixed=100; const s=sectionBox(leftX,yL,colW,Hfixed,'PACIENTE');
      doc.setFont(FONT,'bold'); doc.setFontSize(11.5);
      drawClamp(s.cx,s.cy,colW-16,26,String(receta.paciente?.nombre||'—'),13);
      let cy=s.cy+26+6; doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.sub);
      doc.text(fechaStr(receta.timestamp), s.cx, cy); cy+=13; doc.text(`ID: ${receta.id||'—'}`, s.cx, cy); cy+=16;
      const lv=(x,y,lbl,val)=>{doc.setFont(FONT,'bold');doc.setTextColor(...COLORS.sub);doc.text(lbl,x,y);
        const w=doc.getTextWidth(lbl); doc.setFont(FONT,'normal');doc.setTextColor(...COLORS.text);doc.text(String(val??'—'),x+w+4,y);};
      lv(s.cx,cy,'Edad:',receta.paciente?.edad); lv(s.cx+120,cy,'Sexo:',receta.paciente?.sexo); cy+=13;
      lv(s.cx,cy,'Peso:',receta.paciente?.peso); lv(s.cx+120,cy,'Talla:',receta.paciente?.talla); cy+=13;
      lv(s.cx,cy,'Temp:',receta.paciente?.temperatura); lv(s.cx+120,cy,'PA:',receta.paciente?.presion); cy+=13;
      lv(s.cx,cy,'IMC:',receta.paciente?.imc); yL=s.ny; }

    // OBS + DIAG con separador
    { const lineH=11, SEP=35, MIN_OBS=60, MIN_DX=60;
      const leftSpace = Math.max(0, availYMax - yL);
      const obsWrapped = doc.splitTextToSize(String(receta.observaciones??'—'), colW-16);
      const idealObsH = Math.max(MIN_OBS, obsWrapped.length*lineH + 6);
      const obsMaxH   = Math.max(MIN_OBS, leftSpace - (SEP + MIN_DX));
      const obsH      = Math.min(idealObsH, obsMaxH);

      const sObs=sectionBox(leftX,yL,colW,obsH,'OBSERVACIONES');
      doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(17,24,39);
      drawClamp(sObs.cx,sObs.cy,colW-16,sObs.innerH,receta.observaciones,lineH);

      const gapY=sObs.ny-2, midY=gapY+SEP/2;
      doc.setFillColor(255,255,255); doc.setDrawColor(255,255,255); doc.rect(leftX,gapY,colW,SEP,'F');
      doc.setDrawColor(224,231,240); doc.setLineWidth(0.8); doc.line(leftX+6,midY,leftX+colW-6,midY);
      yL=gapY+SEP+6;

      const dxH=Math.max(MIN_DX, availYMax - yL);
      const sDx=sectionBox(leftX,yL,colW,dxH,'DIAGNÓSTICO');
      drawClamp(sDx.cx,sDx.cy,colW-16,sDx.innerH,receta.diagnostico,lineH);
      yL=sDx.ny; }

    // DERECHA: MEDICAMENTOS
    { const lineH=11; const medsTxt=medsText(receta.medicamentos);
      const tmp=wrap(medsTxt,colW-16); const need=Math.max(90,tmp.length*lineH+6);
      const s=sectionBox(rightX,yR,colW,need,'MEDICAMENTOS');
      drawClamp(s.cx,s.cy,colW-16,s.innerH,medsTxt,lineH); yR=s.ny; }

    // QR receta (en tarjeta centrada, tamaño fijo para no “saltar”)
    { const box=120,pad=10; let y=yR; const yMax=availYMax-(box+20);
      y=Math.min(Math.max(y,startY),yMax);
      const xQR=rightX+(colW-box)/2;
      if (qrs.mainQRUrl){
        doc.setDrawColor(...COLORS.brand); doc.setLineWidth(2.2); doc.roundedRect(xQR,y,box,box,10,10,'S');
        doc.addImage(qrs.mainQRUrl,'PNG',xQR+pad,y+pad,box-2*pad,box-2*pad,undefined,'FAST');
        doc.setTextColor(...COLORS.brand); doc.setFont(FONT,'bold'); doc.setFontSize(9.5);
        doc.text('Receta', xQR+box/2, y+box+12, {align:'center'});
        yR=y+box+20;
      }
    }

    // Código de barras
    { await ensureJsBarcode();
      const canvas=document.createElement('canvas'); canvas.width=300; canvas.height=40;
      if (receta.id) JsBarcode(canvas, String(receta.id), {format:'CODE128', width:2, height:32, margin:4, displayValue:false});
      const barUrl=canvas.toDataURL('image/png');

      let imgW=Math.min(colW-20,300), imgH=40*(imgW/300);
      let x=rightX+(colW-imgW)/2; let y=yR+6; let boxH=imgH+26;
      for(const f of [0.95,0.9,0.85]){ if(y+boxH<=availYMax) break; imgW*=f; imgH*=f; boxH=imgH+26; x=rightX+(colW-imgW)/2; }
      if(y+boxH<=availYMax){
        doc.setFillColor(248,250,252); doc.setDrawColor(224,231,240); doc.setLineWidth(0.8);
        doc.roundedRect(rightX,y,colW,boxH,8,8,'FD');
        doc.addImage(barUrl,'PNG',x,y+8,imgW,imgH,undefined,'FAST');
        doc.setFont(FONT,'bold'); doc.setFontSize(9); doc.setTextColor(55,65,81);
        doc.text('Código de barras (ID)', rightX+colW/2, y+imgH+20, {align:'center'});
        yR=y+boxH+10;
      }
    }

    // HASH (si hay real, lo muestra; si no, simulado – siempre sin desborde)
    { 
      const s = sectionBox(rightX, yR, colW, 50, 'HASH');
      doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.sub);

      const hashLabel = receta.hash
        ? `hash (BC): ${receta.hash}`             // real de blockchain
        : `hash (local): ${hashSimulado(receta)}`; // fallback visual

      drawClamp(s.cx, s.cy, colW-16, s.innerH, hashLabel, 11);
      yR = s.ny;
    }

    // QR blockchain + bloque (con leyenda correcta). Tamaño “mini” para NO desbordar.
    { const mini=90, rectW=mini,rectH=mini; const qrX=rightX+colW-rectW;
      let qrY=Math.max(yL,yR)+6; if(qrY+rectH+38>availYMax) qrY=availYMax-rectH-38;
      if (qrs.chainQRUrl){
        doc.setDrawColor(...COLORS.brand); doc.setLineWidth(2.0); doc.roundedRect(qrX,qrY,rectW,rectH,8,8,'S');
        doc.addImage(qrs.chainQRUrl,'PNG',qrX+8,qrY+8,rectW-16,rectH-16,undefined,'FAST');
        doc.setTextColor(...COLORS.brand); doc.setFont(FONT,'bold'); doc.setFontSize(9);
        doc.text('Blockchain', qrX+rectW/2, qrY+rectH+12, {align:'center'});
        const bn = blockNumber(receta);
        doc.setTextColor(...COLORS.text); doc.setFont(FONT,'bold'); doc.setFontSize(10);
        doc.text('Bloque: '+(bn||'—'), qrX+rectW/2, qrY+rectH+26, {align:'center'});
        doc.setTextColor(...COLORS.sub); doc.setFont(FONT,'normal'); doc.setFontSize(8.5);
        doc.text('Para consultar bloque visitar kodrx.app', qrX+rectW/2, qrY+rectH+38, {align:'center'});
      }
    }

    // Footer final
    footer();

    const filename = `receta_${receta.id||''}.pdf`;
    if (mode==='print'){
      try{ doc.autoPrint(); doc.output('dataurlnewwindow'); } catch { doc.save(filename); }
    } else if (mode==='open'){
      const url = doc.output('bloburl'); window.open(url,'_blank');
    } else {
      doc.save(filename);
    }
  };

  /* ===== bind botones ===== */
  function bindButtons(){
    const btnD = document.getElementById('btnDescargar');
    const btnP = document.getElementById('btnImprimir');
    const btnB = document.getElementById('btnVolver');

    const onPDF = (mode)=>async (ev)=>{
      ev.preventDefault();
      const b=ev.currentTarget; if (b.__busy) return; b.__busy=true; b.disabled=true;
      try{
        if (!window.RECETA_ACTUAL) await renderOnce();
        await window.generarPDF(window.RECETA_ACTUAL, window.QRS||{}, mode?{mode}:{});
      }catch(e){ console.error('[ver] PDF error', e); alert('No se pudo generar el PDF.'); }
      finally{ b.__busy=false; b.disabled=false; }
    };

    if (btnD && !btnD.__b){ btnD.type='button'; btnD.addEventListener('click', onPDF(null), {capture:true}); btnD.__b=true; }
    if (btnP && !btnP.__b){ btnP.type='button'; btnP.addEventListener('click', onPDF('print'), {capture:true}); btnP.__b=true; }
    if (btnB && !btnB.__b){
      btnB.type='button';
      btnB.addEventListener('click', (e)=>{ e.preventDefault(); if (history.length>1) history.back(); else location.href='/medico/panel.html'; }, {capture:true});
      btnB.__b=true;
    }
  }

  /* ===== start ===== */
  if (document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', ()=>{ renderOnce().catch(console.warn); bindButtons(); }, {once:true});
  } else {
    renderOnce().catch(console.warn); bindButtons();
  }
})();
</script>


<script>
(() => {
  function hideVerify(){
    const sels = [
      '#badgeVerificando','#spinnerVerificando','#panelVerificando',
      '[data-role="verificando"]','.verificando','.spinner-verify',
      '.spinner','.loading','#loading'
    ];
    // Oculta por selectores comunes
    for (const sel of sels) {
      document.querySelectorAll(sel).forEach(el=>{
        if (/verific/i.test((el.id||'')+' '+(el.className||'')+' '+(el.textContent||''))) {
          el.style.display='none';
        }
      });
    }
    // Además, cualquier nodo de texto suelto que contenga “verific”
    document.querySelectorAll('body *').forEach(el=>{
      if (el.childElementCount===0 && /verific/i.test(el.textContent||'')) {
        el.style.display='none';
      }
    });
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', hideVerify, {once:true});
  else hideVerify();
  window.kodrxHideVerify = hideVerify; // por si lo quieres invocar manual
})();
</script>

</body>
</html>


