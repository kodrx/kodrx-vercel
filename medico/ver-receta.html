<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KodRx | Receta Digital</title>

<style>
/* ===== Layout general ===== */
body{margin:0;background:#ffffff;color:#0f172a;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
.receta-wrap{max-width:940px;margin:16px auto;padding:12px}
.receta{display:grid;grid-template-columns:1fr 340px;gap:16px;align-items:start}

/* Header */
.receta-header{grid-column:1/-1;background:#F0F5FF;color:#0b1b2b;padding:14px 16px;border-radius:12px;font-weight:700}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;margin-left:8px}
.badge.ok{background:#e7f6e8;color:#0b8b2b}
.badge.warn{background:#fff3cd;color:#7a5a00}

/* Acciones */
.actions{grid-column:1/-1;display:flex;gap:12px;padding:8px 0;flex-wrap:wrap}
button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.primary{background:#0b5bd3;color:#fff}
.ghost{background:#eef2ff;color:#0b1b2b;border:1px solid #dbe3ff}

/* Cards / contenido */
.card{background:#f8fafc;border:1px solid #e0e7f0;border-radius:14px;padding:12px}
.card .title{color:#6b7280;font-weight:800;letter-spacing:.02em;margin:2px 0 8px;text-transform:uppercase}
.kv{color:#111827;font-size:14px;line-height:1.35}
.kv b{color:#6b7280;margin-right:6px}
.card,.kv,.sub{overflow-wrap:anywhere;word-break:break-word}

/* Columna derecha */
.col-right{display:flex;flex-direction:column;gap:16px}
.meds{white-space:pre-wrap;font-size:14px;line-height:1.35;color:#111827}

/* QRs */
.qr-frame{border:2px solid #0b5bd3;border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:center;background:#fff}
.qr-legend{color:#0b5bd3;font-weight:700;font-size:12px;text-align:center;margin-top:6px}
.qr-main img{width:220px;height:220px}
.qr-chain img{width:110px;height:110px}

/* Código de barras (pantalla) */
#panelBarcode canvas{max-width:100%}

/* Hash + footer */
.hash{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;color:#374151;font-size:12px}
.footer{grid-column:1/-1;background:#0b5bd3;color:#fff;border-radius:12px;padding:12px 16px;text-align:center;font-weight:700;margin-top:6px}

/* Responsive */
@media (max-width:920px){
  .receta{grid-template-columns:1fr}
  .qr-main img{width:200px;height:200px}
  .qr-chain img{width:100px;height:100px}
}
@media (max-width:520px){
  .qr-main img{width:180px;height:180px}
  .qr-chain img{width:90px;height:90px}
}

/* En impresión ocultamos botones; preferimos imprimir el PDF generado */
@media print{ .actions{display:none!important} }
</style>
</head>
<body>

<div class="receta-wrap">
<section class="card" style="text-align:center; gap:8px; padding:12px">
  <button id="btnVolver" type="button" class="btn">Regresar</button>
  <button id="btnDescargar" type="button" class="btn">Descargar PDF</button>
  <button id="btnImprimir"  type="button" class="btn">Imprimir</button>
</section>


  <div class="receta">
    <!-- Header -->
    <div class="receta-header">
      KodRx — Receta médica digital
      <span id="badgeOrigen" class="badge warn">MOCK</span>
    </div>


    <!-- Columna IZQUIERDA -->
    <div class="col-left" style="display:flex;flex-direction:column;gap:16px">
      <section class="card">
        <div class="title">MÉDICO</div>
        <div class="kv" id="doctorNombre">—</div>
        <div class="kv"><b>Cédula:</b> <span id="doctorCedula">—</span> &nbsp;&nbsp; <b>Especialidad:</b> <span id="doctorEsp">—</span></div>
        <div class="kv"><b>Tel:</b> <span id="doctorTel">—</span></div>
        <div class="kv"><b>Dirección:</b> <span id="doctorDir">—</span></div>
      </section>

      <section class="card">
        <div class="title">PACIENTE</div>
        <div class="kv" id="pacienteNombre">—</div>
        <div class="kv sub" style="margin-top:6px">
          <span id="fechaEmision">—</span> &nbsp;&nbsp; <span id="recetaId">ID: —</span>
        </div>
        <div class="kv" style="margin-top:8px">
          <b>Edad:</b> <span id="pacEdad">—</span> &nbsp;&nbsp; <b>Sexo:</b> <span id="pacSexo">—</span>
        </div>
        <div class="kv"><b>Peso:</b> <span id="pacPeso">—</span> &nbsp;&nbsp; <b>Talla:</b> <span id="pacTalla">—</span></div>
        <div class="kv"><b>Temp:</b> <span id="pacTemp">—</span> &nbsp;&nbsp; <b>PA:</b> <span id="pacPresion">—</span></div>
        <div class="kv"><b>IMC:</b> <span id="pacIMC">—</span></div>
      </section>

      <section class="card">
        <div class="title">OBSERVACIONES</div>
        <div class="kv" id="obsTexto">—</div>
      </section>

      <section class="card">
        <div class="title">DIAGNÓSTICO</div>
        <div class="kv" id="diagTexto">—</div>
      </section>
    </div>

    <!-- Columna DERECHA -->
    <div class="col-right">
      <section class="card">
        <div class="title">MEDICAMENTOS</div>
        <pre class="meds" id="listaMedsDerecha">—</pre>
      </section>

      <section class="card" style="text-align:center">
        <div class="qr-frame qr-main"><div id="qrMain"></div></div>
        <div class="qr-legend">Receta</div>
      </section>

      <section class="card" id="panelBarcode">
        <div class="title">CÓDIGO DE BARRAS (ID)</div>
        <div style="display:flex;justify-content:center">
          <canvas id="barcodeCanvas" width="300" height="80"></canvas>
        </div>
        <div class="sub" style="text-align:center;margin-top:4px"><span id="barcodeLabel">—</span></div>
      </section>

      <section class="card">
        <div class="title">HASH</div>
        <div class="hash" id="hashTexto">hash: —</div>
      </section>

      <section class="card" style="text-align:center">
        <div class="qr-frame qr-chain"><div id="qrChain"></div></div>
        <div class="qr-legend">
          Blockchain<br>
          <span id="blockNum" style="color:#111827;font-weight:800"></span><br>
          <span class="sub" style="color:#6b7280;font-weight:400">Para verificar receta visitar kodrx.app</span>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <div class="footer">Creada con KodRx. Plataforma digital de recetas verificadas con trazabilidad tecnológica.</div>
    <p id="bcStatus" class="pill" style="display:inline-block;">Verificando blockchain…</p>
  </div>
</div>

<!-- jsPDF (UMD) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>

;(() => {
  'use strict';
  if (window.__KODRX_VER_INLINE_V6__) return;
  window.__KODRX_VER_INLINE_V6__ = true;

  // -------- utils --------
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  const setText = (selOrEl, val)=>{
    const el = typeof selOrEl==='string' ? document.querySelector(selOrEl) : selOrEl;
    if (!el) return;
    const txt = (val ?? '—').toString();
    if (el.textContent !== txt) el.textContent = txt;
  };
  const setClass = (el, cls)=>{ if (el && el.className !== cls) el.className = cls; };

  function normalize(raw0){
    const raw = raw0 || {};
    const bc  = raw.blockchain || {};
    const blk = (Number.isFinite(raw.bloque) && raw.bloque>0) ? raw.bloque : (bc.block ?? null);
    const hash= bc.hash ?? raw.hash ?? null;
    const status = bc.status || (blk ? 'ok' : (hash ? 'simulado' : 'pendiente'));
    const nombrePaciente = raw.nombrePaciente ?? raw.pacienteNombre ?? raw.paciente ?? '—';
    return {
      ...raw,
      nombrePaciente,
      bloque: blk,
      hash,
      medsSig: bc.medsSig ?? raw.medsSig ?? '',
      blockchain: { ...bc, status, block: bc.block ?? blk, hash }
    };
  }
  function prefixMed(nombre, genero){
    if (!nombre) return '—';
    const g=(genero||'').toLowerCase();
    return (g.startsWith('f')?'Dra. ':'Dr. ')+nombre;
  }
  async function ensureLibs(){
    if (!window.QRCode){
      await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
    }
    if (!window.JsBarcode){
      await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
    }
  }
  function qrDivToDataURL(div){
    if (!div) return '';
    const img=div.querySelector('img'); if (img?.src) return img.src;
    const c=div.querySelector('canvas'); return c ? c.toDataURL('image/png') : '';
  }
  async function hydrateIfNeeded(){
    if (window.RECETA_ACTUAL && (window.RECETA_ACTUAL.blockchain || window.RECETA_ACTUAL.hash || window.RECETA_ACTUAL.bloque)) return;
    try{
      const id = new URLSearchParams(location.search).get('id');
      if (!id) return;
      const core = await import('/firebase-init.js');
      const fs   = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
      const snap = await fs.getDoc(fs.doc(core.db,'recetas',id));
      if (snap.exists()) window.RECETA_ACTUAL = { id:snap.id, ...(window.RECETA_ACTUAL||{}), ...(snap.data()||{}) };
    }catch(e){ console.warn('[ver] hydrate warn', e); }
  }

  // -------- badge --------
  function computeBadge(r){
    const bc=r.blockchain||{};
    const hasBlock = Number.isFinite(r.bloque) || typeof r.bloque==='string' ||
                     Number.isFinite(bc.block) || typeof bc.block==='string' || typeof bc.tx==='string';
    if (bc.status==='ok' || hasBlock) return {text:'SELLADO EN BLOCKCHAIN', cls:'badge ok', bg:'#16a34a', fg:'#fff'};
    if (bc.status==='simulado' || r.hash) return {text:'SELLADO SIMULADO', cls:'badge warn', bg:'#f59e0b', fg:'#111'};
    return {text:'PENDIENTE', cls:'badge warn', bg:'#9ca3af', fg:'#111'};
  }
  function paintBadge(r){
    const el=document.getElementById('badgeOrigen'); if(!el) return;
    const st=computeBadge(r);
    setText(el, st.text); setClass(el, st.cls);
    el.style.background=st.bg; el.style.color=st.fg;
  }

  // -------- render --------
  async function renderOnce(){
    for (let i=0;i<100;i++){ if (window.RECETA_ACTUAL) break; await sleep(80); }
    await hydrateIfNeeded();
    const r0 = window.RECETA_ACTUAL; if (!r0) return;
    const r  = window.RECETA_ACTUAL = normalize(r0);

    // fecha / id
    const ts = r?.timestamp?.seconds ? new Date(r.timestamp.seconds*1000) :
               (r?.timestamp?.toDate ? r.timestamp.toDate() : new Date());
    setText('#fechaEmision', ts.toLocaleString('es-MX'));
    setText('#recetaId',    'ID: ' + (r.id || '—'));

    // médico
    setText('#doctorNombre', prefixMed(r.medicoNombre, r.medicoGenero||r.genero));
    setText('#doctorCedula', r.medicoCedula || '—');
    setText('#doctorEsp',    r.medicoEspecialidad || 'General');
    setText('#doctorTel',    r.medicoTelefono || '—');
    setText('#doctorDir',    r.medicoDomicilio || '—');

    // paciente
    setText('#pacienteNombre', r.nombrePaciente);
    setText('#pacEdad',        r.edad ?? '—');
    setText('#pacSexo',        r.sexo || '—');
    setText('#pacPeso',        r.peso ?? '—');
    setText('#pacTalla',       r.talla ?? '—');
    setText('#pacTemp',        r.temperatura ?? '—');
    setText('#pacPresion',     r.presion ?? '—');
    setText('#pacIMC',         r.imc ?? '—');

    // diag / obs
    setText('#obsTexto',  r.observaciones || r.nota || '—');
    setText('#diagTexto', r.diagnostico  || r.diagnosis || '—');

    // hash / bloque + badge
    const bloqueTxt = (Number.isFinite(r.bloque)||typeof r.bloque==='string') ? ('#'+r.bloque)
                   : ((r.blockchain?.status==='simulado' || r.hash) ? 'Simulado' : '—');
    setText('#blockNum',  bloqueTxt);
    // Leyenda bajo el número de bloque (vista)
{
  const legendHolder = document.querySelector('.qr-legend .sub');
  const text = 'Para consultar bloque visitar kodrx.app';
  if (legendHolder) {
    legendHolder.textContent = text;
  } else {
    const numEl = document.getElementById('blockNum');
    if (numEl) numEl.insertAdjacentHTML('afterend',
      '<br><span class="sub" id="blockHint" style="color:#6b7280;font-weight:400">' + text + '</span>'
    );
  }
}

    setText('#hashTexto', 'hash: ' + (r.hash || r.blockchain?.hash || '—'));
    paintBadge(r);

    // medicamentos
    if (!Array.isArray(r.medicamentos) || !r.medicamentos.length){
      try{
        const core = await import('/firebase-init.js');
        const fs   = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
        const medsSnap = await fs.getDocs(fs.collection(fs.doc(core.db,'recetas', r.id),'medicamentos'));
        r.medicamentos = medsSnap.docs.map(d=>d.data());
      }catch(e){ console.warn('[ver] meds subcol warn', e); }
    }
    const pre=document.getElementById('listaMedsDerecha');
    if (pre){
      if (!r.medicamentos?.length) setText(pre,'—');
      else {
        const lines=r.medicamentos.map((m,i)=>`${i+1}. ${m?.nombre||'—'}\n   Dosis: ${m?.dosis||'—'}   Duración: ${m?.duracion||'—'}`).join('\n\n');
        setText(pre, lines);
      }
    }

    // libs + QRs/barcode
    await ensureLibs();
    const qrMainDiv  = document.getElementById('qrMain');
    const qrChainDiv = document.getElementById('qrChain');
    const canvas     = document.getElementById('barcodeCanvas');
    const label      = document.getElementById('barcodeLabel');

    // QR principal (ver-receta)
    if (qrMainDiv && !qrMainDiv.querySelector('canvas, img')) {
      const verURL = location.origin + '/public/ver-receta.html?id=' + encodeURIComponent(r.id);
      new QRCode(qrMainDiv, { text: verURL, width: 260, height: 260, correctLevel: QRCode.CorrectLevel.M });
    }
    // QR blockchain → verificador SOLO con ?id=<bloque>; si no hay bloque, intenta con hash
if (qrChainDiv && !qrChainDiv.querySelector('canvas, img')) {
  const bc  = r.blockchain || {};
  const blk = String(bc.block ?? r.bloque ?? '').trim();
  const h   = String(bc.hash  ?? r.hash  ?? '').trim();

  let verifyURL = '';
  if (blk) {
    verifyURL = 'https://kodrx-blockchain.onrender.com/verificar.html?id=' + encodeURIComponent(blk);
  } else if (h) {
    verifyURL = 'https://kodrx-blockchain.onrender.com/verificar.html?id=' + encodeURIComponent(h);
  } else {
    qrChainDiv.innerHTML = '<div style="opacity:.6;font:12px system-ui">sin datos</div>';
  }

  if (verifyURL) {
    new QRCode(qrChainDiv, {
      text: verifyURL,
      width: 220,
      height: 220,
      correctLevel: QRCode.CorrectLevel.M
    });
  }
}

    // Leyenda bajo el número de bloque (vista)
{
  const legendHolder = document.querySelector('.qr-legend .sub');
  const text = 'Para consultar bloque visitar kodrx.app';
  if (legendHolder) {
    legendHolder.textContent = text;
  } else {
    const numEl = document.getElementById('blockNum');
    if (numEl) numEl.insertAdjacentHTML('afterend',
      '<br><span class="sub" id="blockHint" style="color:#6b7280;font-weight:400">' + text + '</span>'
    );
  }
}

    // barcode
    if (canvas && canvas.getContext && !canvas.__done){
      try{ JsBarcode(canvas, r.id, {format:'CODE128', displayValue:false, margin:0, width:2, height:70}); canvas.__done=true; }catch(e){}
    }
    if (label) setText(label, r.id || '—');

    // export QRS → PDF
    const qrMainData  = qrDivToDataURL(qrMainDiv);
    const qrChainData = qrDivToDataURL(qrChainDiv);
    const barcodeData = (()=>{
      try{ return canvas ? canvas.toDataURL('image/png') : ''; }catch{ return ''; }
    })();
    const linea = [ r.nombrePaciente||'—', ts.toLocaleString('es-MX'), r.medicoNombre||'—', r.medsSig||'' ].join(' | ');
    window.QRS = { qrMain: qrMainData, qrAlt: qrChainData, qrChain: qrChainData, barcode: barcodeData, verURL: location.href, linea };

    // apaga spinners de “verificando…”
    ['#badgeVerificando','#spinnerVerificando','#panelVerificando','[data-role="verificando"]','.verificando','.spinner-verify']
      .forEach(sel => document.querySelectorAll(sel).forEach(el => el.style.display='none'));

    console.log('[ver] render ok');
  }
async function ensureJsPDF(){
    if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
    await new Promise((res,rej)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
      s.onload=res; s.onerror=rej; document.head.appendChild(s);
    });
    return window.jspdf?.jsPDF;
  }
  function split(doc, text, maxW){ return doc.splitTextToSize((text??'').toString(), maxW||360); }

  window.generarPDF = async function(receta, QRS, {mode}={}){
    const jsPDF = await ensureJsPDF();
    if (!jsPDF){ alert('No se pudo cargar jsPDF'); return; }

    const doc = new jsPDF({ unit:'pt', format:'letter' }); // 612x792
    const W=612, H=792, M=54;
    const colL=M, colR=362;            // columnas
    const blue = {r:11,g:91,b:211};
    const rule = (y)=>{ doc.setDrawColor(210); doc.line(M, y, W-M, y); };
    const cardFill = (x,y,w,h)=>{ doc.setDrawColor(230); doc.setFillColor(245,245,245); doc.rect(x, y, w, h, 'FD'); };

    // ===== Header =====
    doc.setFillColor(blue.r,blue.g,blue.b); doc.rect(0,0,W,60,'F');
    doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.setTextColor(255,255,255);
    doc.text('KodRx — Receta médica digital', M, 38);
    doc.setTextColor(0,0,0); doc.setFontSize(11);

    // Tiempos
    const ts = receta?.timestamp?.seconds ? new Date(receta.timestamp.seconds*1000)
             : (receta?.timestamp?.toDate ? receta.timestamp.toDate() : new Date());
    const fechaStr = ts.toLocaleString('es-MX', { day:'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' });

    // ===== Columna izquierda =====
    let y = 88;

    // MÉDICO
    doc.setFont('helvetica','bold'); doc.text('MÉDICO', colL, y); y+=12; rule(y); y+=14;
    doc.setFont('helvetica','normal');
    doc.text((receta.medicoNombre?('Dr. '+receta.medicoNombre):'—'), colL, y); y+=16;
    const cedEsp = `Cédula: ${receta.medicoCedula||'—'}    Especialidad: ${receta.medicoEspecialidad||'General'}`;
    doc.text(cedEsp, colL, y); y+=16;
    if (receta.medicoTelefono){ doc.text('Tel: ' + receta.medicoTelefono, colL, y); y+=16; }
    if (receta.medicoDomicilio){ const a=split(doc,'Dirección: '+receta.medicoDomicilio, 270); doc.text(a, colL, y); y+= a.length*12 + 6; }

    // PACIENTE
    doc.setFont('helvetica','bold'); doc.text('PACIENTE', colL, y); y+=12; rule(y); y+=14;
    doc.setFont('helvetica','normal');
    doc.text(receta.nombrePaciente||'—', colL, y); y+=16;
    doc.text(fechaStr, colL, y); y+=16;
    doc.text('ID: ' + (receta.id||'—'), colL, y); y+=18;

    // Grid signos
    const row = (l)=>{ doc.text(l, colL, y); y+=16; };
    row(`Edad: ${receta.edad??'—'}   Sexo: ${receta.sexo||'—'}`);
    row(`Peso: ${receta.peso??'—'}   Talla: ${receta.talla??'—'}`);
    row(`Temp: ${receta.temperatura??'—'}   PA: ${receta.presion??'—'}`);
    row(`IMC: ${receta.imc??'—'}`);
    y+=6;

    // OBSERVACIONES
    doc.setFont('helvetica','bold'); doc.text('OBSERVACIONES', colL, y); y+=12; rule(y); y+=14;
    doc.setFont('helvetica','normal');
    const obst = split(doc, receta.observaciones||'—', 270); doc.text(obst, colL, y); y+= obst.length*14 + 10;

    // DIAGNÓSTICO
    doc.setFont('helvetica','bold'); doc.text('DIAGNÓSTICO', colL, y); y+=12; rule(y); y+=14;
    doc.setFont('helvetica','normal');
    const dxt = split(doc, receta.diagnostico||'—', 270); doc.text(dxt, colL, y); y+= dxt.length*14 + 10;

    // ===== Columna derecha (tarjetas sombreadas) =====
    let yR = 78;

    // Receta (QR ver-receta)
    doc.setFont('helvetica','bold'); doc.text('Receta', colR, yR);
    cardFill(colR-8, yR+6, 196, 196);
    if (QRS?.qrMain) doc.addImage(QRS.qrMain, 'PNG', colR, yR+10, 180, 180);
    yR += 196 + 24;

    // Medicamentos (en derecha)
    doc.setFont('helvetica','bold'); doc.text('Medicamentos', colR, yR);
    // Construye líneas
    let medsLines = ['—'];
    if (receta.medicamentos?.length){
      medsLines = [];
      receta.medicamentos.forEach((m,i)=>{
        const l1 = `${i+1}. ${m.nombre||'—'}`;
        const l2 = `   Dosis: ${m.dosis||'—'}   Duración: ${m.duracion||'—'}`;
        medsLines.push(...split(doc, l1, 296-16));
        medsLines.push(...split(doc, l2, 296-16));
        medsLines.push(''); // espacio
      });
      if (medsLines[medsLines.length-1]==='') medsLines.pop();
    }
    // Alto dinámico
    const medsH = Math.min(260, Math.max(64, medsLines.length*14 + 12));
    cardFill(colR-8, yR+6, 296, medsH);
    doc.setFont('helvetica','normal');
    // Render dentro de la tarjeta
    let yy = yR + 20;
    const maxH = yR+6+medsH - 12;
    medsLines.forEach(line=>{
      if (yy <= maxH) { doc.text(line||' ', colR, yy); yy += 14; }
    });
    yR += medsH + 24;

    // Código de barras (ID)
    doc.setFont('helvetica','bold'); doc.text('Código de barras (ID)', colR, yR);
    cardFill(colR-8, yR+6, 296, 64);
    if (QRS?.barcode) doc.addImage(QRS.barcode,'PNG', colR, yR+10, 280, 40);
    yR += 64 + 24;

    // Blockchain (Bloque + leyenda + QR blockchain)
    const blk = receta.blockchain?.block ?? receta.bloque ?? '';
    doc.setFont('helvetica','bold'); doc.text('Blockchain', colR, yR);
    const bcCardH = 160; // espacio para texto + QR
    cardFill(colR-8, yR+6, 296, bcCardH);
    doc.setFont('helvetica','normal');
    const bloqueTxt = blk!=='' ? ('Bloque: #'+blk) : 'Bloque: —';
    doc.text(bloqueTxt, colR, yR+26);
    doc.setTextColor(100,100,100);
    doc.text('Para consultar bloque visitar kodrx.app', colR, yR+44);
    doc.setTextColor(0,0,0);
    // QR blockchain (ahora visible)
    if (QRS?.qrChain) doc.addImage(QRS.qrChain, 'PNG', colR+100, yR+56, 160, 160);
    yR += bcCardH + 24;

    // HASH (monoespaciado en caja gris)
    const hashStr = (receta.hash || receta.blockchain?.hash || '—').toString();
    const linesHash = doc.splitTextToSize('hash (BC): ' + hashStr, 296-16);
    doc.setFont('helvetica','bold'); doc.text('HASH', colR, yR);
    const hBoxH = Math.min(160, Math.max(44, linesHash.length*14 + 12));
    doc.setDrawColor(230); doc.setFillColor(245,245,245);
    doc.rect(colR-8, yR+6, 296, hBoxH, 'FD');
    doc.setFont('courier','normal'); doc.setFontSize(10);
    let yHash = yR + 20;
    linesHash.forEach(line=>{
      if (yHash <= yR+6+hBoxH-12){ doc.text(line, colR, yHash); yHash += 14; }
    });
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    yR += hBoxH + 24;

    // Footer
    doc.setDrawColor(220); doc.line(M, H-40, W-M, H-40);
    doc.setFont('helvetica','italic'); doc.setFontSize(9);
    doc.text('Creada con KodRx. Tecnología que verifica, salud que protege.', M, H-22);

    if (mode==='print'){ doc.autoPrint?.(); window.open(doc.output('bloburl'), '_blank'); }
    else { doc.save(`Receta_${receta.id||''}.pdf`); }
  };
})();
</script>

<script>
(() => {
  function hideVerify(){
    const sels = [
      '#badgeVerificando','#spinnerVerificando','#panelVerificando',
      '[data-role="verificando"]','.verificando','.spinner-verify',
      '.spinner','.loading','#loading'
    ];
    // Oculta por selectores comunes
    for (const sel of sels) {
      document.querySelectorAll(sel).forEach(el=>{
        if (/verific/i.test((el.id||'')+' '+(el.className||'')+' '+(el.textContent||''))) {
          el.style.display='none';
        }
      });
    }
    // Además, cualquier nodo de texto suelto que contenga “verific”
    document.querySelectorAll('body *').forEach(el=>{
      if (el.childElementCount===0 && /verific/i.test(el.textContent||'')) {
        el.style.display='none';
      }
    });
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', hideVerify, {once:true});
  else hideVerify();
  window.kodrxHideVerify = hideVerify; // por si lo quieres invocar manual
})();
</script>

</body>
</html>


