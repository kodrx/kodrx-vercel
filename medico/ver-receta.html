<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KodRx | Receta Digital</title>

<style>
/* ===== Layout general ===== */
body{margin:0;background:#ffffff;color:#0f172a;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
.receta-wrap{max-width:940px;margin:16px auto;padding:12px}
.receta{display:grid;grid-template-columns:1fr 340px;gap:16px;align-items:start}

/* Header */
.receta-header{grid-column:1/-1;background:#F0F5FF;color:#0b1b2b;padding:14px 16px;border-radius:12px;font-weight:700}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;margin-left:8px}
.badge.ok{background:#e7f6e8;color:#0b8b2b}
.badge.warn{background:#fff3cd;color:#7a5a00}

/* Acciones */
.actions{grid-column:1/-1;display:flex;gap:12px;padding:8px 0;flex-wrap:wrap}
button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.primary{background:#0b5bd3;color:#fff}
.ghost{background:#eef2ff;color:#0b1b2b;border:1px solid #dbe3ff}

/* Cards / contenido */
.card{background:#f8fafc;border:1px solid #e0e7f0;border-radius:14px;padding:12px}
.card .title{color:#6b7280;font-weight:800;letter-spacing:.02em;margin:2px 0 8px;text-transform:uppercase}
.kv{color:#111827;font-size:14px;line-height:1.35}
.kv b{color:#6b7280;margin-right:6px}
.card,.kv,.sub{overflow-wrap:anywhere;word-break:break-word}

/* Columna derecha */
.col-right{display:flex;flex-direction:column;gap:16px}
.meds{white-space:pre-wrap;font-size:14px;line-height:1.35;color:#111827}

/* QRs */
.qr-frame{border:2px solid #0b5bd3;border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:center;background:#fff}
.qr-legend{color:#0b5bd3;font-weight:700;font-size:12px;text-align:center;margin-top:6px}
.qr-main img{width:220px;height:220px}
.qr-chain img{width:110px;height:110px}

/* Código de barras (pantalla) */
#panelBarcode canvas{max-width:100%}

/* Hash + footer */
.hash{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;color:#374151;font-size:12px}
.footer{grid-column:1/-1;background:#0b5bd3;color:#fff;border-radius:12px;padding:12px 16px;text-align:center;font-weight:700;margin-top:6px}

/* Responsive */
@media (max-width:920px){
  .receta{grid-template-columns:1fr}
  .qr-main img{width:200px;height:200px}
  .qr-chain img{width:100px;height:100px}
}
@media (max-width:520px){
  .qr-main img{width:180px;height:180px}
  .qr-chain img{width:90px;height:90px}
}

/* En impresión ocultamos botones; preferimos imprimir el PDF generado */
@media print{ .actions{display:none!important} }
</style>
</head>
<body>

<div class="receta-wrap">
<section class="card" style="text-align:center; gap:8px; padding:12px">
  <button id="btnDescargar" type="button" class="btn">Descargar PDF</button>
  <button id="btnImprimir"  type="button" class="btn">Imprimir</button>
</section>


  <div class="receta">
    <!-- Header -->
    <div class="receta-header">
      KodRx — Receta médica digital
      <span id="badgeOrigen" class="badge warn">MOCK</span>
    </div>


    <!-- Columna IZQUIERDA -->
    <div class="col-left" style="display:flex;flex-direction:column;gap:16px">
      <section class="card">
        <div class="title">MÉDICO</div>
        <div class="kv" id="doctorNombre">—</div>
        <div class="kv"><b>Cédula:</b> <span id="doctorCedula">—</span> &nbsp;&nbsp; <b>Especialidad:</b> <span id="doctorEsp">—</span></div>
        <div class="kv"><b>Tel:</b> <span id="doctorTel">—</span></div>
        <div class="kv"><b>Dirección:</b> <span id="doctorDir">—</span></div>
      </section>

      <section class="card">
        <div class="title">PACIENTE</div>
        <div class="kv" id="pacienteNombre">—</div>
        <div class="kv sub" style="margin-top:6px">
          <span id="fechaEmision">—</span> &nbsp;&nbsp; <span id="recetaId">ID: —</span>
        </div>
        <div class="kv" style="margin-top:8px">
          <b>Edad:</b> <span id="pacEdad">—</span> &nbsp;&nbsp; <b>Sexo:</b> <span id="pacSexo">—</span>
        </div>
        <div class="kv"><b>Peso:</b> <span id="pacPeso">—</span> &nbsp;&nbsp; <b>Talla:</b> <span id="pacTalla">—</span></div>
        <div class="kv"><b>Temp:</b> <span id="pacTemp">—</span> &nbsp;&nbsp; <b>PA:</b> <span id="pacPresion">—</span></div>
        <div class="kv"><b>IMC:</b> <span id="pacIMC">—</span></div>
      </section>

      <section class="card">
        <div class="title">OBSERVACIONES</div>
        <div class="kv" id="obsTexto">—</div>
      </section>

      <section class="card">
        <div class="title">DIAGNÓSTICO</div>
        <div class="kv" id="diagTexto">—</div>
      </section>
    </div>

    <!-- Columna DERECHA -->
    <div class="col-right">
      <section class="card">
        <div class="title">MEDICAMENTOS</div>
        <pre class="meds" id="listaMedsDerecha">—</pre>
      </section>

      <section class="card" style="text-align:center">
        <div class="qr-frame qr-main"><div id="qrMain"></div></div>
        <div class="qr-legend">Receta</div>
      </section>

      <section class="card" id="panelBarcode">
        <div class="title">CÓDIGO DE BARRAS (ID)</div>
        <div style="display:flex;justify-content:center">
          <canvas id="barcodeCanvas" width="300" height="80"></canvas>
        </div>
        <div class="sub" style="text-align:center;margin-top:4px"><span id="barcodeLabel">—</span></div>
      </section>

      <section class="card">
        <div class="title">HASH</div>
        <div class="hash" id="hashTexto">hash: —</div>
      </section>

      <section class="card" style="text-align:center">
        <div class="qr-frame qr-chain"><div id="qrChain"></div></div>
        <div class="qr-legend">
          Blockchain<br>
          <span id="blockNum" style="color:#111827;font-weight:800"></span><br>
          <span class="sub" style="color:#6b7280;font-weight:400">Para verificar receta visitar kodrx.app</span>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <div class="footer">Creada con KodRx. Plataforma digital de recetas verificadas con trazabilidad tecnológica.</div>
    <p id="bcStatus" class="pill" style="display:inline-block;">Verificando blockchain…</p>
  </div>
</div>

<!-- jsPDF (UMD) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
/* === KODRX anti-MOCK badge fixer (sticky, observa todo el DOM) === */
(() => {
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  async function waitReceta(max=10000, step=120){
    const t0=Date.now();
    while(Date.now()-t0<max){
      if (window.RECETA_ACTUAL) return window.RECETA_ACTUAL;
      await sleep(step);
    }
    return {};
  }

function computeStatus(receta){
  const bc = receta?.blockchain || {};
  const legacyBlock = Number.isFinite(receta?.bloque) && receta.bloque > 0;
  const bcBlock     = Number.isFinite(bc?.block) || typeof bc?.block === 'string' || typeof bc?.tx === 'string';

  // ✅ considera bloque legacy o block/tx en la nueva estructura como "ok"
  if (bc.status === 'ok' || legacyBlock || bcBlock) {
    return { text:'SELLADO EN BLOCKCHAIN', cls:'badge ok', bg:'#16a34a', fg:'#fff' };
  }
  // 🔶 si no hay block pero sí hash (o status 'simulado'): "simulado"
  if (bc.status === 'simulado' || receta?.hash) {
    return { text:'SELLADO SIMULADO', cls:'badge warn', bg:'#f59e0b', fg:'#111' };
  }
  // ⏳ por defecto
  return { text:'PENDIENTE', cls:'badge warn', bg:'#9ca3af', fg:'#111' };
}

  function applyBadge(el, receta){
    const st = computeStatus(receta);
    // solo reescribe si está MOCK o si nunca aplicamos
    if (!el.__kodrxApplied || (el.textContent||'').toUpperCase().includes('MOCK')) {
      el.textContent = st.text;
      el.className   = st.cls;
      el.style.background = st.bg; // fallback si no hay CSS
      el.style.color      = st.fg;
      el.__kodrxApplied = true;
    }
  }

  async function start(){
    const receta0 = await waitReceta();

    const update = ()=>{
      const receta = window.RECETA_ACTUAL || receta0 || {};
      const el = document.getElementById('badgeOrigen');
      if (!el) return;
      applyBadge(el, receta);
    };

    // 1) Primera aplicación
    update();

    // 2) Observa TODO el documento por si reemplazan el badge
    const mo = new MutationObserver(() => update());
    mo.observe(document.body, { childList:true, subtree:true, characterData:true });

    // 3) Reaplica periódicamente un rato (por si hay renders tardíos)
    let ticks = 0;
    const t = setInterval(() => { update(); if (++ticks > 120) clearInterval(t); }, 500);

    // 4) Hooks a tus funciones (si existen)
    const oldRender = window.renderReceta;
    window.renderReceta = function(){
      const res = typeof oldRender==='function' ? oldRender.apply(this, arguments) : undefined;
      update(); return res;
    };
    const oldVerify = window.verificarBlockchain;
    window.verificarBlockchain = async function(){
      try { return typeof oldVerify==='function' ? await oldVerify.apply(this, arguments) : undefined; }
      finally { update(); }
    };
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start, { once:true });
  } else {
    start();
  }
})();
</script>
<script>
/* === KODRX ver-receta: HIDRATADOR DE RECETA (merge desde Firestore) === */
(async () => {
  try {
    const qs = new URLSearchParams(location.search);
    const id = (qs.get('id') || '').trim();
    if (!id) return;

    // imports dinámicos para no depender de módulos
    const core = await import('/firebase-init.js');
    const fs   = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');

    const ref  = fs.doc(core.db, 'recetas', id);
    const snap = await fs.getDoc(ref);
    if (!snap.exists()) return;

    const data = snap.data() || {};
    // Fusiona TODO en RECETA_ACTUAL conservando el id
    const prev = window.RECETA_ACTUAL || {};
    window.RECETA_ACTUAL = Object.assign({ id: snap.id }, prev, data);

    // Log de diagnóstico
    console.log('[hydrate] receta', {
      id: snap.id,
      hasBlockchain: !!data.blockchain,
      blockchain: data.blockchain,
      hash: data.hash,
      bloque: data.bloque
    });

    // Re-aplica badge si existe
    const el = document.getElementById('badgeOrigen');
    if (el) {
      const bc = window.RECETA_ACTUAL.blockchain || {};
      let text = 'PENDIENTE', cls='badge warn', bg='#9ca3af', fg='#111';
      if (bc.status === 'ok') { text='SELLADO EN BLOCKCHAIN'; cls='badge ok'; bg='#16a34a'; fg='#fff'; }
      else if (bc.status === 'simulado' || window.RECETA_ACTUAL.hash) {
        text='SELLADO SIMULADO'; cls='badge warn'; bg='#f59e0b'; fg='#111';
      }
      el.textContent = text;
      el.className   = cls;
      el.style.background = bg;
      el.style.color      = fg;
    }
  } catch (e) {
    console.warn('[hydrate] fallo al rehidratar receta', e);
  }
})();
</script>
<script>
/* === KODRX: QRs + Barcode para #qrMain, #qrChain, #barcodeCanvas === */
(() => {
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  async function waitReceta(max=10000, step=120){
    const t0=Date.now();
    while(Date.now()-t0<max){
      if (window.RECETA_ACTUAL) return window.RECETA_ACTUAL;
      await sleep(step);
    }
    return null;
  }
  async function ensureQRCode(){
    if (window.QRCode) return;
    await new Promise((res,rej)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';
      s.onload=res; s.onerror=rej; document.head.appendChild(s);
    });
  }
  async function ensureJsBarcode(){
    if (window.JsBarcode) return;
    await new Promise((res,rej)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js';
      s.onload=res; s.onerror=rej; document.head.appendChild(s);
    });
  }
  function elToDataURL(container){
    if (!container) return '';
    const img=container.querySelector('img'); if (img?.src) return img.src;
    const c  =container.querySelector('canvas'); return c ? c.toDataURL('image/png') : '';
  }
  function blockStatus(r){
    const bc=r?.blockchain||{};
    const blk = bc.block ?? r?.bloque ?? null;
    if (Number.isFinite(blk) || typeof blk==='string') return { txt:'#'+blk, blk };
    if (bc.status==='simulado' || r?.hash) return { txt:'Simulado', blk:null };
    return { txt:'—', blk:null };
  }
  function chainPayload(r){
    const bc=r?.blockchain||{};
    const blk= bc.block ?? r?.bloque ?? '—';
    const h  = bc.hash ?? r?.hash ?? '—';
    const ms = r?.medsSig || '';
    return `kodrx:${r?.id||''}|ms:${ms}|blk:${blk}|hash:${h}`;
  }

  async function run(){
    const receta = await waitReceta(); if (!receta) return;
    await Promise.all([ensureQRCode(), ensureJsBarcode()]);

    // --- QR principal (URL de verificación)
    const qrMainDiv = document.getElementById('qrMain');
    if (qrMainDiv && window.QRCode){
      qrMainDiv.innerHTML = '';
      const verURL = location.origin + '/public/ver-receta.html?id=' + encodeURIComponent(receta.id);
      new QRCode(qrMainDiv, { text: verURL, width: 260, height: 260, correctLevel: QRCode.CorrectLevel.M });
    }

    // --- QR blockchain (payload compacto)
    const qrChainDiv = document.getElementById('qrChain');
    if (qrChainDiv && window.QRCode){
      qrChainDiv.innerHTML = '';
      new QRCode(qrChainDiv, { text: chainPayload(receta), width: 220, height: 220, correctLevel: QRCode.CorrectLevel.M });
    }

    // --- Barcode (canvas)
    const canvas = document.getElementById('barcodeCanvas');
    if (canvas && window.JsBarcode){
      try{
        JsBarcode(canvas, receta.id, { format:'CODE128', displayValue:false, margin:0, width:2, height:70 });
      }catch(e){ console.warn('[barcode] warn', e); }
    }
    const lbl = document.getElementById('barcodeLabel');
    if (lbl) lbl.textContent = receta.id || '—';

    // --- Bloque / Simulado
    const b = blockStatus(receta);
    const bn = document.getElementById('blockNum');
    if (bn) bn.textContent = b.txt;

    // --- Exportar para PDF (dataURL)
    const qrMainData  = elToDataURL(qrMainDiv);
    const qrChainData = elToDataURL(qrChainDiv);
    const barcodeData = (()=>{
      try{ return canvas ? canvas.toDataURL('image/png') : ''; }catch{ return ''; }
    })();
    const ts = receta?.timestamp?.seconds ? new Date(receta.timestamp.seconds*1000)
             : (receta?.timestamp?.toDate ? receta.timestamp.toDate() : new Date());
    const linea = [
      receta.nombrePaciente || receta.pacienteNombre || '—',
      ts.toLocaleString('es-MX'),
      receta.medicoNombre || '—',
      receta.medsSig || ''
    ].join(' | ');

    window.QRS = {
      qrMain: qrMainData,
      qrAlt:  qrChainData,   // compat con tu PDF
      qrChain: qrChainData,  // explícito
      barcode: barcodeData,
      verURL: location.origin + '/public/ver-receta.html?id=' + encodeURIComponent(receta.id),
      linea
    };
    console.log('[qr/init] listo', { haveMain:!!qrMainData, haveChain:!!qrChainData, haveBarcode:!!barcodeData });
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', run, {once:true});
  else run();
})();
</script>

<script>
/* ==== KODRX generarPDF fallback (usa window.jspdf) ==== */
(async ()=>{
  if (window.generarPDF) return; // ya existe tu versión
  // espera jsPDF
  for(let i=0;i<100;i++){ if(window.jspdf?.jsPDF) break; await new Promise(r=>setTimeout(r,100)); }
  if (!window.jspdf?.jsPDF) { console.warn('[pdf] jsPDF no está cargado'); return; }

  window.generarPDF = async function(receta, QRS, {mode}={}){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'letter' }); // 612x792 pt

    // Cabecera sencilla
    doc.setFont('helvetica','bold'); doc.setFontSize(16);
    doc.text('Receta Médica', 54, 54);
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    doc.text(`Paciente: ${receta.nombrePaciente||'—'}`, 54, 80);
    doc.text(`Médico: ${receta.medicoNombre||'—'}`, 54, 96);
    doc.text(`Fecha: ${new Date().toLocaleString('es-MX')}`, 54, 112);

    // QRs/Barcode si existen
    if (QRS?.qrMain) doc.addImage(QRS.qrMain, 'PNG', 420, 54, 140, 140);
    if (QRS?.qrAlt)  doc.addImage(QRS.qrAlt,  'PNG', 420, 206, 120, 120);
    if (QRS?.barcode)doc.addImage(QRS.barcode,'PNG', 54, 730, 260, 30);

    // Observaciones/diagnóstico (muy simple)
    let y=150; doc.setFontSize(12); doc.setFont('helvetica','bold'); doc.text('Diagnóstico', 54, y);
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    doc.text((receta.diagnostico||'—'), 54, (y+=18), {maxWidth: 320});
    doc.setFont('helvetica','bold'); doc.text('Observaciones', 54, (y+=48));
    doc.setFont('helvetica','normal'); doc.text((receta.observaciones||'—'), 54, (y+=18), {maxWidth: 320});

    if (mode==='print'){ doc.autoPrint?.(); window.open(doc.output('bloburl'), '_blank'); }
    else { doc.save(`Receta_${receta.id||''}.pdf`); }
  };
})();
</script>
<script>
(() => {
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  async function waitFor(fn, max=8000, step=100){
    const t0=Date.now();
    while(Date.now()-t0<max){ const v=fn(); if(v) return v; await sleep(step); }
    return null;
  }
  async function ensureReceta(){
    const r = await waitFor(()=>window.RECETA_ACTUAL, 8000, 120);
    if (!r && typeof window.loadAndRender==='function') {
      try { await window.loadAndRender(); } catch {}
      return await waitFor(()=>window.RECETA_ACTUAL, 3000, 120);
    }
    return r;
  }
  async function ensureQRS(){
    const q = await waitFor(()=>window.QRS, 4000, 120);
    return q || null;
  }

  function bind(){
    const btnD = document.getElementById('btnDescargar');
    const btnP = document.getElementById('btnImprimir');
    if (!btnD && !btnP) { console.warn('[ver] No encontré botones'); return; }

    const onClick = (mode)=>async (ev)=>{
      ev.preventDefault();
      const b = ev.currentTarget;
      if (b.__busy) return; b.__busy = true; b.disabled = true;
      try{
        if (typeof window.generarPDF !== 'function') {
          alert('Falta generarPDF (jsPDF). Pega el snippet del generador de PDF.');
          return;
        }
        const receta = await ensureReceta();
        if (!receta) { alert('No se pudo cargar la receta'); return; }
        const qrs = await ensureQRS(); // si no hay, igual generará tu PDF sin QRs
        await window.generarPDF(receta, qrs || {}, mode ? {mode} : {});
      } catch(e){
        console.error('[ver] PDF error:', e);
        alert('No se pudo generar el PDF.');
      } finally {
        b.__busy = false; b.disabled = false;
      }
    };

    if (btnD && !btnD.__bound){ btnD.addEventListener('click', onClick(null), {capture:true}); btnD.__bound=true; }
    if (btnP && !btnP.__bound){ btnP.addEventListener('click', onClick('print'), {capture:true}); btnP.__bound=true; }

    console.log('[ver] binder OK', { descargar: !!btnD, imprimir: !!btnP });
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind, {once:true});
  else bind();
})();
</script>
<script>
/* ==== KODRX ver-receta: datos médico/paciente/diag/obs/meds (robusto) ==== */
(() => {
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  async function waitReceta(max=10000, step=120){
    const t0=Date.now();
    while(Date.now()-t0<max){
      if (window.RECETA_ACTUAL) return window.RECETA_ACTUAL;
      await sleep(step);
    }
    return null;
  }

  // Normaliza receta para soportar legacy/new
  function normalizeReceta(raw){
    const bc   = raw?.blockchain || {};
    const blk  = (Number.isFinite(raw?.bloque) && raw.bloque>0) ? raw.bloque : (bc.block ?? null);
    const hash = bc.hash ?? raw?.hash ?? null;
    const status = bc.status ? bc.status : (blk ? 'ok' : (hash ? 'simulado' : 'pendiente'));
    // nombre paciente (variantes)
    const pacNombre = raw?.nombrePaciente ?? raw?.pacienteNombre ?? raw?.paciente ?? '—';
    // array resumen de medicamentos si existe
    const medsArr = Array.isArray(raw?.medicamentos) ? raw.medicamentos : (raw?.meds || []);
    return {
      ...raw,
      nombrePaciente: pacNombre,
      bloque: blk,
      hash,
      medsSig: bc.medsSig ?? raw.medsSig ?? '',
      medicamentos: medsArr,
      blockchain: { ...bc, status, block: bc.block ?? blk, hash }
    };
  }

  // Mapea texto a uno de varios selectores (toma el primero que exista)
  function setText(targets, text){
    const arr = Array.isArray(targets) ? targets : [targets];
    for (const sel of arr){
      const el = document.querySelector(sel);
      if (el){ el.textContent = (text ?? '—').toString(); return true; }
    }
    return false;
  }

  // Crea panel si no existe
  function ensurePanel(id, title){
    let sec = document.getElementById(id);
    if (!sec){
      sec = document.createElement('section');
      sec.className = 'card';
      sec.id = id;
      sec.innerHTML = `<div class="title">${title}</div><div class="body"></div>`;
      (document.querySelector('#contenido') || document.body).appendChild(sec);
    }
    return sec.querySelector('.body') || sec;
  }

  async function loadMedsIfMissing(r){
    if (Array.isArray(r.medicamentos) && r.medicamentos.length) return r.medicamentos;
    // intenta subcolección
    try{
      const core = await import('/firebase-init.js');
      const fs   = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
      const medsSnap = await fs.getDocs(fs.collection(fs.doc(core.db,'recetas', r.id),'medicamentos'));
      r.medicamentos = medsSnap.docs.map(d=>d.data());
    }catch(e){ console.warn('[ver] no pude leer subcolección medicamentos', e); }
    return r.medicamentos || [];
  }

  async function run(){
    const rec = await waitReceta(); if(!rec) return;
    const r = window.RECETA_ACTUAL = normalizeReceta(rec);

    // ---------- Panel MÉDICO ----------
    const m = ensurePanel('panelMedico', 'DATOS DEL MÉDICO');
    m.innerHTML = `
      <p><strong>Nombre:</strong> <span id="medicoNombre"></span></p>
      <p><strong>Especialidad:</strong> <span id="medicoEspecialidad"></span></p>
      <p><strong>Cédula:</strong> <span id="medicoCedula"></span></p>
      <p><strong>Domicilio:</strong> <span id="medicoDomicilio"></span></p>
      <p><strong>Teléfono:</strong> <span id="medicoTelefono"></span></p>`;
    setText('#medicoNombre',       r.medicoNombre || r.medico || '—');
    setText('#medicoEspecialidad', r.medicoEspecialidad || r.medicoEspecialidad || r.especialidad || 'General');
    setText('#medicoCedula',       r.medicoCedula || r.cedula || '—');
    setText('#medicoDomicilio',    r.medicoDomicilio || r.domicilio || '—');
    setText('#medicoTelefono',     r.medicoTelefono || r.telefono || '—');

    // ---------- Panel PACIENTE ----------
    const p = ensurePanel('panelPaciente', 'DATOS DEL PACIENTE');
    const ts = r?.timestamp?.seconds ? new Date(r.timestamp.seconds*1000)
             : (r?.timestamp?.toDate ? r.timestamp.toDate() : new Date());
    p.innerHTML = `
      <p><strong>Nombre:</strong> <span id="pacienteNombre"></span></p>
      <p><strong>Edad:</strong> <span id="pacienteEdad"></span></p>
      <p><strong>Sexo:</strong> <span id="pacienteSexo"></span></p>
      <p><strong>Fecha/Hora:</strong> <span id="fechaEmision"></span></p>
      <p><strong>Signos:</strong> <span id="signosVitales"></span></p>`;
    setText('#pacienteNombre', r.nombrePaciente || '—');
    setText('#pacienteEdad',   r.edad ?? '—');
    setText('#pacienteSexo',   r.sexo || '—');
    setText('#fechaEmision',   ts.toLocaleString('es-MX'));
    // signos: IMC, peso, talla, temperatura, presión (si existen)
    const signos = [];
    if (r.imc) signos.push(`IMC ${r.imc}`);
    if (r.peso) signos.push(`${r.peso} kg`);
    if (r.talla) signos.push(`${r.talla} cm`);
    if (r.temperatura) signos.push(`${r.temperatura}°C`);
    if (r.presion) signos.push(`PA ${r.presion}`);
    setText('#signosVitales', signos.join(' · ') || '—');

    // ---------- Panel DIAGNÓSTICO / OBS ----------
    const d = ensurePanel('panelDiag', 'DIAGNÓSTICO Y OBSERVACIONES');
    d.innerHTML = `
      <p style="margin:0 0 8px 0"><strong>Diagnóstico:</strong></p>
      <p id="diagnosticoText" style="white-space:pre-wrap; margin:0 0 16px 0"></p>
      <p style="margin:0 0 8px 0"><strong>Observaciones:</strong></p>
      <p id="observacionesText" style="white-space:pre-wrap; margin:0"></p>`;
    setText('#diagnosticoText',   r.diagnostico || r.diagnosis || '—');
    setText('#observacionesText', r.observaciones || r.nota || '—');

    // ---------- Panel MEDICAMENTOS ----------
    const medsPanel = ensurePanel('panelMeds', 'MEDICAMENTOS');
    const meds = await loadMedsIfMissing(r);
    if (!meds.length){
      medsPanel.innerHTML = '<p>—</p>';
    } else {
      medsPanel.innerHTML = '<ol id="listaMeds" style="padding-left:18px;margin:0"></ol>';
      const ol = document.getElementById('listaMeds');
      meds.forEach((m,i)=>{
        const li=document.createElement('li');
        li.textContent = `${m.nombre||'—'} — Dosis: ${m.dosis||'—'} — Duración: ${m.duracion||'—'}`;
        ol.appendChild(li);
      });
    }

    // ---------- Hash / Bloque (si tienes placeholders) ----------
    setText(['#hashText', '#hash', '[data-hash]'], r.hash || '—');
    if (document.getElementById('blockNum')){
      const bn = (Number.isFinite(r.bloque) || typeof r.bloque==='string') ? ('#'+r.bloque)
               : ((r.blockchain?.status==='simulado'||r.hash)?'Simulado':'—');
      setText('#blockNum', bn);
    }

    console.log('[ver] datos pintados');
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', run, {once:true});
  else run();
})();
</script>
<script>
/* === KODRX: pintado robusto de datos en ver-receta === */
(() => {
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  async function waitReceta(max=10000, step=100){
    const t0=Date.now();
    while(Date.now()-t0<max){ if (window.RECETA_ACTUAL) return window.RECETA_ACTUAL; await sleep(step); }
    return null;
  }
  // Normaliza legacy/new
  function normalize(r0){
    const r = r0 || {};
    const bc = r.blockchain || {};
    const blk = (Number.isFinite(r.bloque) && r.bloque>0) ? r.bloque : (bc.block ?? null);
    const hash = bc.hash ?? r.hash ?? null;
    const status = bc.status || (blk ? 'ok' : (hash ? 'simulado' : 'pendiente'));
    const nombrePaciente = r.nombrePaciente ?? r.pacienteNombre ?? r.paciente ?? '—';
    return {
      ...r,
      nombrePaciente,
      bloque: blk,
      hash,
      medicoNombre: r.medicoNombre ?? r.medico ?? '',
      medicoCedula: r.medicoCedula ?? r.cedula ?? '',
      medicoEspecialidad: r.medicoEspecialidad ?? r.especialidad ?? 'General',
      medicoTelefono: r.medicoTelefono ?? r.telefono ?? '',
      medicoDomicilio: r.medicoDomicilio ?? r.domicilio ?? '',
      blockchain: { ...bc, status, block: bc.block ?? blk, hash }
    };
  }
  const setText = (sels, val)=>{
    const arr = Array.isArray(sels)? sels : [sels];
    for (const sel of arr){
      const el = document.querySelector(sel);
      if (el){ el.textContent = (val ?? '—').toString(); return true; }
    }
    return false;
  };
  const prefixMed = (nombre, genero)=>{
    if (!nombre) return '—';
    const g = (genero||'').toLowerCase();
    return (g.startsWith('f') ? 'Dra. ' : 'Dr. ') + nombre;
  };

  function paint(){
    const r = normalize(window.RECETA_ACTUAL||{});
    // MÉDICO
    setText(['#medicoNombre','[data-bind="medicoNombre"]'], prefixMed(r.medicoNombre, r.medicoGenero||r.genero));
    setText(['#medicoCedula','[data-bind="medicoCedula"]'], r.medicoCedula);
    setText(['#medicoEspecialidad','[data-bind="medicoEspecialidad"]'], r.medicoEspecialidad||'General');
    setText(['#medicoTelefono','[data-bind="medicoTelefono"]'], r.medicoTelefono);
    setText(['#medicoDomicilio','[data-bind="medicoDomicilio"]'], r.medicoDomicilio);
    // PACIENTE
    setText(['#nombrePaciente','[data-bind="nombrePaciente"]'], r.nombrePaciente);
    setText(['#edad','#pacienteEdad','[data-bind="edad"]'], r.edad ?? '—');
    setText(['#sexo','[data-bind="sexo"]'], r.sexo || '—');
    setText(['#peso','[data-bind="peso"]'], r.peso ?? '—');
    setText(['#talla','[data-bind="talla"]'], r.talla ?? '—');
    setText(['#imc','[data-bind="imc"]'], r.imc ?? '—');
    setText(['#presion','#pa','[data-bind="presion"]'], r.presion ?? '—');
    setText(['#temperatura','[data-bind="temperatura"]'], r.temperatura ?? '—');
    // DIAG / OBS
    setText(['#observaciones','#observacionesText','[data-bind="observaciones"]'], r.observaciones || r.nota || '—');
    setText(['#diagnostico','#diagnosticoText','[data-bind="diagnostico"]'], r.diagnostico || r.diagnosis || '—');
    // BLOQUE / HASH
    const bloqueTxt = (Number.isFinite(r.bloque)||typeof r.bloque==='string') ? '#'+r.bloque
                     : ((r.blockchain?.status==='simulado' || r.hash) ? 'Simulado' : '—');
    setText(['#bloque','#blockNum','[data-bind="bloque"]'], bloqueTxt);
    setText(['#hash','#hashText','[data-bind="hash"]'], r.hash || r.blockchain?.hash || '—');
  }

  async function run(){
    const r = await waitReceta();
    if (!r) return;
    paint();
    // Si el render vuelve a escribir el DOM, repinta
    const mo = new MutationObserver(()=>paint());
    mo.observe(document.body, { childList:true, subtree:true, characterData:true });
    // Hook si existen tus funciones
    const oldRender = window.renderReceta;
    if (typeof oldRender==='function'){
      window.renderReceta = function(){ const res = oldRender.apply(this, arguments); setTimeout(paint,0); return res; };
    }
    window.kodrxPaint = paint; // debug
  }

  (document.readyState==='loading') ? document.addEventListener('DOMContentLoaded', run, {once:true}) : run();
})();
</script>


</body>
</html>


