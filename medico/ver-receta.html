<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KodRx | Receta Digital</title>

<style>
/* ===== Layout general ===== */
body{margin:0;background:#ffffff;color:#0f172a;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
.receta-wrap{max-width:940px;margin:16px auto;padding:12px}
.receta{display:grid;grid-template-columns:1fr 340px;gap:16px;align-items:start}

/* Header */
.receta-header{grid-column:1/-1;background:#F0F5FF;color:#0b1b2b;padding:14px 16px;border-radius:12px;font-weight:700}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;margin-left:8px}
.badge.ok{background:#e7f6e8;color:#0b8b2b}
.badge.warn{background:#fff3cd;color:#7a5a00}

/* Acciones */
.actions{grid-column:1/-1;display:flex;gap:12px;padding:8px 0;flex-wrap:wrap}
button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.primary{background:#0b5bd3;color:#fff}
.ghost{background:#eef2ff;color:#0b1b2b;border:1px solid #dbe3ff}

/* Cards / contenido */
.card{background:#f8fafc;border:1px solid #e0e7f0;border-radius:14px;padding:12px}
.card .title{color:#6b7280;font-weight:800;letter-spacing:.02em;margin:2px 0 8px;text-transform:uppercase}
.kv{color:#111827;font-size:14px;line-height:1.35}
.kv b{color:#6b7280;margin-right:6px}
.card,.kv,.sub{overflow-wrap:anywhere;word-break:break-word}

/* Columna derecha */
.col-right{display:flex;flex-direction:column;gap:16px}
.meds{white-space:pre-wrap;font-size:14px;line-height:1.35;color:#111827}

/* QRs */
.qr-frame{border:2px solid #0b5bd3;border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:center;background:#fff}
.qr-legend{color:#0b5bd3;font-weight:700;font-size:12px;text-align:center;margin-top:6px}
.qr-main img{width:220px;height:220px}
.qr-chain img{width:110px;height:110px}

/* Código de barras (pantalla) */
#panelBarcode canvas{max-width:100%}

/* Hash + footer */
.hash{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;color:#374151;font-size:12px}
.footer{grid-column:1/-1;background:#0b5bd3;color:#fff;border-radius:12px;padding:12px 16px;text-align:center;font-weight:700;margin-top:6px}

/* Responsive */
@media (max-width:920px){
  .receta{grid-template-columns:1fr}
  .qr-main img{width:200px;height:200px}
  .qr-chain img{width:100px;height:100px}
}
@media (max-width:520px){
  .qr-main img{width:180px;height:180px}
  .qr-chain img{width:90px;height:90px}
}

/* En impresión ocultamos botones; preferimos imprimir el PDF generado */
@media print{ .actions{display:none!important} }
</style>
</head>
<body>

<div class="receta-wrap">
  <div class="actions">
    <button class="ghost" id="btnRegresar">Regresar</button>
    <button class="primary" id="btnDescargar">Descargar PDF</button>
    <button class="ghost" id="btnImprimir">Imprimir</button>
  </div>

  <div class="receta">
    <!-- Header -->
    <div class="receta-header">
      KodRx — Receta médica digital
      <span id="badgeOrigen" class="badge warn">MOCK</span>
    </div>


    <!-- Columna IZQUIERDA -->
    <div class="col-left" style="display:flex;flex-direction:column;gap:16px">
      <section class="card">
        <div class="title">MÉDICO</div>
        <div class="kv" id="doctorNombre">—</div>
        <div class="kv"><b>Cédula:</b> <span id="doctorCedula">—</span> &nbsp;&nbsp; <b>Especialidad:</b> <span id="doctorEsp">—</span></div>
        <div class="kv"><b>Tel:</b> <span id="doctorTel">—</span></div>
        <div class="kv"><b>Dirección:</b> <span id="doctorDir">—</span></div>
      </section>

      <section class="card">
        <div class="title">PACIENTE</div>
        <div class="kv" id="pacienteNombre">—</div>
        <div class="kv sub" style="margin-top:6px">
          <span id="fechaEmision">—</span> &nbsp;&nbsp; <span id="recetaId">ID: —</span>
        </div>
        <div class="kv" style="margin-top:8px">
          <b>Edad:</b> <span id="pacEdad">—</span> &nbsp;&nbsp; <b>Sexo:</b> <span id="pacSexo">—</span>
        </div>
        <div class="kv"><b>Peso:</b> <span id="pacPeso">—</span> &nbsp;&nbsp; <b>Talla:</b> <span id="pacTalla">—</span></div>
        <div class="kv"><b>Temp:</b> <span id="pacTemp">—</span> &nbsp;&nbsp; <b>PA:</b> <span id="pacPresion">—</span></div>
        <div class="kv"><b>IMC:</b> <span id="pacIMC">—</span></div>
      </section>

      <section class="card">
        <div class="title">OBSERVACIONES</div>
        <div class="kv" id="obsTexto">—</div>
      </section>

      <section class="card">
        <div class="title">DIAGNÓSTICO</div>
        <div class="kv" id="diagTexto">—</div>
      </section>
    </div>

    <!-- Columna DERECHA -->
    <div class="col-right">
      <section class="card">
        <div class="title">MEDICAMENTOS</div>
        <pre class="meds" id="listaMedsDerecha">—</pre>
      </section>

      <section class="card" style="text-align:center">
        <div class="qr-frame qr-main"><div id="qrMain"></div></div>
        <div class="qr-legend">Receta</div>
      </section>

      <section class="card" id="panelBarcode">
        <div class="title">CÓDIGO DE BARRAS (ID)</div>
        <div style="display:flex;justify-content:center">
          <canvas id="barcodeCanvas" width="300" height="80"></canvas>
        </div>
        <div class="sub" style="text-align:center;margin-top:4px"><span id="barcodeLabel">—</span></div>
      </section>

      <section class="card">
        <div class="title">HASH</div>
        <div class="hash" id="hashTexto">hash: —</div>
      </section>

      <section class="card" style="text-align:center">
        <div class="qr-frame qr-chain"><div id="qrChain"></div></div>
        <div class="qr-legend">
          Blockchain<br>
          <span id="blockNum" style="color:#111827;font-weight:800"></span><br>
          <span class="sub" style="color:#6b7280;font-weight:400">Para verificar receta visitar kodrx.app</span>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <div class="footer">Creada con KodRx. Plataforma digital de recetas verificadas con trazabilidad tecnológica.</div>
    <p id="bcStatus" class="pill" style="display:inline-block;">Verificando blockchain…</p>
  </div>
</div>

<!-- jsPDF (UMD) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
/* ==== KODRX ver-receta badge+QR fix ==== */
(()=> {
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  async function waitReceta(maxMs=4000){
    const t0=Date.now();
    while(Date.now()-t0<maxMs){
      if (window.RECETA_ACTUAL) return window.RECETA_ACTUAL;
      await sleep(80);
    }
    return null;
  }
  function statusFrom(receta){
    const bc = receta?.blockchain || {};
    if (bc.status === 'ok') return 'ok';
    if (bc.status === 'simulado' || receta?.hash) return 'simulado';
    return 'pendiente';
  }
  function updateBadgeOrigen(receta){
    const el = document.getElementById('badgeOrigen');
    if (!el) return;
    const st = statusFrom(receta);
    const map = {
      ok:        { text: 'SELLADO EN BLOCKCHAIN', cls: 'badge ok',   bg:'#16a34a', fg:'#fff'  },
      simulado:  { text: 'SELLADO SIMULADO',      cls: 'badge warn', bg:'#f59e0b', fg:'#111'  },
      pendiente: { text: 'PENDIENTE',             cls: 'badge warn', bg:'#9ca3af', fg:'#111'  }
    };
    const m = map[st];
    el.textContent = m.text;
    el.className   = m.cls;
    // fallback visual por si no hay CSS para .ok/.warn
    el.style.background = m.bg; el.style.color = m.fg;
    // por si traía texto “MOCK”
    el.removeAttribute('data-mock');
  }

  async function makeQR(text,size=260){
    return new Promise((resolve)=>{
      if (typeof QRCode==='undefined'){ resolve(''); return; }
      const div=document.createElement('div');
      try { new QRCode(div,{text,width:size,height:size,correctLevel:QRCode.CorrectLevel.M}); } catch { resolve(''); return; }
      setTimeout(()=>{
        const img=div.querySelector('img'); if (img?.src) return resolve(img.src);
        const c=div.querySelector('canvas'); resolve(c?c.toDataURL('image/png'):'');
      },0);
    });
  }
  async function ensureBarcode(id){
    try{
      if (!window.JsBarcode){
        await new Promise((res,rej)=>{
          const s=document.createElement('script');
          s.src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js";
          s.onload=res; s.onerror=rej; document.head.appendChild(s);
        });
      }
      const c=document.createElement('canvas');
      JsBarcode(c, id, {format:'CODE128', displayValue:false, margin:0, width:2, height:60});
      return c.toDataURL('image/png');
    }catch{ return ''; }
  }

  async function run(){
    const receta = await waitReceta();
    if (!receta) return;

    // Actualiza el badge MOCK → estado real
    updateBadgeOrigen(receta);

    // Genera QRs/barcode si no existen aún
    if (!window.QRS){
      const verURL = location.origin + '/public/ver-receta.html?id=' + encodeURIComponent(receta.id);
      const ts = (()=> {
        try{
          if (receta?.timestamp?.seconds) return new Date(receta.timestamp.seconds*1000);
          if (receta?.timestamp?.toDate)  return receta.timestamp.toDate();
        }catch{}
        return new Date();
      })();
      const linea = [
        receta.nombrePaciente || receta.pacienteNombre || '—',
        ts.toLocaleString('es-MX'),
        receta.medicoNombre || '—',
        receta.medsSig || ''
      ].join(' | ');

      const [qrMain, qrAlt] = await Promise.all([ makeQR(verURL,280), makeQR(linea,200) ]);
      const barcode = await ensureBarcode(receta.id);
      window.QRS = { qrMain, qrAlt, barcode, verURL, linea };

      // Coloca en imgs si existen
      const img1 = document.getElementById('qrMain');   if (img1) img1.src = qrMain || '';
      const img2 = document.getElementById('qrAlt');    if (img2) img2.src = qrAlt || '';
      const img3 = document.getElementById('barcode');  if (img3) img3.src = barcode || '';
    }
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', run, {once:true});
  else run();
})();
</script>

</body>
</html>


