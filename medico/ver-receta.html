<!DOCTYPE html>
<html lang="es">
<head>
  <script type="module">
  import { db } from "/firebase-init.js";
  import {
    doc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // exp√≥n a window para que los vea el script inline cl√°sico
  window.db = db;
  window.__fs = { doc, updateDoc, serverTimestamp };
</script>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KodRx | Receta Digital</title>

<style>
/* ===== Layout general ===== */
html, body { height: 100%; }
body { min-height: 100svh; margin: 0; display: block; } /* ‚Üê quitamos flex aqu√≠ */

/* Contenedor ra√≠z: 2 filas ‚Üí [contenido flexible][footer auto] */
.receta-root{
  min-height: 100svh;
  display: grid;
  grid-template-rows: 1fr auto;
}
.receta-wrap{
  /* lo que ya ten√≠as */
  flex:1 0 auto;
  max-width:940px;
  margin:16px auto;
  padding:12px;

  /* lo que faltaba ‚Üí grid de 2 columnas */
  display:grid !important;
  grid-template-columns: minmax(0,1fr) 340px;
  gap:16px;
  align-items:start;
}
/* evita que el contenido rompa el grid */
.col-left, .col-right{ min-width:0; }
/* Header */
.receta-header{grid-column:1/-1;background:#F0F5FF;color:#0b1b2b;padding:14px 16px;border-radius:12px;font-weight:700}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;margin-left:8px}
.badge.ok{background:#e7f6e8;color:#0b8b2b}
.badge.warn{background:#fff3cd;color:#7a5a00}

/* Acciones */
.actions{grid-column:1/-1;display:flex;gap:12px;padding:8px 0;flex-wrap:wrap}
button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.primary{background:#0b5bd3;color:#fff}
.ghost{background:#eef2ff;color:#0b1b2b;border:1px solid #dbe3ff}

/* Cards / contenido */
.card{background:#f8fafc;border:1px solid #e0e7f0;border-radius:14px;padding:12px}
.card .title{color:#6b7280;font-weight:800;letter-spacing:.02em;margin:2px 0 8px;text-transform:uppercase}
.kv{color:#111827;font-size:14px;line-height:1.35}
.kv b{color:#6b7280;margin-right:6px}
.card,.kv,.sub{overflow-wrap:anywhere;word-break:break-word}

/* Columna derecha */
.col-right{display:flex;flex-direction:column;gap:16px}
.meds{white-space:pre-wrap;font-size:14px;line-height:1.35;color:#111827}

/* QRs */
.qr-frame{border:2px solid #0b5bd3;border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:center;background:#fff}
.qr-legend{color:#0b5bd3;font-weight:700;font-size:12px;text-align:center;margin-top:6px}
.qr-main img{width:220px;height:220px}
.qr-chain img{width:110px;height:110px}

/* C√≥digo de barras (pantalla) */
#panelBarcode canvas{max-width:100%}

/* Hash + footer */
.hash{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;color:#374151;font-size:12px}


  .footer{
  /* si el padre es grid, ocupa todo; si no, tambi√©n :) */
  grid-column: 1 / -1;

  background:#0b5bd3;
  color:#fff;
  border-radius:12px;
  padding:12px 16px;
  text-align:center;
  font-weight:700;

  /* claves para que quede pegado abajo en layout flex-col */
  margin-top:auto;
  display:block;
  width:100%;
  align-self:stretch;
}
.qr-frame.qr-main  { width:260px; height:260px; }
  .qr-frame.qr-chain { width:220px; height:220px; }
  #barcodeCanvas     { width:300px; height:80px; display:block; }
/* Responsive */
@media (max-width:920px){
  .receta-wrap{ grid-template-columns:1fr; }
  .qr-main img{width:200px;height:200px}
  .qr-chain img{width:100px;height:100px}
}
@media (max-width:520px){
  .qr-main img{width:180px;height:180px}
  .qr-chain img{width:90px;height:90px}
}

/* En impresi√≥n ocultamos botones; preferimos imprimir el PDF generado */
@media print{ .actions{display:none!important} }
</style>
</head>


<body>
  <div class="receta-root"><!-- wrapper para sticky footer -->

    <div class="receta-wrap"><!-- √öNICO grid de 2 columnas -->

      <!-- Acciones (ocupa ambas columnas) -->
     <section class="card actions" style="gap:8px; padding:12px">
  <button id="btnVolver" type="button" class="btn">Regresar</button>
  <button id="btnDescargar" type="button" class="btn">Descargar PDF</button>
  <button id="btnImprimir"  type="button" class="btn">Imprimir</button>
</section>
      <!-- Header (ocupa ambas columnas) -->
      <div class="receta-header">
        KodRx ‚Äî Receta m√©dica digital
        <span id="badgeOrigen" class="badge warn">MOCK</span>
      </div>


      <!-- Columna IZQUIERDA -->
      <div class="col-left" style="display:flex;flex-direction:column;gap:16px">
        <section class="card">
          <div class="title">M√âDICO</div>
          <div class="kv" id="doctorNombre">‚Äî</div>
          <div class="kv"><b>C√©dula:</b> <span id="doctorCedula">‚Äî</span> &nbsp;&nbsp; <b>Especialidad:</b> <span id="doctorEsp">‚Äî</span></div>
          <div class="kv"><b>Tel:</b> <span id="doctorTel">‚Äî</span></div>
          <div class="kv"><b>Direcci√≥n:</b> <span id="doctorDir">‚Äî</span></div>
        </section>

        <section class="card">
          <div class="title">PACIENTE</div>
          <div class="kv" id="pacienteNombre">‚Äî</div>
          <div class="kv sub" style="margin-top:6px">
            <span id="fechaEmision">‚Äî</span> &nbsp;&nbsp; <span id="recetaId">ID: ‚Äî</span>
          </div>
          <div class="kv" style="margin-top:8px">
            <b>Edad:</b> <span id="pacEdad">‚Äî</span> &nbsp;&nbsp; <b>Sexo:</b> <span id="pacSexo">‚Äî</span>
          </div>
          <div class="kv"><b>Peso:</b> <span id="pacPeso">‚Äî</span> &nbsp;&nbsp; <b>Talla:</b> <span id="pacTalla">‚Äî</span></div>
          <div class="kv"><b>Temp:</b> <span id="pacTemp">‚Äî</span> &nbsp;&nbsp; <b>PA:</b> <span id="pacPresion">‚Äî</span></div>
          <div class="kv"><b>IMC:</b> <span id="pacIMC">‚Äî</span></div>
        </section>

        <section class="card">
          <div class="title">OBSERVACIONES</div>
          <div class="kv" id="obsTexto">‚Äî</div>
        </section>

        <section class="card">
          <div class="title">DIAGN√ìSTICO</div>
          <div class="kv" id="diagTexto">‚Äî</div>
        </section>
      </div><!-- /.col-left -->

      <!-- Columna DERECHA -->
      <div class="col-right">
        <section class="card">
          <div class="title">MEDICAMENTOS</div>
          <pre class="meds" id="listaMedsDerecha">‚Äî</pre>
        </section>

        <section class="card" style="text-align:center">
          <div class="qr-frame qr-main"><div id="qrMain"></div></div>
          <div class="qr-legend">Receta</div>
        </section>

        <section class="card" id="panelBarcode">
          <div class="title">C√ìDIGO DE BARRAS (ID)</div>
          <div style="display:flex;justify-content:center">
            <canvas id="barcodeCanvas" width="300" height="80"></canvas>
          </div>
          <div class="sub" style="text-align:center;margin-top:4px">
            <span id="barcodeLabel">‚Äî</span>
          </div>
        </section>

        <section class="card">
          <div class="title">HASH</div>
          <div class="hash" id="hashTexto">hash: ‚Äî</div>
        </section>

        <section class="card" style="text-align:center">
          <div class="qr-frame qr-chain"><div id="qrChain"></div></div>
          <div class="qr-legend">
            Blockchain<br>
            <span id="blockNum" style="color:#111827;font-weight:800"></span><br>
            <span class="sub" style="color:#6b7280;font-weight:400">Para consultar bloque visitar kodrx.app</span>
          </div>
        </section>
      </div><!-- /.col-right -->
    </div><!-- /.receta-wrap -->

    <!-- Pill de estado (lo ocultamos desde JS al terminar verificaci√≥n) -->
    <div id="verifyScope" data-role="verificando">
  <p id="bcStatus" class="pill verificando">Verificando blockchain‚Ä¶</p>
  <div id="panelVerificando" class="verificando spinner-verify">‚Ä¶spinner‚Ä¶</div>
</div>

    <!-- Footer -->
    <div class="footer">
      Creada con KodRx. Plataforma digital de recetas verificadas con trazabilidad tecnol√≥gica.
    </div>
  </div><!-- /.receta-root -->

</body>
</html>



<!-- jsPDF (UMD) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
;(() => {
  'use strict';

  // ===== Config =====
  const BC_BASE = 'https://kodrx-blockchain.onrender.com';

  // ===== Utils =====
  const sleep   = (ms)=>new Promise(r=>setTimeout(r,ms));
  const setText = (selOrEl, val)=>{
    const el = typeof selOrEl==='string' ? document.querySelector(selOrEl) : selOrEl;
    if (!el) return; el.textContent = (val ?? '‚Äî');
  };

  // Normaliza la receta (soporta legacy)
  window.normalize = function normalize(raw0){
  const raw = raw0 || {};
  const bc  = raw.blockchain || {};

  // bloque: admite r.bloque o bc.block
  let bloque = null;
  if (Number.isFinite(raw.bloque)) bloque = raw.bloque;
  else if (typeof bc.block === 'number' || typeof bc.block === 'string') bloque = bc.block;

  // hash: primero blockchain.hash, si no r.hash
  const hash = (bc.hash ?? raw.hash) || null;

  // status derivado si no viene en bc.status
  const status = bc.status || (bloque ? 'ok' : (hash ? 'simulado' : 'pendiente'));

  // nombre del paciente (compat)
  const nombrePaciente =
    raw.nombrePaciente ?? raw.pacienteNombre ?? raw.paciente?.nombre ?? raw.paciente ?? '‚Äî';

  // objeto m√©dico desde campos sueltos (compat)
  const medico = raw.medico || {
    nombre:       raw.medicoNombre,
    genero:       raw.medicoGenero,
    cedula:       raw.medicoCedula,
    especialidad: raw.medicoEspecialidad,
    telefono:     raw.medicoTelefono,
    direccion:    raw.medicoDomicilio
  };

  return {
    ...raw,
    nombrePaciente,
    medico,
    bloque,
    hash,
    blockchain: {
      ...bc,
      status,
      block: (bc.block ?? bloque) ?? null,
      hash:  hash
    }
  };
};

  // ===== Libs (idempotentes) =====
  async function ensureLibs(){
    const jobs=[];
    if (!window.QRCode && !window.qrcode){
      jobs.push(new Promise((res,rej)=>{const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';
        s.onload=res; s.onerror=rej; document.head.appendChild(s);}));
    }
    if (!window.JsBarcode){
      jobs.push(new Promise((res,rej)=>{const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js';
        s.onload=res; s.onerror=rej; document.head.appendChild(s);}));
    }
    if (jobs.length) await Promise.allSettled(jobs);
  }
  async function ensureJsPDF(){
    if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
    await new Promise((res,rej)=>{const s=document.createElement('script');
      s.src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
      s.onload=res; s.onerror=rej; document.head.appendChild(s);});
    return window.jspdf.jsPDF;
  }

  // ===== QR helpers =====
  function makeQR(host, text, size){
    if (!host) return false;
    const QR = window.QRCode || window.qrcode;
    if (!QR) return false;
    host.innerHTML = '';
    if (window.QRCode){ new QRCode(host, { text, width:size, height:size, correctLevel: QRCode.CorrectLevel.M }); return true; }
    try{
      if (QR.toCanvas){
        const c=document.createElement('canvas'); host.appendChild(c);
        QR.toCanvas(c, text, { width:size }); return true;
      }
    }catch{}
    return false;
  }
  async function makeQRDataURLCompat(text, size=220){
    await ensureLibs();
    try{
      if (window.qrcode?.toDataURL){
        return await window.qrcode.toDataURL(text, { width:size, margin:1 });
      }
      if (window.QRCode){
        const div=document.createElement('div');
        new QRCode(div, { text, width:size, height:size, correctLevel:(window.QRCode.CorrectLevel?.M ?? 1) });
        await Promise.resolve();
        const img=div.querySelector('img'); if (img?.src) return img.src;
        const c=div.querySelector('canvas'); if (c) return c.toDataURL('image/png');
      }
    }catch{}
    return '';
  }

  // ===== Firestore helpers =====
  let __fsMod=null;
  async function _fs(){
    if (window.__fs) return window.__fs;
    if (!__fsMod) __fsMod = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
    return __fsMod;
  }
  async function getDB(){
    if (window.db) return window.db;
    const core = await import('/firebase-init.js');
    return core.db;
  }

  // ===== Badge =====
  function updateBadgeFromReceta(r){
    const el = document.getElementById('badgeOrigen'); if(!el) return;
    const hasBlock = (r?.blockchain?.block ?? r?.bloque) != null;
    const hasHash  = !!(r?.blockchain?.hash ?? r?.hash);
    const S = hasBlock ? {txt:'SELLADO EN BLOCKCHAIN', cls:'badge ok',   bg:'#16a34a', fg:'#fff'}
          : hasHash   ? {txt:'SELLADO SIMULADO',      cls:'badge warn', bg:'#f59e0b', fg:'#111'}
                      : {txt:'PENDIENTE',             cls:'badge warn', bg:'#9ca3af', fg:'#111'};
    el.textContent = S.txt; el.className = S.cls; el.style.background = S.bg; el.style.color = S.fg;
  }

  // ===== QR del bloque =====
  async function setChainQR(block){
    const host = document.getElementById('qrChain');
    if (!host) return;
    await ensureLibs();
    const url = `${BC_BASE}/verificar.html?id=${encodeURIComponent(block)}`;
    makeQR(host, url, 220);
    const bn = document.getElementById('blockNum');
    if (bn) bn.textContent = String(block || '‚Äî');
  }

  // ===== QRs para PDF =====
  async function getQRSources(receta){
    const out = {};
    const mainNode  = document.querySelector('#qrMain  canvas, #qrMain  img');
    const chainNode = document.querySelector('#qrChain canvas, #qrChain img');
    if (mainNode)  out.main  = mainNode.tagName==='IMG' ? mainNode.src  : mainNode.toDataURL('image/png');
    if (chainNode) out.chain = chainNode.tagName==='IMG'? chainNode.src : chainNode.toDataURL('image/png');
    if (!out.main){
      const verURL = `${location.origin}${location.pathname}?id=${encodeURIComponent(receta.id)}`;
      out.main = await makeQRDataURLCompat(verURL, 220);
    }
    if (!out.chain){
      const blk = receta?.blockchain?.block ?? receta?.bloque ?? null;
      if (blk) out.chain = await makeQRDataURLCompat(`${BC_BASE}/verificar.html?id=${encodeURIComponent(blk)}`, 220);
    }
    return out;
  }

  // ===== Carga receta si falta =====
  async function hydrateIfNeeded(){
    if (window.RECETA_ACTUAL && (window.RECETA_ACTUAL.blockchain || window.RECETA_ACTUAL.hash || window.RECETA_ACTUAL.bloque)) return;
    try{
      const id = new URLSearchParams(location.search).get('id'); if (!id) return;
      const core = await import('/firebase-init.js');
      const fs   = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
      const snap = await fs.getDoc(fs.doc(core.db,'recetas',id));
      if (snap.exists()) window.RECETA_ACTUAL = { id:snap.id, ...(window.RECETA_ACTUAL||{}), ...(snap.data()||{}) };
    }catch(e){ console.warn('[ver] hydrate warn', e); }
  }

  // ===== Render principal =====
  async function renderOnce(){
    for (let i=0;i<100;i++){ if (window.RECETA_ACTUAL) break; await sleep(60); }
    await hydrateIfNeeded();
    const r0 = window.RECETA_ACTUAL; if (!r0) return;
    const r  = window.RECETA_ACTUAL = normalize(r0);

    // M√©dico
    setText('doctorNombre', r.medico?.nombre ? ((String(r.medico?.genero||'').toLowerCase().startsWith('f')?'Dra. ':'Dr. ')+r.medico.nombre) :
      (r.medicoNombre ? ((String(r.medicoGenero||'').toLowerCase().startsWith('f')?'Dra. ':'Dr. ')+r.medicoNombre) : '‚Äî'));
    setText('doctorCedula', r.medico?.cedula ?? r.medicoCedula ?? '‚Äî');
    setText('doctorEsp',    r.medico?.especialidad ?? r.medicoEspecialidad ?? '‚Äî');
    setText('doctorTel',    r.medico?.telefono ?? r.medicoTelefono ?? '‚Äî');
    setText('doctorDir',    r.medico?.direccion ?? r.medicoDomicilio ?? '‚Äî');

    // Paciente
    setText('pacienteNombre', r.paciente?.nombre ?? r.nombrePaciente ?? '‚Äî');
    setText('pacEdad',        r.paciente?.edad ?? r.edad ?? '‚Äî');
    setText('pacSexo',        r.paciente?.sexo ?? r.sexo ?? '‚Äî');
    setText('pacPeso',        r.paciente?.peso ?? r.peso ?? '‚Äî');
    setText('pacTalla',       r.paciente?.talla ?? r.talla ?? '‚Äî');
    setText('pacTemp',        r.paciente?.temperatura ?? r.temperatura ?? '‚Äî');
    setText('pacPresion',     r.paciente?.presion ?? r.presion ?? '‚Äî');
    setText('pacIMC',         r.paciente?.imc ?? r.imc ?? '‚Äî');

    // Texto libre
    setText('obsTexto',  r.observaciones ?? '‚Äî');
    setText('diagTexto', r.diagnostico   ?? '‚Äî');

    // ID y fecha
    setText('recetaId', 'ID: ' + (r.id || '‚Äî'));
    try{
      let ts=r.timestamp;
      if (ts && typeof ts.toDate==='function') ts = ts.toDate();
      else if (ts && typeof ts.seconds==='number') ts = new Date(ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6));
      else if (!(ts instanceof Date)) ts = new Date(ts);
      setText('fechaEmision', ts ? ts.toLocaleString('es-MX',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '‚Äî');
    }catch{ setText('fechaEmision','‚Äî'); }

    // Medicamentos (texto)
    const meds = Array.isArray(r.medicamentos) ? r.medicamentos : [];
    const medsTxt = meds.length
      ? meds.map((m,i)=>`${i+1}. ${m.nombre}\n   Dosis: ${m.dosis}\n   Duraci√≥n: ${m.duracion}`).join('\n\n')
      : '‚Äî';
    const medsEl = document.getElementById('listaMedsDerecha'); if (medsEl) medsEl.textContent = medsTxt;

    // Hash / badge
    const hashEl = document.getElementById('hashTexto');
    if (hashEl){ const h=r.hash ?? r.blockchain?.hash ?? '';
      hashEl.textContent = h ? `hash (BC): ${h}` : (r.id ? `hash (local): ${String(r.id).slice(0,8)}` : 'hash: ‚Äî'); }
    updateBadgeFromReceta(r);

    // Libs + QRs
    await ensureLibs();

    // QR principal
    const host = document.getElementById('qrMain');
    if (host && !host.querySelector('canvas,img')){
      const verURL = `${location.origin}${location.pathname}?id=${encodeURIComponent(r.id)}`;
      makeQR(host, verURL, 260);
    }

    // C√≥digo de barras
    const canvas = document.getElementById('barcodeCanvas');
    const label  = document.getElementById('barcodeLabel');
    if (canvas && window.JsBarcode){
      try{
        const dpr=Math.max(1,window.devicePixelRatio||1), cssW=300, cssH=80;
        canvas.width=cssW*dpr; canvas.height=cssH*dpr;
        canvas.style.width=cssW+'px'; canvas.style.height=cssH+'px';
        const ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
        JsBarcode(canvas, String(r.id||''), { format:'CODE128', width:2, height:40, margin:4, displayValue:false });
        if (label) label.textContent = r.id || '‚Äî';
      }catch(e){ if (label) label.textContent = r.id || '‚Äî'; }
    }

    // QR blockchain + leyenda
    const blk = r?.blockchain?.block ?? r?.bloque ?? null;
    if (blk) await setChainQR(blk);
    {
      const legendHolder = document.querySelector('.qr-legend .sub');
      const text='Para consultar bloque visitar kodrx.app';
      if (legendHolder) legendHolder.textContent = text;
      else document.getElementById('blockNum')?.insertAdjacentHTML('afterend','<br><span class="sub" style="color:#6b7280;font-weight:400">'+text+'</span>');
    }

    // QRs para PDF
    window.QRS = await getQRSources(r);

    // apaga cualquier spinner ‚Äúverificando‚Äù
    document.getElementById('verifyScope')?.remove();

    console.log('[ver] render ok');
  }

  // ===== PDF / Botones =====
  async function generarPDF(r, qrs, {mode='save'}={}){
    const jsPDF = await ensureJsPDF();
    const { jsPDF:Cls } = window.jspdf;
    const doc = new Cls({ unit:'pt', format:'letter' });
    const W = doc.internal.pageSize.getWidth();
    let y=50;
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('KodRx ‚Äî Receta m√©dica digital', 40, y); y+=22;
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    doc.text(`Paciente: ${r.nombrePaciente||'‚Äî'}`, 40, y); y+=16;
    doc.text(`ID: ${r.id||'‚Äî'}`, 40, y); y+=16;
    doc.text(`M√©dico: ${r.medico?.nombre||r.medicoNombre||'‚Äî'}`, 40, y); y+=16;
    doc.text(`C√©dula: ${r.medico?.cedula||r.medicoCedula||'‚Äî'}`, 40, y); y+=20;
    const wrap=(t,w)=>doc.splitTextToSize(String(t??'‚Äî'),w);
    doc.setFont('helvetica','bold'); doc.text('Observaciones:', 40, y); y+=14;
    doc.setFont('helvetica','normal'); doc.text(wrap(r.observaciones, W-80), 40, y); y+=40;
    doc.setFont('helvetica','bold'); doc.text('Diagn√≥stico:', 40, y); y+=14;
    doc.setFont('helvetica','normal'); doc.text(wrap(r.diagnostico, W-80), 40, y); y+=40;
    const meds = Array.isArray(r.medicamentos)?r.medicamentos:[];
    doc.setFont('helvetica','bold'); doc.text('Medicamentos:', 40, y); y+=14;
    doc.setFont('helvetica','normal');
    const medsText = meds.length ? meds.map((m,i)=>`${i+1}. ${m.nombre} ‚Äî ${m.dosis} ‚Äî ${m.duracion}`).join('\n') : '‚Äî';
    doc.text(wrap(medsText, W-80), 40, y); y+=60;
    if (qrs?.main){ try{ doc.addImage(qrs.main,'PNG', W-40-160, 80, 160,160, undefined,'FAST'); }catch{} }
    if (qrs?.chain){ try{ doc.addImage(qrs.chain,'PNG', W-40-120, 260,120,120, undefined,'FAST'); }catch{} }
    doc.setFont('helvetica','bold'); doc.setFontSize(10);
    doc.text('Creada con KodRx. Tecnolog√≠a que verifica, salud que protege.', W/2, 780, {align:'center'});
    const filename=`receta_${r.id||'sin-id'}.pdf`;
    if (mode==='print'){ try{ doc.autoPrint(); doc.output('dataurlnewwindow'); } catch{ doc.save(filename); } }
    else if (mode==='open'){ const url=doc.output('bloburl'); window.open(url,'_blank'); }
    else { doc.save(filename); }
  }

  function bindButtons(){
    const btnD = document.getElementById('btnDescargar');
    const btnP = document.getElementById('btnImprimir');
    const btnB = document.getElementById('btnVolver');

    const onPDF = (mode)=>async (e)=>{
      e?.preventDefault?.();
      try{
        if (!window.RECETA_ACTUAL) await renderOnce();
        const r = window.RECETA_ACTUAL || {};
        const qrs = window.QRS || await getQRSources(r);
        await generarPDF(r, qrs, {mode});
      }catch(err){ console.error('[pdf]',err); alert('No se pudo generar el PDF.'); }
    };

    if (btnD && !btnD.__b){ btnD.type='button'; btnD.disabled=false; btnD.addEventListener('click', onPDF('save'),  {capture:true}); btnD.__b=true; }
    if (btnP && !btnP.__b){ btnP.type='button'; btnP.disabled=false; btnP.addEventListener('click', onPDF('print'), {capture:true}); btnP.__b=true; }
    if (btnB && !btnB.__b){
      btnB.type='button'; btnB.addEventListener('click', (e)=>{ e.preventDefault();
        if (history.length>1) history.back(); else location.href='/medico/panel.html';
      }, {capture:true}); btnB.__b=true;
    }
  }
function writeField(key, val){
  const sels = ['#'+key, `[data-bind="${key}"]`, '.'+key];
  let hits = 0;
  for (const sel of sels){
    document.querySelectorAll(sel).forEach(el => { el.textContent = String(val ?? '‚Äî'); hits++; });
  }
  return hits; // √∫til para depurar
}

function prefixMed(nombre, genero){
  if (!nombre) return '‚Äî';
  const g = String(genero||'').toLowerCase();
  return (g.startsWith('f') ? 'Dra. ' : 'Dr. ') + nombre;
}

function paintFields(recetaRaw){
  const r = (typeof normalize === 'function') ? normalize(recetaRaw||{}) : (recetaRaw||{});
  const med = r.medico || {};

  // M√©dico
  writeField('doctorNombre', prefixMed(med.nombre ?? r.medicoNombre, med.genero ?? r.medicoGenero));
  writeField('doctorCedula', med.cedula ?? r.medicoCedula);
  writeField('doctorEsp',    med.especialidad ?? r.medicoEspecialidad);
  writeField('doctorTel',    med.telefono ?? r.medicoTelefono);
  writeField('doctorDir',    med.direccion ?? r.medicoDomicilio);

  // Paciente
  writeField('pacienteNombre', r.paciente?.nombre ?? r.nombrePaciente ?? r.pacienteNombre);
  writeField('pacEdad',        r.paciente?.edad ?? r.edad);
  writeField('pacSexo',        r.paciente?.sexo ?? r.sexo);
  writeField('pacPeso',        r.paciente?.peso ?? r.peso);
  writeField('pacTalla',       r.paciente?.talla ?? r.talla);
  writeField('pacTemp',        r.paciente?.temperatura ?? r.temperatura);
  writeField('pacPresion',     r.paciente?.presion ?? r.presion);
  writeField('pacIMC',         r.paciente?.imc ?? r.imc);

  // Textos
  writeField('obsTexto',  r.observaciones);
  writeField('diagTexto', r.diagnostico);

  // ID y fecha
  writeField('recetaId', 'ID: ' + (r.id || '‚Äî'));
  try{
    let ts = r.timestamp;
    if (ts && typeof ts.toDate==='function') ts = ts.toDate();
    else if (ts && typeof ts.seconds==='number') ts = new Date(ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6));
    else if (!(ts instanceof Date)) ts = new Date(ts);
    writeField('fechaEmision', ts ? ts.toLocaleString('es-MX',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '‚Äî');
  }catch{ writeField('fechaEmision', '‚Äî'); }

  // Si alg√∫n overlay tapa la vista, lo escondemos
  ['#badgeVerificando','#spinnerVerificando','#panelVerificando','[data-role="verificando"]','.verificando','.spinner-verify']
    .forEach(sel => document.querySelectorAll(sel).forEach(el=>el.style.display='none'));
}

// üëâ Llama a paintFields dentro de tu renderOnce
// Ejemplo mini de integraci√≥n:
if (typeof renderOnce === 'function'){
  const _renderOnce = renderOnce;
  window.renderOnce = async function(){
    const out = await _renderOnce();
    paintFields(window.RECETA_ACTUAL); // pinta al final
    return out;
  };
} else {
  // Si a√∫n no existe renderOnce, pinta cuando cargue el DOM
  document.readyState === 'loading'
    ? document.addEventListener('DOMContentLoaded', ()=>paintFields(window.RECETA_ACTUAL), {once:true})
    : paintFields(window.RECETA_ACTUAL);
}
  // ===== Boot =====
  function start(){
    renderOnce().catch(console.error);
    bindButtons();
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start, {once:true});
  } else {
    start();
  }
})();
</script>
