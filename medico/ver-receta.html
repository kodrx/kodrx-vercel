<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KodRx | Receta Digital</title>

<style>
/* ===== Layout general ===== */
body{margin:0;background:#ffffff;color:#0f172a;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
.receta-wrap{max-width:940px;margin:16px auto;padding:12px}
.receta{display:grid;grid-template-columns:1fr 340px;gap:16px;align-items:start}

/* Header */
.receta-header{grid-column:1/-1;background:#F0F5FF;color:#0b1b2b;padding:14px 16px;border-radius:12px;font-weight:700}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;margin-left:8px}
.badge.ok{background:#e7f6e8;color:#0b8b2b}
.badge.warn{background:#fff3cd;color:#7a5a00}

/* Acciones */
.actions{grid-column:1/-1;display:flex;gap:12px;padding:8px 0;flex-wrap:wrap}
button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.primary{background:#0b5bd3;color:#fff}
.ghost{background:#eef2ff;color:#0b1b2b;border:1px solid #dbe3ff}

/* Cards / contenido */
.card{background:#f8fafc;border:1px solid #e0e7f0;border-radius:14px;padding:12px}
.card .title{color:#6b7280;font-weight:800;letter-spacing:.02em;margin:2px 0 8px;text-transform:uppercase}
.kv{color:#111827;font-size:14px;line-height:1.35}
.kv b{color:#6b7280;margin-right:6px}
.card,.kv,.sub{overflow-wrap:anywhere;word-break:break-word}

/* Columna derecha */
.col-right{display:flex;flex-direction:column;gap:16px}
.meds{white-space:pre-wrap;font-size:14px;line-height:1.35;color:#111827}

/* QRs */
.qr-frame{border:2px solid #0b5bd3;border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:center;background:#fff}
.qr-legend{color:#0b5bd3;font-weight:700;font-size:12px;text-align:center;margin-top:6px}
.qr-main img{width:220px;height:220px}
.qr-chain img{width:110px;height:110px}

/* CÃ³digo de barras (pantalla) */
#panelBarcode canvas{max-width:100%}

/* Hash + footer */
.hash{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;color:#374151;font-size:12px}
.footer{grid-column:1/-1;background:#0b5bd3;color:#fff;border-radius:12px;padding:12px 16px;text-align:center;font-weight:700;margin-top:6px}

/* Responsive */
@media (max-width:920px){
  .receta{grid-template-columns:1fr}
  .qr-main img{width:200px;height:200px}
  .qr-chain img{width:100px;height:100px}
}
@media (max-width:520px){
  .qr-main img{width:180px;height:180px}
  .qr-chain img{width:90px;height:90px}
}

/* En impresiÃ³n ocultamos botones; preferimos imprimir el PDF generado */
@media print{ .actions{display:none!important} }
</style>
</head>
<body>

<div class="receta-wrap">
  <div class="actions">
    <button class="ghost" id="btnRegresar">Regresar</button>
    <button class="primary" id="btnDescargar">Descargar PDF</button>
    <button class="ghost" id="btnImprimir">Imprimir</button>
  </div>

  <div class="receta">
    <!-- Header -->
    <div class="receta-header">
      KodRx â€” Receta mÃ©dica digital
      <span id="badgeOrigen" class="badge warn">MOCK</span>
    </div>


    <!-- Columna IZQUIERDA -->
    <div class="col-left" style="display:flex;flex-direction:column;gap:16px">
      <section class="card">
        <div class="title">MÃ‰DICO</div>
        <div class="kv" id="doctorNombre">â€”</div>
        <div class="kv"><b>CÃ©dula:</b> <span id="doctorCedula">â€”</span> &nbsp;&nbsp; <b>Especialidad:</b> <span id="doctorEsp">â€”</span></div>
        <div class="kv"><b>Tel:</b> <span id="doctorTel">â€”</span></div>
        <div class="kv"><b>DirecciÃ³n:</b> <span id="doctorDir">â€”</span></div>
      </section>

      <section class="card">
        <div class="title">PACIENTE</div>
        <div class="kv" id="pacienteNombre">â€”</div>
        <div class="kv sub" style="margin-top:6px">
          <span id="fechaEmision">â€”</span> &nbsp;&nbsp; <span id="recetaId">ID: â€”</span>
        </div>
        <div class="kv" style="margin-top:8px">
          <b>Edad:</b> <span id="pacEdad">â€”</span> &nbsp;&nbsp; <b>Sexo:</b> <span id="pacSexo">â€”</span>
        </div>
        <div class="kv"><b>Peso:</b> <span id="pacPeso">â€”</span> &nbsp;&nbsp; <b>Talla:</b> <span id="pacTalla">â€”</span></div>
        <div class="kv"><b>Temp:</b> <span id="pacTemp">â€”</span> &nbsp;&nbsp; <b>PA:</b> <span id="pacPresion">â€”</span></div>
        <div class="kv"><b>IMC:</b> <span id="pacIMC">â€”</span></div>
      </section>

      <section class="card">
        <div class="title">OBSERVACIONES</div>
        <div class="kv" id="obsTexto">â€”</div>
      </section>

      <section class="card">
        <div class="title">DIAGNÃ“STICO</div>
        <div class="kv" id="diagTexto">â€”</div>
      </section>
    </div>

    <!-- Columna DERECHA -->
    <div class="col-right">
      <section class="card">
        <div class="title">MEDICAMENTOS</div>
        <pre class="meds" id="listaMedsDerecha">â€”</pre>
      </section>

      <section class="card" style="text-align:center">
        <div class="qr-frame qr-main"><div id="qrMain"></div></div>
        <div class="qr-legend">Receta</div>
      </section>

      <section class="card" id="panelBarcode">
        <div class="title">CÃ“DIGO DE BARRAS (ID)</div>
        <div style="display:flex;justify-content:center">
          <canvas id="barcodeCanvas" width="300" height="80"></canvas>
        </div>
        <div class="sub" style="text-align:center;margin-top:4px"><span id="barcodeLabel">â€”</span></div>
      </section>

      <section class="card">
        <div class="title">HASH</div>
        <div class="hash" id="hashTexto">hash: â€”</div>
      </section>

      <section class="card" style="text-align:center">
        <div class="qr-frame qr-chain"><div id="qrChain"></div></div>
        <div class="qr-legend">
          Blockchain<br>
          <span id="blockNum" style="color:#111827;font-weight:800"></span><br>
          <span class="sub" style="color:#6b7280;font-weight:400">Para verificar receta visitar kodrx.app</span>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <div class="footer">Creada con KodRx. Plataforma digital de recetas verificadas con trazabilidad tecnolÃ³gica.</div>
    <p id="bcStatus" class="pill" style="display:inline-block;">Verificando blockchainâ€¦</p>
  </div>
</div>

<!-- jsPDF (UMD) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
/* === KODRX anti-MOCK badge fixer (clean) === */
(() => {
  console.log('[badge-fix] boot');

  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  async function waitFor(fn, max=8000, step=100){
    const t0=Date.now();
    while(Date.now()-t0<max){
      const v = fn();
      if (v) return v;
      await sleep(step);
    }
    return null;
  }

  function computeStatus(receta){
    const bc = receta?.blockchain || {};
    if (bc.status === 'ok') return { text:'SELLADO EN BLOCKCHAIN', cls:'badge ok',   bg:'#16a34a', fg:'#fff' };
    if (bc.status === 'simulado' || receta?.hash) return { text:'SELLADO SIMULADO',  cls:'badge warn', bg:'#f59e0b', fg:'#111' };
    return { text:'PENDIENTE',                  cls:'badge warn', bg:'#9ca3af', fg:'#111' };
  }

  function applyBadge(el, receta){
    const st = computeStatus(receta);
    el.textContent   = st.text;
    el.className     = st.cls;
    // fallback por si tu CSS no define .ok/.warn
    el.style.background = st.bg;
    el.style.color      = st.fg;
  }

  async function init(){
    // Espera receta y badge
    const receta = await waitFor(()=>window.RECETA_ACTUAL, 10000, 120);
    const badge  = await waitFor(()=>document.getElementById('badgeOrigen'), 10000, 120);
    if (!badge) return;

    // Aplica una vez
    applyBadge(badge, receta || {});
    console.log('[badge-fix] applied once');

    // 1) Observa reescrituras del badge (si alguien vuelve a poner MOCK)
    const mo = new MutationObserver(()=>{
      if (!badge.isConnected){ mo.disconnect(); return; }
      if ((badge.textContent||'').toUpperCase().includes('MOCK')){
        applyBadge(badge, window.RECETA_ACTUAL || {});
        console.log('[badge-fix] re-applied after MOCK rewrite');
      }
    });
    mo.observe(badge, { childList:true, characterData:true, subtree:true });

    // 2) Hook a renderReceta/verificarBlockchain para re-aplicar al final
    const oldRender = window.renderReceta;
    if (typeof oldRender === 'function'){
      window.renderReceta = function(r){
        const res = oldRender.apply(this, arguments);
        try { applyBadge(badge, r || window.RECETA_ACTUAL || {}); } catch {}
        return res;
      };
    }
    const oldVerify = window.verificarBlockchain;
    if (typeof oldVerify === 'function'){
      window.verificarBlockchain = async function(){
        try { return await oldVerify.apply(this, arguments); }
        finally { try { applyBadge(badge, window.RECETA_ACTUAL || {}); } catch {} }
      };
    }

    // 3) Reaplica si cambia el hash (p.ej. tras sellado)
    let lastHash = window.RECETA_ACTUAL?.hash ?? null;
    setInterval(()=>{
      const h = window.RECETA_ACTUAL?.hash ?? null;
      if (h !== lastHash){ lastHash = h; applyBadge(badge, window.RECETA_ACTUAL || {}); }
    }, 800);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { once:true });
  } else {
    init();
  }
})();
</script>

<script>
/* === KODRX anti-MOCK badge fixer (sticky, observa todo el DOM) === */
(() => {
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  async function waitReceta(max=10000, step=120){
    const t0=Date.now();
    while(Date.now()-t0<max){
      if (window.RECETA_ACTUAL) return window.RECETA_ACTUAL;
      await sleep(step);
    }
    return {};
  }

  function computeStatus(receta){
  const bc = receta?.blockchain || {};
  const legacyBlock = Number.isFinite(receta?.bloque) && receta.bloque > 0;
  const bcBlock     = Number.isFinite(bc?.block) || typeof bc?.block === 'string' || typeof bc?.tx === 'string';

  // âœ… considera bloque legacy o block/tx en la nueva estructura como "ok"
  if (bc.status === 'ok' || legacyBlock || bcBlock) {
    return { text:'SELLADO EN BLOCKCHAIN', cls:'badge ok', bg:'#16a34a', fg:'#fff' };
  }
  // ðŸ”¶ si no hay block pero sÃ­ hash (o status 'simulado'): "simulado"
  if (bc.status === 'simulado' || receta?.hash) {
    return { text:'SELLADO SIMULADO', cls:'badge warn', bg:'#f59e0b', fg:'#111' };
  }
  // â³ por defecto
  return { text:'PENDIENTE', cls:'badge warn', bg:'#9ca3af', fg:'#111' };
}

  function applyBadge(el, receta){
    const st = computeStatus(receta);
    // solo reescribe si estÃ¡ MOCK o si nunca aplicamos
    if (!el.__kodrxApplied || (el.textContent||'').toUpperCase().includes('MOCK')) {
      el.textContent = st.text;
      el.className   = st.cls;
      el.style.background = st.bg; // fallback si no hay CSS
      el.style.color      = st.fg;
      el.__kodrxApplied = true;
    }
  }

  async function start(){
    const receta0 = await waitReceta();

    const update = ()=>{
      const receta = window.RECETA_ACTUAL || receta0 || {};
      const el = document.getElementById('badgeOrigen');
      if (!el) return;
      applyBadge(el, receta);
    };

    // 1) Primera aplicaciÃ³n
    update();

    // 2) Observa TODO el documento por si reemplazan el badge
    const mo = new MutationObserver(() => update());
    mo.observe(document.body, { childList:true, subtree:true, characterData:true });

    // 3) Reaplica periÃ³dicamente un rato (por si hay renders tardÃ­os)
    let ticks = 0;
    const t = setInterval(() => { update(); if (++ticks > 120) clearInterval(t); }, 500);

    // 4) Hooks a tus funciones (si existen)
    const oldRender = window.renderReceta;
    window.renderReceta = function(){
      const res = typeof oldRender==='function' ? oldRender.apply(this, arguments) : undefined;
      update(); return res;
    };
    const oldVerify = window.verificarBlockchain;
    window.verificarBlockchain = async function(){
      try { return typeof oldVerify==='function' ? await oldVerify.apply(this, arguments) : undefined; }
      finally { update(); }
    };
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start, { once:true });
  } else {
    start();
  }
})();
</script>

<script>
/* === KODRX ver-receta: HIDRATADOR DE RECETA (merge desde Firestore) === */
(async () => {
  try {
    const qs = new URLSearchParams(location.search);
    const id = (qs.get('id') || '').trim();
    if (!id) return;

    // imports dinÃ¡micos para no depender de mÃ³dulos
    const core = await import('/firebase-init.js');
    const fs   = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');

    const ref  = fs.doc(core.db, 'recetas', id);
    const snap = await fs.getDoc(ref);
    if (!snap.exists()) return;

    const data = snap.data() || {};
    // Fusiona TODO en RECETA_ACTUAL conservando el id
    const prev = window.RECETA_ACTUAL || {};
    window.RECETA_ACTUAL = Object.assign({ id: snap.id }, prev, data);

    // Log de diagnÃ³stico
    console.log('[hydrate] receta', {
      id: snap.id,
      hasBlockchain: !!data.blockchain,
      blockchain: data.blockchain,
      hash: data.hash,
      bloque: data.bloque
    });

    // Re-aplica badge si existe
    const el = document.getElementById('badgeOrigen');
    if (el) {
      const bc = window.RECETA_ACTUAL.blockchain || {};
      let text = 'PENDIENTE', cls='badge warn', bg='#9ca3af', fg='#111';
      if (bc.status === 'ok') { text='SELLADO EN BLOCKCHAIN'; cls='badge ok'; bg='#16a34a'; fg='#fff'; }
      else if (bc.status === 'simulado' || window.RECETA_ACTUAL.hash) {
        text='SELLADO SIMULADO'; cls='badge warn'; bg='#f59e0b'; fg='#111';
      }
      el.textContent = text;
      el.className   = cls;
      el.style.background = bg;
      el.style.color      = fg;
    }
  } catch (e) {
    console.warn('[hydrate] fallo al rehidratar receta', e);
  }
})();
</script>



</body>
</html>


