<!DOCTYPE html>
<html lang="es">
<head>
  <script type="module">
  import { db } from "/firebase-init.js";
  import {
    doc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // exp√≥n a window para que los vea el script inline cl√°sico
  window.db = db;
  window.__fs = { doc, updateDoc, serverTimestamp };
</script>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KodRx | Receta Digital</title>

<style>
/* ===== Layout general ===== */
html, body { height: 100%; }
body { min-height: 100svh; margin: 0; display: block; } /* ‚Üê quitamos flex aqu√≠ */

/* Contenedor ra√≠z: 2 filas ‚Üí [contenido flexible][footer auto] */
.receta-root{
  min-height: 100svh;
  display: grid;
  grid-template-rows: 1fr auto;
}
.receta-wrap{
  /* lo que ya ten√≠as */
  flex:1 0 auto;
  max-width:940px;
  margin:16px auto;
  padding:12px;

  /* lo que faltaba ‚Üí grid de 2 columnas */
  display:grid !important;
  grid-template-columns: minmax(0,1fr) 340px;
  gap:16px;
  align-items:start;
}
/* evita que el contenido rompa el grid */
.col-left, .col-right{ min-width:0; }
/* Header */
.receta-header{grid-column:1/-1;background:#F0F5FF;color:#0b1b2b;padding:14px 16px;border-radius:12px;font-weight:700}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;margin-left:8px}
.badge.ok{background:#e7f6e8;color:#0b8b2b}
.badge.warn{background:#fff3cd;color:#7a5a00}

/* Acciones */
.actions{grid-column:1/-1;display:flex;gap:12px;padding:8px 0;flex-wrap:wrap}
button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.primary{background:#0b5bd3;color:#fff}
.ghost{background:#eef2ff;color:#0b1b2b;border:1px solid #dbe3ff}

/* Cards / contenido */
.card{background:#f8fafc;border:1px solid #e0e7f0;border-radius:14px;padding:12px}
.card .title{color:#6b7280;font-weight:800;letter-spacing:.02em;margin:2px 0 8px;text-transform:uppercase}
.kv{color:#111827;font-size:14px;line-height:1.35}
.kv b{color:#6b7280;margin-right:6px}
.card,.kv,.sub{overflow-wrap:anywhere;word-break:break-word}

/* Columna derecha */
.col-right{display:flex;flex-direction:column;gap:16px}
.meds{white-space:pre-wrap;font-size:14px;line-height:1.35;color:#111827}

/* QRs */
.qr-frame{border:2px solid #0b5bd3;border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:center;background:#fff}
.qr-legend{color:#0b5bd3;font-weight:700;font-size:12px;text-align:center;margin-top:6px}
.qr-main img{width:220px;height:220px}
.qr-chain img{width:110px;height:110px}

/* C√≥digo de barras (pantalla) */
#panelBarcode canvas{max-width:100%}

/* Hash + footer */
.hash{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;color:#374151;font-size:12px}


  .footer{
  /* si el padre es grid, ocupa todo; si no, tambi√©n :) */
  grid-column: 1 / -1;

  background:#0b5bd3;
  color:#fff;
  border-radius:12px;
  padding:12px 16px;
  text-align:center;
  font-weight:700;

  /* claves para que quede pegado abajo en layout flex-col */
  margin-top:auto;
  display:block;
  width:100%;
  align-self:stretch;
}
.qr-frame.qr-main  { width:260px; height:260px; }
  .qr-frame.qr-chain { width:220px; height:220px; }
  #barcodeCanvas     { width:300px; height:80px; display:block; }
/* Responsive */
@media (max-width:920px){
  .receta-wrap{ grid-template-columns:1fr; }
  .qr-main img{width:200px;height:200px}
  .qr-chain img{width:100px;height:100px}
}
@media (max-width:520px){
  .qr-main img{width:180px;height:180px}
  .qr-chain img{width:90px;height:90px}
}

/* En impresi√≥n ocultamos botones; preferimos imprimir el PDF generado */
@media print{ .actions{display:none!important} }
</style>
</head>


<body>
  <div class="receta-root"><!-- wrapper para sticky footer -->

    <div class="receta-wrap"><!-- √öNICO grid de 2 columnas -->

      <!-- Acciones (ocupa ambas columnas) -->
     <section class="card actions" style="gap:8px; padding:12px">
  <button id="btnVolver" type="button" class="btn">Regresar</button>
  <button id="btnDescargar" type="button" class="btn">Descargar PDF</button>
  <button id="btnImprimir"  type="button" class="btn">Imprimir</button>
</section>
      <!-- Header (ocupa ambas columnas) -->
      <div class="receta-header">
        KodRx ‚Äî Receta m√©dica digital
        <span id="badgeOrigen" class="badge warn">MOCK</span>
      </div>


      <!-- Columna IZQUIERDA -->
      <div class="col-left" style="display:flex;flex-direction:column;gap:16px">
        <section class="card">
          <div class="title">M√âDICO</div>
          <div class="kv" id="doctorNombre">‚Äî</div>
          <div class="kv"><b>C√©dula:</b> <span id="doctorCedula">‚Äî</span> &nbsp;&nbsp; <b>Especialidad:</b> <span id="doctorEsp">‚Äî</span></div>
          <div class="kv"><b>Tel:</b> <span id="doctorTel">‚Äî</span></div>
          <div class="kv"><b>Direcci√≥n:</b> <span id="doctorDir">‚Äî</span></div>
        </section>

        <section class="card">
          <div class="title">PACIENTE</div>
          <div class="kv" id="pacienteNombre">‚Äî</div>
          <div class="kv sub" style="margin-top:6px">
            <span id="fechaEmision">‚Äî</span> &nbsp;&nbsp; <span id="recetaId">ID: ‚Äî</span>
          </div>
          <div class="kv" style="margin-top:8px">
            <b>Edad:</b> <span id="pacEdad">‚Äî</span> &nbsp;&nbsp; <b>Sexo:</b> <span id="pacSexo">‚Äî</span>
          </div>
          <div class="kv"><b>Peso:</b> <span id="pacPeso">‚Äî</span> &nbsp;&nbsp; <b>Talla:</b> <span id="pacTalla">‚Äî</span></div>
          <div class="kv"><b>Temp:</b> <span id="pacTemp">‚Äî</span> &nbsp;&nbsp; <b>PA:</b> <span id="pacPresion">‚Äî</span></div>
          <div class="kv"><b>IMC:</b> <span id="pacIMC">‚Äî</span></div>
        </section>

        <section class="card">
          <div class="title">OBSERVACIONES</div>
          <div class="kv" id="obsTexto">‚Äî</div>
        </section>

        <section class="card">
          <div class="title">DIAGN√ìSTICO</div>
          <div class="kv" id="diagTexto">‚Äî</div>
        </section>
      </div><!-- /.col-left -->

      <!-- Columna DERECHA -->
      <div class="col-right">
        <section class="card">
          <div class="title">MEDICAMENTOS</div>
          <pre class="meds" id="listaMedsDerecha">‚Äî</pre>
        </section>

        <section class="card" style="text-align:center">
          <div class="qr-frame qr-main"><div id="qrMain"></div></div>
          <div class="qr-legend">Receta</div>
        </section>

        <section class="card" id="panelBarcode">
          <div class="title">C√ìDIGO DE BARRAS (ID)</div>
          <div style="display:flex;justify-content:center">
            <canvas id="barcodeCanvas" width="300" height="80"></canvas>
          </div>
          <div class="sub" style="text-align:center;margin-top:4px">
            <span id="barcodeLabel">‚Äî</span>
          </div>
        </section>

        <section class="card">
          <div class="title">HASH</div>
          <div class="hash" id="hashTexto">hash: ‚Äî</div>
        </section>

        <section class="card" style="text-align:center">
          <div class="qr-frame qr-chain"><div id="qrChain"></div></div>
          <div class="qr-legend">
            Blockchain<br>
            <span id="blockNum" style="color:#111827;font-weight:800"></span><br>
            <span class="sub" style="color:#6b7280;font-weight:400">Para consultar bloque visitar kodrx.app</span>
          </div>
        </section>
      </div><!-- /.col-right -->
    </div><!-- /.receta-wrap -->

    <!-- Pill de estado (lo ocultamos desde JS al terminar verificaci√≥n) -->
    <div id="verifyScope" data-role="verificando">
  <p id="bcStatus" class="pill verificando">Verificando blockchain‚Ä¶</p>
  <div id="panelVerificando" class="verificando spinner-verify">‚Ä¶spinner‚Ä¶</div>
</div>

    <!-- Footer -->
    <div class="footer">
      Creada con KodRx. Plataforma digital de recetas verificadas con trazabilidad tecnol√≥gica.
    </div>
  </div><!-- /.receta-root -->

</body>
</html>



<!-- jsPDF (UMD) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
;(() => {
  'use strict';
  if (window.__KODRX_VER_INLINE_V7__) return;
  window.__KODRX_VER_INLINE_V7__ = true;

  /* ===== utils ===== */
/* ====== Config ====== */
const BC_BASE = 'https://kodrx-blockchain.onrender.com';

/* ====== Libs (idempotente) ====== */
async function ensureLibs(){
  const jobs = [];
  // QR
  if (!window.QRCode && !window.qrcode){
    jobs.push(new Promise((res,rej)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';
      s.onload=res; s.onerror=rej; document.head.appendChild(s);
    }));
  }
  // C√≥digo de barras
  if (!window.JsBarcode){
    jobs.push(new Promise((res,rej)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js';
      s.onload=res; s.onerror=rej; document.head.appendChild(s);
    }));
  }
  // jsPDF (por si alguien lo quit√≥)
  if (!window.jspdf?.jsPDF){
    jobs.push(new Promise((res,rej)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
      s.onload=res; s.onerror=rej; document.head.appendChild(s);
    }));
  }
  if (jobs.length) await Promise.allSettled(jobs);
}
// compat: no pinta, solo asegura
async function ensureQRCode(){ return ensureLibs(); }

/* ====== Helpers QR ====== */
function makeQR(host, text, size){
  if (!host) return false;
  const QR = window.QRCode || window.qrcode;
  if (!QR) return false;
  host.innerHTML = '';
  if (window.QRCode){ // qrcodejs cl√°sico
    new QRCode(host, { text, width:size, height:size, correctLevel: QRCode.CorrectLevel.M });
    return true;
  }
  try{
    if (QR.toCanvas){
      const c = document.createElement('canvas');
      host.appendChild(c);
      QR.toCanvas(c, text, { width: size });
      return true;
    }
  }catch{}
  return false;
}

async function makeQRDataURLCompat(text, size=220){
  await ensureLibs();
  try{
    if (window.qrcode?.toDataURL){
      return await window.qrcode.toDataURL(text, { width:size, margin:1 });
    }
    if (window.QRCode){
      const div=document.createElement('div');
      new QRCode(div, { text, width:size, height:size, correctLevel:(window.QRCode.CorrectLevel?.M ?? 1) });
      await new Promise(r=>setTimeout(r,0));
      const img=div.querySelector('img'); if (img?.src) return img.src;
      const c  =div.querySelector('canvas'); if (c) return c.toDataURL('image/png');
    }
  }catch{}
  return '';
}

/* ====== DB helpers ====== */
let __fsMod=null;
async function _fs(){
  if (window.__fs) return window.__fs; // si ya los expusiste
  if (!__fsMod) __fsMod = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
  return __fsMod;
}
async function getDB(){
  if (window.db) return window.db;
  const core = await import('/firebase-init.js');
  return core.db;
}

/* ====== QR Chain (bloque) ====== */
async function setChainQR(block){
  const host = document.getElementById('qrChain');
  if (!host) return;
  await ensureQRCode();
  const url = `${BC_BASE}/verificar.html?id=${encodeURIComponent(block)}`;
  makeQR(host, url, 220);
  const bn = document.getElementById('blockNum');
  if (bn) bn.textContent = String(block || '‚Äî');
}

/* ====== Fuente de QRs para PDF ====== */
async function getQRSources(receta){
  const out = {};
  const mainNode  = document.querySelector('#qrMain canvas, #qrMain img');
  const chainNode = document.querySelector('#qrChain canvas, #qrChain img');

  if (mainNode)  out.main  = mainNode.tagName==='IMG' ? mainNode.src  : mainNode.toDataURL('image/png');
  if (chainNode) out.chain = chainNode.tagName==='IMG'? chainNode.src : chainNode.toDataURL('image/png');

  if (!out.main){
    const verURL = `${location.origin}${location.pathname}?id=${encodeURIComponent(receta.id)}`;
    out.main = await makeQRDataURLCompat(verURL, 220);
  }
  if (!out.chain){
    const blk = receta?.blockchain?.block ?? receta?.bloque ?? null;
    if (blk){
      out.chain = await makeQRDataURLCompat(`${BC_BASE}/verificar.html?id=${encodeURIComponent(blk)}`, 220);
    }
  }
  return out;
}


  function updateBadgeFromReceta(r){
  const el = document.getElementById('badgeOrigen'); if(!el) return;
  const hasBlock = (r?.blockchain?.block ?? r?.bloque) != null;     // admite recetas viejas
  const hasHash  = !!(r?.blockchain?.hash ?? r?.hash);

  const S = hasBlock ? {txt:'SELLADO EN BLOCKCHAIN', cls:'badge ok',   bg:'#16a34a', fg:'#fff'}
        : hasHash   ? {txt:'SELLADO SIMULADO',      cls:'badge warn', bg:'#f59e0b', fg:'#111'}
                    : {txt:'PENDIENTE',             cls:'badge warn', bg:'#9ca3af', fg:'#111'};

  el.textContent = S.txt; el.className = S.cls; el.style.background = S.bg; el.style.color = S.fg;
}

  async function hydrateIfNeeded(){
    if (window.RECETA_ACTUAL && (window.RECETA_ACTUAL.blockchain || window.RECETA_ACTUAL.hash || window.RECETA_ACTUAL.bloque)) return;
    try{
      const id = new URLSearchParams(location.search).get('id');
      if (!id) return;
      const core = await import('/firebase-init.js');
      const fs   = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
      const snap = await fs.getDoc(fs.doc(core.db,'recetas',id));
      if (snap.exists()) window.RECETA_ACTUAL = { id:snap.id, ...(window.RECETA_ACTUAL||{}), ...(snap.data()||{}) };
    }catch(e){ console.warn('[ver] hydrate warn', e); }
  }


 

/* Iniciales por si no fueron guardadas (AMO-IBU-PAR) */
function inicialesDeMeds(meds){
  return (meds||[])
    .map(m => String(m?.nombre||'').trim().split(/\s+/).map(w=>w[0]||'').join('').slice(0,3).toUpperCase())
    .filter(Boolean).join('-');
}

/* Carga on-demand funciones de Firestore que necesitamos para actualizar */
let __fsMod = null;
async function _fs(){
  if (window.__fs) return window.__fs;  // ‚Üê usa el shim si existe
  if (__fsMod) return __fsMod;
  __fsMod = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
  return __fsMod;
}

  async function getQRSources(receta){
  const out = {};

  // 1) leer del DOM si ya est√°n renderizados
  const mainNode  = document.querySelector('#qrMain canvas, #qrMain img');
  const chainNode = document.querySelector('#qrChain canvas, #qrChain img');

  if (mainNode)  out.main  = mainNode.tagName==='IMG' ? mainNode.src  : mainNode.toDataURL('image/png');
  if (chainNode) out.chain = chainNode.tagName==='IMG'? chainNode.src : chainNode.toDataURL('image/png');

  // 2) fallback: regenerar
  if (!out.main) {
    const verURL = location.origin + '/public/ver-receta.html?id=' + encodeURIComponent(receta.id);
    out.main = await makeQRDataURLCompat(verURL, 220);
  }
  if (!out.chain) {
    const blk = receta?.blockchain?.block ?? receta?.bloque ?? null;
    if (blk) {
      const base = (typeof BC_BASE==='string' ? BC_BASE : 'https://kodrx-blockchain.onrender.com');
      out.chain = await makeQRDataURLCompat(`${base}/verificar.html?id=${encodeURIComponent(blk)}`, 220);
    }
  }

  return out;
}



/* Construye el QR del bloque (solo ?id=<bloque>) */
async function setChainQR(block){
  const host = document.getElementById('qrChain');
  if (!host) return;
  await ensureQRCode();               // üëà asegura la lib

  const url = `${BC_BASE}/verificar.html?id=${encodeURIComponent(block)}`;
  host.innerHTML = '';
  new QRCode(host, { text: url, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.M });

  const bn = document.getElementById('blockNum');
  if (bn) bn.textContent = String(block || '‚Äî');
}


// helper opcional para limpiar acentos y dejar solo A-Z/.- en iniciales
function sanitizeInitials(str){
  return String(str||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .toUpperCase().replace(/[^A-Z.\-]/g,'');
}

const __locks = new Set();

async function sellIfPending(receta){
  try{
    if (!receta?.id) return receta;

    // si ya tiene bloque ‚Üí pinta QR/Badge y sal
    const hasBlock = (receta.blockchain?.block ?? receta.bloque) != null;
    if (hasBlock){
      await setChainQR(receta.blockchain?.block ?? receta.bloque);
      updateBadgeFromReceta?.(receta);
      window.killVerificandoUI?.();
      return receta;
    }

    // evita reintentos en 30s
    const k='bc-selling-'+receta.id;
    if (__locks.has(k) || localStorage.getItem(k)) return receta;
    __locks.add(k); localStorage.setItem(k, Date.now().toString());
    setTimeout(()=>{ __locks.delete(k); localStorage.removeItem(k); }, 30_000);

    window.bcStart?.();

    // payload para proxy
    const tsSec =
      (receta.timestamp && typeof receta.timestamp.toDate === 'function')
        ? Math.floor(receta.timestamp.toDate().getTime()/1000)
        : (receta.timestamp?.seconds ?? Math.floor(Date.now()/1000));

    const meds = Array.isArray(receta.medicamentos) ? receta.medicamentos : [];
    const recetaResumen = meds.map(m => `${m.nombre} ${m.dosis} por ${m.duracion}`).join(', ');
    const inicialesArr =
      Array.isArray(receta.iniciales) && receta.iniciales.length
        ? receta.iniciales
        : (receta.medsIniciales || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().split('-').filter(Boolean);

    const payload = {
      receta: recetaResumen,
      medico: receta.medicoNombre || receta.medico?.nombre || '',
      cedula: receta.medicoCedula || receta.medico?.cedula || '',
      medicamentos: meds,
      iniciales: inicialesArr,
      idReceta: receta.id,
      timestamp: tsSec
    };
    // console.log('[bc] payload /api/bloques:', payload);

    const resp = await fetch('/api/bloques', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    let raw = {}; try{ raw = await resp.json(); }catch{}
    // console.log('[bc] raw /api/bloques:', raw);

    const toNum = v => (typeof v==='number'&&Number.isFinite(v)) ? v : (/^\d+$/.test(String(v??'')) ? Number(v) : NaN);
    const block = [raw?.bloque?.index, raw?.index, raw?.bloqueIndex, raw?.block].map(toNum).find(Number.isFinite);
    const hash  =  raw?.bloque?.hash || raw?.hash || raw?.blockHash || raw?.txid || null;

    if (!(resp.ok && Number.isFinite(block) && hash)) {
      // pendiente
      window.bcError?.(); window.killVerificandoUI?.();
      return receta;
    }

    // actualizar Firestore
    try{
      const {doc, updateDoc, serverTimestamp} = await _fs();
      const db = await getDB();
      await updateDoc(doc(db,'recetas', receta.id), {
        blockchain: { status:'ok', block, hash, at: serverTimestamp() },
        bloque: block,
        hash
      });
    }catch(e){ console.warn('[bc] Firestore update fall√≥ (UI igual se actualiza):', e); }

    // refrescar UI
    receta.blockchain = { status:'ok', block, hash };
    receta.bloque = block; receta.hash = hash;
    window.RECETA_ACTUAL = receta;

    await setChainQR(block);
    updateBadgeFromReceta?.(receta);
    window.bcDone?.(receta);
    window.killVerificandoUI?.();

    return receta;
  }catch(err){
    console.error('[bc] sellIfPending error', err);
    window.bcError?.(); window.killVerificandoUI?.();
    return receta;
  }
}

  /* ===== badge ===== */
  function computeBadge(r){
    const bc=r.blockchain||{};
    const hasBlock = Number.isFinite(r.bloque) || typeof r.bloque==='string' ||
                     Number.isFinite(bc.block) || typeof bc.block==='string' || typeof bc.tx==='string';
    if (bc.status==='ok' || hasBlock) return {text:'SELLADO EN BLOCKCHAIN', cls:'badge ok', bg:'#16a34a', fg:'#fff'};
    if (bc.status==='simulado' || r.hash) return {text:'SELLADO SIMULADO', cls:'badge warn', bg:'#f59e0b', fg:'#111'};
    return {text:'PENDIENTE', cls:'badge warn', bg:'#9ca3af', fg:'#111'};
  }
  function paintBadge(r){
    const el=document.getElementById('badgeOrigen'); if(!el) return;
    const st=computeBadge(r);
    setText(el, st.text); setClass(el, st.cls);
    el.style.background=st.bg; el.style.color=st.fg;
  }


// ===== renderOnce: reemplazo seguro =====
async function renderOnce(){
  // Espera la receta normalizada
  for (let i=0;i<100;i++){
    if (window.RECETA_ACTUAL) break;
    await sleep(80);
  }
  await hydrateIfNeeded();

  const r0 = window.RECETA_ACTUAL;
  if (!r0) return;

  // Normaliza y deja en memoria
  const r = window.RECETA_ACTUAL = normalize(r0);

  // === RENDER DE CAMPOS (si ya tienes otra funci√≥n que lo hace, puedes omitir esta secci√≥n) ===
  const set = (id, v)=>{ const el=document.getElementById(id); if(el) el.textContent = (v ?? '‚Äî'); };

  // M√©dico
  set('doctorNombre', r.medico?.nombre ? (r.medico?.genero?.toLowerCase().startsWith('f')?'Dra. ':'Dr. ') + r.medico.nombre : (r.medicoNombre ? ( (r.medicoGenero||'').toLowerCase().startsWith('f')?'Dra. ':'Dr. ') + r.medicoNombre : '‚Äî'));
  set('doctorCedula', r.medico?.cedula ?? r.medicoCedula ?? '‚Äî');
  set('doctorEsp',    r.medico?.especialidad ?? r.medicoEspecialidad ?? '‚Äî');
  set('doctorTel',    r.medico?.telefono ?? r.medicoTelefono ?? '‚Äî');
  set('doctorDir',    r.medico?.direccion ?? r.medicoDomicilio ?? '‚Äî');

  // Paciente
  set('pacienteNombre', r.paciente?.nombre ?? r.nombrePaciente ?? '‚Äî');
  set('pacEdad',        r.paciente?.edad ?? r.edad ?? '‚Äî');
  set('pacSexo',        r.paciente?.sexo ?? r.sexo ?? '‚Äî');
  set('pacPeso',        r.paciente?.peso ?? r.peso ?? '‚Äî');
  set('pacTalla',       r.paciente?.talla ?? r.talla ?? '‚Äî');
  set('pacTemp',        r.paciente?.temperatura ?? r.temperatura ?? '‚Äî');
  set('pacPresion',     r.paciente?.presion ?? r.presion ?? '‚Äî');
  set('pacIMC',         r.paciente?.imc ?? r.imc ?? '‚Äî');

  // Texto libre
  set('obsTexto',  r.observaciones ?? '‚Äî');
  set('diagTexto', r.diagnostico   ?? '‚Äî');

  // ID y fecha
  set('recetaId', 'ID: ' + (r.id || '‚Äî'));
  try{
    let ts = r.timestamp;
    if (ts && typeof ts.toDate==='function') ts = ts.toDate();
    else if (ts && typeof ts.seconds==='number') ts=new Date(ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6));
    else if (!(ts instanceof Date)) ts = new Date(ts);
    set('fechaEmision', ts ? ts.toLocaleString('es-MX',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '‚Äî');
  }catch{ set('fechaEmision','‚Äî'); }

  // Medicamentos ‚Üí texto
  const meds = Array.isArray(r.medicamentos) ? r.medicamentos : [];
  const medsTxt = meds.length
    ? meds.map((m,i)=>`${i+1}. ${m.nombre}\n   Dosis: ${m.dosis}\n   Duraci√≥n: ${m.duracion}`).join('\n\n')
    : '‚Äî';
  const medsEl = document.getElementById('listaMedsDerecha');
  if (medsEl) medsEl.textContent = medsTxt;

  // Hash (si hay)
  const hashEl = document.getElementById('hashTexto');
  if (hashEl){
    const h = r.hash ?? r.blockchain?.hash ?? '';
    hashEl.textContent = h ? `hash (BC): ${h}` : (r.id ? `hash (local): ${hashSimulado(r)}` : 'hash: ‚Äî');
  }


 // ====== LIBRER√çAS + C√ìDIGOS ======
await ensureLibs();
await ensureQRCode();

// QR principal (link a ver-receta actual)
{
  const host = document.getElementById('qrMain');
  if (host && !host.querySelector('canvas,img')){
    const verURL = `${location.origin}${location.pathname}?id=${encodeURIComponent(r.id)}`;
    makeQR(host, verURL, 260);
  }
}

// C√≥digo de barras (ID)
{
  const canvas = document.getElementById('barcodeCanvas');
  const label  = document.getElementById('barcodeLabel');
  if (canvas && window.JsBarcode){
    try{
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const cssW=300, cssH=80;
      canvas.width=cssW*dpr; canvas.height=cssH*dpr;
      canvas.style.width=cssW+'px'; canvas.style.height=cssH+'px';
      const ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);

      JsBarcode(canvas, String(r.id||''), { format:'CODE128', width:2, height:40, margin:4, displayValue:false });
      if (label) label.textContent = r.id || '‚Äî';
    }catch(e){
      console.warn('[barcode] no se pudo generar', e);
      if (label) label.textContent = r.id || '‚Äî';
    }
  }
}

// QR de blockchain (si ya hay bloque) + sellado perezoso
{
  const blk = r?.blockchain?.block ?? r?.bloque ?? null;
  if (blk) { await setChainQR(blk); }
  sellIfPending(r); // no await
}

// Leyenda bajo bloque
{
  const legendHolder = document.querySelector('.qr-legend .sub');
  const text = 'Para consultar bloque visitar kodrx.app';
  if (legendHolder) legendHolder.textContent = text;
  else document.getElementById('blockNum')
        ?.insertAdjacentHTML('afterend','<br><span class="sub" style="color:#6b7280;font-weight:400">'+text+'</span>');
}

// QRs para PDF (deja esto si tu generarPDF usa window.QRS)
window.QRS = await getQRSources(r);

// Badge final
updateBadgeFromReceta(r);


  /* ===== PDF ===== */
 function prefixMedico(nombre,genero){
    if(!nombre) return '‚Äî';
    const g=(genero||'').toLowerCase();
    return (g.startsWith('f')?'Dra. ':'Dr. ')+nombre;
  }
  function hashSimulado(receta){
    try{
      const base = JSON.stringify({id:receta?.id, meds:receta?.medicamentos||[], t:receta?.timestamp||null});
      let h=0; for(let i=0;i<base.length;i++){ h=(h*31+base.charCodeAt(i))>>>0; }
      return ('00000000'+h.toString(16)).slice(-8)+'-'+btoa(unescape(encodeURIComponent(receta?.id||''))).replace(/=+$/,'');
    }catch{ return '‚Äî'; }
  }
  async function ensureJsBarcode(){
    if (window.JsBarcode) return;
    await new Promise((res,rej)=>{
      const s=document.createElement('script');
      s.src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js";
      s.onload=res; s.onerror=rej; document.head.appendChild(s);
    });
  }

  // Adaptador: mapea tu receta "actual" a la estructura legacy que esperaba tu generador antiguo
  function adaptLegacy(receta){
    const r = receta || {};
    const medico = {
      nombre: r.medicoNombre || '‚Äî',
      genero: r.medicoGenero || r.genero || '',
      cedula: r.medicoCedula || '‚Äî',
      especialidad: r.medicoEspecialidad || 'General',
      telefono: r.medicoTelefono || '',
      direccion: r.medicoDomicilio || ''
    };
    const paciente = {
      nombre: r.nombrePaciente || r.pacienteNombre || r.paciente || '‚Äî',
      edad:   r.edad ?? '‚Äî',
      sexo:   r.sexo || '‚Äî',
      peso:   r.peso ?? '‚Äî',
      talla:  r.talla ?? '‚Äî',
      temperatura: r.temperatura ?? '‚Äî',
      presion:     r.presion ?? '‚Äî',
      imc:         r.imc ?? '‚Äî'
    };
    const blockchain = r.blockchain || {};
    return {
      ...r,
      medico, paciente,
      hash: r.hash || blockchain.hash || null,
      bloque: (blockchain.block ?? r.bloque ?? null),
    };
  }

  // Generador "legacy" con paneles/columnas. Usa QRs desde el DOM (ya renderizados en la vista)
  window.generarPDF = async function generarPDF(recetaIn, qrsIn, {mode='save'}={}){
    // Cargar jsPDF si hace falta
    const jsPDF = await (async ()=>{
      if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
      await new Promise((res,rej)=>{ const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
        s.onload=res; s.onerror=rej; document.head.appendChild(s); });
      return window.jspdf?.jsPDF;
    })();
    if (!jsPDF){ alert('No se pudo cargar jsPDF'); return; }

    // Adaptar receta y QRs
    const receta = adaptLegacy(recetaIn);
 const qrSrc = await getQRSources(receta);
const mainQRUrl  = qrSrc.main  || qrs?.mainQRUrl  || '';
const chainQRUrl = qrSrc.chain || qrs?.chainQRUrl || '';

// ... luego doc.addImage(mainQRUrl, 'PNG', ...) y doc.addImage(chainQRUrl, 'PNG', ...)

    };

    const { jsPDF:Cls } = window.jspdf;
    const doc = new Cls({ unit:'pt', format:'letter', compress:true }); // 612 x 792
    const W = doc.internal.pageSize.getWidth(), H = doc.internal.pageSize.getHeight();

    // Geometr√≠a y estilo
    const Mx=40, gutter=16, CW=W-2*Mx, colW=(CW-gutter)/2, leftX=Mx, rightX=Mx+colW+gutter;
    const footerH=52, My=50, availYMax=H-My-footerH-10;

    const COLORS={panelFill:[248,250,252],panelStroke:[224,231,240],text:[17,24,39],sub:[55,65,81],label:[107,114,128],brand:[11,91,211]};
    const FONT='helvetica'; doc.setFont(FONT,'normal');

    // Utils de layout
    function header(){
      const headY=18, headH=50;
      doc.setFillColor(240,245,255); doc.roundedRect(18,headY,W-36,headH,9,9,'F');
      doc.setTextColor(11,27,43); doc.setFont(FONT,'bold'); doc.setFontSize(13);
      doc.text('KodRx ‚Äî Receta m√©dica digital', Mx, headY+30);
      doc.setFont(FONT,'normal'); return headY+headH+12;
    }
    function footer(){
      doc.setFillColor(...COLORS.brand); doc.rect(18,H-18-footerH,W-36,footerH,'F');
      doc.setTextColor(255,255,255); doc.setFont(FONT,'bold'); doc.setFontSize(10.5);
      doc.text('Creada con KodRx. Tecnolog√≠a que verifica, salud que protege.', W/2, H-22, {align:'center'});
    }
    function wrap(txt,w){ return doc.splitTextToSize(String(txt??'‚Äî'),w); }
    function sectionBox(x,y,w,contentH,title){
      const padX=10,padY=10,titleH=18,boxH=contentH+padY*2+titleH;
      const yClamped=Math.min(y, availYMax - boxH);
      doc.setFillColor(...COLORS.panelFill); doc.setDrawColor(...COLORS.panelStroke); doc.setLineWidth(0.8);
      doc.roundedRect(x,yClamped,w,boxH,8,8,'FD');
      doc.setTextColor(...COLORS.label); doc.setFont(FONT,'bold'); doc.setFontSize(10);
      doc.text(title,x+padX,yClamped+14);
      doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.text);
      return {cx:x+padX, cy:yClamped+14+padY, ny:yClamped+boxH+10, innerH:contentH};
    }
    function drawClamp(x,y,maxW,maxH,text,lineH=11){
      const lines=wrap(text,maxW); let used=0,lastY=y;
      for(let i=0;i<lines.length;i++){
        if(used+lineH>maxH){
          if(i>0){const prev=lines[i-1];
            doc.text(prev.length>1?prev.slice(0,prev.length-1)+'‚Ä¶':prev+'‚Ä¶',x,lastY);
          }
          return;
        }
        lastY=y+used+lineH; doc.text(lines[i],x,lastY); used+=lineH;
      }
    }
    function fechaStr(ts){
      try{
        if(ts&&typeof ts.toDate==='function') ts=ts.toDate();
        else if(ts&&typeof ts.seconds==='number') ts=new Date(ts.seconds*1000+Math.floor((ts.nanoseconds||0)/1e6));
        else if(!(ts instanceof Date)) ts=new Date(ts);
        return ts.toLocaleString('es-MX',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
      }catch{ return ''; }
    }
    function medsText(meds){ if(!Array.isArray(meds)||!meds.length) return '‚Äî';
      return meds.map((m,i)=>`${i+1}. ${m.nombre}\n   Dosis: ${m.dosis}\n   Duraci√≥n: ${m.duracion}`).join('\n\n'); }
    function blockNumber(r){
      if (r?.bloque!=null) return String(r.bloque);
      if (r?.blockchain?.block!=null) return String(r.blockchain.block);
      try{const u=new URL(r.urlBlockchain); return u.searchParams.get('id')||u.searchParams.get('block')||'‚Äî';}catch{return '‚Äî';}
    }

    const startY=header(); let yL=startY,yR=startY;

    // M√âDICO
    { const Hfixed=90; const s=sectionBox(leftX,yL,colW,Hfixed,'M√âDICO');
      doc.setFont(FONT,'bold'); doc.setFontSize(11.5);
      const nom=receta.medico?.nombre?prefixMedico(receta.medico.nombre,receta.medico.genero):'‚Äî';
      drawClamp(s.cx,s.cy,colW-16,26,nom,13);
      let cy=s.cy+26+6; doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.sub);
      const info=`C√©dula: ${receta.medico?.cedula||'‚Äî'}    Especialidad: ${receta.medico?.especialidad||'‚Äî'}\nTel: ${receta.medico?.telefono||'‚Äî'}\nDirecci√≥n: ${receta.medico?.direccion||'‚Äî'}`;
      drawClamp(s.cx,cy,colW-16,Hfixed-(cy-s.cy),info,13); yL=s.ny; }

    // PACIENTE
    { const Hfixed=100; const s=sectionBox(leftX,yL,colW,Hfixed,'PACIENTE');
      doc.setFont(FONT,'bold'); doc.setFontSize(11.5);
      drawClamp(s.cx,s.cy,colW-16,26,String(receta.paciente?.nombre||'‚Äî'),13);
      let cy=s.cy+26+6; doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.sub);
      doc.text(fechaStr(receta.timestamp), s.cx, cy); cy+=13; doc.text(`ID: ${receta.id||'‚Äî'}`, s.cx, cy); cy+=16;
      const lv=(x,y,lbl,val)=>{doc.setFont(FONT,'bold');doc.setTextColor(...COLORS.sub);doc.text(lbl,x,y);
        const w=doc.getTextWidth(lbl); doc.setFont(FONT,'normal');doc.setTextColor(...COLORS.text);doc.text(String(val??'‚Äî'),x+w+4,y);};
      lv(s.cx,cy,'Edad:',receta.paciente?.edad); lv(s.cx+120,cy,'Sexo:',receta.paciente?.sexo); cy+=13;
      lv(s.cx,cy,'Peso:',receta.paciente?.peso); lv(s.cx+120,cy,'Talla:',receta.paciente?.talla); cy+=13;
      lv(s.cx,cy,'Temp:',receta.paciente?.temperatura); lv(s.cx+120,cy,'PA:',receta.paciente?.presion); cy+=13;
      lv(s.cx,cy,'IMC:',receta.paciente?.imc); yL=s.ny; }

    // OBS + DIAG con separador
    { const lineH=11, SEP=35, MIN_OBS=60, MIN_DX=60;
      const leftSpace = Math.max(0, availYMax - yL);
      const obsWrapped = doc.splitTextToSize(String(receta.observaciones??'‚Äî'), colW-16);
      const idealObsH = Math.max(MIN_OBS, obsWrapped.length*lineH + 6);
      const obsMaxH   = Math.max(MIN_OBS, leftSpace - (SEP + MIN_DX));
      const obsH      = Math.min(idealObsH, obsMaxH);

      const sObs=sectionBox(leftX,yL,colW,obsH,'OBSERVACIONES');
      doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(17,24,39);
      drawClamp(sObs.cx,sObs.cy,colW-16,sObs.innerH,receta.observaciones,lineH);

      const gapY=sObs.ny-2, midY=gapY+SEP/2;
      doc.setFillColor(255,255,255); doc.setDrawColor(255,255,255); doc.rect(leftX,gapY,colW,SEP,'F');
      doc.setDrawColor(224,231,240); doc.setLineWidth(0.8); doc.line(leftX+6,midY,leftX+colW-6,midY);
      yL=gapY+SEP+6;

      const dxH=Math.max(MIN_DX, availYMax - yL);
      const sDx=sectionBox(leftX,yL,colW,dxH,'DIAGN√ìSTICO');
      drawClamp(sDx.cx,sDx.cy,colW-16,sDx.innerH,receta.diagnostico,lineH);
      yL=sDx.ny; }

    // DERECHA: MEDICAMENTOS
    { const lineH=11; const medsTxt=medsText(receta.medicamentos);
      const tmp=wrap(medsTxt,colW-16); const need=Math.max(90,tmp.length*lineH+6);
      const s=sectionBox(rightX,yR,colW,need,'MEDICAMENTOS');
      drawClamp(s.cx,s.cy,colW-16,s.innerH,medsTxt,lineH); yR=s.ny; }

    // QR receta (en tarjeta centrada, tama√±o fijo para no ‚Äúsaltar‚Äù)
    { const box=120,pad=10; let y=yR; const yMax=availYMax-(box+20);
      y=Math.min(Math.max(y,startY),yMax);
      const xQR=rightX+(colW-box)/2;
      if (qrs.mainQRUrl){
        doc.setDrawColor(...COLORS.brand); doc.setLineWidth(2.2); doc.roundedRect(xQR,y,box,box,10,10,'S');
        doc.addImage(qrs.mainQRUrl,'PNG',xQR+pad,y+pad,box-2*pad,box-2*pad,undefined,'FAST');
        doc.setTextColor(...COLORS.brand); doc.setFont(FONT,'bold'); doc.setFontSize(9.5);
        doc.text('Receta', xQR+box/2, y+box+12, {align:'center'});
        yR=y+box+20;
      }
    }

    // C√≥digo de barras
    { await ensureJsBarcode();
      const canvas=document.createElement('canvas'); canvas.width=300; canvas.height=40;
      if (receta.id) JsBarcode(canvas, String(receta.id), {format:'CODE128', width:2, height:32, margin:4, displayValue:false});
      const barUrl=canvas.toDataURL('image/png');

      let imgW=Math.min(colW-20,300), imgH=40*(imgW/300);
      let x=rightX+(colW-imgW)/2; let y=yR+6; let boxH=imgH+26;
      for(const f of [0.95,0.9,0.85]){ if(y+boxH<=availYMax) break; imgW*=f; imgH*=f; boxH=imgH+26; x=rightX+(colW-imgW)/2; }
      if(y+boxH<=availYMax){
        doc.setFillColor(248,250,252); doc.setDrawColor(224,231,240); doc.setLineWidth(0.8);
        doc.roundedRect(rightX,y,colW,boxH,8,8,'FD');
        doc.addImage(barUrl,'PNG',x,y+8,imgW,imgH,undefined,'FAST');
        doc.setFont(FONT,'bold'); doc.setFontSize(9); doc.setTextColor(55,65,81);
        doc.text('C√≥digo de barras (ID)', rightX+colW/2, y+imgH+20, {align:'center'});
        yR=y+boxH+10;
      }
    }

    // HASH (si hay real, lo muestra; si no, simulado ‚Äì siempre sin desborde)
    { 
      const s = sectionBox(rightX, yR, colW, 50, 'HASH');
      doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.sub);

      const hashLabel = receta.hash
        ? `hash (BC): ${receta.hash}`             // real de blockchain
        : `hash (local): ${hashSimulado(receta)}`; // fallback visual

      drawClamp(s.cx, s.cy, colW-16, s.innerH, hashLabel, 11);
      yR = s.ny;
    }

    // QR blockchain + bloque (con leyenda correcta). Tama√±o ‚Äúmini‚Äù para NO desbordar.
    { const mini=90, rectW=mini,rectH=mini; const qrX=rightX+colW-rectW;
      let qrY=Math.max(yL,yR)+6; if(qrY+rectH+38>availYMax) qrY=availYMax-rectH-38;
      if (qrs.chainQRUrl){
        doc.setDrawColor(...COLORS.brand); doc.setLineWidth(2.0); doc.roundedRect(qrX,qrY,rectW,rectH,8,8,'S');
        doc.addImage(qrs.chainQRUrl,'PNG',qrX+8,qrY+8,rectW-16,rectH-16,undefined,'FAST');
        doc.setTextColor(...COLORS.brand); doc.setFont(FONT,'bold'); doc.setFontSize(9);
        doc.text('Blockchain', qrX+rectW/2, qrY+rectH+12, {align:'center'});
        const bn = blockNumber(receta);
        doc.setTextColor(...COLORS.text); doc.setFont(FONT,'bold'); doc.setFontSize(10);
        doc.text('Bloque: '+(bn||'‚Äî'), qrX+rectW/2, qrY+rectH+26, {align:'center'});
        doc.setTextColor(...COLORS.sub); doc.setFont(FONT,'normal'); doc.setFontSize(8.5);
        doc.text('Para consultar bloque visitar kodrx.app', qrX+rectW/2, qrY+rectH+38, {align:'center'});
      }
    }

    // Footer final
    footer();

    const filename = `receta_${receta.id||''}.pdf`;
    if (mode==='print'){
      try{ doc.autoPrint(); doc.output('dataurlnewwindow'); } catch { doc.save(filename); }
    } else if (mode==='open'){
      const url = doc.output('bloburl'); window.open(url,'_blank');
    } else {
      doc.save(filename);
    }
  };

  /* ===== bind botones ===== */
  function bindButtons(){
    const btnD = document.getElementById('btnDescargar');
    const btnP = document.getElementById('btnImprimir');
    const btnB = document.getElementById('btnVolver');

    const onPDF = (mode)=>async (ev)=>{
      ev.preventDefault();
      const b=ev.currentTarget; if (b.__busy) return; b.__busy=true; b.disabled=true;
      try{
        if (!window.RECETA_ACTUAL) await renderOnce();
        await window.generarPDF(window.RECETA_ACTUAL, window.QRS||{}, mode?{mode}:{});
      }catch(e){ console.error('[ver] PDF error', e); alert('No se pudo generar el PDF.'); }
      finally{ b.__busy=false; b.disabled=false; }
    };

    if (btnD && !btnD.__b){ btnD.type='button'; btnD.addEventListener('click', onPDF(null), {capture:true}); btnD.__b=true; }
    if (btnP && !btnP.__b){ btnP.type='button'; btnP.addEventListener('click', onPDF('print'), {capture:true}); btnP.__b=true; }
    if (btnB && !btnB.__b){
      btnB.type='button';
      btnB.addEventListener('click', (e)=>{ e.preventDefault(); if (history.length>1) history.back(); else location.href='/medico/panel.html'; }, {capture:true});
      btnB.__b=true;
    }
  }

  /* ===== start ===== */
  if (document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', ()=>{ renderOnce().catch(console.warn); bindButtons(); }, {once:true});
  } else {
    renderOnce().catch(console.warn); bindButtons();
  }
})();
</script>

<script>
/* ====== Config Blockchain ====== */
const BC_BASE = 'https://kodrx-blockchain.onrender.com';

/* Iniciales por si no fueron guardadas (AMO-IBU-PAR) */
function inicialesDeMeds(meds){
  return (meds||[])
    .map(m => String(m?.nombre||'').trim().split(/\s+/).map(w=>w[0]||'').join('').slice(0,3).toUpperCase())
    .filter(Boolean).join('-');
}

/* Carga on-demand funciones de Firestore que necesitamos para actualizar */
let __fsMod=null;
async function _fs(){
  if(__fsMod) return __fsMod;
  __fsMod = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
  return __fsMod;
}

/* Construye el QR del bloque (solo ?id=<bloque>) */
async function setChainQR(block){
  const url = `${BC_BASE}/verificar.html?id=${encodeURIComponent(block)}`;
  const png = await makeQRDataURL(url, 220); // ya tienes makeQRDataURL
  const img = new Image(); img.alt = 'QR blockchain'; img.src = png;
  const host = document.getElementById('qrChain');
  if (host){ host.innerHTML=''; host.appendChild(img); }
  const bn = document.getElementById('blockNum');
  if (bn) bn.textContent = String(block||'‚Äî');
}

/* L√≥gica de sellado: intenta varios endpoints conocidos; si alguno responde con {block, hash}, actualiza Firestore */
async function sellIfPending(receta){
  if (!receta?.id) return receta;
  const already = (receta.blockchain?.status==='ok') && ((receta.blockchain?.block ?? receta.bloque) != null);
  if (already) { // ya est√° sellado: solo asegurar QR
    const block = receta.blockchain?.block ?? receta.bloque;
    if (block) await setChainQR(block);
    return receta;
  }

  // Feedback visual solo con badge (sin spinner)
  if (typeof window.bcStart==='function') window.bcStart();

  const payload = {
    id: receta.id,
    medsIniciales: receta.medsIniciales || inicialesDeMeds(receta.medicamentos),
    medico: receta.medicoNombre || receta.medico?.nombre || '',
    timestamp: (receta.timestamp && receta.timestamp.seconds) ? receta.timestamp.seconds : Math.floor(Date.now()/1000)
  };
  const paths = ['/api/sellar','/sell','/registrar','/api/registrar'];

  let out=null;
  for (const p of paths){
    try{
      const res = await fetch(`${BC_BASE}${p}`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload),
        mode: 'cors', credentials: 'omit'
      });
      if (!res.ok) continue;
      const data = await res.json().catch(()=>null);
      const block = data?.block ?? data?.bloque ?? null;
      const hash  = data?.hash  ?? data?.txid  ?? data?.tx ?? null;
      if (block){ out = {block, hash: hash||null}; break; }
    }catch(_e){ /* prueba siguiente endpoint */ }
  }

  if (out){
    // Actualiza Firestore
    const {doc, updateDoc, serverTimestamp} = await _fs();
    try{
      const ref = doc(db,'recetas', receta.id);
      await updateDoc(ref, {
        blockchain: { status:'ok', block: out.block, hash: out.hash, at: serverTimestamp() },
        bloque: out.block,
        hash: out.hash
      });
    }catch(e){ console.warn('[bc] no se pudo actualizar firestore (seguimos en UI):', e); }

    // Refresca estado en memoria y UI
    receta.blockchain = {status:'ok', block: out.block, hash: out.hash};
    receta.bloque = out.block; receta.hash = out.hash;
    window.RECETA_ACTUAL = receta;

    await setChainQR(out.block);
    if (typeof window.bcDone==='function') window.bcDone(receta);
  }else{
    if (typeof window.bcError==='function') window.bcError();
  }

  if (typeof window.killVerificandoUI==='function') window.killVerificandoUI();
  return receta;
}
</script>
<script>
(() => {
  // Nunca ocultar:
  const NEVER = 'footer, .footer, [data-role="footer"], .qr-legend, .qr-chain, #blockNum, #hashTexto';

  // √öNICO listado permitido (allowlist):
  const ALLOW = [
    '#badgeVerificando',
    '#spinnerVerificando',
    '#panelVerificando',
    '#bcStatus',                // tu pill de estado
    '[data-role="verificando"]',
    '.verificando',
    '.spinner-verify'
  ];

  function hideVerify(root){
    const ctx = root || document;
    const targets = ALLOW
      .flatMap(sel => Array.from(ctx.querySelectorAll(sel)))
      .filter(el => el && !el.closest(NEVER));

    targets.forEach(el => {
      el.style.display = 'none';
      el.setAttribute('data-hidden-by','kodrx');
    });


  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => hideVerify(), { once:true });
  } else {
    hideVerify();
  }

  // por si quieres llamarlo manualmente despu√©s
  window.kodrxHideVerify = hideVerify;
})();
</script>


</body>
</html>


