<!DOCTYPE html>
<html lang="es">
<head>
  <script type="module">
  import { db } from "/firebase-init.js";
  import {
    doc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // expón a window para que los vea el script inline clásico
  window.db = db;
  window.__fs = { doc, updateDoc, serverTimestamp };
</script>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KodRx | Receta Digital</title>

<style>
/* ===== Layout general ===== */
html, body { height: 100%; }
body { min-height: 100svh; margin: 0; display: block; } /* ← quitamos flex aquí */

/* Contenedor raíz: 2 filas → [contenido flexible][footer auto] */
.receta-root{
  min-height: 100svh;
  display: grid;
  grid-template-rows: 1fr auto;
}
.receta-wrap{
  /* lo que ya tenías */
  flex:1 0 auto;
  max-width:940px;
  margin:16px auto;
  padding:12px;

  /* lo que faltaba → grid de 2 columnas */
  display:grid !important;
  grid-template-columns: minmax(0,1fr) 340px;
  gap:16px;
  align-items:start;
}
/* evita que el contenido rompa el grid */
.col-left, .col-right{ min-width:0; }
/* Header */
.receta-header{grid-column:1/-1;background:#F0F5FF;color:#0b1b2b;padding:14px 16px;border-radius:12px;font-weight:700}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;margin-left:8px}
.badge.ok{background:#e7f6e8;color:#0b8b2b}
.badge.warn{background:#fff3cd;color:#7a5a00}

/* Acciones */
.actions{grid-column:1/-1;display:flex;gap:12px;padding:8px 0;flex-wrap:wrap}
button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.primary{background:#0b5bd3;color:#fff}
.ghost{background:#eef2ff;color:#0b1b2b;border:1px solid #dbe3ff}

/* Cards / contenido */
.card{background:#f8fafc;border:1px solid #e0e7f0;border-radius:14px;padding:12px}
.card .title{color:#6b7280;font-weight:800;letter-spacing:.02em;margin:2px 0 8px;text-transform:uppercase}
.kv{color:#111827;font-size:14px;line-height:1.35}
.kv b{color:#6b7280;margin-right:6px}
.card,.kv,.sub{overflow-wrap:anywhere;word-break:break-word}

/* Columna derecha */
.col-right{display:flex;flex-direction:column;gap:16px}
.meds{white-space:pre-wrap;font-size:14px;line-height:1.35;color:#111827}

/* QRs */
.qr-frame{border:2px solid #0b5bd3;border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:center;background:#fff}
.qr-legend{color:#0b5bd3;font-weight:700;font-size:12px;text-align:center;margin-top:6px}
.qr-main img{width:220px;height:220px}
.qr-chain img{width:110px;height:110px}

/* Código de barras (pantalla) */
#panelBarcode canvas{max-width:100%}

/* Hash + footer */
.hash{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;color:#374151;font-size:12px}


  .footer{
  /* si el padre es grid, ocupa todo; si no, también :) */
  grid-column: 1 / -1;

  background:#0b5bd3;
  color:#fff;
  border-radius:12px;
  padding:12px 16px;
  text-align:center;
  font-weight:700;

  /* claves para que quede pegado abajo en layout flex-col */
  margin-top:auto;
  display:block;
  width:100%;
  align-self:stretch;
}
.qr-frame.qr-main  { width:260px; height:260px; }
  .qr-frame.qr-chain { width:220px; height:220px; }
  #barcodeCanvas     { width:300px; height:80px; display:block; }
/* Responsive */
@media (max-width:920px){
  .receta-wrap{ grid-template-columns:1fr; }
  .qr-main img{width:200px;height:200px}
  .qr-chain img{width:100px;height:100px}
}
@media (max-width:520px){
  .qr-main img{width:180px;height:180px}
  .qr-chain img{width:90px;height:90px}
}

/* En impresión ocultamos botones; preferimos imprimir el PDF generado */
@media print{ .actions{display:none!important} }
</style>
</head>


<body>
  <div class="receta-root"><!-- wrapper para sticky footer -->

    <div class="receta-wrap"><!-- ÚNICO grid de 2 columnas -->

      <!-- Acciones (ocupa ambas columnas) -->
     <section class="card actions" style="gap:8px; padding:12px">
  <button id="btnVolver" type="button" class="btn">Regresar</button>
  <button id="btnDescargar" type="button" class="btn">Descargar PDF</button>
  <button id="btnImprimir"  type="button" class="btn">Imprimir</button>
</section>
      <!-- Header (ocupa ambas columnas) -->
      <div class="receta-header">
        KodRx — Receta médica digital
        <span id="badgeOrigen" class="badge warn">MOCK</span>
      </div>


      <!-- Columna IZQUIERDA -->
      <div class="col-left" style="display:flex;flex-direction:column;gap:16px">
        <section class="card">
          <div class="title">MÉDICO</div>
          <div class="kv" id="doctorNombre">—</div>
          <div class="kv"><b>Cédula:</b> <span id="doctorCedula">—</span> &nbsp;&nbsp; <b>Especialidad:</b> <span id="doctorEsp">—</span></div>
          <div class="kv"><b>Tel:</b> <span id="doctorTel">—</span></div>
          <div class="kv"><b>Dirección:</b> <span id="doctorDir">—</span></div>
        </section>

        <section class="card">
          <div class="title">PACIENTE</div>
          <div class="kv" id="pacienteNombre">—</div>
          <div class="kv sub" style="margin-top:6px">
            <span id="fechaEmision">—</span> &nbsp;&nbsp; <span id="recetaId">ID: —</span>
          </div>
          <div class="kv" style="margin-top:8px">
            <b>Edad:</b> <span id="pacEdad">—</span> &nbsp;&nbsp; <b>Sexo:</b> <span id="pacSexo">—</span>
          </div>
          <div class="kv"><b>Peso:</b> <span id="pacPeso">—</span> &nbsp;&nbsp; <b>Talla:</b> <span id="pacTalla">—</span></div>
          <div class="kv"><b>Temp:</b> <span id="pacTemp">—</span> &nbsp;&nbsp; <b>PA:</b> <span id="pacPresion">—</span></div>
          <div class="kv"><b>IMC:</b> <span id="pacIMC">—</span></div>
        </section>

        <section class="card">
          <div class="title">OBSERVACIONES</div>
          <div class="kv" id="obsTexto">—</div>
        </section>

        <section class="card">
          <div class="title">DIAGNÓSTICO</div>
          <div class="kv" id="diagTexto">—</div>
        </section>
      </div><!-- /.col-left -->

      <!-- Columna DERECHA -->
      <div class="col-right">
        <section class="card">
          <div class="title">MEDICAMENTOS</div>
          <pre class="meds" id="listaMedsDerecha">—</pre>
        </section>

        <section class="card" style="text-align:center">
          <div class="qr-frame qr-main"><div id="qrMain"></div></div>
          <div class="qr-legend">Receta</div>
        </section>

        <section class="card" id="panelBarcode">
          <div class="title">CÓDIGO DE BARRAS (ID)</div>
          <div style="display:flex;justify-content:center">
            <canvas id="barcodeCanvas" width="300" height="80"></canvas>
          </div>
          <div class="sub" style="text-align:center;margin-top:4px">
            <span id="barcodeLabel">—</span>
          </div>
        </section>

        <section class="card">
          <div class="title">HASH</div>
          <div class="hash" id="hashTexto">hash: —</div>
        </section>

        <section class="card" style="text-align:center">
          <div class="qr-frame qr-chain"><div id="qrChain"></div></div>
          <div class="qr-legend">
            Blockchain<br>
            <span id="blockNum" style="color:#111827;font-weight:800"></span><br>
            <span class="sub" style="color:#6b7280;font-weight:400">Para consultar bloque visitar kodrx.app</span>
          </div>
        </section>
      </div><!-- /.col-right -->
    </div><!-- /.receta-wrap -->

    <!-- Pill de estado (lo ocultamos desde JS al terminar verificación) -->
    <div id="verifyScope" data-role="verificando">
  <p id="bcStatus" class="pill verificando">Verificando blockchain…</p>
  <div id="panelVerificando" class="verificando spinner-verify">…spinner…</div>
</div>

    <!-- Footer -->
    <div class="footer">
      Creada con KodRx. Plataforma digital de recetas verificadas con trazabilidad tecnológica.
    </div>
  </div><!-- /.receta-root -->

</body>
</html>



<!-- jsPDF (UMD) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
;(() => {
  'use strict';

  // ===== Config =====
  const BC_BASE = 'https://kodrx-blockchain.onrender.com';

  // ===== Utils =====
  const sleep   = (ms)=>new Promise(r=>setTimeout(r,ms));
  const setText = (selOrEl, val)=>{
    const el = typeof selOrEl==='string' ? document.querySelector(selOrEl) : selOrEl;
    if (!el) return; el.textContent = (val ?? '—');
  };

  // Normaliza la receta (soporta legacy)
  window.normalize = function normalize(raw0){
  const raw = raw0 || {};
  const bc  = raw.blockchain || {};

  // bloque: admite r.bloque o bc.block
  let bloque = null;
  if (Number.isFinite(raw.bloque)) bloque = raw.bloque;
  else if (typeof bc.block === 'number' || typeof bc.block === 'string') bloque = bc.block;

  // hash: primero blockchain.hash, si no r.hash
  const hash = (bc.hash ?? raw.hash) || null;

  // status derivado si no viene en bc.status
  const status = bc.status || (bloque ? 'ok' : (hash ? 'simulado' : 'pendiente'));

  // nombre del paciente (compat)
  const nombrePaciente =
    raw.nombrePaciente ?? raw.pacienteNombre ?? raw.paciente?.nombre ?? raw.paciente ?? '—';

  // objeto médico desde campos sueltos (compat)
  const medico = raw.medico || {
    nombre:       raw.medicoNombre,
    genero:       raw.medicoGenero,
    cedula:       raw.medicoCedula,
    especialidad: raw.medicoEspecialidad,
    telefono:     raw.medicoTelefono,
    direccion:    raw.medicoDomicilio
  };

  return {
    ...raw,
    nombrePaciente,
    medico,
    bloque,
    hash,
    blockchain: {
      ...bc,
      status,
      block: (bc.block ?? bloque) ?? null,
      hash:  hash
    }
  };
};

  // ===== Libs (idempotentes) =====
  async function ensureLibs(){
    const jobs=[];
    if (!window.QRCode && !window.qrcode){
      jobs.push(new Promise((res,rej)=>{const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';
        s.onload=res; s.onerror=rej; document.head.appendChild(s);}));
    }
    if (!window.JsBarcode){
      jobs.push(new Promise((res,rej)=>{const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js';
        s.onload=res; s.onerror=rej; document.head.appendChild(s);}));
    }
    if (jobs.length) await Promise.allSettled(jobs);
  }
  async function ensureJsPDF(){
    if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
    await new Promise((res,rej)=>{const s=document.createElement('script');
      s.src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
      s.onload=res; s.onerror=rej; document.head.appendChild(s);});
    return window.jspdf.jsPDF;
  }

  // ===== QR helpers =====
  function makeQR(host, text, size){
    if (!host) return false;
    const QR = window.QRCode || window.qrcode;
    if (!QR) return false;
    host.innerHTML = '';
    if (window.QRCode){ new QRCode(host, { text, width:size, height:size, correctLevel: QRCode.CorrectLevel.M }); return true; }
    try{
      if (QR.toCanvas){
        const c=document.createElement('canvas'); host.appendChild(c);
        QR.toCanvas(c, text, { width:size }); return true;
      }
    }catch{}
    return false;
  }
  async function makeQRDataURLCompat(text, size=220){
    await ensureLibs();
    try{
      if (window.qrcode?.toDataURL){
        return await window.qrcode.toDataURL(text, { width:size, margin:1 });
      }
      if (window.QRCode){
        const div=document.createElement('div');
        new QRCode(div, { text, width:size, height:size, correctLevel:(window.QRCode.CorrectLevel?.M ?? 1) });
        await Promise.resolve();
        const img=div.querySelector('img'); if (img?.src) return img.src;
        const c=div.querySelector('canvas'); if (c) return c.toDataURL('image/png');
      }
    }catch{}
    return '';
  }

  // ===== Firestore helpers =====
  let __fsMod=null;
  async function _fs(){
    if (window.__fs) return window.__fs;
    if (!__fsMod) __fsMod = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
    return __fsMod;
  }
  async function getDB(){
    if (window.db) return window.db;
    const core = await import('/firebase-init.js');
    return core.db;
  }

  // ===== Badge =====
  function updateBadgeFromReceta(r){
    const el = document.getElementById('badgeOrigen'); if(!el) return;
    const hasBlock = (r?.blockchain?.block ?? r?.bloque) != null;
    const hasHash  = !!(r?.blockchain?.hash ?? r?.hash);
    const S = hasBlock ? {txt:'SELLADO EN BLOCKCHAIN', cls:'badge ok',   bg:'#16a34a', fg:'#fff'}
          : hasHash   ? {txt:'SELLADO SIMULADO',      cls:'badge warn', bg:'#f59e0b', fg:'#111'}
                      : {txt:'PENDIENTE',             cls:'badge warn', bg:'#9ca3af', fg:'#111'};
    el.textContent = S.txt; el.className = S.cls; el.style.background = S.bg; el.style.color = S.fg;
  }

  // ===== QR del bloque =====
  async function setChainQR(block){
    const host = document.getElementById('qrChain');
    if (!host) return;
    await ensureLibs();
    const url = `${BC_BASE}/verificar.html?id=${encodeURIComponent(block)}`;
    makeQR(host, url, 220);
    const bn = document.getElementById('blockNum');
    if (bn) bn.textContent = String(block || '—');
  }

  // ===== QRs para PDF =====
  async function getQRSources(receta){
    const out = {};
    const mainNode  = document.querySelector('#qrMain  canvas, #qrMain  img');
    const chainNode = document.querySelector('#qrChain canvas, #qrChain img');
    if (mainNode)  out.main  = mainNode.tagName==='IMG' ? mainNode.src  : mainNode.toDataURL('image/png');
    if (chainNode) out.chain = chainNode.tagName==='IMG'? chainNode.src : chainNode.toDataURL('image/png');
    if (!out.main){
      const verURL = QR_RECETA_URL(r.id);
      out.main = await makeQRDataURLCompat(verURL, 220);
    }
    if (!out.chain){
      const blk = receta?.blockchain?.block ?? receta?.bloque ?? null;
      if (blk) out.chain = await makeQRDataURLCompat(`${BC_BASE}/verificar.html?id=${encodeURIComponent(blk)}`, 220);
    }
    return out;
  }

  // ===== Carga receta si falta =====
  async function hydrateIfNeeded(){
    if (window.RECETA_ACTUAL && (window.RECETA_ACTUAL.blockchain || window.RECETA_ACTUAL.hash || window.RECETA_ACTUAL.bloque)) return;
    try{
      const id = new URLSearchParams(location.search).get('id'); if (!id) return;
      const core = await import('/firebase-init.js');
      const fs   = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
      const snap = await fs.getDoc(fs.doc(core.db,'recetas',id));
      if (snap.exists()) window.RECETA_ACTUAL = { id:snap.id, ...(window.RECETA_ACTUAL||{}), ...(snap.data()||{}) };
    }catch(e){ console.warn('[ver] hydrate warn', e); }
  }

  // ===== Render principal =====
  async function renderOnce(){
    for (let i=0;i<100;i++){ if (window.RECETA_ACTUAL) break; await sleep(60); }
    await hydrateIfNeeded();
    const r0 = window.RECETA_ACTUAL; if (!r0) return;
    const r  = window.RECETA_ACTUAL = normalize(r0);

    // Médico
    setText('doctorNombre', r.medico?.nombre ? ((String(r.medico?.genero||'').toLowerCase().startsWith('f')?'Dra. ':'Dr. ')+r.medico.nombre) :
      (r.medicoNombre ? ((String(r.medicoGenero||'').toLowerCase().startsWith('f')?'Dra. ':'Dr. ')+r.medicoNombre) : '—'));
    setText('doctorCedula', r.medico?.cedula ?? r.medicoCedula ?? '—');
    setText('doctorEsp',    r.medico?.especialidad ?? r.medicoEspecialidad ?? '—');
    setText('doctorTel',    r.medico?.telefono ?? r.medicoTelefono ?? '—');
    setText('doctorDir',    r.medico?.direccion ?? r.medicoDomicilio ?? '—');

    // Paciente
    setText('pacienteNombre', r.paciente?.nombre ?? r.nombrePaciente ?? '—');
    setText('pacEdad',        r.paciente?.edad ?? r.edad ?? '—');
    setText('pacSexo',        r.paciente?.sexo ?? r.sexo ?? '—');
    setText('pacPeso',        r.paciente?.peso ?? r.peso ?? '—');
    setText('pacTalla',       r.paciente?.talla ?? r.talla ?? '—');
    setText('pacTemp',        r.paciente?.temperatura ?? r.temperatura ?? '—');
    setText('pacPresion',     r.paciente?.presion ?? r.presion ?? '—');
    setText('pacIMC',         r.paciente?.imc ?? r.imc ?? '—');

    // Texto libre
    setText('obsTexto',  r.observaciones ?? '—');
    setText('diagTexto', r.diagnostico   ?? '—');

    // ID y fecha
    setText('recetaId', 'ID: ' + (r.id || '—'));
    try{
      let ts=r.timestamp;
      if (ts && typeof ts.toDate==='function') ts = ts.toDate();
      else if (ts && typeof ts.seconds==='number') ts = new Date(ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6));
      else if (!(ts instanceof Date)) ts = new Date(ts);
      setText('fechaEmision', ts ? ts.toLocaleString('es-MX',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '—');
    }catch{ setText('fechaEmision','—'); }

    // Medicamentos (texto)
    const meds = Array.isArray(r.medicamentos) ? r.medicamentos : [];
    const medsTxt = meds.length
      ? meds.map((m,i)=>`${i+1}. ${m.nombre}\n   Dosis: ${m.dosis}\n   Duración: ${m.duracion}`).join('\n\n')
      : '—';
    const medsEl = document.getElementById('listaMedsDerecha'); if (medsEl) medsEl.textContent = medsTxt;

    // Hash / badge
    const hashEl = document.getElementById('hashTexto');
    if (hashEl){ const h=r.hash ?? r.blockchain?.hash ?? '';
      hashEl.textContent = h ? `hash (BC): ${h}` : (r.id ? `hash (local): ${String(r.id).slice(0,8)}` : 'hash: —'); }
    updateBadgeFromReceta(r);

    // Libs + QRs
    await ensureLibs();

    // QR principal
    const host = document.getElementById('qrMain');
    if (host && !host.querySelector('canvas,img')){
    const verURL = QR_RECETA_URL(r.id);
      makeQR(host, verURL, 260);
    }

    // Código de barras
    const canvas = document.getElementById('barcodeCanvas');
    const label  = document.getElementById('barcodeLabel');
    if (canvas && window.JsBarcode){
      try{
        const dpr=Math.max(1,window.devicePixelRatio||1), cssW=300, cssH=80;
        canvas.width=cssW*dpr; canvas.height=cssH*dpr;
        canvas.style.width=cssW+'px'; canvas.style.height=cssH+'px';
        const ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
        JsBarcode(canvas, String(r.id||''), { format:'CODE128', width:2, height:40, margin:4, displayValue:false });
        if (label) label.textContent = r.id || '—';
      }catch(e){ if (label) label.textContent = r.id || '—'; }
    }

    // QR blockchain + leyenda
    const blk = r?.blockchain?.block ?? r?.bloque ?? null;
    if (blk) await setChainQR(blk);
    {
      const legendHolder = document.querySelector('.qr-legend .sub');
      const text='Para consultar bloque visitar kodrx.app';
      if (legendHolder) legendHolder.textContent = text;
      else document.getElementById('blockNum')?.insertAdjacentHTML('afterend','<br><span class="sub" style="color:#6b7280;font-weight:400">'+text+'</span>');
    }

    // QRs para PDF
    window.QRS = await getQRSources(r);

    // apaga cualquier spinner “verificando”
    document.getElementById('verifyScope')?.remove();

    console.log('[ver] render ok');
  }

  // ===== PDF / Botones =====
window.generarPDF = async function generarPDF(rIn, qrsIn, { mode = 'save' } = {}) {
  // 1) jsPDF
  const jsPDF = await (window.ensureJsPDF
    ? window.ensureJsPDF()
    : (async () => {
        if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
        await new Promise((res, rej) => {
          const s = document.createElement('script');
          s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          s.onload = res; s.onerror = rej; document.head.appendChild(s);
        });
        return window.jspdf.jsPDF;
      })()
  );
  const { jsPDF: Cls } = window.jspdf || {};
  if (!Cls) { alert('No se pudo cargar jsPDF'); return; }

  // 2) Adaptador (mapea tu objeto a una forma común)
  const adapt = (x={}) => {
    const medico = {
      nombre:       x.medico?.nombre ?? x.medicoNombre ?? '—',
      genero:       x.medico?.genero ?? x.medicoGenero ?? '',
      cedula:       x.medico?.cedula ?? x.medicoCedula ?? '—',
      especialidad: x.medico?.especialidad ?? x.medicoEspecialidad ?? 'General',
      telefono:     x.medico?.telefono ?? x.medicoTelefono ?? '',
      direccion:    x.medico?.direccion ?? x.medicoDomicilio ?? ''
    };
    const paciente = {
      nombre: x.paciente?.nombre ?? x.nombrePaciente ?? x.pacienteNombre ?? '—',
      edad:   x.paciente?.edad   ?? x.edad ?? '—',
      sexo:   x.paciente?.sexo   ?? x.sexo ?? '—',
      peso:   x.paciente?.peso   ?? x.peso ?? '—',
      talla:  x.paciente?.talla  ?? x.talla ?? '—',
      temperatura: x.paciente?.temperatura ?? x.temperatura ?? '—',
      presion:     x.paciente?.presion     ?? x.presion ?? '—',
      imc:         x.paciente?.imc         ?? x.imc ?? '—',
    };
    const bloque = (x.blockchain?.block ?? x.bloque ?? null);
    const hash   = x.hash ?? x.blockchain?.hash ?? null;
    return { ...x, medico, paciente, bloque, hash };
  };
  const r = adapt(rIn || {});

  // 3) QRs: usa los que ya existen o regénéralos si faltan
  const qrs = (qrsIn && (qrsIn.main || qrsIn.chain))
    ? qrsIn
    : (window.QRS || (window.getQRSources ? await window.getQRSources(r) : {}));

  // 4) Doc y layout base
  const doc = new Cls({ unit: 'pt', format: 'letter', compress: true }); // 612 x 792
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();

  const Mx = 40, gutter = 16, CW = W - 2*Mx, colW = (CW - gutter)/2;
  const leftX = Mx, rightX = Mx + colW + gutter;
  const footerH = 52, My = 50, availYMax = H - My - footerH - 10;

  const COLORS = {
    panelFill:   [248,250,252],
    panelStroke: [224,231,240],
    text:        [17,24,39],
    sub:         [55,65,81],
    label:       [107,114,128],
    brand:       [11,91,211]
  };
  const FONT = 'helvetica';
  doc.setFont(FONT, 'normal');

  // 5) Utils de dibujo
  const prefixMed = (nombre, genero) => {
    if (!nombre) return '—';
    const g = String(genero||'').toLowerCase();
    return (g.startsWith('f') ? 'Dra. ' : 'Dr. ') + nombre;
  };
  const wrap  = (txt, w) => doc.splitTextToSize(String(txt ?? '—'), w);
  const linesH = 11;

  function header() {
    const headY = 18, headH = 50;
    doc.setFillColor(240,245,255);
    doc.roundedRect(18, headY, W-36, headH, 9, 9, 'F');
    doc.setTextColor(11,27,43); doc.setFont(FONT,'bold'); doc.setFontSize(13);
    doc.text('KodRx — Receta médica digital', Mx, headY+30);
    doc.setFont(FONT, 'normal');
    return headY + headH + 12;
  }
  function footer() {
    doc.setFillColor(...COLORS.brand);
    doc.rect(18, H-18-footerH, W-36, footerH, 'F');
    doc.setTextColor(255,255,255);
    doc.setFont(FONT, 'bold'); doc.setFontSize(10.5);
    doc.text('Creada con KodRx. Tecnología que verifica, salud que protege.', W/2, H-22, { align: 'center' });
  }
  function sectionBox(x, y, w, contentH, title) {
    const padX = 10, padY = 10, titleH = 18, boxH = contentH + padY*2 + titleH;
    const yClamped = Math.min(y, availYMax - boxH);
    doc.setFillColor(...COLORS.panelFill);
    doc.setDrawColor(...COLORS.panelStroke); doc.setLineWidth(0.8);
    doc.roundedRect(x, yClamped, w, boxH, 8, 8, 'FD');
    doc.setTextColor(...COLORS.label); doc.setFont(FONT,'bold'); doc.setFontSize(10);
    doc.text(title, x + padX, yClamped + 14);
    doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.text);
    return { cx: x+padX, cy: yClamped + 14 + padY, ny: yClamped + boxH + 10, innerH: contentH };
  }
  function drawClamp(x, y, maxW, maxH, text, lineH = linesH) {
    const lines = wrap(text, maxW);
    let used = 0, lastY = y;
    for (let i = 0; i < lines.length; i++) {
      if (used + lineH > maxH) {
        if (i > 0) {
          const prev = lines[i-1];
          doc.text(prev.length > 1 ? prev.slice(0, prev.length - 1) + '…' : prev + '…', x, lastY);
        }
        return;
      }
      lastY = y + used + lineH;
      doc.text(lines[i], x, lastY);
      used += lineH;
    }
  }
  function fechaStr(ts) {
    try {
      if (ts && typeof ts.toDate === 'function') ts = ts.toDate();
      else if (ts && typeof ts.seconds === 'number') ts = new Date(ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6));
      else if (!(ts instanceof Date)) ts = new Date(ts);
      return ts.toLocaleString('es-MX', { year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit' });
    } catch { return ''; }
  }
  const medsText = (list) =>
    (Array.isArray(list) && list.length)
      ? list.map((m,i)=>`${i+1}. ${m.nombre}\n   Dosis: ${m.dosis}\n   Duración: ${m.duracion}`).join('\n\n')
      : '—';
  const blockNumber = (x) => {
    if (x?.bloque != null) return String(x.bloque);
    if (x?.blockchain?.block != null) return String(x.blockchain.block);
    try {
      const u = new URL(x.urlBlockchain);
      return u.searchParams.get('id') || u.searchParams.get('block') || '—';
    } catch { return '—'; }
  };

  // 6) Composición
  const startY = header();
  let yL = startY, yR = startY;

  // MÉDICO
  { const Hfixed = 90; const s = sectionBox(leftX, yL, colW, Hfixed, 'MÉDICO');
    doc.setFont(FONT,'bold'); doc.setFontSize(11.5);
    drawClamp(s.cx, s.cy, colW-16, 26, prefixMed(r.medico.nombre, r.medico.genero), 13);
    let cy = s.cy + 26 + 6;
    doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.sub);
    const info =
      `Cédula: ${r.medico.cedula || '—'}    Especialidad: ${r.medico.especialidad || '—'}\n` +
      `Tel: ${r.medico.telefono || '—'}\n` +
      `Dirección: ${r.medico.direccion || '—'}`;
    drawClamp(s.cx, cy, colW-16, Hfixed - (cy - s.cy), info, 13);
    yL = s.ny;
  }

  // PACIENTE
  { const Hfixed = 100; const s = sectionBox(leftX, yL, colW, Hfixed, 'PACIENTE');
    doc.setFont(FONT,'bold'); doc.setFontSize(11.5);
    drawClamp(s.cx, s.cy, colW-16, 26, String(r.paciente.nombre || '—'), 13);
    let cy = s.cy + 26 + 6;
    doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.sub);
    doc.text(fechaStr(r.timestamp), s.cx, cy); cy += 13;
    doc.text(`ID: ${r.id || '—'}`, s.cx, cy); cy += 16;
    const lv = (x,y,lbl,val)=>{ doc.setFont(FONT,'bold'); doc.setTextColor(...COLORS.sub); doc.text(lbl, x, y);
      const w = doc.getTextWidth(lbl); doc.setFont(FONT,'normal'); doc.setTextColor(...COLORS.text); doc.text(String(val ?? '—'), x+w+4, y); };
    lv(s.cx, cy, 'Edad:', r.paciente.edad);   lv(s.cx+120, cy, 'Sexo:', r.paciente.sexo);   cy += 13;
    lv(s.cx, cy, 'Peso:', r.paciente.peso);   lv(s.cx+120, cy, 'Talla:', r.paciente.talla); cy += 13;
    lv(s.cx, cy, 'Temp:', r.paciente.temperatura); lv(s.cx+120, cy, 'PA:', r.paciente.presion); cy += 13;
    lv(s.cx, cy, 'IMC:',  r.paciente.imc);
    yL = s.ny;
  }

  // OBSERVACIONES + DIAGNÓSTICO (con separador)
  { const lineH = linesH, SEP = 35, MIN_OBS = 60, MIN_DX = 60;
    const leftSpace   = Math.max(0, availYMax - yL);
    const obsWrapped  = doc.splitTextToSize(String(r.observaciones ?? '—'), colW-16);
    const idealObsH   = Math.max(MIN_OBS, obsWrapped.length*lineH + 6);
    const obsMaxH     = Math.max(MIN_OBS, leftSpace - (SEP + MIN_DX));
    const obsH        = Math.min(idealObsH, obsMaxH);

    const sObs = sectionBox(leftX, yL, colW, obsH, 'OBSERVACIONES');
    doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.text);
    drawClamp(sObs.cx, sObs.cy, colW-16, sObs.innerH, r.observaciones, lineH);

    const gapY = sObs.ny - 2, midY = gapY + SEP/2;
    doc.setFillColor(255,255,255); doc.setDrawColor(255,255,255);
    doc.rect(leftX, gapY, colW, SEP, 'F');
    doc.setDrawColor(...COLORS.panelStroke); doc.setLineWidth(0.8);
    doc.line(leftX+6, midY, leftX+colW-6, midY);
    yL = gapY + SEP + 6;

    const dxH  = Math.max(MIN_DX, availYMax - yL);
    const sDx = sectionBox(leftX, yL, colW, dxH, 'DIAGNÓSTICO');
    drawClamp(sDx.cx, sDx.cy, colW-16, sDx.innerH, r.diagnostico, lineH);
    yL = sDx.ny;
  }

  // DERECHA: MEDICAMENTOS
  { const lineH = linesH;
    const medsTxt = medsText(r.medicamentos);
    const tmp = wrap(medsTxt, colW-16);
    const need = Math.max(90, tmp.length * lineH + 6);
    const s = sectionBox(rightX, yR, colW, need, 'MEDICAMENTOS');
    drawClamp(s.cx, s.cy, colW-16, s.innerH, medsTxt, lineH);
    yR = s.ny;
  }

  // QR de Receta (tarjeta centrada)
  { const box=120, pad=10; let y = yR; const yMax = availYMax - (box + 20);
    y = Math.min(Math.max(y, startY), yMax);
    const xQR = rightX + (colW - box)/2;
    if (qrs?.main) {
      doc.setDrawColor(...COLORS.brand); doc.setLineWidth(2.2);
      doc.roundedRect(xQR, y, box, box, 10, 10, 'S');
      doc.addImage(qrs.main, 'PNG', xQR+pad, y+pad, box-2*pad, box-2*pad, undefined, 'FAST');
      doc.setTextColor(...COLORS.brand); doc.setFont(FONT,'bold'); doc.setFontSize(9.5);
      doc.text('Receta', xQR + box/2, y + box + 12, { align: 'center' });
      yR = y + box + 20;
    }
  }

  // Código de barras (ID)
  { await (window.ensureJsBarcode ? window.ensureJsBarcode() : (async () => {
      if (window.JsBarcode) return;
      await new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js';
        s.onload = res; s.onerror = rej; document.head.appendChild(s);
      });
    })());
    if (window.JsBarcode) {
      const canvas = document.createElement('canvas'); canvas.width = 300; canvas.height = 40;
      if (r.id) window.JsBarcode(canvas, String(r.id), { format:'CODE128', width:2, height:32, margin:4, displayValue:false });
      const barUrl = canvas.toDataURL('image/png');

      let imgW = Math.min(colW-20, 300), imgH = 40*(imgW/300);
      let x = rightX + (colW - imgW)/2; let y = yR + 6; let boxH = imgH + 26;
      for (const f of [0.95, 0.9, 0.85]) { if (y + boxH <= availYMax) break; imgW *= f; imgH *= f; boxH = imgH + 26; x = rightX + (colW-imgW)/2; }
      if (y + boxH <= availYMax) {
        doc.setFillColor(248,250,252); doc.setDrawColor(224,231,240); doc.setLineWidth(0.8);
        doc.roundedRect(rightX, y, colW, boxH, 8, 8, 'FD');
        doc.addImage(barUrl, 'PNG', x, y+8, imgW, imgH, undefined, 'FAST');
        doc.setFont(FONT,'bold'); doc.setFontSize(9); doc.setTextColor(55,65,81);
        doc.text('Código de barras (ID)', rightX + colW/2, y + imgH + 20, { align:'center' });
        yR = y + boxH + 10;
      }
    }
  }

  // HASH (real o simulado)
  { const s = sectionBox(rightX, yR, colW, 50, 'HASH');
    doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.sub);
    const hashLabel = r.hash ? `hash (BC): ${r.hash}` : 'hash (local): —';
    drawClamp(s.cx, s.cy, colW-16, s.innerH, hashLabel, 11);
    yR = s.ny;
  }

  // QR Blockchain mini + bloque
  { const mini = 90, rectW = mini, rectH = mini; const qrX = rightX + colW - rectW;
    let qrY = Math.max(yL, yR) + 6; if (qrY + rectH + 38 > availYMax) qrY = availYMax - rectH - 38;
    if (qrs?.chain) {
      doc.setDrawColor(...COLORS.brand); doc.setLineWidth(2.0);
      doc.roundedRect(qrX, qrY, rectW, rectH, 8, 8, 'S');
      doc.addImage(qrs.chain, 'PNG', qrX+8, qrY+8, rectW-16, rectH-16, undefined, 'FAST');
      doc.setTextColor(...COLORS.brand); doc.setFont(FONT,'bold'); doc.setFontSize(9);
      doc.text('Blockchain', qrX + rectW/2, qrY + rectH + 12, { align:'center' });
      const bn = blockNumber(r);
      doc.setTextColor(...COLORS.text); doc.setFont(FONT,'bold'); doc.setFontSize(10);
      doc.text('Bloque: ' + (bn || '—'), qrX + rectW/2, qrY + rectH + 26, { align:'center' });
      doc.setTextColor(...COLORS.sub); doc.setFont(FONT,'normal'); doc.setFontSize(8.5);
      doc.text('Para consultar bloque visitar kodrx.app', qrX + rectW/2, qrY + rectH + 38, { align:'center' });
    }
  }

  footer();

  // 7) Output
  const filename = `receta_${r.id || 'sin-id'}.pdf`;
  if (mode === 'print') {
    try { doc.autoPrint(); doc.output('dataurlnewwindow'); } catch { doc.save(filename); }
  } else if (mode === 'open') {
    const url = doc.output('bloburl'); window.open(url, '_blank');
  } else {
    doc.save(filename);
  }
};
    function bindButtons(){
    const btnD = document.getElementById('btnDescargar');
    const btnP = document.getElementById('btnImprimir');
    const btnB = document.getElementById('btnVolver');

    const onPDF = (mode)=>async (e)=>{
      e?.preventDefault?.();
      try{
        if (!window.RECETA_ACTUAL && typeof renderOnce==='function') await renderOnce();
        const r   = window.RECETA_ACTUAL || {};
        const qrs = window.QRS || (typeof getQRSources==='function' ? await getQRSources(r) : {});
        if (typeof generarPDF !== 'function'){ alert('Falta generador de PDF'); return; }
        await generarPDF(r, qrs, {mode});
      }catch(err){ console.error('[pdf]',err); alert('No se pudo generar el PDF.'); }
    };

    if (btnD && !btnD.__b){ btnD.type='button'; btnD.disabled=false; btnD.addEventListener('click', onPDF('save'),  {capture:true}); btnD.__b=true; }
    if (btnP && !btnP.__b){ btnP.type='button'; btnP.disabled=false; btnP.addEventListener('click', onPDF('print'), {capture:true}); btnP.__b=true; }
    if (btnB && !btnB.__b){
      btnB.type='button';
      btnB.addEventListener('click', (e)=>{ e.preventDefault(); if (history.length>1) history.back(); else location.href='/medico/panel.html'; }, {capture:true});
      btnB.__b=true;
    }
  }

// ===== Boot =====
  function start(){
    try{ typeof renderOnce==='function' && renderOnce().catch?.(console.error); }catch(e){}
    try{ bindButtons(); }catch(e){ console.warn('bindButtons err', e); }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start, {once:true});
  } else {
    start();
  }
})();
</script>

<script>
;(() => {
  // --- normalizador mínimo (solo si faltara) ---
  if (typeof window.normalize !== 'function') {
    window.normalize = function normalize(raw0){
      const raw = raw0 || {};
      const bc  = raw.blockchain || {};
      const bloque = Number.isFinite(raw.bloque) ? raw.bloque : (bc.block ?? null);
      const hash   = bc.hash ?? raw.hash ?? null;
      const status = bc.status || (bloque ? 'ok' : (hash ? 'simulado' : 'pendiente'));
      const medico = raw.medico || {
        nombre: raw.medicoNombre,
        genero: raw.medicoGenero,
        cedula: raw.medicoCedula,
        especialidad: raw.medicoEspecialidad,
        telefono: raw.medicoTelefono,
        direccion: raw.medicoDomicilio
      };
      const nombrePaciente = raw.nombrePaciente ?? raw.pacienteNombre ?? raw.paciente?.nombre ?? raw.paciente ?? '—';
      return { ...raw, nombrePaciente, medico,
        bloque, hash,
        blockchain: { ...bc, status, block: (bc.block ?? bloque) ?? null, hash }
      };
    };
  }

  // --- helpers ---
  const write = (key, val) => {
    const txt = String(val ?? '—');
    document.querySelectorAll('#'+key+', [data-bind="'+key+'"], .'+key)
      .forEach(el => { if (el && el.textContent !== txt) el.textContent = txt; });
  };
  const prefijoMed = (nombre, genero) => {
    if (!nombre) return '—';
    const g = String(genero||'').toLowerCase();
    return (g.startsWith('f') ? 'Dra. ' : 'Dr. ') + nombre;
  };

  // --- pintado central ---
  function paint(){
    const r0 = window.RECETA_ACTUAL;
    if (!r0) { console.log('[paint] no RECETA_ACTUAL aún'); return false; }
    const r  = window.normalize(r0);
    const m  = r.medico || {};

    // Médico
    write('doctorNombre', prefijoMed(m.nombre ?? r.medicoNombre, m.genero ?? r.medicoGenero));
    write('doctorCedula', m.cedula ?? r.medicoCedula);
    write('doctorEsp',    m.especialidad ?? r.medicoEspecialidad);
    write('doctorTel',    m.telefono ?? r.medicoTelefono);
    write('doctorDir',    m.direccion ?? r.medicoDomicilio);

    // Paciente
    write('pacienteNombre', r.paciente?.nombre ?? r.nombrePaciente ?? r.pacienteNombre);
    write('pacEdad',   r.paciente?.edad ?? r.edad);
    write('pacSexo',   r.paciente?.sexo ?? r.sexo);
    write('pacPeso',   r.paciente?.peso ?? r.peso);
    write('pacTalla',  r.paciente?.talla ?? r.talla);
    write('pacTemp',   r.paciente?.temperatura ?? r.temperatura);
    write('pacPresion',r.paciente?.presion ?? r.presion);
    write('pacIMC',    r.paciente?.imc ?? r.imc);

    // Textos
    write('obsTexto',  r.observaciones);
    write('diagTexto', r.diagnostico);

    // ID + fecha
    write('recetaId', 'ID: ' + (r.id || '—'));
    try{
      let ts = r.timestamp;
      if (ts && typeof ts.toDate==='function') ts = ts.toDate();
      else if (ts && typeof ts.seconds==='number') ts=new Date(ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6));
      else if (!(ts instanceof Date)) ts = new Date(ts);
      write('fechaEmision', ts ? ts.toLocaleString('es-MX',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '—');
    }catch{ write('fechaEmision','—'); }

    // oculta overlays
    ['#badgeVerificando','#spinnerVerificando','#panelVerificando','[data-role="verificando"]','.verificando','.spinner-verify']
      .forEach(sel => document.querySelectorAll(sel).forEach(el => (el.style.display='none')));

    console.log('[paint] OK');
    return true;
  }

  // expón y dispara
  window.kodrxPaint = paint;
  // 1) intenta pintar YA (por si ya está RECETA_ACTUAL)
  setTimeout(paint, 0);
  setTimeout(paint, 250);

  // 2) engancha renderOnce si existe (para pintar al final)
  (function hook(){
    if (typeof window.renderOnce === 'function' && !window.renderOnce.__kodrxHooked) {
      const orig = window.renderOnce;
      window.renderOnce = async function(...args){
        const out = await orig.apply(this, args);
        try { paint(); } catch {}
        return out;
      };
      window.renderOnce.__kodrxHooked = true;
      return;
    }
    setTimeout(hook, 200);
  })();

  // 3) repintado defensivo por si otro script borra texto
  let n=0; const iv=setInterval(()=>{ const ok=paint(); if ((ok && ++n>2) || n>20) clearInterval(iv); }, 300);
})();
</script>


