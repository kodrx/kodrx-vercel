<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KodRx | ver-receta-pdf-puro (jsPDF)</title>
  <style>
    :root{ --kodrx-blue:#0b5bd3; --kodrx-dark:#0b1b2b; --muted:#6b7280; --ok:#059669; --warn:#b45309 }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:#0f172a;color:#0f172a}
    .wrap{max-width:900px;margin:32px auto;padding:20px}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden}
    .card-header{display:flex;gap:16px;align-items:center;padding:16px 20px;border-bottom:1px solid #e5e7eb}
    .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#83fbc9,#0b5bd3);display:flex;align-items:center;justify-content:center;color:#001b3b;font-weight:800}
    .title{font-size:18px;font-weight:700;color:var(--kodrx-dark)}
    .sub{font-size:12px;color:var(--muted)}
    .badge{margin-left:auto;font-size:11px;padding:4px 8px;border-radius:999px;font-weight:700}
    .badge.ok{background:#ecfdf5;color:var(--ok);border:1px solid #a7f3d0}
    .badge.warn{background:#fffbeb;color:var(--warn);border:1px solid #fcd34d}

    .canvas{display:grid;grid-template-columns:1fr 1fr;gap:20px;padding:20px}
    .left{display:flex;flex-direction:column;gap:8px}
    .doc-label{font-size:12px;color:var(--muted);letter-spacing:.04em;text-transform:uppercase}
    .doc-val{font-size:16px;font-weight:700;color:#111827}

    .qr-frame{position:relative;display:flex;align-items:center;justify-content:center;background:#f8fafc;border:4px solid var(--kodrx-blue);border-radius:14px;min-height:280px}
    .qr-frame.small{min-height:140px;border-width:3px;border-radius:12px}
    .qr-legend{position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);background:#fff;color:var(--kodrx-blue);font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid var(--kodrx-blue);font-weight:700}

    .hash{margin-top:8px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;color:#111827;background:#f3f4f6;border-radius:10px;padding:10px;word-break:break-all}

    .footer{background:var(--kodrx-blue);color:#fff;padding:12px 16px;text-align:center;font-weight:600}

    .actions{display:flex;gap:12px;padding:16px;border-top:1px solid #e5e7eb;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .primary{background:var(--kodrx-blue);color:#fff}
    .ghost{background:#eef2ff;color:#111827}
    .meta{display:flex;gap:24px;color:#374151;font-size:13px;margin-top:6px}

    @media (max-width:720px){ .canvas{grid-template-columns:1fr} }
    @media print{ body{background:#fff} .actions,.card-header{display:none} .wrap{margin:0;padding:0} .card{box-shadow:none;border-radius:0} }
  </style>
</head>
<body class="page-border">
  <div class="wrap">
    <div class="card" id="previewCard">
      <div class="card-header">
        <div class="logo">K</div>
        <div>
          <div class="title">KodRx — Receta médica digital</div>
          <div class="sub">Vista previa en pantalla </div>
        </div>
        <span id="badgeOrigen" class="badge warn">MOCK</span>
      </div>

      <div class="canvas">
        <section class="left">
         <div>
  <div class="doc-label">Médico</div>
  <div class="doc-val" id="doctorNombre">—</div>
  <div class="meta">
    <div id="doctorCedula">Cédula: —</div>
    <div id="doctorEsp">Especialidad: —</div>
  </div>
  <div class="meta">
    <div id="doctorTel">Tel: —</div>
    <div id="doctorDir">Dirección: —</div>
  </div>
</div>


          <div>
  <div class="doc-label">Paciente</div>
  <div class="doc-val" id="pacienteNombre">—</div>
  <div class="meta">
    <div id="fechaEmision">—</div>
    <div id="recetaId">ID: —</div>
  </div>
  <div class="meta" id="pacienteVitals">
    <div id="pacEdad">Edad: —</div>
    <div id="pacSexo">Sexo: —</div>
    <div id="pacPeso">Peso: —</div>
    <div id="pacTalla">Talla: —</div>
    <div id="pacIMC">IMC: —</div>
    <div id="pacTemp">Temp: —</div>
    <div id="pacPresion">PA: —</div>
  </div>
</div>

<div>
  <div class="doc-label">Observaciones</div>
  <div id="obsTexto" class="hash" style="white-space:pre-wrap">—</div>
</div>

<div>
  <div class="doc-label">Diagnóstico</div>
  <div id="diagTexto" class="hash" style="white-space:pre-wrap">—</div>
</div>

          <div>
            <div class="doc-label">Medicamentos</div>
            <div id="listaMeds" class="hash" style="white-space:pre-wrap">—</div>
          </div>

          
        </section>

        <section class="right">
          <div class="qr-frame">
            <div id="qrMain"></div>
            <div class="qr-legend">Receta</div>
          </div>
          <div class="hash" id="hashTexto">hash: —</div>

          <div style="display:grid;grid-template-columns:1fr auto;gap:14px;align-items:center;margin-top:6px">
            <div>
              <div class="doc-label">Verificación en cadena (pública)</div>
              <div class="sub" id="verifUrl">—</div>
            </div>
            <div class="qr-frame small" style="width:150px;height:150px">
              <div id="qrChain"></div>
              <div class="qr-legend" style="bottom:-12px;font-size:10px">Blockchain</div>
            </div>
          </div>
        </section>
      </div>

      <div class="footer">Creada con KodRx. Tecnología que verifica, salud que protege.</div>

      <div class="actions">
        <button class="primary" id="btnDescargar">Descargar PDF</button>
        <button class="ghost" onclick="window.print()">Imprimir</button>
        <button class="ghost" id="btnCargarEjemplo">Cargar ejemplo</button>
      </div>
    </div>
  </div>

  <!-- jsPDF (puro) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- QRCode.js para generar QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Firebase (opcional): si hay ID, intentará traer receta real de Firestore -->
  <script type="module">
    // ⚠️ Rellena con tu configuración real de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBIjaOe4HcGNDk0xrqen8etBv0RyjyOJHw",
      authDomain: "kodrx-105b9.firebaseapp.com",
      projectId: "kodrx-105b9"
    };

    try{
      const [{ initializeApp }, { getFirestore, doc, getDoc }] = await Promise.all([
        import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'),
        import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js')
      ]);

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Expone un helper global para que el script no-módulo lo use
      window.kodrxGetReceta = async (id) => {
        try{
          // Ajusta la colección/nombre a tu esquema real
          const ref = doc(db, 'recetas', id);
          const snap = await getDoc(ref);
          if(!snap.exists()) return null;
          const d = snap.data();
          // Mapea a la estructura esperada por el renderer
          const receta = {
            id,
            medico: {
              nombre: d.medicoNombre || d.medico?.nombre || '—',
              genero: d.medicoGenero || d.medico?.genero || '',
              cedula: d.medicoCedula || d.medico?.cedula || '—',
              especialidad: d.medicoEspecialidad || d.medico?.especialidad || '—'
            },
            paciente: { nombre: d.nombrePaciente || d.pacienteNombre || d.paciente?.nombre || '—' },
            medicamentos: (d.medicamentos || d.items || []).map((m, i) => ({
              nombre: m.nombre || m.medicamento || `Medicamento ${i+1}`,
              dosis: m.dosis || m.indicaciones || '—',
              duracion: m.duracion || m.tiempo || '—'
            })),
            timestamp: d.timestamp || d.fecha || Date.now(),
            urlVerificacion: `https://kodrx.app/verificar.html?id=${encodeURIComponent(id)}`,
            urlBlockchain: `https://kodrx-blockchain.onrender.com/verificar.html?id=${encodeURIComponent(d.bloque || id)}`,
            _origen: 'firestore'
          };
          console.info('[KodRx] Receta obtenida de Firestore:', id);
          // Normaliza fecha si viene como Timestamp de Firestore
receta.timestamp = (d.fecha && typeof d.fecha.toDate === 'function')
  ? d.fecha.toDate()
  : (d.timestamp || d.fecha || Date.now());

// Enriquecer con campos adicionales
receta.medico.telefono  = d.medicoTelefono || d.medico?.telefono || '—';
receta.medico.direccion = d.medicoDomicilio || d.medico?.domicilio || d.medico?.direccion || '—';

receta.paciente = {
  ...receta.paciente,
  edad:        d.edad ?? d.paciente?.edad ?? '—',
  sexo:        d.sexo ?? d.paciente?.sexo ?? '—',
  peso:        d.peso ?? d.paciente?.peso ?? '—',
  talla:       d.talla ?? d.paciente?.talla ?? '—',
  imc:         d.imc ?? d.paciente?.imc ?? '—',
  temperatura: d.temperatura ?? d.paciente?.temperatura ?? '—',
  presion:     d.presion ?? d.paciente?.presion ?? '—'
};

receta.observaciones = d.observaciones || '—';
receta.diagnostico   = d.diagnostico   || '—';

          return receta;
        }catch(e){
          console.warn('[KodRx] No se pudo leer Firestore, usando mock. Motivo:', e);
          return null;
        }
      }
    }catch(e){
      console.warn('[KodRx] Firebase no disponible (modo demo). Puedes ignorar este aviso si aún no configuras Firebase.');
    }
  </script>

  <script>
    // ====== Utilidades ======
    const KODRX_BLUE = '#0b5bd3';

    // Espera a que las librerías UMD (jsPDF y QRCode) se carguen correctamente
    async function waitForLibs(maxTries = 50){
      let tries = 0;
      return new Promise(resolve => {
        (function check(){
          if (window.jspdf && window.QRCode){ resolve(); return; }
          if (++tries >= maxTries){ console.warn('Aviso: librerías no confirmadas, continúo'); resolve(); return; }
          setTimeout(check, 100);
        })();
      });
    }

    function prefixMedico(nombre, genero){
      if(!nombre) return '';
      const g = (genero||'').toLowerCase();
      const pref = (g.startsWith('f'))? 'Dra. ':'Dr. ';
      return pref + nombre;
    }

   function fechaLarga(ts){
  try{
    const d = (ts && typeof ts.toDate === 'function') ? ts.toDate()
            : (ts instanceof Date ? ts : new Date(ts));
    return d.toLocaleString('es-MX',{
      year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'
    });
  }catch(e){ return String(ts||''); }
}


    function hashSimulado(receta){
      const base = JSON.stringify({id:receta.id, meds:receta.medicamentos, t:receta.timestamp});
      let h = 0; for (let i=0;i<base.length;i++){ h = (h*31 + base.charCodeAt(i))>>>0; }
      return ('00000000'+h.toString(16)).slice(-8)+('-'+btoa(unescape(encodeURIComponent(receta.id))).replace(/=+$/,''));
    }

    // Construye un mock distinto basado en el ID (si no hay Firestore) para que se note el cambio
    function mockFromId(id){
      const suf = (id||'').slice(0,6) || 'EJEMP1';
      return {
        id,
        medico:{ nombre: `Dra. Demo ${suf}`, genero:'F', cedula:`MX-${suf}`, especialidad:'Medicina General' },
        paciente:{ nombre:`Paciente ${suf}` },
        medicamentos:[
          { nombre:`IBUPROFENO 400mg ${suf}`, dosis:'1 tableta cada 8 h', duracion:'3 días' },
          { nombre:`OMEPRAZOL 20mg ${suf}`, dosis:'1 cápsula en ayunas', duracion:'7 días' }
        ],
        timestamp: Date.now(),
        urlVerificacion: location.origin + '/public/verificar.html?id='+encodeURIComponent(id),
        urlBlockchain: location.origin + '/public/consulta.html?block='+encodeURIComponent(id),
        _origen:'mock-id'
      };
    }

    function makeQRDataURL(text, size=260){
      return new Promise((resolve)=>{
        if (typeof QRCode === 'undefined'){ console.error('QRCode no está disponible'); resolve(''); return; }
        const div = document.createElement('div');
        new QRCode(div,{text,width:size,height:size,correctLevel:QRCode.CorrectLevel.M});
        setTimeout(()=>{
          const img = div.querySelector('img');
          if(img && img.src){ resolve(img.src); }
          else{
            const canvas = div.querySelector('canvas');
            resolve(canvas? canvas.toDataURL('image/png') : '');
          }
        }, 0);
      });
    }

    // ====== Carga de datos ======
 async function cargarRecetaDesdeQuery(){
  const p = new URLSearchParams(location.search);
  const id = p.get('id') || 'RECETA-DE-EJEMPLO-001';

  // Si viene ?id=..., espera a que Firebase exponga el helper y prueba Firestore
  if (p.get('id')){
    const hasFS = await waitForFirestoreHelper(5000);
    if (hasFS){
      try{
        const r = await window.kodrxGetReceta(id);
        if (r){ r._origen = 'firestore'; return r; }
      }catch(e){
        console.warn('[KodRx] Error Firestore, usaré mock con ID:', e);
      }
    }else{
      console.warn('[KodRx] Helper Firestore no llegó a tiempo, usaré mock con ID');
      return mockFromId(id); // para que veas cambios aunque no haya FS
    }
  }

  // Mock por defecto (cuando no hay ?id=)
  return {
    id,
    medico:{ nombre:'Gabriela López Ramírez', genero:'F', cedula:'1234567', especialidad:'Medicina Interna' },
    paciente:{ nombre:'Juan Pérez' },
    medicamentos:[
      { nombre:'Amoxicilina 500 mg', dosis:'1 cápsula cada 8 h', duracion:'7 días' },
      { nombre:'Paracetamol 500 mg', dosis:'1 tableta cada 8 h si dolor', duracion:'5 días' }
    ],
    timestamp: Date.now(),
    urlVerificacion: location.origin + '/public/verificar.html?id='+encodeURIComponent(id),
    urlBlockchain: location.origin + '/public/consulta.html?block='+encodeURIComponent(id),
    _origen:'mock'
  };
}


function renderPreview(receta, mainQRDataURL, chainQRDataURL){
  // Datos de médico
  document.getElementById('doctorNombre').textContent = prefixMedico(receta.medico.nombre, receta.medico.genero);
  document.getElementById('doctorCedula').textContent = 'Cédula: '+(receta.medico.cedula||'—');
  document.getElementById('doctorEsp').textContent = 'Especialidad: '+(receta.medico.especialidad||'—');
  document.getElementById('doctorTel').textContent = 'Tel: '+(receta.medico.telefono||'—');
  document.getElementById('doctorDir').textContent = 'Dirección: '+(receta.medico.direccion||'—');

  // Datos de paciente
  document.getElementById('pacienteNombre').textContent = receta.paciente.nombre||'—';
  document.getElementById('pacEdad').textContent = 'Edad: '+(receta.paciente.edad||'—');
  document.getElementById('pacSexo').textContent = 'Sexo: '+(receta.paciente.sexo||'—');
  document.getElementById('pacPeso').textContent = 'Peso: '+(receta.paciente.peso||'—');
  document.getElementById('pacTalla').textContent = 'Talla: '+(receta.paciente.talla||'—');
  document.getElementById('pacIMC').textContent = 'IMC: '+(receta.paciente.imc||'—');
  document.getElementById('pacTemp').textContent = 'Temp: '+(receta.paciente.temperatura||'—');
  document.getElementById('pacPresion').textContent = 'PA: '+(receta.paciente.presion||'—');

  document.getElementById('fechaEmision').textContent = fechaLarga(receta.timestamp);
  document.getElementById('recetaId').textContent = 'ID: '+receta.id;

  // Medicamentos
  const medsText = (receta.medicamentos||[]).map((m,i)=>`${i+1}. ${m.nombre}\n   Dosis: ${m.dosis}\n   Duración: ${m.duracion}`).join('\n\n');
  document.getElementById('listaMeds').textContent = medsText;

  // Observaciones y diagnóstico
  document.getElementById('obsTexto').textContent = receta.observaciones||'—';
  document.getElementById('diagTexto').textContent = receta.diagnostico||'—';

  document.getElementById('hashTexto').textContent = 'hash: '+hashSimulado(receta);
  document.getElementById('verifUrl').textContent = receta.urlBlockchain;

  // QR - Ajustar tamaños
  // QR principal en pantalla (más compacto)
const qrMain = document.getElementById('qrMain');
qrMain.innerHTML = '';
const img1 = new Image();
img1.alt = 'QR Receta';
img1.width = 200;   // antes 240
img1.height = 200;  // antes 240
img1.src = mainQRDataURL;
qrMain.appendChild(img1);

// QR blockchain en pantalla (más compacto)
const qrChain = document.getElementById('qrChain');
qrChain.innerHTML = '';
const img2 = new Image();
img2.alt = 'QR Blockchain';
img2.width = 100;   // antes 120
img2.height = 100;  // antes 120
img2.src = chainQRDataURL;
qrChain.appendChild(img2);


      // Actualiza badge de origen
      const badge = document.getElementById('badgeOrigen');
      if (receta._origen === 'firestore'){ badge.textContent = 'FIRESTORE'; badge.className='badge ok'; }
      else if (receta._origen === 'mock-id'){ badge.textContent = 'MOCK (ID)'; badge.className='badge warn'; }
      else { badge.textContent = 'MOCK'; badge.className='badge warn'; }
    }

    async function prepararReceta(receta){
      const mainQRUrl = await makeQRDataURL(receta.urlVerificacion, 520);
      const chainQRUrl = await makeQRDataURL(receta.urlBlockchain, 260);
      renderPreview(receta, mainQRUrl, chainQRUrl);
      return { mainQRUrl, chainQRUrl };
    }

    // ====== Generación de PDF con jsPDF puro ======
async function generarPDF(receta, qrs){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4', compress:true }); // 595 x 842
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const Mx = 48, My = 54;
  const font = 'helvetica';
  doc.setFont(font, 'normal');

  // ===== Marco exterior
  doc.setDrawColor(220,226,235);
  doc.setLineWidth(1.2);
  doc.roundedRect(18, 18, W-36, H-36, 12, 12, 'S');

  // ===== Encabezado dentro del marco
  doc.setFillColor(240,245,255);
  doc.roundedRect(18,18,W-36,60,12,12,'F');
  doc.setTextColor(11,27,43);
  doc.setFontSize(14);
  doc.text('KodRx — Receta médica digital', Mx, 50);

  // Columnas
  const leftX = Mx, leftW = W/2 - Mx - 12;
  const rightX = W/2 + 12, rightW = W - rightX - Mx;

  // ===== Helper de panel sombreado
  const PANEL_FILL = [248,250,252];  // #F8FAFC
  const PANEL_STROKE = [224,231,240]; // #E0E7F0
  function panel(x, y, w, h){
    doc.setFillColor(...PANEL_FILL);
    doc.setDrawColor(...PANEL_STROKE);
    doc.setLineWidth(1);
    doc.roundedRect(x-10, y-12, w+20, h+24, 10, 10, 'FD');
  }

  // ===== Precalcular contenidos para saber alturas
  const fechaStr = (function(ts){
    try{
      const d = (ts && typeof ts.toDate==='function') ? ts.toDate() : (ts instanceof Date ? ts : new Date(ts));
      return d.toLocaleString('es-MX',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
    }catch(e){ return String(ts||''); }
  })(receta.timestamp);

  const medsLines = (receta.medicamentos||[])
    .map((m,i)=>`${i+1}. ${m.nombre}\n   Dosis: ${m.dosis}\n   Duración: ${m.duracion}`)
    .join('\n\n');
  const medsSplit = doc.splitTextToSize(medsLines, leftW);
  const obsSplit  = doc.splitTextToSize(receta.observaciones||'—', leftW);
  const diagSplit = doc.splitTextToSize(receta.diagnostico||'—', leftW);

  // Alturas (coherentes con tamaños de fuente abajo)
  const medicoH = 94;
  const pacBaseY = My+112;
  const pacienteH = 112;
  const medsH = (medsSplit.length * 13) + 28;
  const obsH  = (obsSplit.length  * 12) + 28;
  const diagH = (diagSplit.length * 12) + 28;

  // ===== Paneles izquierda
  panel(leftX, My, leftW, medicoH);               // Médico
  panel(leftX, pacBaseY, leftW, pacienteH);       // Paciente
  let yPanels = pacBaseY + pacienteH + 16;
  panel(leftX, yPanels, leftW, medsH);            // Medicamentos
  yPanels += medsH + 16;
  panel(leftX, yPanels, leftW, obsH);             // Observaciones
  yPanels += obsH + 16;
  panel(leftX, yPanels, leftW, diagH);            // Diagnóstico

  // ===== Contenidos sobre paneles
  // Médico
  doc.setTextColor(107,114,128); doc.setFontSize(10); doc.setFont(font,'normal');
  doc.text('Médico', leftX, My);
  doc.setTextColor(17,24,39); doc.setFontSize(14); doc.setFont(font,'bold');
  doc.text(prefixMedico(receta.medico.nombre, receta.medico.genero), leftX, My+18);
  doc.setFont(font,'normal'); doc.setFontSize(10); doc.setTextColor(55,65,81);
  doc.text(`Cédula: ${receta.medico.cedula||'—'}`, leftX, My+34);
  doc.text(`Especialidad: ${receta.medico.especialidad||'—'}`, leftX, My+50);
  doc.text(`Tel: ${receta.medico.telefono||'—'}`, leftX, My+66);
  doc.text(`Dirección: ${receta.medico.direccion||'—'}`, leftX, My+82);

  // Paciente
  doc.setTextColor(107,114,128); doc.setFontSize(10);
  doc.text('Paciente', leftX, pacBaseY);
  doc.setTextColor(17,24,39); doc.setFontSize(14); doc.setFont(font,'bold');
  doc.text(receta.paciente.nombre||'—', leftX, pacBaseY+18);
  doc.setFont(font,'normal'); doc.setFontSize(10); doc.setTextColor(55,65,81);
  doc.text(fechaStr, leftX, pacBaseY+34);
  doc.text(`ID: ${receta.id}`, leftX, pacBaseY+50);
  let y = pacBaseY + 68;
  doc.text(`Edad: ${receta.paciente.edad||'—'}  Sexo: ${receta.paciente.sexo||'—'}`, leftX, y); y+=16;
  doc.text(`Peso: ${receta.paciente.peso||'—'}  Talla: ${receta.paciente.talla||'—'}  IMC: ${receta.paciente.imc||'—'}`, leftX, y); y+=16;
  doc.text(`Temp: ${receta.paciente.temperatura||'—'}  PA: ${receta.paciente.presion||'—'}`, leftX, y);

  // Medicamentos
  let medsY = pacBaseY + pacienteH + 16;
  doc.setTextColor(107,114,128); doc.setFontSize(10);
  doc.text('Medicamentos', leftX, medsY);
  doc.setTextColor(17,24,39); doc.setFontSize(11);
  doc.text(medsSplit, leftX, medsY+18);

  // Observaciones
  let obsY = medsY + 18 + (medsSplit.length * 13) + 12;
  doc.setTextColor(107,114,128); doc.setFontSize(10);
  doc.text('Observaciones', leftX, obsY);
  doc.setTextColor(17,24,39); doc.setFontSize(10);
  doc.text(obsSplit, leftX, obsY+16);

  // Diagnóstico
  let diagY = obsY + 16 + (obsSplit.length * 12) + 24;
  doc.setTextColor(107,114,128); doc.setFontSize(10);
  doc.text('Diagnóstico', leftX, diagY);
  doc.setTextColor(17,24,39); doc.setFontSize(10);
  doc.text(diagSplit, leftX, diagY+16);

  // ===== Derecha: QR principal y blockchain más abajo
  const qrBoxSize = 230;      // más compacto
  const qrPadding = 14;
  const qrInner = qrBoxSize - qrPadding*2;
  doc.setDrawColor(11,91,211); doc.setLineWidth(4);
  doc.roundedRect(rightX, My, qrBoxSize, qrBoxSize, 12, 12, 'S');
  doc.addImage(qrs.mainQRUrl, 'PNG', rightX+qrPadding, My+qrPadding, qrInner, qrInner, undefined, 'FAST');
  doc.setTextColor(11,91,211); doc.setFont(font,'bold'); doc.setFontSize(10);
  doc.text('Receta', rightX + qrBoxSize/2, My + qrBoxSize + 18, {align:'center'});

  // Hash
  let ry = My + qrBoxSize + 40;
  doc.setTextColor(17,24,39); doc.setFont(font,'normal'); doc.setFontSize(10);
  const hashText = 'hash: '+hashSimulado(receta);
  const hashSplit = doc.splitTextToSize(hashText, rightW);
  doc.text(hashSplit, rightX, ry);
  ry += hashSplit.length * 12 + 26;

  // Verificación + QR pequeño (más abajo y más chico)
  doc.setTextColor(107,114,128); doc.setFontSize(10);
  doc.text('Verificación en cadena (pública)', rightX, ry);
  doc.setTextColor(55,65,81); doc.setFontSize(9);
  const urlSplit = doc.splitTextToSize(receta.urlBlockchain, rightW - 120);
  doc.text(urlSplit, rightX, ry+16);
  doc.setFontSize(10);

  const miniSize = 100;  // más pequeño
  doc.setDrawColor(11,91,211); doc.setLineWidth(3);
  doc.roundedRect(rightX + rightW - miniSize, ry - 8, miniSize, miniSize, 10, 10, 'S');
  doc.addImage(qrs.chainQRUrl, 'PNG',
    rightX + rightW - miniSize + 10, ry + 2, miniSize-20, miniSize-20, undefined, 'FAST');
  doc.setTextColor(11,91,211); doc.setFont(font,'bold'); doc.setFontSize(9);
  doc.text('Blockchain', rightX + rightW - miniSize/2, ry + miniSize + 10, {align:'center'});

  // Pie
  doc.setFillColor(11,91,211);
  doc.rect(18, H-60-18, W-36, 60, 'F');
  doc.setTextColor(255,255,255); doc.setFont(font,'bold'); doc.setFontSize(11);
  doc.text('Creada con KodRx. Tecnología que verifica, salud que protege.', W/2, H-24, {align:'center'});

  // Guardar
  doc.save(`receta_${receta.id}.pdf`);
}

    // ====== Boot ======
    let RECETA_ACTUAL = null; let QRS = null;

async function boot(){
  await waitForLibs();
  const p = new URLSearchParams(location.search);
  if (p.get('id')){ await waitForFirestoreHelper(5000); }  // <- agrega esta línea
  const receta = await cargarRecetaDesdeQuery();
  RECETA_ACTUAL = receta;
  QRS = await prepararReceta(receta);
}

    document.getElementById('btnDescargar').addEventListener('click', async ()=>{
      await waitForLibs();
      if(!RECETA_ACTUAL){ RECETA_ACTUAL = await cargarRecetaDesdeQuery(); }
      if(!QRS){ QRS = await prepararReceta(RECETA_ACTUAL); }
      generarPDF(RECETA_ACTUAL, QRS);
    });

    // Espera a que window.kodrxGetReceta exista (lo pone el <script type="module"> de Firebase)
async function waitForFirestoreHelper(maxMs = 5000){
  const t0 = Date.now();
  while (Date.now() - t0 < maxMs){
    if (typeof window.kodrxGetReceta === 'function') return true;
    await new Promise(r=>setTimeout(r,100));
  }
  return false;
}


    document.getElementById('btnCargarEjemplo').addEventListener('click', async ()=>{
      const receta = await cargarRecetaDesdeQuery();
      RECETA_ACTUAL = receta; QRS = await prepararReceta(receta);
    });

    // Auto-carga
    boot();
  </script>
</body>
</html>

