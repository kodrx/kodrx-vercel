<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KodRx | ver-receta-pdf-puro (jsPDF)</title>
  <style>
/* ===== Layout general ===== */
.receta-wrap{
  max-width: 940px;   /* ancho c√≥modo en desktop */
  margin: 16px auto;
  padding: 12px;
}

.receta{
  display: grid;
  grid-template-columns: 1fr 340px; /* izquierda flexible + derecha fija */
  gap: 16px;
  align-items: start;
}

/* Header */
.receta-header{
  grid-column: 1 / -1;
  background: #F0F5FF;
  color: #0b1b2b;
  padding: 14px 16px;
  border-radius: 12px;
  font-weight: 700;
}
/* ===== Botones / acciones ===== */
.actions{
  display:flex; gap:12px; padding:14px 0; justify-content:flex-start; flex-wrap:wrap;
}
button{
  appearance:none; border:0; cursor:pointer; font-weight:700;
  border-radius:12px; padding:10px 14px; transition:transform .04s ease, box-shadow .2s ease;
}
button:active{ transform:translateY(1px) }
.primary{
  background:#0b5bd3; color:#fff;
  box-shadow:0 6px 16px rgba(11,91,211,.2);
}
.primary:hover{ box-shadow:0 8px 22px rgba(11,91,211,.25) }
.ghost{
  background:#eef2ff; color:#0b1b2b; border:1px solid #dbe3ff;
}
.ghost:hover{ background:#e6ebff }

/* Oculta acciones en impresi√≥n */
@media print{ .actions{ display:none !important } }

/* Badge origen */
.badge{
  display:inline-block; padding:4px 10px; border-radius:999px;
  font-size:12px; font-weight:700; margin-left:8px;
}
.badge.ok{ background:#e7f6e8; color:#0b8b2b; }
.badge.warn{ background:#fff3cd; color:#7a5a00; }

/* ===== Paneles (cards) ===== */
.card{
  background: #f8fafc;
  border:1px solid #e0e7f0;
  border-radius: 14px;
  padding: 12px;
}
.card .title{
  color:#6b7280;
  font-weight:800;
  letter-spacing:.02em;
  margin: 2px 0 8px;
  text-transform: uppercase;
}
.card .kv{ color:#374151; font-size:14px; line-height:1.35; }
.card .kv b{ color:#6b7280; margin-right:6px; }

/* Evitar desbordes de textos largos */
.card, .kv, .sub{
  overflow-wrap:anywhere; word-break:break-word;
}

/* ===== Columna derecha como columna flexible ===== */
.col-right{
  display:flex; flex-direction:column; gap:16px; min-height:100%;
}
.col-right .spacer{ flex:1 1 auto; } /* empuja blockchain hacia abajo si hay espacio */

/* Medicamentos en formato lista bloque */
.meds{
  white-space:pre-wrap; /* respeta saltos */
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  font-size: 14px; line-height:1.35; color:#111827;
}

/* ===== QRs ===== */
.qr-frame{
  border:2px solid #0b5bd3; border-radius:12px; padding:8px;
  display:flex; align-items:center; justify-content:center; background:#fff;
}
.qr-legend{
  color:#0b5bd3; font-weight:700; font-size:12px; text-align:center; margin-top:6px;
}
.qr-main img{ width: 220px; height: 220px; }       /* Receta */
.qr-chain img{ width: 110px; height: 110px; }      /* Blockchain */
/* C√≥digo de barras */
#panelBarcode canvas{
  max-width: 100%;
}
@media print{
  #panelBarcode canvas{
    width: 70mm !important;   /* ~ 265 px */
    height: 11mm !important;  /* ~ 83 px */
  }
}

/* Hash */
.hash{
  background:#f3f4f6; border:1px solid #e5e7eb; border-radius:10px;
  padding:6px 8px; color:#374151; font-size:12px; white-space:normal;
}

/* Pie de p√°gina */
.footer{
  grid-column: 1 / -1;
  background:#0b5bd3; color:#fff;
  border-radius:12px;
  padding: 12px 16px;
  text-align:center; font-weight:700; margin-top:6px;
}

/* ===== Responsive ===== */
@media (max-width: 920px){
  .receta{ grid-template-columns: 1fr; }
  .col-right{ order: 2; }  /* si quieres, puedes moverla */
  .qr-main img{ width: 200px; height:200px; }
  .qr-chain img{ width: 100px; height:100px; }
}
@media (max-width: 520px){
  .qr-main img{ width: 180px; height:180px; }
  .qr-chain img{ width: 90px; height:90px; }
}

/* ===== PRINT: header fijo arriba + reserva de espacio ===== */
@page{ size: A4 portrait; margin: 8mm; }

@media print{
  /* Reservas para header y footer fijos */
  .receta-wrap{
    padding-top: 22mm !important;   /* altura reservada p/ header fijo */
    padding-bottom: 22mm !important;/* ya la ten√≠as para footer fijo */
  }

  /* Header fijo centrado con el mismo ancho de la hoja */
  .receta-header{
    position: fixed !important;
    top: 8mm !important;                  /* al ras del margen de p√°gina */
    left: 50% !important;
    transform: translateX(-50%) !important;
    width: 185mm !important;              /* igual que el contenido */
    margin: 0 !important;
    padding: 8px 10px !important;
    border-radius: 8px !important;
    z-index: 20 !important;
    display: block !important;            /* que no intente ser ‚Äúcelda‚Äù */
    -webkit-print-color-adjust: exact;    /* conserva color de fondo */
    print-color-adjust: exact;
  }

  /* Mant√©n la tabla de 2 columnas para el contenido (como ya pusimos) */
  .receta{
    display: table !important;
    width: 185mm !important;
    table-layout: fixed !important;
    border-collapse: separate !important;
    border-spacing: 0 0 !important;
  }
  .col-left, .col-right{
    display: table-cell !important;
    vertical-align: top !important;
    page-break-inside: avoid !important;
    break-inside: avoid !important;
    -webkit-column-break-inside: avoid !important;
  }
  .col-left{
    width: calc(185mm - 82mm - 8mm) !important;
    padding-right: 4mm !important;
  }
  .col-right{
    width: 82mm !important;
    padding-left: 4mm !important;
  }
}

  /* --- Footer fuera del flujo de la "tabla" --- */
  .receta-wrap{ padding-bottom: 22mm !important; } /* reserva espacio para el footer fijo */
  .footer{
    position: fixed !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    bottom: 8mm !important;           /* coincide con @page margin */
    width: 185mm !important;          /* mismo ancho que .receta tabla */
    margin: 0 !important;
    border-radius: 8px !important;
    padding: 8px 10px !important;
    font-size: 12px !important;
    z-index: 10 !important;
    /* evita que se renderice como parte de la tabla */
    display: block !important;
  }

  /* Compacta un poco para asegurar 1 p√°gina */
  .card{ padding:8px !important; margin-bottom:8px !important; border-radius:10px !important; }
  .card .title{ font-size:11px !important; margin:2px 0 4px !important; }
  .kv, .meds{ font-size:12px !important; line-height:1.25 !important; }

  /* QRs en mm (m√°s estable en WebKit) */
  .qr-main img{ width:60mm !important; height:60mm !important; }
  .qr-chain img{ width:32mm !important; height:32mm !important; }
  .qr-frame{ padding:5px !important; border-width:2px !important; }
  .qr-legend{ font-size:11px !important; padding:3px 8px !important; margin-top:4px !important; }

  /* Nada se parte raro */
  .card, .qr-frame, #listaMedsDerecha, #obsTexto, #diagTexto{
    page-break-inside: avoid !important;
    break-inside: avoid !important;
    -webkit-column-break-inside: avoid !important;
  }

  /* Colores s√≥lidos en WebKit */
  body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; background:#fff !important; }
}



  </style>
</head>
<body class="page-border">
  <div class="receta-wrap">
  <div class="receta">
     <div class="actions">
  <button class="ghost" id="btnRegresar">Regresar</button>
  <button class="primary" id="btnDescargar">Descargar PDF</button>
  <button class="ghost" onclick="window.print()">Imprimir</button>

</div>    <!-- Header -->
    <div class="receta-header">
      KodRx ‚Äî Receta m√©dica digital
      <span id="badgeOrigen" class="badge ok">Receta Verificada</span>
    </div>

    <!-- Columna IZQUIERDA -->
    <div class="col-left" style="display:flex;flex-direction:column;gap:16px">

      <section class="card">
        <div class="title">M√âDICO</div>
        <div class="kv" id="doctorNombre">‚Äî</div>
        <div class="kv"><b>C√©dula:</b> <span id="doctorCedula">‚Äî</span> &nbsp;&nbsp; <b>Especialidad:</b> <span id="doctorEsp">‚Äî</span></div>
        <div class="kv"><b>Tel:</b> <span id="doctorTel">‚Äî</span></div>
        <div class="kv"><b>Direcci√≥n:</b> <span id="doctorDir">‚Äî</span></div>
      </section>

      <section class="card">
        <div class="title">PACIENTE</div>
        <div class="kv" id="pacienteNombre">‚Äî</div>
        <div class="kv sub" style="margin-top:6px">
          <span id="fechaEmision">‚Äî</span> &nbsp;&nbsp; <span id="recetaId">ID: ‚Äî</span>
        </div>
        <div class="kv" style="margin-top:8px">
          <b>Edad:</b> <span id="pacEdad">‚Äî</span> &nbsp;&nbsp;
          <b>Sexo:</b> <span id="pacSexo">‚Äî</span>
        </div>
        <div class="kv">
          <b>Peso:</b> <span id="pacPeso">‚Äî</span> &nbsp;&nbsp;
          <b>Talla:</b> <span id="pacTalla">‚Äî</span>
        </div>
        <div class="kv">
          <b>Temp:</b> <span id="pacTemp">‚Äî</span> &nbsp;&nbsp;
          <b>PA:</b> <span id="pacPresion">‚Äî</span>
        </div>
        <div class="kv">
          <b>IMC:</b> <span id="pacIMC">‚Äî</span>
        </div>
      </section>

      <section class="card">
        <div class="title">OBSERVACIONES</div>
        <div class="kv" id="obsTexto">‚Äî</div>
      </section>

      <section class="card">
        <div class="title">DIAGN√ìSTICO</div>
        <div class="kv" id="diagTexto">‚Äî</div>
      </section>
    </div>

    <!-- Columna DERECHA -->
    <div class="col-right">
      <section class="card">
        <div class="title">MEDICAMENTOS</div>
        <pre class="meds" id="listaMedsDerecha">‚Äî</pre>
      </section>

      <section class="card" style="text-align:center">
        <div class="qr-frame qr-main"><div id="qrMain"></div></div>
        <div class="qr-legend">Receta</div>
      </section>
<!-- === C√ìDIGO DE BARRAS (ID) === -->
<section class="card" id="panelBarcode">
  <div class="title">C√ìDIGO DE BARRAS (ID)</div>
  <div style="display:flex;justify-content:center">
    <canvas id="barcodeCanvas" width="320" height="90"></canvas>
  </div>
  <div class="sub" style="text-align:center;margin-top:4px">
    <span id="barcodeLabel">‚Äî</span>
  </div>
</section>

      <section class="card">
        <div class="title">HASH</div>
        <div class="hash" id="hashTexto">hash: ‚Äî</div>
      </section>

      <div class="spacer"></div> <!-- empuja blockchain hacia abajo si hay espacio -->

      <section class="card" style="text-align:center">
        <div class="qr-frame qr-chain"><div id="qrChain"></div></div>
        <div class="qr-legend">
          Blockchain<br>
          <span id="blockNum" style="color:#111827;font-weight:800"></span><br>
          <span class="sub" style="color:#6b7280;font-weight:400">Para verificar receta visitar kodrx.app</span>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <div class="footer">
      Creada con KodRx. Plataforma digital de recetas verificadas con trazabilidad tecnol√≥gica.
    </div>

  </div>
</div>

      <div class="actions">
  <button class="ghost" id="btnRegresar">Regresar</button>
  <button class="primary" id="btnDescargar">Descargar PDF</button>
  <button class="ghost" onclick="window.print()">Imprimir</button>

</div>

    </div>
  </div>

  <!-- jsPDF (puro) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- QRCode.js para generar QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Firebase (opcional): si hay ID, intentar√° traer receta real de Firestore -->
  <script type="module">
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBIjaOe4HcGNDk0xrqen8etBv0RyjyOJHw",
    authDomain: "kodrx-105b9.firebaseapp.com",
    projectId: "kodrx-105b9"
  };

  try {
    const [{ initializeApp }, { getFirestore, doc, getDoc }] = await Promise.all([
      import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'),
      import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js')
    ]);

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Helper global para el script no-m√≥dulo
    window.kodrxGetReceta = async (id) => {
      try {
        const ref  = doc(db, 'recetas', id);
        const snap = await getDoc(ref);
        if (!snap.exists()) return null;
        const d = snap.data();

        // Normaliza timestamp a Date (Timestamp | {seconds,nanoseconds} | number/string)
        const ts = d.fecha ?? d.timestamp;
        const normDate =
          (ts && typeof ts.toDate === 'function') ? ts.toDate() :
          (ts && typeof ts.seconds === 'number') ? new Date(ts.seconds * 1000 + Math.floor((ts.nanoseconds || 0) / 1e6)) :
          (ts ? new Date(ts) : new Date());

        // Objeto receta final
        const receta = {
          id,
          medico: {
            nombre:        d.medicoNombre       || d.medico?.nombre       || '‚Äî',
            genero:        d.medicoGenero       || d.medico?.genero       || '',
            cedula:        d.medicoCedula       || d.medico?.cedula       || '‚Äî',
            especialidad:  d.medicoEspecialidad || d.medico?.especialidad || '‚Äî',
            telefono:      d.medicoTelefono     || d.medico?.telefono     || '‚Äî',
            direccion:     d.medicoDomicilio    || d.medico?.domicilio    || d.medico?.direccion || '‚Äî'
          },
          paciente: {
            nombre:       d.nombrePaciente || d.pacienteNombre || d.paciente?.nombre || '‚Äî',
            edad:         d.edad ?? d.paciente?.edad ?? '‚Äî',
            sexo:         d.sexo ?? d.paciente?.sexo ?? '‚Äî',
            peso:         d.peso ?? d.paciente?.peso ?? '‚Äî',
            talla:        d.talla ?? d.paciente?.talla ?? '‚Äî',
            imc:          d.imc ?? d.paciente?.imc ?? '‚Äî',
            temperatura:  d.temperatura ?? d.paciente?.temperatura ?? '‚Äî',
            presion:      d.presion ?? d.paciente?.presion ?? '‚Äî'
          },
          medicamentos: (d.medicamentos || d.items || []).map((m,i)=>({
            nombre:   m.nombre || m.medicamento || `Medicamento ${i+1}`,
            dosis:    m.dosis  || m.indicaciones || '‚Äî',
            duracion: m.duracion || m.tiempo     || '‚Äî'
          })),
          observaciones:   d.observaciones || '‚Äî',
          diagnostico:     d.diagnostico   || '‚Äî',
          timestamp:       normDate,
          urlVerificacion: `https://kodrx.app/verificar.html?id=${encodeURIComponent(id)}`,
          urlBlockchain:   `https://kodrx-blockchain.onrender.com/verificar.html?id=${encodeURIComponent(d.bloque || id)}`,
          _origen: 'firestore'
        };

        console.info('[KodRx] Receta obtenida de Firestore:', id);
        return receta;
      } catch (e) {
        console.warn('[KodRx] No se pudo leer Firestore, usando mock. Motivo:', e);
        return null;
      }
    };
  } catch (e) {
    console.warn('[KodRx] Firebase no disponible (modo demo). Puedes ignorar este aviso si a√∫n no configuras Firebase.', e);
  }
</script>
<script>
// Loader global y √∫nico para JsBarcode
window.__kodrx_jsbLoading = null;

async function ensureJsBarcode(){
  // Ya est√° listo
  if (window.JsBarcode) return;

  // Ya se est√° cargando
  if (window.__kodrx_jsbLoading) {
    await window.__kodrx_jsbLoading;
    return;
  }

  // Cargar desde CDN (sin SRI para evitar bloqueos)
  window.__kodrx_jsbLoading = new Promise((resolve, reject)=>{
    const s = document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js";
    s.onload = () => resolve();
    s.onerror = (e) => reject(e);
    document.head.appendChild(s);
  });

  await window.__kodrx_jsbLoading;
}
</script>

  <script>
    // ====== Utilidades ======
    const KODRX_BLUE = '#0b5bd3';
async function waitForFirestoreHelper(maxMs = 8000){
  const t0 = Date.now();
  while (Date.now() - t0 < maxMs){
    if (typeof window.kodrxGetReceta === 'function') return true;
    await new Promise(r=>setTimeout(r,120));
  }
  return false;
}

async function smartLoadReceta(id){
  // 1) intenta directo si el helper ya est√°
  if (await waitForFirestoreHelper(0)){
    try{
      const r = await window.kodrxGetReceta(id);
      if (r) return r; // FIRESTORE listo
    }catch(_){}
  }

  // 2) muestra MOCK(ID) inmediato para no dejar vac√≠o‚Ä¶
  let receta = {
    id,
    medico:{ nombre:`Demo ${id.slice(0,6)}`, genero:'F', cedula:`MX-${id.slice(0,6)}`, especialidad:'Medicina General', telefono:'‚Äî', direccion:'‚Äî' },
    paciente:{ nombre:`Paciente ${id.slice(0,6)}` },
    medicamentos:[],
    observaciones:'‚Äî',
    diagnostico:'‚Äî',
    timestamp: Date.now(),
    urlVerificacion: location.origin + '/public/verificar.html?id='+encodeURIComponent(id),
    urlBlockchain: location.origin + '/public/consulta.html?block='+encodeURIComponent(id),
    _origen:'mock-id'
  };

  // 3) ‚Ä¶y reintenta Firestore en background 3 veces; si llega, re-renderiza
  (async ()=>{
    const maxTries = 3;
    for (let i=0;i<maxTries;i++){
      const ready = await waitForFirestoreHelper(2500);
      if (!ready) continue;
      try{
        const r = await window.kodrxGetReceta(id);
        if (r){
          RECETA_ACTUAL = r;
          const q = await prepararReceta(r); // re-render
          QRS = q;
          return;
        }
      }catch(_){}
    }
  })();

  return receta;
}
    // Espera a que las librer√≠as UMD (jsPDF y QRCode) se carguen correctamente
    async function waitForLibs(maxTries = 50){
    let tries = 0;
    return new Promise(resolve => {
      (function check(){
        if (window.jspdf && window.QRCode){ resolve(); return; }
        if (++tries >= maxTries){ console.warn('Aviso: librer√≠as no confirmadas, contin√∫o'); resolve(); return; }
        setTimeout(check, 100);
      })();
    });
  }

  function prefixMedico(nombre, genero){
    if(!nombre) return '';
    const g = (genero||'').toLowerCase();
    const pref = (g.startsWith('f'))? 'Dra. ':'Dr. ';
    return pref + nombre;
  }

 function fechaLarga(ts){
  try{
    if (!ts) return '';
    if (typeof ts.toDate === 'function') {
      ts = ts.toDate();
    } else if (ts && typeof ts.seconds === 'number') {
      ts = new Date(ts.seconds * 1000 + Math.floor((ts.nanoseconds || 0) / 1e6));
    } else if (!(ts instanceof Date)) {
      ts = new Date(ts);
    }
    return ts.toLocaleString('es-MX', {
      year:'numeric', month:'long', day:'numeric',
      hour:'2-digit', minute:'2-digit'
    });
  } catch(e) {
    return '';
  }
}

function medsToText(meds){
  if(!Array.isArray(meds) || meds.length===0) return '‚Äî';
  return meds.map((m,i)=>`${i+1}. ${m.nombre}\n   Dosis: ${m.dosis}\n   Duraci√≥n: ${m.duracion}`).join('\n\n');
}

  function hashSimulado(receta){
    const base = JSON.stringify({id:receta.id, meds:receta.medicamentos, t:receta.timestamp});
    let h = 0; for (let i=0;i<base.length;i++){ h = (h*31 + base.charCodeAt(i))>>>0; }
    return ('00000000'+h.toString(16)).slice(-8)+('-'+btoa(unescape(encodeURIComponent(receta.id))).replace(/=+$/,''));
  }

  function makeQRDataURL(text, size=260){
    return new Promise((resolve)=>{
      if (typeof QRCode === 'undefined'){ console.error('QRCode no est√° disponible'); resolve(''); return; }
      const div = document.createElement('div');
      new QRCode(div,{text,width:size,height:size,correctLevel:QRCode.CorrectLevel.M});
      setTimeout(()=>{
        const img = div.querySelector('img');
        if(img && img.src){ resolve(img.src); }
        else{
          const canvas = div.querySelector('canvas');
          resolve(canvas? canvas.toDataURL('image/png') : '');
        }
      }, 0);
    });
  }

async function renderPreview(receta, mainQRDataURL, chainQRDataURL){
  // helper local
  function setTextById(id, txt){
    const el = document.getElementById(id);
    if (el) el.textContent = txt;
  }

  // Datos m√©dico
  setTextById('doctorNombre', prefixMedico(receta.medico.nombre, receta.medico.genero));
  setTextById('doctorCedula', receta.medico.cedula);
  setTextById('doctorEsp', receta.medico.especialidad);
  setTextById('doctorTel', receta.medico.telefono);
  setTextById('doctorDir', receta.medico.direccion);

  // Datos paciente
  setTextById('pacienteNombre', receta.paciente.nombre);
  setTextById('pacEdad', receta.paciente.edad);
  setTextById('pacSexo', receta.paciente.sexo);
  setTextById('pacPeso', receta.paciente.peso);
  setTextById('pacTalla',receta.paciente.talla);
  setTextById('pacIMC',  receta.paciente.imc);
  setTextById('pacTemp', receta.paciente.temperatura);
  setTextById('pacPresion',receta.paciente.presion);

  setTextById('fechaEmision', fechaLarga(receta.timestamp));
  setTextById('recetaId',  receta.id);

  setTextById('obsTexto',  receta.observaciones||'‚Äî');
  setTextById('diagTexto', receta.diagnostico||'‚Äî');


  // Medicamentos (derecha si existe, si no a la izquierda)
  const medsTXT = medsToText(receta.medicamentos);
  const medsEl = document.getElementById('listaMedsDerecha') || document.getElementById('listaMeds');
  if (medsEl) medsEl.textContent = medsTXT;

  // Hash y URL
  setTextById('hashTexto',hashSimulado(receta));
  setTextById('verifUrl', receta.urlBlockchain);

 // Dentro de renderPreview(receta, mainQRDataURL, chainQRDataURL)
const qrMain = document.getElementById('qrMain');
qrMain.innerHTML = '';
const i1 = new Image();
i1.src = mainQRDataURL; i1.alt = 'QR Receta';
i1.style.width = '220px'; i1.style.height = '220px';
qrMain.appendChild(i1);


  
const qrChain = document.getElementById('qrChain');
qrChain.innerHTML = '';
const i2 = new Image();
i2.src = chainQRDataURL; i2.alt = 'QR Blockchain';
i2.style.width = '110px'; i2.style.height = '110px';
qrChain.appendChild(i2);

  // === C√≥digo de barras del ID (pantalla) ===
try{
  await ensureJsBarcode();
  const c = document.getElementById('barcodeCanvas');
  if (c){
    // Limpia y dibuja
    const ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    JsBarcode(c, String(receta.id || ''), {
      format: 'CODE128',
      height: 40,          // alto de barras (px)
      width: 2,            // ancho de barra (px)
      margin: 4,
      displayValue: true,  // imprime el valor abajo
      fontSize: 10,
      textMargin: 4
    });
  }
  const lbl = document.getElementById('barcodeLabel');
  if (lbl) lbl.textContent = String(receta.id || '‚Äî');
}catch(e){
  console.warn('[KodRx] No se pudo generar el c√≥digo de barras:', e);
}
// n√∫mero de bloque si lo tienes
const blockSpan = document.getElementById('blockNum');
if (blockSpan){
  const num = (receta.bloque!=null) ? receta.bloque : (new URL(receta.urlBlockchain).searchParams.get('id') || '‚Äî');
  blockSpan.textContent = `Bloque: ${num}`;
}

  // Badge
  const badge = document.getElementById('badgeOrigen');
  if (badge){
    if (receta._origen === 'firestore'){ badge.textContent = 'Receta Verificada';  badge.className='badge ok'; }
    else if (receta._origen === 'mock-id'){ badge.textContent = 'MOCK (ID)'; badge.className='badge warn'; }
    else { badge.textContent = 'MOCK'; badge.className='badge warn'; }
  }
}


async function generarPDF(receta, qrs){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'letter', compress:true }); // 612x792
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();

  // --- Layout base ---
  const Mx = 40;               // margen lateral
  const gutter = 16;           // separaci√≥n entre columnas
  const CW = W - 2*Mx;         // ancho √∫til
  const colW = (CW - gutter)/2;
  const leftX  = Mx;
  const rightX = Mx + colW + gutter;

  // Pie alto y l√≠mite inferior SIEMPRE respetado
  const footerH = 52;
  const My = 50;                              // top base (header devuelve startY)
  const availYMax = H - My - footerH - 10;    // l√≠mite inferior duro

  // --- Colores / fuente ---
  const COLORS = {
    panelFill: [248,250,252], panelStroke:[224,231,240],
    text:[17,24,39], sub:[55,65,81], label:[107,114,128], brand:[11,91,211]
  };
  const FONT = 'helvetica';
  doc.setFont(FONT,'normal');

  // --- Helpers locales (autocontenidos) ---
  function header(){
    const headY = 18, headH = 50;
    doc.setFillColor(240,245,255);
    doc.roundedRect(18, headY, W-36, headH, 9, 9, 'F');
    doc.setTextColor(11,27,43);
    doc.setFont(FONT,'bold'); doc.setFontSize(13);
    doc.text('KodRx ‚Äî Receta m√©dica digital', Mx, headY + 30);
    doc.setFont(FONT,'normal');
    return headY + headH + 12; // Y segura para arrancar contenido
  }
  function footer(){
    doc.setFillColor(...COLORS.brand);
    doc.rect(18, H-18-footerH, W-36, footerH, 'F');
    doc.setTextColor(255,255,255);
    doc.setFont(FONT,'bold'); doc.setFontSize(10.5);
    doc.text('Creada con KodRx. Tecnolog√≠a que verifica, salud que protege.', W/2, H-22, {align:'center'});
    doc.setFont(FONT,'normal');
  }
  function wrap(txt, w){ return doc.splitTextToSize(String(txt ?? '‚Äî'), w); }
  function sectionBox(x, y, w, contentH, title){
    // Clamp vertical para NO invadir el pie
    const padX=10, padY=10, titleH=18, boxH = contentH + padY*2 + titleH;
    const yClamped = Math.min(y, availYMax - boxH);
    doc.setFillColor(...COLORS.panelFill);
    doc.setDrawColor(...COLORS.panelStroke);
    doc.setLineWidth(0.8);
    doc.roundedRect(x, yClamped, w, boxH, 8, 8, 'FD');
    doc.setTextColor(...COLORS.label);
    doc.setFont(FONT,'bold'); doc.setFontSize(10);
    doc.text(title, x + padX, yClamped + 14);
    doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.text);
    return { cx:x+padX, cy:yClamped+14+padY, ny:yClamped+boxH+10, innerH:contentH };
  }
  function drawClamp(x,y,maxW,maxH,text,lineH=11){
    const lines = wrap(text, maxW);
    let used = 0, lastY = y;
    for (let i=0;i<lines.length;i++){
      if (used + lineH > maxH){
        if (i>0){
          const prev = lines[i-1];
          const trimmed = prev.length>1 ? prev.slice(0, prev.length-1)+'‚Ä¶' : prev+'‚Ä¶';
          doc.text(trimmed, x, lastY);
        }
        return;
      }
      lastY = y + used + lineH;
      doc.text(lines[i], x, lastY);
      used += lineH;
    }
  }
  function fechaStr(ts){
    try{
      if (ts && typeof ts.toDate === 'function') ts = ts.toDate();
      else if (ts && typeof ts.seconds === 'number') ts = new Date(ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6));
      else if (!(ts instanceof Date)) ts = new Date(ts);
      return ts.toLocaleString('es-MX',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
    }catch(_){ return ''; }
  }
  function medsText(meds){
    if(!Array.isArray(meds)||!meds.length) return '‚Äî';
    return meds.map((m,i)=>`${i+1}. ${m.nombre}\n   Dosis: ${m.dosis}\n   Duraci√≥n: ${m.duracion}`).join('\n\n');
  }
  function blockNumber(r){
    if (r.bloque!=null) return String(r.bloque);
    try{ const u=new URL(r.urlBlockchain); return u.searchParams.get('id')||u.searchParams.get('block')||'‚Äî'; }
    catch(_){ return '‚Äî'; }
  }

  // === Arranque y cursores ===
  const startY = header();
  let yL = startY, yR = startY;

  // ------- IZQUIERDA -------
  // M√âDICO (compacto, con clamp)
  {
    const Hfixed = 90;
    const s = sectionBox(leftX, yL, colW, Hfixed, 'M√âDICO');
    // nombre (2 l√≠neas m√°x)
    doc.setFont(FONT,'bold'); doc.setFontSize(11.5); doc.setTextColor(...COLORS.text);
    const nombreMed = receta.medico?.nombre ? (typeof prefixMedico==='function' ? prefixMedico(receta.medico.nombre, receta.medico.genero) : receta.medico.nombre) : '‚Äî';
    drawClamp(s.cx, s.cy, colW-16, 26, nombreMed, 13);
    // datos
    let cy = s.cy + 26 + 6;
    doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.sub);
    const info = `C√©dula: ${receta.medico?.cedula||'‚Äî'}    Especialidad: ${receta.medico?.especialidad||'‚Äî'}\n`+
                 `Tel: ${receta.medico?.telefono||'‚Äî'}\n`+
                 `Direcci√≥n: ${receta.medico?.direccion||'‚Äî'}`;
    drawClamp(s.cx, cy, colW-16, Hfixed - (cy - s.cy), info, 13);
    yL = s.ny;
  }

  // PACIENTE (fecha+ID debajo del nombre; IMC debajo de Temp)
  {
    const Hfixed = 100;
    const s = sectionBox(leftX, yL, colW, Hfixed, 'PACIENTE');
    doc.setFont(FONT,'bold'); doc.setFontSize(11.5); doc.setTextColor(...COLORS.text);
    drawClamp(s.cx, s.cy, colW-16, 26, String(receta.paciente?.nombre||'‚Äî'), 13);

    // fecha + ID
    let cy = s.cy + 26 + 6;
    doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.sub);
    doc.text(fechaStr(receta.timestamp), s.cx, cy); cy += 13;
    doc.text(`ID: ${receta.id}`,          s.cx, cy); cy += 16;

    // vitals
    const lv = (x,y,lbl,val)=>{ doc.setFont(FONT,'bold'); doc.setTextColor(...COLORS.sub); doc.text(lbl,x,y);
      const w=doc.getTextWidth(lbl); doc.setFont(FONT,'normal'); doc.setTextColor(...COLORS.text); doc.text(String(val??'‚Äî'), x+w+4, y); };
    lv(s.cx,     cy, 'Edad:', receta.paciente?.edad);
    lv(s.cx+120, cy, 'Sexo:', receta.paciente?.sexo);
    cy += 13;
    lv(s.cx,     cy, 'Peso:', receta.paciente?.peso);
    lv(s.cx+120, cy, 'Talla:', receta.paciente?.talla);
    cy += 13;
    lv(s.cx,     cy, 'Temp:',  receta.paciente?.temperatura);
    lv(s.cx+120, cy, 'PA:',    receta.paciente?.presion);
    cy += 13;
    lv(s.cx,     cy, 'IMC:',   receta.paciente?.imc);

    yL = s.ny;
  }
// ===== IZQUIERDA: OBSERVACIONES + DIAGN√ìSTICO con separador duro =====
{
  const lineH   = 11;
  const SEP     = 35;  // altura visible del hueco (sube a 30 si quieres m√°s aire)
  const MIN_OBS = 60;
  const MIN_DX  = 60;

  // --- 1) Altura para OBSERVACIONES (sin comerse el m√≠nimo de DIAG + hueco) ---
  const leftSpaceTotal = Math.max(0, availYMax - yL);
  const obsWrapped = doc.splitTextToSize(String(receta.observaciones ?? '‚Äî'), colW - 16);
  const idealObsH  = Math.max(MIN_OBS, obsWrapped.length * lineH + 6);
  const obsMaxH    = Math.max(MIN_OBS, leftSpaceTotal - (SEP + MIN_DX));
  const obsH       = Math.min(idealObsH, obsMaxH);

  // --- 2) OBSERVACIONES ---
  const sObs = sectionBox(leftX, yL, colW, obsH, 'OBSERVACIONES');
  doc.setFont('helvetica','normal'); doc.setFontSize(9.5); doc.setTextColor(17,24,39);
  (function clamp(x,y,maxW,maxH,txt){
    const lines = doc.splitTextToSize(String(txt ?? '‚Äî'), maxW);
    let used = 0, lastY = y;
    for (let i=0;i<lines.length;i++){
      if (used + lineH > maxH){
        if (i>0){
          const prev = lines[i-1];
          doc.text((prev.length>1 ? prev.slice(0,prev.length-1)+'‚Ä¶' : prev+'‚Ä¶'), x, lastY);
        }
        return;
      }
      lastY = y + used + lineH;
      doc.text(lines[i], x, lastY);
      used += lineH;
    }
  })(sObs.cx, sObs.cy, colW - 16, sObs.innerH, receta.observaciones);

  // --- 3) Separador visual DURO (franja blanca + l√≠nea tenue) ---
  {
    const gapY = sObs.ny - 2;         // tapa la curva inferior
    const midY = gapY + SEP/2;

    // franja blanca
    doc.setFillColor(255,255,255);
    doc.setDrawColor(255,255,255);
    doc.rect(leftX, gapY, colW, SEP, 'F');

    // l√≠nea tenue
    doc.setDrawColor(224,231,240);
    doc.setLineWidth(0.8);
    doc.line(leftX + 6, midY, leftX + colW - 6, midY);

    // cursor despu√©s del separador
    yL = gapY + SEP + 6;
  }

  // --- 4) DIAGN√ìSTICO (usa TODO lo que quede hasta el pie) ---
  const dxH = Math.max(MIN_DX, availYMax - yL);
  const sDx = sectionBox(leftX, yL, colW, dxH, 'DIAGN√ìSTICO');
  doc.setFont('helvetica','normal'); doc.setFontSize(9.5); doc.setTextColor(17,24,39);
  (function clamp(x,y,maxW,maxH,txt){
    const lines = doc.splitTextToSize(String(txt ?? '‚Äî'), maxW);
    let used = 0, lastY = y;
    for (let i=0;i<lines.length;i++){
      if (used + lineH > maxH){
        if (i>0){
          const prev = lines[i-1];
          doc.text((prev.length>1 ? prev.slice(0,prev.length-1)+'‚Ä¶' : prev+'‚Ä¶'), x, lastY);
        }
        return;
      }
      lastY = y + used + lineH;
      doc.text(lines[i], x, lastY);
      used += lineH;
    }
  })(sDx.cx, sDx.cy, colW - 16, sDx.innerH, receta.diagnostico);

  yL = sDx.ny;
} // ‚Üê‚Üê‚Üê ESTA ES LA LLAVE QUE FALTABA: cierra el bloque IZQUIERDA


 
  // ------- DERECHA -------
  // MEDICAMENTOS
  {
    const lineH = 11;
    const medsTxt = medsText(receta.medicamentos);
    const tmp = wrap(medsTxt, colW-16);
    const need = Math.max(90, tmp.length*lineH + 6);
    const s = sectionBox(rightX, yR, colW, need, 'MEDICAMENTOS');
    doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.text);
    drawClamp(s.cx, s.cy, colW-16, s.innerH, medsTxt, lineH);
    yR = s.ny;
  }

  // QR Receta
  {
    const box = 120, pad=10;
    let y = yR;
    const yMax = availYMax - (box + 20);
    y = Math.min(Math.max(y, startY), yMax); // nunca sobre header, nunca invade pie
    const xQR = rightX + (colW - box)/2;
    doc.setDrawColor(...COLORS.brand); doc.setLineWidth(2.2);
    doc.roundedRect(xQR, y, box, box, 10, 10, 'S');
    doc.addImage(qrs.mainQRUrl, 'PNG', xQR+pad, y+pad, box-2*pad, box-2*pad, undefined, 'FAST');
    doc.setTextColor(...COLORS.brand); doc.setFont(FONT,'bold'); doc.setFontSize(9.5);
    doc.text('Receta', xQR + box/2, y + box + 12, {align:'center'});
    yR = y + box + 20;
  }
// === C√ìDIGO DE BARRAS (ID) ===
{
  const barUrl = await makeBarcodeDataURL(receta.id, { w: 300, h: 40, bw: 2, bh: 56 });
  // ancho del dibujo dentro de la columna
  const imgW = Math.min(colW - 20, 300);
  const imgH = 40 * (imgW / 300);
  let x = rightX + (colW - imgW)/2;
  let y = yR; // parte de arriba del bloque actual

  // Evita pegarse al QR anterior
  y += 6;

  // Marco suave del panel
  const boxH = imgH + 26; // imagen + etiqueta
  doc.setFillColor(248,250,252);
  doc.setDrawColor(224,231,240);
  doc.setLineWidth(0.8);
  doc.roundedRect(rightX, y, colW, boxH, 8, 8, 'FD');

  // Dibuja el barcode centrado
  doc.addImage(barUrl, 'PNG', x, y + 8, imgW, imgH, undefined, 'FAST');

  // Etiqueta (‚ÄúC√≥digo de barras (ID)‚Äù)
  doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(55,65,81);
  doc.text('C√≥digo de barras (ID)', rightX + colW/2, y + imgH + 20, { align:'center' });

  yR = y + boxH + 10; // avanza cursor derecha
}

  // HASH
  {
    const s = sectionBox(rightX, yR, colW, 40, 'HASH');
    doc.setFont(FONT,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.sub);
    drawClamp(s.cx, s.cy, colW-16, s.innerH, 'hash: ' + (typeof hashSimulado==='function'?hashSimulado(receta):'‚Äî'), 11);
    yR = s.ny;
  }

  // QR Blockchain + bloque + leyenda
  {
    const mini=90, rectW=mini, rectH=mini;
    const qrX = rightX + colW - rectW;
    let qrY = Math.max(yL, yR) + 6;
    if (qrY + rectH + 38 > availYMax) qrY = availYMax - rectH - 38;

    doc.setDrawColor(...COLORS.brand); doc.setLineWidth(2.0);
    doc.roundedRect(qrX, qrY, rectW, rectH, 8, 8, 'S');
    doc.addImage(qrs.chainQRUrl, 'PNG', qrX+8, qrY+8, rectW-16, rectH-16, undefined, 'FAST');

    doc.setTextColor(...COLORS.brand); doc.setFont(FONT,'bold'); doc.setFontSize(9);
    doc.text('Blockchain', qrX + rectW/2, qrY + rectH + 12, {align:'center'});

    const bnum = blockNumber(receta);
    doc.setTextColor(...COLORS.text); doc.setFont(FONT,'bold'); doc.setFontSize(10);
    doc.text(`Bloque: ${bnum}`, qrX + rectW/2, qrY + rectH + 26, {align:'center'});

    doc.setTextColor(...COLORS.sub); doc.setFont(FONT,'normal'); doc.setFontSize(8.5);
    doc.text('Para verificar receta visitar kodrx.app', qrX + rectW/2, qrY + rectH + 38, {align:'center'});

    yR = qrY + rectH + 42;
  }

  // --- Pie SIEMPRE visible ---
  footer();

  doc.save(`receta_${receta.id}.pdf`);
}



  // ===== Boot & Listeners =====
  let RECETA_ACTUAL = null; let QRS = null;

  async function cargarRecetaDesdeQuery(){
  const p = new URLSearchParams(location.search);
  const id = p.get('id') || 'RECETA-DE-EJEMPLO-001';
  if (p.get('id')) return await smartLoadReceta(id);

  // mock por defecto cuando NO hay ?id=
  return {
    id,
    medico:{ nombre:'Gabriela L√≥pez Ram√≠rez', genero:'F', cedula:'1234567', especialidad:'Medicina Interna', telefono:'‚Äî', direccion:'‚Äî' },
    paciente:{ nombre:'Juan P√©rez' },
    medicamentos:[
      { nombre:'Amoxicilina 500 mg', dosis:'1 c√°psula cada 8 h', duracion:'7 d√≠as' },
      { nombre:'Paracetamol 500 mg', dosis:'1 tableta cada 8 h si dolor', duracion:'5 d√≠as' }
    ],
    observaciones:'‚Äî',
    diagnostico:'‚Äî',
    timestamp: Date.now(),
    urlVerificacion: location.origin + '/public/verificar.html?id='+encodeURIComponent(id),
    urlBlockchain: location.origin + '/public/consulta.html?block='+encodeURIComponent(id),
    _origen:'mock'
  };
}

// === QR -> DataURL (usado por prepararReceta/generarPDF) ===
function makeQRDataURL(text, size = 260){
  return new Promise((resolve)=>{
    if (typeof QRCode === 'undefined'){ console.error('QRCode no est√° disponible'); resolve(''); return; }
    const div = document.createElement('div');
    new QRCode(div, { text, width:size, height:size, correctLevel: QRCode.CorrectLevel.M });
    setTimeout(()=>{
      const img = div.querySelector('img');
      if (img && img.src) return resolve(img.src);
      const canvas = div.querySelector('canvas');
      resolve(canvas ? canvas.toDataURL('image/png') : '');
    }, 0);
  });
}
async function makeBarcodeDataURL(text, {w=260, h=90, bw=2, bh=60}={}){
  await ensureJsBarcode();
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
  JsBarcode(canvas, String(text||''), {
    format: 'CODE128',
    width: bw,
    height: bh,
    margin: 4,
    displayValue: true,
    fontSize: 12,
    textMargin: 4
  });
  return canvas.toDataURL('image/png');
}

// === Render de vista (aseg√∫rate que esta funci√≥n YA exista arriba) ===
// function renderPreview(receta, mainQRDataURL, chainQRDataURL){ ... }

// === Preparar QRs y pintar vista ===
async function prepararReceta(receta){
  const mainQRUrl  = await makeQRDataURL(receta.urlVerificacion, 520);
  const chainQRUrl = await makeQRDataURL(receta.urlBlockchain, 260);
  await renderPreview(receta, mainQRUrl, chainQRUrl);   // üëà importante
  return { mainQRUrl, chainQRUrl };
}

// ===== Evita doble boot =====
if (!window.__kodrx_booted__) {
  window.__kodrx_booted__ = true;

  window.addEventListener('DOMContentLoaded', () => {

    // ===== Wire listeners solo una vez =====
    if (!window.__kodrx_pdf_wired__) {
      window.__kodrx_pdf_wired__ = true;

      const btnDesc = document.getElementById('btnDescargar');
      btnDesc?.addEventListener('click', async () => {
        if (btnDesc.__busy) return;         // anti-double click
        btnDesc.__busy = true; btnDesc.disabled = true;

        try{
          await waitForLibs();
          if (!RECETA_ACTUAL)  RECETA_ACTUAL = await cargarRecetaDesdeQuery();
          if (!QRS)            QRS = await prepararReceta(RECETA_ACTUAL);
          await generarPDF(RECETA_ACTUAL, QRS);  // üëà IMPORTANTE
        } finally {
          btnDesc.__busy = false; btnDesc.disabled = false;
        }
      });

      document.getElementById('btnRegresar')?.addEventListener('click', ()=>{
        if (history.length > 1) history.back();
        else window.location.href = '/';
      });

      document.getElementById('btnCargarEjemplo')?.addEventListener('click', async ()=>{
        const receta = await cargarRecetaDesdeQuery();
        RECETA_ACTUAL = receta;
        QRS = await prepararReceta(receta);
      });
    }

    // ===== Boot una sola vez =====
    (async () => {
      await waitForLibs();
      const receta = await cargarRecetaDesdeQuery();
      RECETA_ACTUAL = receta;
      QRS = await prepararReceta(receta);
    })();

  });
}


  </script>
  <script>
(function(){
  const card = document.querySelector('.card') || document.body;
  const canvas = document.querySelector('.canvas');
  const left   = document.querySelector('.left');
  const right  = document.querySelector('.right');
  const footer = document.querySelector('.footer');

  // contenedor para la vista de impresi√≥n
  const printLayout = document.createElement('div');
  printLayout.id = 'printLayout';
  card.appendChild(printLayout);

  function buildPrintLayout(){
    // Clonamos el HTML ya renderizado (incluye <img> de los QRs)
    const leftHTML  = left ? left.innerHTML : '';
    const rightHTML = right ? right.innerHTML : '';
    const footerHTML= footer ? footer.innerHTML : '';

    printLayout.innerHTML = `
      <div class="sheet">
        <table role="presentation" aria-hidden="true">
          <tr>
            <td class="leftCol">
              ${leftHTML}
            </td>
            <td class="rightCol">
              ${rightHTML}
            </td>
          </tr>
        </table>
        <div class="footer">${footerHTML}</div>
      </div>
    `;
  }

  function showPrintLayout(){
    if (!printLayout) return;
    buildPrintLayout();
    if (canvas) canvas.style.display = 'none';
    printLayout.style.display = 'block';
  }
  function hidePrintLayout(){
    if (canvas) canvas.style.display = '';
    if (printLayout){ printLayout.style.display = 'none'; printLayout.innerHTML = ''; }
  }

  // Hooks de impresi√≥n (WebKit y otros)
  window.addEventListener('beforeprint', showPrintLayout);
  window.addEventListener('afterprint',  hidePrintLayout);

  // Fallback (algunos iOS disparan matchMedia)
  const mql = window.matchMedia('print');
  if (mql && mql.addListener){
    mql.addListener(function(e){ e.matches ? showPrintLayout() : hidePrintLayout(); });
  }
})();
</script>

</body>
</html>

