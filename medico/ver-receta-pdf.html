<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KodRx | ver-receta-pdf-puro (jsPDF)</title>
  <style>
/* ===== Layout general ===== */
.receta-wrap{
  max-width: 940px;   /* ancho cómodo en desktop */
  margin: 16px auto;
  padding: 12px;
}

.receta{
  display: grid;
  grid-template-columns: 1fr 340px; /* izquierda flexible + derecha fija */
  gap: 16px;
  align-items: start;
}

/* Header */
.receta-header{
  grid-column: 1 / -1;
  background: #F0F5FF;
  color: #0b1b2b;
  padding: 14px 16px;
  border-radius: 12px;
  font-weight: 700;
}
/* ===== Botones / acciones ===== */
.actions{
  display:flex; gap:12px; padding:14px 0; justify-content:flex-start; flex-wrap:wrap;
}
button{
  appearance:none; border:0; cursor:pointer; font-weight:700;
  border-radius:12px; padding:10px 14px; transition:transform .04s ease, box-shadow .2s ease;
}
button:active{ transform:translateY(1px) }
.primary{
  background:#0b5bd3; color:#fff;
  box-shadow:0 6px 16px rgba(11,91,211,.2);
}
.primary:hover{ box-shadow:0 8px 22px rgba(11,91,211,.25) }
.ghost{
  background:#eef2ff; color:#0b1b2b; border:1px solid #dbe3ff;
}
.ghost:hover{ background:#e6ebff }

/* Oculta acciones en impresión */
@media print{ .actions{ display:none !important } }

/* Badge origen */
.badge{
  display:inline-block; padding:4px 10px; border-radius:999px;
  font-size:12px; font-weight:700; margin-left:8px;
}
.badge.ok{ background:#e7f6e8; color:#0b8b2b; }
.badge.warn{ background:#fff3cd; color:#7a5a00; }

/* ===== Paneles (cards) ===== */
.card{
  background: #f8fafc;
  border:1px solid #e0e7f0;
  border-radius: 14px;
  padding: 12px;
}
.card .title{
  color:#6b7280;
  font-weight:800;
  letter-spacing:.02em;
  margin: 2px 0 8px;
  text-transform: uppercase;
}
.card .kv{ color:#374151; font-size:14px; line-height:1.35; }
.card .kv b{ color:#6b7280; margin-right:6px; }

/* Evitar desbordes de textos largos */
.card, .kv, .sub{
  overflow-wrap:anywhere; word-break:break-word;
}

/* ===== Columna derecha como columna flexible ===== */
.col-right{
  display:flex; flex-direction:column; gap:16px; min-height:100%;
}
.col-right .spacer{ flex:1 1 auto; } /* empuja blockchain hacia abajo si hay espacio */

/* Medicamentos en formato lista bloque */
.meds{
  white-space:pre-wrap; /* respeta saltos */
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  font-size: 14px; line-height:1.35; color:#111827;
}

/* ===== QRs ===== */
.qr-frame{
  border:2px solid #0b5bd3; border-radius:12px; padding:8px;
  display:flex; align-items:center; justify-content:center; background:#fff;
}
.qr-legend{
  color:#0b5bd3; font-weight:700; font-size:12px; text-align:center; margin-top:6px;
}
.qr-main img{ width: 220px; height: 220px; }       /* Receta */
.qr-chain img{ width: 110px; height: 110px; }      /* Blockchain */
/* Código de barras */
#panelBarcode canvas{
  max-width: 100%;
}
@media print{
  #panelBarcode canvas{
    width: 70mm !important;   /* ~ 265 px */
    height: 11mm !important;  /* ~ 83 px */
  }
}

/* Hash */
.hash{
  background:#f3f4f6; border:1px solid #e5e7eb; border-radius:10px;
  padding:6px 8px; color:#374151; font-size:12px; white-space:normal;
}

/* Pie de página */
.footer{
  grid-column: 1 / -1;
  background:#0b5bd3; color:#fff;
  border-radius:12px;
  padding: 12px 16px;
  text-align:center; font-weight:700; margin-top:6px;
}

/* ===== Responsive ===== */
@media (max-width: 920px){
  .receta{ grid-template-columns: 1fr; }
  .col-right{ order: 2; }  /* si quieres, puedes moverla */
  .qr-main img{ width: 200px; height:200px; }
  .qr-chain img{ width: 100px; height:100px; }
}
@media (max-width: 520px){
  .qr-main img{ width: 180px; height:180px; }
  .qr-chain img{ width: 90px; height:90px; }
}

/* ===== PRINT: header fijo arriba + reserva de espacio ===== */
@page{ size: A4 portrait; margin: 8mm; }

@media print{
  /* Reservas para header y footer fijos */
  .receta-wrap{
    padding-top: 22mm !important;   /* altura reservada p/ header fijo */
    padding-bottom: 22mm !important;/* ya la tenías para footer fijo */
  }

  /* Header fijo centrado con el mismo ancho de la hoja */
  .receta-header{
    position: fixed !important;
    top: 8mm !important;                  /* al ras del margen de página */
    left: 50% !important;
    transform: translateX(-50%) !important;
    width: 185mm !important;              /* igual que el contenido */
    margin: 0 !important;
    padding: 8px 10px !important;
    border-radius: 8px !important;
    z-index: 20 !important;
    display: block !important;            /* que no intente ser “celda” */
    -webkit-print-color-adjust: exact;    /* conserva color de fondo */
    print-color-adjust: exact;
  }

  /* Mantén la tabla de 2 columnas para el contenido (como ya pusimos) */
  .receta{
    display: table !important;
    width: 185mm !important;
    table-layout: fixed !important;
    border-collapse: separate !important;
    border-spacing: 0 0 !important;
  }
  .col-left, .col-right{
    display: table-cell !important;
    vertical-align: top !important;
    page-break-inside: avoid !important;
    break-inside: avoid !important;
    -webkit-column-break-inside: avoid !important;
  }
  .col-left{
    width: calc(185mm - 82mm - 8mm) !important;
    padding-right: 4mm !important;
  }
  .col-right{
    width: 82mm !important;
    padding-left: 4mm !important;
  }
}



  </style>
</head>
<body class="page-border">
  <div class="receta-wrap">
  <div class="receta">
     <div class="actions">
  <button class="ghost" id="btnRegresar">Regresar</button>
  <button class="primary" id="btnDescargar">Descargar PDF</button>
  <button class="ghost" onclick="window.print()">Imprimir</button>

</div>    <!-- Header -->
    <div class="receta-header">
      KodRx — Receta médica digital
      <span id="badgeOrigen" class="badge ok">Receta Verificada</span>
    </div>

    <!-- Columna IZQUIERDA -->
    <div class="col-left" style="display:flex;flex-direction:column;gap:16px">

      <section class="card">
        <div class="title">MÉDICO</div>
        <div class="kv" id="doctorNombre">—</div>
        <div class="kv"><b>Cédula:</b> <span id="doctorCedula">—</span> &nbsp;&nbsp; <b>Especialidad:</b> <span id="doctorEsp">—</span></div>
        <div class="kv"><b>Tel:</b> <span id="doctorTel">—</span></div>
        <div class="kv"><b>Dirección:</b> <span id="doctorDir">—</span></div>
      </section>

      <section class="card">
        <div class="title">PACIENTE</div>
        <div class="kv" id="pacienteNombre">—</div>
        <div class="kv sub" style="margin-top:6px">
          <span id="fechaEmision">—</span> &nbsp;&nbsp; <span id="recetaId">ID: —</span>
        </div>
        <div class="kv" style="margin-top:8px">
          <b>Edad:</b> <span id="pacEdad">—</span> &nbsp;&nbsp;
          <b>Sexo:</b> <span id="pacSexo">—</span>
        </div>
        <div class="kv">
          <b>Peso:</b> <span id="pacPeso">—</span> &nbsp;&nbsp;
          <b>Talla:</b> <span id="pacTalla">—</span>
        </div>
        <div class="kv">
          <b>Temp:</b> <span id="pacTemp">—</span> &nbsp;&nbsp;
          <b>PA:</b> <span id="pacPresion">—</span>
        </div>
        <div class="kv">
          <b>IMC:</b> <span id="pacIMC">—</span>
        </div>
      </section>

      <section class="card">
        <div class="title">OBSERVACIONES</div>
        <div class="kv" id="obsTexto">—</div>
      </section>

      <section class="card">
        <div class="title">DIAGNÓSTICO</div>
        <div class="kv" id="diagTexto">—</div>
      </section>
    </div>

    <!-- Columna DERECHA -->
    <div class="col-right">
      <section class="card">
        <div class="title">MEDICAMENTOS</div>
        <pre class="meds" id="listaMedsDerecha">—</pre>
      </section>

      <section class="card" style="text-align:center">
        <div class="qr-frame qr-main"><div id="qrMain"></div></div>
        <div class="qr-legend">Receta</div>
      </section>
<!-- === CÓDIGO DE BARRAS (ID) === -->
<section class="card" id="panelBarcode">
  <div class="title">CÓDIGO DE BARRAS (ID)</div>
  <div style="display:flex;justify-content:center">
    <canvas id="barcodeCanvas" width="320" height="90"></canvas>
  </div>
  <div class="sub" style="text-align:center;margin-top:4px">
    <span id="barcodeLabel">—</span>
  </div>
</section>

      <section class="card">
        <div class="title">HASH</div>
        <div class="hash" id="hashTexto">hash: —</div>
      </section>

      <div class="spacer"></div> <!-- empuja blockchain hacia abajo si hay espacio -->

      <section class="card" style="text-align:center">
        <div class="qr-frame qr-chain"><div id="qrChain"></div></div>
        <div class="qr-legend">
          Blockchain<br>
          <span id="blockNum" style="color:#111827;font-weight:800"></span><br>
          <span class="sub" style="color:#6b7280;font-weight:400">Para verificar receta visitar kodrx.app</span>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <div class="footer">
      Creada con KodRx. Plataforma digital de recetas verificadas con trazabilidad tecnológica.
    </div>

  </div>
</div>

    

    </div>
  </div>

  <!-- jsPDF (puro) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- QRCode.js para generar QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Firebase (opcional): si hay ID, intentará traer receta real de Firestore -->
  <script type="module">
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBIjaOe4HcGNDk0xrqen8etBv0RyjyOJHw",
    authDomain: "kodrx-105b9.firebaseapp.com",
    projectId: "kodrx-105b9"
  };

  try {
    const [{ initializeApp }, { getFirestore, doc, getDoc }] = await Promise.all([
      import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'),
      import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js')
    ]);

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Helper global para el script no-módulo
    window.kodrxGetReceta = async (id) => {
      try {
        const ref  = doc(db, 'recetas', id);
        const snap = await getDoc(ref);
        if (!snap.exists()) return null;
        const d = snap.data();

        // Normaliza timestamp a Date (Timestamp | {seconds,nanoseconds} | number/string)
        const ts = d.fecha ?? d.timestamp;
        const normDate =
          (ts && typeof ts.toDate === 'function') ? ts.toDate() :
          (ts && typeof ts.seconds === 'number') ? new Date(ts.seconds * 1000 + Math.floor((ts.nanoseconds || 0) / 1e6)) :
          (ts ? new Date(ts) : new Date());

        // Objeto receta final
        const receta = {
          id,
          medico: {
            nombre:        d.medicoNombre       || d.medico?.nombre       || '—',
            genero:        d.medicoGenero       || d.medico?.genero       || '',
            cedula:        d.medicoCedula       || d.medico?.cedula       || '—',
            especialidad:  d.medicoEspecialidad || d.medico?.especialidad || '—',
            telefono:      d.medicoTelefono     || d.medico?.telefono     || '—',
            direccion:     d.medicoDomicilio    || d.medico?.domicilio    || d.medico?.direccion || '—'
          },
          paciente: {
            nombre:       d.nombrePaciente || d.pacienteNombre || d.paciente?.nombre || '—',
            edad:         d.edad ?? d.paciente?.edad ?? '—',
            sexo:         d.sexo ?? d.paciente?.sexo ?? '—',
            peso:         d.peso ?? d.paciente?.peso ?? '—',
            talla:        d.talla ?? d.paciente?.talla ?? '—',
            imc:          d.imc ?? d.paciente?.imc ?? '—',
            temperatura:  d.temperatura ?? d.paciente?.temperatura ?? '—',
            presion:      d.presion ?? d.paciente?.presion ?? '—'
          },
          medicamentos: (d.medicamentos || d.items || []).map((m,i)=>({
            nombre:   m.nombre || m.medicamento || `Medicamento ${i+1}`,
            dosis:    m.dosis  || m.indicaciones || '—',
            duracion: m.duracion || m.tiempo     || '—'
          })),
          observaciones:   d.observaciones || '—',
          diagnostico:     d.diagnostico   || '—',
          timestamp:       normDate,
          urlVerificacion: `https://kodrx.app/verificar.html?id=${encodeURIComponent(id)}`,
          urlBlockchain:   `https://kodrx-blockchain.onrender.com/verificar.html?id=${encodeURIComponent(d.bloque || id)}`,
          _origen: 'firestore'
        };

        console.info('[KodRx] Receta obtenida de Firestore:', id);
        return receta;
      } catch (e) {
        console.warn('[KodRx] No se pudo leer Firestore, usando mock. Motivo:', e);
        return null;
      }
    };
  } catch (e) {
    console.warn('[KodRx] Firebase no disponible (modo demo). Puedes ignorar este aviso si aún no configuras Firebase.', e);
  }
</script>
<script>
// Loader global y único para JsBarcode
window.__kodrx_jsbLoading = null;

async function ensureJsBarcode(){
  // Ya está listo
  if (window.JsBarcode) return;

  // Ya se está cargando
  if (window.__kodrx_jsbLoading) {
    await window.__kodrx_jsbLoading;
    return;
  }

  // Cargar desde CDN (sin SRI para evitar bloqueos)
  window.__kodrx_jsbLoading = new Promise((resolve, reject)=>{
    const s = document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js";
    s.onload = () => resolve();
    s.onerror = (e) => reject(e);
    document.head.appendChild(s);
  });

  await window.__kodrx_jsbLoading;
}
</script>

  <script>
    // ====== Utilidades ======
    const KODRX_BLUE = '#0b5bd3';
async function waitForFirestoreHelper(maxMs = 8000){
  const t0 = Date.now();
  while (Date.now() - t0 < maxMs){
    if (typeof window.kodrxGetReceta === 'function') return true;
    await new Promise(r=>setTimeout(r,120));
  }
  return false;
}

async function smartLoadReceta(id){
  // 1) intenta directo si el helper ya está
  if (await waitForFirestoreHelper(0)){
    try{
      const r = await window.kodrxGetReceta(id);
      if (r) return r; // FIRESTORE listo
    }catch(_){}
  }

  // 2) muestra MOCK(ID) inmediato para no dejar vacío…
  let receta = {
    id,
    medico:{ nombre:`Demo ${id.slice(0,6)}`, genero:'F', cedula:`MX-${id.slice(0,6)}`, especialidad:'Medicina General', telefono:'—', direccion:'—' },
    paciente:{ nombre:`Paciente ${id.slice(0,6)}` },
    medicamentos:[],
    observaciones:'—',
    diagnostico:'—',
    timestamp: Date.now(),
    urlVerificacion: location.origin + '/public/verificar.html?id='+encodeURIComponent(id),
    urlBlockchain: location.origin + '/public/consulta.html?block='+encodeURIComponent(id),
    _origen:'mock-id'
  };

  // 3) …y reintenta Firestore en background 3 veces; si llega, re-renderiza
  (async ()=>{
    const maxTries = 3;
    for (let i=0;i<maxTries;i++){
      const ready = await waitForFirestoreHelper(2500);
      if (!ready) continue;
      try{
        const r = await window.kodrxGetReceta(id);
        if (r){
          RECETA_ACTUAL = r;
          const q = await prepararReceta(r); // re-render
          QRS = q;
          return;
        }
      }catch(_){}
    }
  })();

  return receta;
}
    // Espera a que las librerías UMD (jsPDF y QRCode) se carguen correctamente
    async function waitForLibs(maxTries = 50){
    let tries = 0;
    return new Promise(resolve => {
      (function check(){
        if (window.jspdf && window.QRCode){ resolve(); return; }
        if (++tries >= maxTries){ console.warn('Aviso: librerías no confirmadas, continúo'); resolve(); return; }
        setTimeout(check, 100);
      })();
    });
  }

  function prefixMedico(nombre, genero){
    if(!nombre) return '';
    const g = (genero||'').toLowerCase();
    const pref = (g.startsWith('f'))? 'Dra. ':'Dr. ';
    return pref + nombre;
  }

 function fechaLarga(ts){
  try{
    if (!ts) return '';
    if (typeof ts.toDate === 'function') {
      ts = ts.toDate();
    } else if (ts && typeof ts.seconds === 'number') {
      ts = new Date(ts.seconds * 1000 + Math.floor((ts.nanoseconds || 0) / 1e6));
    } else if (!(ts instanceof Date)) {
      ts = new Date(ts);
    }
    return ts.toLocaleString('es-MX', {
      year:'numeric', month:'long', day:'numeric',
      hour:'2-digit', minute:'2-digit'
    });
  } catch(e) {
    return '';
  }
}

function medsToText(meds){
  if(!Array.isArray(meds) || meds.length===0) return '—';
  return meds.map((m,i)=>`${i+1}. ${m.nombre}\n   Dosis: ${m.dosis}\n   Duración: ${m.duracion}`).join('\n\n');
}

  function hashSimulado(receta){
    const base = JSON.stringify({id:receta.id, meds:receta.medicamentos, t:receta.timestamp});
    let h = 0; for (let i=0;i<base.length;i++){ h = (h*31 + base.charCodeAt(i))>>>0; }
    return ('00000000'+h.toString(16)).slice(-8)+('-'+btoa(unescape(encodeURIComponent(receta.id))).replace(/=+$/,''));
  }

  function makeQRDataURL(text, size=260){
    return new Promise((resolve)=>{
      if (typeof QRCode === 'undefined'){ console.error('QRCode no está disponible'); resolve(''); return; }
      const div = document.createElement('div');
      new QRCode(div,{text,width:size,height:size,correctLevel:QRCode.CorrectLevel.M});
      setTimeout(()=>{
        const img = div.querySelector('img');
        if(img && img.src){ resolve(img.src); }
        else{
          const canvas = div.querySelector('canvas');
          resolve(canvas? canvas.toDataURL('image/png') : '');
        }
      }, 0);
    });
  }

async function renderPreview(receta, mainQRDataURL, chainQRDataURL){
  // helper local
  function setTextById(id, txt){
    const el = document.getElementById(id);
    if (el) el.textContent = txt;
  }

  // Datos médico
  setTextById('doctorNombre', prefixMedico(receta.medico.nombre, receta.medico.genero));
  setTextById('doctorCedula', receta.medico.cedula);
  setTextById('doctorEsp', receta.medico.especialidad);
  setTextById('doctorTel', receta.medico.telefono);
  setTextById('doctorDir', receta.medico.direccion);

  // Datos paciente
  setTextById('pacienteNombre', receta.paciente.nombre);
  setTextById('pacEdad', receta.paciente.edad);
  setTextById('pacSexo', receta.paciente.sexo);
  setTextById('pacPeso', receta.paciente.peso);
  setTextById('pacTalla',receta.paciente.talla);
  setTextById('pacIMC',  receta.paciente.imc);
  setTextById('pacTemp', receta.paciente.temperatura);
  setTextById('pacPresion',receta.paciente.presion);

  setTextById('fechaEmision', fechaLarga(receta.timestamp));
  setTextById('recetaId',  receta.id);

  setTextById('obsTexto',  receta.observaciones||'—');
  setTextById('diagTexto', receta.diagnostico||'—');


  // Medicamentos (derecha si existe, si no a la izquierda)
  const medsTXT = medsToText(receta.medicamentos);
  const medsEl = document.getElementById('listaMedsDerecha') || document.getElementById('listaMeds');
  if (medsEl) medsEl.textContent = medsTXT;

  // Hash y URL
  setTextById('hashTexto',hashSimulado(receta));
  setTextById('verifUrl', receta.urlBlockchain);

 // Dentro de renderPreview(receta, mainQRDataURL, chainQRDataURL)
const qrMain = document.getElementById('qrMain');
qrMain.innerHTML = '';
const i1 = new Image();
i1.src = mainQRDataURL; i1.alt = 'QR Receta';
i1.style.width = '220px'; i1.style.height = '220px';
qrMain.appendChild(i1);


  
const qrChain = document.getElementById('qrChain');
qrChain.innerHTML = '';
const i2 = new Image();
i2.src = chainQRDataURL; i2.alt = 'QR Blockchain';
i2.style.width = '110px'; i2.style.height = '110px';
qrChain.appendChild(i2);

  // === Código de barras del ID (pantalla) ===
try{
  await ensureJsBarcode();
  const c = document.getElementById('barcodeCanvas');
  if (c){
    // Limpia y dibuja
    const ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    JsBarcode(c, String(receta.id || ''), {
      format: 'CODE128',
      height: 40,          // alto de barras (px)
      width: 2,            // ancho de barra (px)
      margin: 4,
      displayValue: false,  // imprime el valor abajo
      fontSize: 10,
      textMargin: 4
    });
  }
  const lbl = document.getElementById('barcodeLabel');
  if (lbl) lbl.textContent = String(receta.id || '—');
}catch(e){
  console.warn('[KodRx] No se pudo generar el código de barras:', e);
}
// número de bloque si lo tienes
const blockSpan = document.getElementById('blockNum');
if (blockSpan){
  const num = (receta.bloque!=null) ? receta.bloque : (new URL(receta.urlBlockchain).searchParams.get('id') || '—');
  blockSpan.textContent = `Bloque: ${num}`;
}

  // Badge
  const badge = document.getElementById('badgeOrigen');
  if (badge){
    if (receta._origen === 'firestore'){ badge.textContent = 'Receta Verificada';  badge.className='badge ok'; }
    else if (receta._origen === 'mock-id'){ badge.textContent = 'MOCK (ID)'; badge.className='badge warn'; }
    else { badge.textContent = 'MOCK'; badge.className='badge warn'; }
  }
}

<script>
/* ========= PARCHE RESCATE KODRX (no depende del print layout) ========= */
(function(){
  console.info('[KodRx] Rescue patch activo');

  // ---------- Utilidades mínimas ----------
  function $(id){ return document.getElementById(id); }
  function setText(id, v){ const el=$(id); if(el) el.textContent = v ?? '—'; }

  // Espera jsPDF y QRCode (CDN ya en la página)
  async function waitForLibs(maxMs=6000){
    const t0 = Date.now();
    while (Date.now()-t0 < maxMs){
      if (window.jspdf && window.QRCode) return true;
      await new Promise(r=>setTimeout(r,120));
    }
    console.warn('[KodRx] Librerías no confirmadas, continúo');
    return true;
  }

  // Cargar JsBarcode si hace falta
  async function ensureJsBarcode(){
    if (window.JsBarcode) return;
    await new Promise((res, rej)=>{
      const s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js";
      s.onload = res; s.onerror = rej;
      document.head.appendChild(s);
    });
  }

  // QR -> DataURL
  function makeQRDataURL(text, size=260){
    return new Promise((resolve)=>{
      if (typeof QRCode === 'undefined'){ resolve(''); return; }
      const div = document.createElement('div');
      new QRCode(div,{text,width:size,height:size,correctLevel:QRCode.CorrectLevel.M});
      // Deja que pinte el <img>/<canvas>
      setTimeout(()=>{
        const img = div.querySelector('img');
        if(img && img.src) return resolve(img.src);
        const canvas = div.querySelector('canvas');
        resolve(canvas? canvas.toDataURL('image/png') : '');
      },0);
    });
  }

  // Carga receta desde Firestore si está el helper; si no, mock con ?id=
  async function smartLoadReceta(){
    const p = new URLSearchParams(location.search);
    const id = p.get('id') || 'RECETA-DE-EJEMPLO-001';
    if (typeof window.kodrxGetReceta === 'function'){
      try{
        const real = await window.kodrxGetReceta(id);
        if (real){ console.info('[KodRx] Receta Firestore:', id); return real; }
      }catch(e){ console.warn('[KodRx] Firestore falló, uso mock:', e); }
    }
    // Mock
    return {
      id,
      medico:{ nombre:'Gabriela López Ramírez', genero:'F', cedula:'1234567', especialidad:'Medicina Interna', telefono:'—', direccion:'—' },
      paciente:{ nombre:'Juan Pérez', edad:'—', sexo:'—', peso:'—', talla:'—', imc:'—', temperatura:'—', presion:'—' },
      medicamentos:[
        { nombre:'Amoxicilina 500 mg', dosis:'1 cápsula cada 8 h', duracion:'7 días' },
        { nombre:'Paracetamol 500 mg', dosis:'1 tableta cada 8 h si dolor', duracion:'5 días' }
      ],
      observaciones:'—',
      diagnostico:'—',
      timestamp: Date.now(),
      urlVerificacion: location.origin + '/public/verificar.html?id='+encodeURIComponent(id),
      urlBlockchain: location.origin + '/public/consulta.html?block='+encodeURIComponent(id),
      _origen:'mock-id'
    };
  }

  function prefixMedico(nombre, genero){
    if(!nombre) return '—';
    const g = (genero||'').toLowerCase();
    return (g.startsWith('f')?'Dra. ':'Dr. ') + nombre;
  }
  function fechaLarga(ts){
    try{
      if (ts && typeof ts.toDate === 'function') ts = ts.toDate();
      else if (ts && typeof ts.seconds === 'number') ts = new Date(ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6));
      else if (!(ts instanceof Date)) ts = new Date(ts);
      return ts.toLocaleString('es-MX',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
    }catch{ return ''; }
  }
  function medsToText(meds){
    if(!Array.isArray(meds)||!meds.length) return '—';
    return meds.map((m,i)=>`${i+1}. ${m.nombre}\n   Dosis: ${m.dosis}\n   Duración: ${m.duracion}`).join('\n\n');
  }
  function hashSimulado(receta){
    const base = JSON.stringify({id:receta.id, meds:receta.medicamentos, t:receta.timestamp});
    let h=0; for(let i=0;i<base.length;i++){ h=(h*31+base.charCodeAt(i))>>>0; }
    return ('00000000'+h.toString(16)).slice(-8)+'-'+btoa(unescape(encodeURIComponent(receta.id))).replace(/=+$/,'');
  }

  async function renderPreview(receta, mainQR, chainQR){
    // Médico
    setText('doctorNombre',  prefixMedico(receta.medico?.nombre, receta.medico?.genero));
    setText('doctorCedula',  receta.medico?.cedula);
    setText('doctorEsp',     receta.medico?.especialidad);
    setText('doctorTel',     receta.medico?.telefono);
    setText('doctorDir',     receta.medico?.direccion);
    // Paciente
    setText('pacienteNombre', receta.paciente?.nombre);
    setText('pacEdad',   receta.paciente?.edad);
    setText('pacSexo',   receta.paciente?.sexo);
    setText('pacPeso',   receta.paciente?.peso);
    setText('pacTalla',  receta.paciente?.talla);
    setText('pacIMC',    receta.paciente?.imc);
    setText('pacTemp',   receta.paciente?.temperatura);
    setText('pacPresion',receta.paciente?.presion);
    setText('fechaEmision', fechaLarga(receta.timestamp));
    setText('recetaId', 'ID: '+receta.id);

    // Observaciones / Diagnóstico
    setText('obsTexto',  receta.observaciones || '—');
    setText('diagTexto', receta.diagnostico   || '—');

    // Medicamentos
    const medsEl = document.getElementById('listaMedsDerecha') || document.getElementById('listaMeds');
    if (medsEl) medsEl.textContent = medsToText(receta.medicamentos);

    // Hash + URL/Bloque
    setText('hashTexto', 'hash: '+hashSimulado(receta));
    setText('verifUrl', receta.urlBlockchain);

    // QR Receta
    const qrMain = $('qrMain'); if (qrMain){
      qrMain.innerHTML = '';
      const i = new Image(); i.alt='QR Receta'; i.src = mainQR;
      i.style.width='220px'; i.style.height='220px';
      qrMain.appendChild(i);
    }
    // QR Blockchain
    const qrChain = $('qrChain'); if (qrChain){
      qrChain.innerHTML = '';
      const i = new Image(); i.alt='QR Blockchain'; i.src = chainQR;
      i.style.width='110px'; i.style.height='110px';
      qrChain.appendChild(i);
    }
    // Código de barras (pantalla)
    try{
      await ensureJsBarcode();
      const c = $('barcodeCanvas');
      if (c){
        const ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
        JsBarcode(c, String(receta.id||''), { format:'CODE128', width:2, height:56, margin:4, displayValue:true, fontSize:12, textMargin:4 });
      }
      const lbl = $('barcodeLabel'); if (lbl) lbl.textContent = String(receta.id||'—');
    }catch(e){ console.warn('[KodRx] JsBarcode fallo:', e); }

    // Badge
    const badge = $('badgeOrigen');
    if (badge){
      if (receta._origen === 'firestore'){ badge.textContent = 'Receta Verificada'; badge.className='badge ok'; }
      else if (receta._origen === 'mock-id'){ badge.textContent = 'MOCK (ID)'; badge.className='badge warn'; }
      else { badge.textContent = 'MOCK'; badge.className='badge warn'; }
    }
  }

  async function prepararReceta(receta){
    const mainQR  = await makeQRDataURL(receta.urlVerificacion, 520);
    const chainQR = await makeQRDataURL(receta.urlBlockchain, 260);
    await renderPreview(receta, mainQR, chainQR);
    return { mainQRUrl: mainQR, chainQRUrl: chainQR };
  }

  // ---------- Boot seguro (evita dobles) ----------
  if (!window.__kodrx_booted_rescue__){
    window.__kodrx_booted_rescue__ = true;

    window.addEventListener('DOMContentLoaded', ()=>{
      (async ()=>{
        await waitForLibs();
        // si tu app ya define estas globales, las respetamos
        window.RECETA_ACTUAL = window.RECETA_ACTUAL || await smartLoadReceta();
        window.QRS = await prepararReceta(window.RECETA_ACTUAL);

        // Botones (si existen)
        document.getElementById('btnDescargar')?.addEventListener('click', async ()=>{
          try{
            if (!window.RECETA_ACTUAL) window.RECETA_ACTUAL = await smartLoadReceta();
            if (!window.QRS)           window.QRS = await prepararReceta(window.RECETA_ACTUAL);
            // Tu generarPDF original debería seguir existiendo:
            if (typeof window.generarPDF === 'function'){
              await window.generarPDF(window.RECETA_ACTUAL, window.QRS);
            } else {
              console.warn('[KodRx] generarPDF no encontrado. Sólo vista previa lista.');
            }
          }catch(e){ console.error(e); }
        });

        document.getElementById('btnCargarEjemplo')?.addEventListener('click', async ()=>{
          window.RECETA_ACTUAL = await smartLoadReceta(); // mock si no hay id
          window.QRS = await prepararReceta(window.RECETA_ACTUAL);
        });

        document.getElementById('btnRegresar')?.addEventListener('click', ()=>{
          if (history.length>1) history.back(); else location.href='/';
        });

        console.info('[KodRx] Rescue patch: boot OK');
      })();
    });
  }
})();
</script>

  </script>
 

</body>
</html>

