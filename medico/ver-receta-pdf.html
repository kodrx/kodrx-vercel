<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KodRx | ver-receta-pdf-puro (jsPDF)</title>
  <style>
    :root{ --kodrx-blue:#0b5bd3; --kodrx-dark:#0b1b2b; --muted:#6b7280; --ok:#059669; --warn:#b45309 }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:#0f172a;color:#0f172a}
    .wrap{max-width:900px;margin:32px auto;padding:20px}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden}
    .card-header{display:flex;gap:16px;align-items:center;padding:16px 20px;border-bottom:1px solid #e5e7eb}
    .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#83fbc9,#0b5bd3);display:flex;align-items:center;justify-content:center;color:#001b3b;font-weight:800}
    .title{font-size:18px;font-weight:700;color:var(--kodrx-dark)}
    .sub{font-size:12px;color:var(--muted)}
    .badge{margin-left:auto;font-size:11px;padding:4px 8px;border-radius:999px;font-weight:700}
    .badge.ok{background:#ecfdf5;color:var(--ok);border:1px solid #a7f3d0}
    .badge.warn{background:#fffbeb;color:var(--warn);border:1px solid #fcd34d}

    /* Layout de dos columnas con derecha fija para que los QR no se muevan */
.canvas{
  display: grid;
  grid-template-columns: 1fr 320px; /* izquierda fluye, derecha fija */
  gap: 16px;
}
.right{ display:flex; flex-direction:column; align-items:center; }
.qr-frame{ flex:0 0 auto; }          /* evita que el QR cambie de tamaño */
#qrMain img{ width:200px; height:200px }
#qrChain img{ width:100px; height:100px }

    .left{display:flex;flex-direction:column;gap:8px}
    .doc-label{font-size:12px;color:var(--muted);letter-spacing:.04em;text-transform:uppercase}
    .doc-val{font-size:16px;font-weight:700;color:#111827}

    .qr-frame{position:relative;display:flex;align-items:center;justify-content:center;background:#f8fafc;border:4px solid var(--kodrx-blue);border-radius:14px;min-height:280px}
    .qr-frame.small{min-height:140px;border-width:3px;border-radius:12px}
    .qr-legend{position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);background:#fff;color:var(--kodrx-blue);font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid var(--kodrx-blue);font-weight:700}

    .hash{margin-top:8px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;color:#111827;background:#f3f4f6;border-radius:10px;padding:10px;word-break:break-all}

    .footer{background:var(--kodrx-blue);color:#fff;padding:12px 16px;text-align:center;font-weight:600}

    .actions{display:flex;gap:12px;padding:16px;border-top:1px solid #e5e7eb;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .primary{background:var(--kodrx-blue);color:#fff}
    .ghost{background:#eef2ff;color:#111827}
    .meta{display:flex;gap:24px;color:#374151;font-size:13px;margin-top:6px}
/* === PANELS (screen + print) === */
.panel{
  background: #f8fafc;              /* mismo tono que en jsPDF */
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 12px;
}
.panel h5{ margin: 0 0 6px; font-size: 12px; color:#6b7280; letter-spacing:.04em; text-transform:uppercase; }

    @media (max-width:720px){ .canvas{grid-template-columns:1fr} }
   /* === PRINT FIX A4 === */
@page { size: A4; margin: 10mm; }

@media print{
  html, body { height: auto; background: #fff !important; }
  .wrap{ margin:0; padding:0 }
  .card{ width: 190mm; margin: 0 auto; box-shadow:none; border-radius:0 }
  .actions,.card-header{ display:none !important }

  /* Compactar layout y evitar empujones */
  .canvas{ display:block }
  section.left, section.right{ break-inside: avoid; page-break-inside: avoid }

  /* Módulos en una sola página */
  .panel, .qr-frame, #listaMeds, #obsTexto, #diagTexto{
    break-inside: avoid; page-break-inside: avoid; 
  }

  /* QRs fijos y centrados */
  .qr-frame{ 
    width:auto; min-width: 0; 
    border-width:3px; 
    margin: 8px auto; 
    display:inline-flex; align-items:center; justify-content:center;
  }
  #qrMain img{ width:200px; height:200px }
  #qrChain img{ width:100px; height:100px }
}

  </style>
</head>
<body class="page-border">
  <div class="wrap">
    <div class="card" id="previewCard">
      <div class="card-header">
        <div class="logo">K</div>
        <div>
          <div class="title">KodRx — Receta médica digital</div>
          <div class="sub">Vista previa en pantalla </div>
        </div>
        <span id="badgeOrigen" class="badge warn">MOCK</span>
      </div>

      <div class="canvas">
        <section class="left">
         <div>
  <div class="doc-label">Médico</div>
  <div class="doc-val" id="doctorNombre">—</div>
  <div class="meta">
    <div id="doctorCedula">Cédula: —</div>
    <div id="doctorEsp">Especialidad: —</div>
  </div>
  <div class="meta">
    <div id="doctorTel">Tel: —</div>
    <div id="doctorDir">Dirección: —</div>
  </div>
</div>


          <div>
  <div class="doc-label">Paciente</div>
  <div class="doc-val" id="pacienteNombre">—</div>
  <div class="meta">
    <div id="fechaEmision">—</div>
    <div id="recetaId">ID: —</div>
  </div>
  <div class="meta" id="pacienteVitals">
    <div id="pacEdad">Edad: —</div>
    <div id="pacSexo">Sexo: —</div>
    <div id="pacPeso">Peso: —</div>
    <div id="pacTalla">Talla: —</div>
    <div id="pacIMC">IMC: —</div>
    <div id="pacTemp">Temp: —</div>
    <div id="pacPresion">PA: —</div>
  </div>
</div>

<div>
  <div class="doc-label">Observaciones</div>
  <div id="obsTexto" class="hash" style="white-space:pre-wrap">—</div>
</div>

<div>
  <div class="doc-label">Diagnóstico</div>
  <div id="diagTexto" class="hash" style="white-space:pre-wrap">—</div>
</div>

          

          
        </section>

      
          <section class="right">
 <div class="panel" id="panelMedsRight" style="margin-bottom:12px">
  <div class="doc-label">Medicamentos</div>
  <pre id="listaMedsDerecha" style="white-space:pre-wrap; margin:0">—</pre>
</div>

<div class="qr-frame">
  <div id="qrMain"></div>
  <div class="qr-legend">Receta</div>
</div>
<div class="hash" id="hashTexto">hash: —</div>

<div style="display:grid;grid-template-columns:1fr auto;gap:14px;align-items:center;margin-top:6px">
  <div>
    <div class="doc-label">Verificación en cadena (pública)</div>
    <div class="sub" id="verifUrl">—</div>
  </div>
  <div class="qr-frame small" style="width:150px;height:150px">
    <div id="qrChain"></div>
    <div class="qr-legend" style="bottom:-12px;font-size:10px">Blockchain</div>
  </div>
</div>
          </section>

      <div class="footer">Creada con KodRx. Tecnología que verifica, salud que protege.</div>

      <div class="actions">
        <button class="primary" id="btnDescargar">Descargar PDF</button>
        <button class="ghost" onclick="window.print()">Imprimir</button>
        <button class="ghost" id="btnCargarEjemplo">Cargar ejemplo</button>
      </div>
    </div>
  </div>

  <!-- jsPDF (puro) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- QRCode.js para generar QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Firebase (opcional): si hay ID, intentará traer receta real de Firestore -->
  <script type="module">
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBIjaOe4HcGNDk0xrqen8etBv0RyjyOJHw",
    authDomain: "kodrx-105b9.firebaseapp.com",
    projectId: "kodrx-105b9"
  };

  try {
    const [{ initializeApp }, { getFirestore, doc, getDoc }] = await Promise.all([
      import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'),
      import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js')
    ]);

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Helper global para el script no-módulo
    window.kodrxGetReceta = async (id) => {
      try {
        const ref  = doc(db, 'recetas', id);
        const snap = await getDoc(ref);
        if (!snap.exists()) return null;
        const d = snap.data();

        // Normaliza timestamp a Date (Timestamp | {seconds,nanoseconds} | number/string)
        const ts = d.fecha ?? d.timestamp;
        const normDate =
          (ts && typeof ts.toDate === 'function') ? ts.toDate() :
          (ts && typeof ts.seconds === 'number') ? new Date(ts.seconds * 1000 + Math.floor((ts.nanoseconds || 0) / 1e6)) :
          (ts ? new Date(ts) : new Date());

        // Objeto receta final
        const receta = {
          id,
          medico: {
            nombre:        d.medicoNombre       || d.medico?.nombre       || '—',
            genero:        d.medicoGenero       || d.medico?.genero       || '',
            cedula:        d.medicoCedula       || d.medico?.cedula       || '—',
            especialidad:  d.medicoEspecialidad || d.medico?.especialidad || '—',
            telefono:      d.medicoTelefono     || d.medico?.telefono     || '—',
            direccion:     d.medicoDomicilio    || d.medico?.domicilio    || d.medico?.direccion || '—'
          },
          paciente: {
            nombre:       d.nombrePaciente || d.pacienteNombre || d.paciente?.nombre || '—',
            edad:         d.edad ?? d.paciente?.edad ?? '—',
            sexo:         d.sexo ?? d.paciente?.sexo ?? '—',
            peso:         d.peso ?? d.paciente?.peso ?? '—',
            talla:        d.talla ?? d.paciente?.talla ?? '—',
            imc:          d.imc ?? d.paciente?.imc ?? '—',
            temperatura:  d.temperatura ?? d.paciente?.temperatura ?? '—',
            presion:      d.presion ?? d.paciente?.presion ?? '—'
          },
          medicamentos: (d.medicamentos || d.items || []).map((m,i)=>({
            nombre:   m.nombre || m.medicamento || `Medicamento ${i+1}`,
            dosis:    m.dosis  || m.indicaciones || '—',
            duracion: m.duracion || m.tiempo     || '—'
          })),
          observaciones:   d.observaciones || '—',
          diagnostico:     d.diagnostico   || '—',
          timestamp:       normDate,
          urlVerificacion: `https://kodrx.app/verificar.html?id=${encodeURIComponent(id)}`,
          urlBlockchain:   `https://kodrx-blockchain.onrender.com/verificar.html?id=${encodeURIComponent(d.bloque || id)}`,
          _origen: 'firestore'
        };

        console.info('[KodRx] Receta obtenida de Firestore:', id);
        return receta;
      } catch (e) {
        console.warn('[KodRx] No se pudo leer Firestore, usando mock. Motivo:', e);
        return null;
      }
    };
  } catch (e) {
    console.warn('[KodRx] Firebase no disponible (modo demo). Puedes ignorar este aviso si aún no configuras Firebase.', e);
  }
</script>


  <script>
    // ====== Utilidades ======
    const KODRX_BLUE = '#0b5bd3';
async function waitForFirestoreHelper(maxMs = 8000){
  const t0 = Date.now();
  while (Date.now() - t0 < maxMs){
    if (typeof window.kodrxGetReceta === 'function') return true;
    await new Promise(r=>setTimeout(r,120));
  }
  return false;
}

async function smartLoadReceta(id){
  // 1) intenta directo si el helper ya está
  if (await waitForFirestoreHelper(0)){
    try{
      const r = await window.kodrxGetReceta(id);
      if (r) return r; // FIRESTORE listo
    }catch(_){}
  }

  // 2) muestra MOCK(ID) inmediato para no dejar vacío…
  let receta = {
    id,
    medico:{ nombre:`Demo ${id.slice(0,6)}`, genero:'F', cedula:`MX-${id.slice(0,6)}`, especialidad:'Medicina General', telefono:'—', direccion:'—' },
    paciente:{ nombre:`Paciente ${id.slice(0,6)}` },
    medicamentos:[],
    observaciones:'—',
    diagnostico:'—',
    timestamp: Date.now(),
    urlVerificacion: location.origin + '/public/verificar.html?id='+encodeURIComponent(id),
    urlBlockchain: location.origin + '/public/consulta.html?block='+encodeURIComponent(id),
    _origen:'mock-id'
  };

  // 3) …y reintenta Firestore en background 3 veces; si llega, re-renderiza
  (async ()=>{
    const maxTries = 3;
    for (let i=0;i<maxTries;i++){
      const ready = await waitForFirestoreHelper(2500);
      if (!ready) continue;
      try{
        const r = await window.kodrxGetReceta(id);
        if (r){
          RECETA_ACTUAL = r;
          const q = await prepararReceta(r); // re-render
          QRS = q;
          return;
        }
      }catch(_){}
    }
  })();

  return receta;
}
    // Espera a que las librerías UMD (jsPDF y QRCode) se carguen correctamente
    async function waitForLibs(maxTries = 50){
    let tries = 0;
    return new Promise(resolve => {
      (function check(){
        if (window.jspdf && window.QRCode){ resolve(); return; }
        if (++tries >= maxTries){ console.warn('Aviso: librerías no confirmadas, continúo'); resolve(); return; }
        setTimeout(check, 100);
      })();
    });
  }

  function prefixMedico(nombre, genero){
    if(!nombre) return '';
    const g = (genero||'').toLowerCase();
    const pref = (g.startsWith('f'))? 'Dra. ':'Dr. ';
    return pref + nombre;
  }

 function fechaLarga(ts){
  try{
    if (!ts) return '';
    if (typeof ts.toDate === 'function') {
      ts = ts.toDate();
    } else if (ts && typeof ts.seconds === 'number') {
      ts = new Date(ts.seconds * 1000 + Math.floor((ts.nanoseconds || 0) / 1e6));
    } else if (!(ts instanceof Date)) {
      ts = new Date(ts);
    }
    return ts.toLocaleString('es-MX', {
      year:'numeric', month:'long', day:'numeric',
      hour:'2-digit', minute:'2-digit'
    });
  } catch(e) {
    return '';
  }
}

function medsToText(meds){
  if(!Array.isArray(meds) || meds.length===0) return '—';
  return meds.map((m,i)=>`${i+1}. ${m.nombre}\n   Dosis: ${m.dosis}\n   Duración: ${m.duracion}`).join('\n\n');
}

  function hashSimulado(receta){
    const base = JSON.stringify({id:receta.id, meds:receta.medicamentos, t:receta.timestamp});
    let h = 0; for (let i=0;i<base.length;i++){ h = (h*31 + base.charCodeAt(i))>>>0; }
    return ('00000000'+h.toString(16)).slice(-8)+('-'+btoa(unescape(encodeURIComponent(receta.id))).replace(/=+$/,''));
  }

  function makeQRDataURL(text, size=260){
    return new Promise((resolve)=>{
      if (typeof QRCode === 'undefined'){ console.error('QRCode no está disponible'); resolve(''); return; }
      const div = document.createElement('div');
      new QRCode(div,{text,width:size,height:size,correctLevel:QRCode.CorrectLevel.M});
      setTimeout(()=>{
        const img = div.querySelector('img');
        if(img && img.src){ resolve(img.src); }
        else{
          const canvas = div.querySelector('canvas');
          resolve(canvas? canvas.toDataURL('image/png') : '');
        }
      }, 0);
    });
  }

function renderPreview(receta, mainQRDataURL, chainQRDataURL){
  // helper local
  function setTextById(id, txt){
    const el = document.getElementById(id);
    if (el) el.textContent = txt;
  }

  // Datos médico
  setTextById('doctorNombre', prefixMedico(receta.medico.nombre, receta.medico.genero));
  setTextById('doctorCedula', 'Cédula: ' + (receta.medico.cedula||'—'));
  setTextById('doctorEsp',    'Especialidad: ' + (receta.medico.especialidad||'—'));
  setTextById('doctorTel',    'Tel: ' + (receta.medico.telefono||'—'));
  setTextById('doctorDir',    'Dirección: ' + (receta.medico.direccion||'—'));

  // Datos paciente
  setTextById('pacienteNombre', receta.paciente.nombre||'—');
  setTextById('pacEdad',   'Edad: ' + (receta.paciente.edad||'—'));
  setTextById('pacSexo',   'Sexo: ' + (receta.paciente.sexo||'—'));
  setTextById('pacPeso',   'Peso: ' + (receta.paciente.peso||'—'));
  setTextById('pacTalla',  'Talla: ' + (receta.paciente.talla||'—'));
  setTextById('pacIMC',    'IMC: '  + (receta.paciente.imc||'—'));
  setTextById('pacTemp',   'Temp: ' + (receta.paciente.temperatura||'—'));
  setTextById('pacPresion','PA: '   + (receta.paciente.presion||'—'));

  setTextById('fechaEmision', fechaLarga(receta.timestamp));
  setTextById('recetaId', 'ID: ' + receta.id);

  setTextById('obsTexto',  receta.observaciones||'—');
  setTextById('diagTexto', receta.diagnostico||'—');


  // Medicamentos (derecha si existe, si no a la izquierda)
  const medsTXT = medsToText(receta.medicamentos);
  const medsEl = document.getElementById('listaMedsDerecha') || document.getElementById('listaMeds');
  if (medsEl) medsEl.textContent = medsTXT;

  // Hash y URL
  setTextById('hashTexto', 'hash: ' + hashSimulado(receta));
  setTextById('verifUrl', receta.urlBlockchain);

  // QRs (solo si existen contenedores)
  const qrMain = document.getElementById('qrMain');
  if (qrMain){
    qrMain.innerHTML = '';
    const img1 = new Image();
    img1.alt = 'QR Receta'; img1.width = 200; img1.height = 200; img1.src = mainQRDataURL;
    qrMain.appendChild(img1);
  }
  const qrChain = document.getElementById('qrChain');
  if (qrChain){
    qrChain.innerHTML = '';
    const img2 = new Image();
    img2.alt = 'QR Blockchain'; img2.width = 100; img2.height = 100; img2.src = chainQRDataURL;
    qrChain.appendChild(img2);
  }

  // Badge
  const badge = document.getElementById('badgeOrigen');
  if (badge){
    if (receta._origen === 'firestore'){ badge.textContent = 'FIRESTORE';  badge.className='badge ok'; }
    else if (receta._origen === 'mock-id'){ badge.textContent = 'MOCK (ID)'; badge.className='badge warn'; }
    else { badge.textContent = 'MOCK'; badge.className='badge warn'; }
  }
}


async function generarPDF(receta, qrs){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4', compress:true }); // ~595 x 842
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();

  // ===== Layout base (márgenes + 2 columnas) =====
  const Mx = 42, My = 50;                      // márgenes compactos
  const CW = W - 2*Mx;                         // ancho de contenido
  const gutter = 16;                           // separación entre columnas
  const colW = (CW - gutter) / 2;              // ancho de cada columna
  const leftX = Mx, rightX = Mx + colW + gutter;
  const footerH = 48;                          // alto del pie
  const availYMax = H - My - footerH - 10;     // límite para el contenido
  const font = 'helvetica';

  const COLORS = {
    panelFill: [248,250,252],
    panelStroke: [224,231,240],
    text: [17,24,39],
    sub: [55,65,81],
    label: [107,114,128],
    brand: [11,91,211]
  };

  doc.setFont(font,'normal');

  // ===== Helpers =====
  function header(){
    doc.setFillColor(240,245,255);
    doc.roundedRect(18,18,W-36,50,9,9,'F');
    doc.setTextColor(11,27,43);
    doc.setFontSize(13);
    doc.text('KodRx — Receta médica digital', Mx, 48);
  }
  function footer(){
    doc.setFillColor(...COLORS.brand);
    doc.rect(18, H-18-footerH, W-36, footerH, 'F');
    doc.setTextColor(255,255,255);
    doc.setFont(font,'bold'); doc.setFontSize(10.5);
    doc.text('Creada con KodRx. Tecnología que verifica, salud que protege.', W/2, H-22, {align:'center'});
    doc.setFont(font,'normal');
  }
  function sectionBoxCol(x, y, w, contentH, title){
    const padX = 10, padY = 10, titleH = 18;
    const boxH = contentH + padY*2 + titleH;
    // sombreado + borde
    doc.setFillColor(...COLORS.panelFill);
    doc.setDrawColor(...COLORS.panelStroke);
    doc.setLineWidth(0.8);
    doc.roundedRect(x, y, w, boxH, 8, 8, 'FD');
    // título
    doc.setTextColor(...COLORS.label);
    doc.setFont(font,'bold'); doc.setFontSize(10);
    doc.text(title, x + padX, y + 14);
    // contenido
    doc.setFont(font,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.text);
    return { cx: x + padX, cy: y + 14 + padY, ny: y + boxH + 10 };
  }
  function wrap(text, width){ return doc.splitTextToSize(String(text ?? '—'), width); }
  function medsToText(meds){
    if(!Array.isArray(meds) || meds.length===0) return '—';
    return meds.map((m,i)=>`${i+1}. ${m.nombre}\n   Dosis: ${m.dosis}\n   Duración: ${m.duracion}`).join('\n\n');
  }
  function fechaStrSafe(ts){
    try{
      if (ts && typeof ts.toDate === 'function') ts = ts.toDate();
      else if (ts && typeof ts.seconds === 'number') ts = new Date(ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6));
      else if (!(ts instanceof Date)) ts = new Date(ts);
      return ts.toLocaleString('es-MX',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
    }catch(_){ return ''; }
  }
  function labelValueLine(x, y, label, value){
    doc.setFont(font,'bold'); doc.setTextColor(...COLORS.sub); doc.setFontSize(9.5);
    doc.text(label, x, y);
    const w = doc.getTextWidth(label);
    doc.setFont(font,'normal'); doc.setTextColor(...COLORS.text);
    doc.text(String(value ?? '—'), x + w + 4, y);
  }

  // ===== Encabezado
  header();

  // ===== Cursores de columnas
  let yL = My;   // izquierda
  let yR = My;   // derecha

  // ===== MÉDICO (col izquierda)
  {
    const lines = 4, lineH = 13;
    const contentH = lines*lineH + 20;        // nombre en 12 pt + 3 líneas
    const s = sectionBoxCol(leftX, yL, colW, contentH, 'MÉDICO');
    let cy = s.cy + 2;
    doc.setFont(font,'bold'); doc.setFontSize(11.5); doc.setTextColor(...COLORS.text);
    doc.text(receta.medico?.nombre ? `${prefixMedico(receta.medico.nombre, receta.medico.genero)}` : '—', s.cx, cy);
    doc.setFont(font,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.sub);
    cy += 16;
    doc.text(`Cédula: ${receta.medico?.cedula || '—'}    Especialidad: ${receta.medico?.especialidad || '—'}`, s.cx, cy);
    cy += 14;
    doc.text(`Tel: ${receta.medico?.telefono || '—'}`, s.cx, cy); cy += 14;
    doc.text(`Dirección: ${receta.medico?.direccion || '—'}`, s.cx, cy);
    yL = s.ny;
  }

  // ===== PACIENTE (col izquierda)
  {
    const lines = 3, lineH = 13;
    const contentH = lines*lineH + 30;        // añade espacio para vitals
    const s = sectionBoxCol(leftX, yL, colW, contentH, 'PACIENTE');
    let cy = s.cy + 2;

    doc.setFont(font,'bold'); doc.setFontSize(11.5); doc.setTextColor(...COLORS.text);
    doc.text(receta.paciente?.nombre || '—', s.cx, cy);
    doc.setFont(font,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.sub);
    cy += 16;
    doc.text(`${fechaStrSafe(receta.timestamp)}    ID: ${receta.id}`, s.cx, cy);
    cy += 16;

    labelValueLine(s.cx, cy, 'Edad:', receta.paciente?.edad);
    labelValueLine(s.cx + 110, cy, 'Sexo:', receta.paciente?.sexo);
    cy += 13;
    labelValueLine(s.cx, cy, 'Peso:', receta.paciente?.peso);
    labelValueLine(s.cx + 110, cy, 'Talla:', receta.paciente?.talla);
    labelValueLine(s.cx + 220, cy, 'IMC:',  receta.paciente?.imc);
    cy += 13;
    labelValueLine(s.cx, cy, 'Temp:', receta.paciente?.temperatura);
    labelValueLine(s.cx + 110, cy, 'PA:',   receta.paciente?.presion);

    yL = s.ny;
  }

  // ===== OBSERVACIONES (col izquierda)
  {
    const obsWrapped = wrap(receta.observaciones, colW - 20);
    const contentH = Math.max(40, obsWrapped.length * 11 + 6);
    const s = sectionBoxCol(leftX, yL, colW, contentH, 'OBSERVACIONES');
    doc.setFont(font,'normal'); doc.setFontSize(9.5); doc.setTextColor(...COLORS.text);
    doc.text(obsWrapped, s.cx, s.cy);
    yL = s.ny;
  }

  // ===== DIAGNÓSTICO (col derecha, arriba)
  {
    const diagWrapped = wrap(receta.diagnostico, colW - 20);
    const contentH = Math.max(40, diagWrapped.length * 11 + 6);
    const s = sectionBoxCol(rightX, yR, colW, contentH, 'DIAGNÓSTICO');
    doc.text(diagWrapped, s.cx, s.cy);
    yR = s.ny;
  }

  // ===== MEDICAMENTOS (col derecha, debajo de diagnóstico)
  {
    const medsWrapped = wrap(medsToText(receta.medicamentos), colW - 20);
    const contentH = Math.max(60, medsWrapped.length * 11 + 6);
    const s = sectionBoxCol(rightX, yR, colW, contentH, 'MEDICAMENTOS');
    doc.text(medsWrapped, s.cx, s.cy);
    yR = s.ny;
  }

  // ===== QR RECETA (debajo de Medicamentos, mismo flujo derecha)
  {
    const box = 140, pad = 10;       // más compacto (140 px)
    let y = yR;
    // si no cabe arriba del footer, lo pegamos a la altura mínima de margen
    if (y + box + 28 > availYMax) y = Math.min(availYMax - (box + 28), y);

    const xQR = rightX + (colW - box) / 2;
    doc.setDrawColor(...COLORS.brand); doc.setLineWidth(3);
    doc.roundedRect(xQR, y, box, box, 10, 10, 'S');
    doc.addImage(qrs.mainQRUrl, 'PNG', xQR + pad, y + pad, box - pad*2, box - pad*2, undefined, 'FAST');
    doc.setTextColor(...COLORS.brand); doc.setFont(font,'bold'); doc.setFontSize(9.5);
    doc.text('Receta', xQR + box/2, y + box + 14, {align:'center'});
    yR = y + box + 22;
  }

  // ===== Hash + Verificación + QR Blockchain (esquina inferior derecha)
  {
    // bloque se ubica a partir del mayor de ambas columnas
    let y = Math.max(yL, yR) + 8;
    const mini = 90;
    const rectW = mini, rectH = mini;
    const qrX = rightX + colW - rectW;   // alineado a la derecha de la columna derecha
    let qrY = y;

    // Si no cabe, súbelo para no pisar el pie
    if (qrY + rectH + 30 > availYMax) qrY = availYMax - rectH - 30;

    // Texto (hash + url) se imprimen sobre la columna izquierda hasta llegar a la altura del QR
    const textW = CW - (colW - 0); // aprovechamos todo el ancho menos el bloque del QR
    doc.setTextColor(...COLORS.sub); doc.setFont(font,'normal'); doc.setFontSize(9.5);
    const hashText = 'hash: ' + hashSimulado(receta);
    const hashWrapped = wrap(hashText, rightX - leftX + (colW - mini) - 24); // ancho hasta antes del QR
    doc.text(hashWrapped, leftX, qrY);

    const urlTitleY = qrY + hashWrapped.length*11 + 16;
    doc.setTextColor(...COLORS.label); doc.setFont(font,'bold'); doc.setFontSize(9.5);
    doc.text('Verificación en cadena (pública)', leftX, urlTitleY);
    doc.setTextColor(...COLORS.sub); doc.setFont(font,'normal'); doc.setFontSize(9);
    const urlWrapped = wrap(receta.urlBlockchain, rightX - leftX + (colW - mini) - 24);
    doc.text(urlWrapped, leftX, urlTitleY + 12);

    // Marco del QR Blockchain
    doc.setDrawColor(...COLORS.brand); doc.setLineWidth(2.6);
    doc.roundedRect(qrX, qrY - 8, rectW, rectH, 8, 8, 'S');
    doc.addImage(qrs.chainQRUrl, 'PNG', qrX + 8, qrY + 2, rectW - 16, rectH - 16, undefined, 'FAST');
    doc.setTextColor(...COLORS.brand); doc.setFont(font,'bold'); doc.setFontSize(8.5);
    doc.text('Blockchain', qrX + rectW/2, qrY + rectH + 10, {align:'center'});

    // no avanzamos y más: queremos que el pie vaya centrado al final
  }

  // ===== Pie (una sola página)
  footer();

  doc.save(`receta_${receta.id}.pdf`);
}


  // ===== Boot & Listeners =====
  let RECETA_ACTUAL = null; let QRS = null;

  async function cargarRecetaDesdeQuery(){
  const p = new URLSearchParams(location.search);
  const id = p.get('id') || 'RECETA-DE-EJEMPLO-001';
  if (p.get('id')) return await smartLoadReceta(id);

  // mock por defecto cuando NO hay ?id=
  return {
    id,
    medico:{ nombre:'Gabriela López Ramírez', genero:'F', cedula:'1234567', especialidad:'Medicina Interna', telefono:'—', direccion:'—' },
    paciente:{ nombre:'Juan Pérez' },
    medicamentos:[
      { nombre:'Amoxicilina 500 mg', dosis:'1 cápsula cada 8 h', duracion:'7 días' },
      { nombre:'Paracetamol 500 mg', dosis:'1 tableta cada 8 h si dolor', duracion:'5 días' }
    ],
    observaciones:'—',
    diagnostico:'—',
    timestamp: Date.now(),
    urlVerificacion: location.origin + '/public/verificar.html?id='+encodeURIComponent(id),
    urlBlockchain: location.origin + '/public/consulta.html?block='+encodeURIComponent(id),
    _origen:'mock'
  };
}

// Evita doble boot/listeners si el script se inyecta dos veces
if (!window.__kodrx_booted__) {
  window.__kodrx_booted__ = true;

  window.addEventListener('DOMContentLoaded', () => {
    // Listeners seguros (solo si existen)
    document.getElementById('btnDescargar')?.addEventListener('click', async () => {
      await waitForLibs();
      if (!RECETA_ACTUAL)  RECETA_ACTUAL = await cargarRecetaDesdeQuery();
      if (!QRS)            QRS = await prepararReceta(RECETA_ACTUAL);
      generarPDF(RECETA_ACTUAL, QRS);
    });

    document.getElementById('btnCargarEjemplo')?.addEventListener('click', async () => {
      const receta = await cargarRecetaDesdeQuery();
      RECETA_ACTUAL = receta;
      QRS = await prepararReceta(receta);
    });

    // Boot una sola vez
    (async () => {
      await waitForLibs();
      const receta = await cargarRecetaDesdeQuery();
      RECETA_ACTUAL = receta;
      QRS = await prepararReceta(receta);
    })();
  });
}

  </script>
</body>
</html>

