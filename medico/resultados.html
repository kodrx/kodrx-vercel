<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resultados de b√∫squeda</title>
  <style>
    body{font-family:system-ui;background:#f9fafb;color:#111;}
    .wrap{max-width:900px;margin:20px auto;padding:16px;}
    .result{padding:12px;margin-bottom:8px;border:1px solid #ddd;border-radius:8px;background:#fff;}
    .result h3{margin:0 0 6px;font-size:16px;color:#0b5bd3;}
    .result p{margin:0;font-size:14px;color:#444;}
 
  </style>
    <link rel="stylesheet" href="/estilos/global.css" />
  <script src="/componentes/header.js" defer></script>
</head>
<body>
<br>
  <br>
   <div class="actions">
  <button class="ghost" id="btnRegresar">Regresar</button>
</div>
  
  <div class="contenedor">
  <h1>Resultados de b√∫squeda</h1>
  <div id="results"></div>
</div>

<style>
  body { font-family: 'Poppins', sans-serif; margin: 0; padding: 1rem; background: #f8f9fc; }
  h1 { color: #123f91; text-align: center; margin-bottom: 1rem; }
  .contenedor { max-width: 800px; margin: auto; }
  .acordeon { background: white; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 0.5rem; overflow: hidden; }
  .acordeon-header { background: #123f91; color: white; padding: 0.75rem 1rem; cursor: pointer; font-weight: 500; display: flex; justify-content: space-between; align-items: center; }
  .acordeon-body { display: none; padding: 1rem; background: #fff; border-top: 1px solid #ddd; }
  .acordeon-body p { margin: 0.3rem 0; }
  .acordeon.open .acordeon-body { display: block; }
  .acordeon.open .acordeon-header::after { content: "‚ñ≤"; }
  .acordeon-header::after { content: "‚ñº"; font-size: 0.8rem; }
  a.boton-ver { background: #2e6fd6; color: white; padding: 0.4rem 0.8rem; border-radius: 4px; text-decoration: none; font-size: 0.85rem; margin-top: 0.5rem; display: inline-block; }
</style>
<main class="contenedor">
  <h1>Resultados de b√∫squeda</h1>
  <p id="metaBusqueda" class="sub"></p>
  <div id="resultados"></div>
</main>

<script type="module">
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, where, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const auth = getAuth();
const db   = getFirestore();

const $res  = document.getElementById('resultados');
const $meta = document.getElementById('metaBusqueda');

const params = new URLSearchParams(location.search);
const term   = (params.get('q') || '').trim();
const termLower = term.toLowerCase();

onAuthStateChanged(auth, async (user)=>{
  if (!user) { location.href = '/login.html'; return; }

  $meta.textContent = term ? `Buscando: ‚Äú${term}‚Äù` : 'Sin t√©rmino de b√∫squeda.';

  try {
    // --- Opci√≥n A: b√∫squeda por prefijo si tienes pacienteNombreLower ---
    // where medicoUid == user.uid (multi-tenant) + rango de prefijo en pacienteNombreLower
    const q = query(
      collection(db,'recetas'),
      where('medicoUid','==', user.uid),
      where('pacienteNombreLower','>=', termLower),
      where('pacienteNombreLower','<=', termLower + '\uf8ff'),
      orderBy('pacienteNombreLower'),
      orderBy('timestamp','desc'),
      limit(100)
    );

    const snap = await getDocs(q);
    if (snap.empty) {
      renderVacio();
    } else {
      renderCascada(snap.docs.map(d=>({ id:d.id, ...d.data() })));
    }

  } catch (e) {
    // Si falta √≠ndice compuesto o a√∫n no guardas pacienteNombreLower, haz fallback:
    console.warn('[Resultados] Fallback por √≠ndice/campo:', e?.code, e?.message);

    // --- Opci√≥n B (fallback): trae por m√©dico y filtra en memoria por nombre ---
    const q2 = query(
      collection(db,'recetas'),
      where('medicoUid','==', user.uid),
      orderBy('timestamp','desc'),
      limit(200)
    );
    const snap2 = await getDocs(q2);
    const lista = snap2.docs
      .map(d=>({ id:d.id, ...d.data() }))
      .filter(r => (r.pacienteNombre || r.paciente?.nombre || '')
                    .toLowerCase()
                    .includes(termLower));

    if (lista.length === 0) renderVacio();
    else renderCascada(lista);
  }
});

function renderVacio(){
  $res.innerHTML = `
    <div class="acordeon">
      <div class="acordeon-header">Sin resultados</div>
      <div class="acordeon-body">
        No encontramos recetas que coincidan con ‚Äú${escapeHtml(term)}‚Äù.
      </div>
    </div>`;
}

function renderCascada(items){
  // Agrupa por fecha (dd/mm/aaaa) como en el historial
  const grupos = new Map();
  for (const r of items){
    const d = toDate(r.timestamp);
    const key = d.toLocaleDateString('es-MX');
    if (!grupos.has(key)) grupos.set(key, []);
    grupos.get(key).push(r);
  }

  let html = '';
  for (const [fecha, arr] of grupos){
    html += `
      <div class="acordeon open">
        <div class="acordeon-header">
          <span>üìÖ ${fecha} (${arr.length})</span>
        </div>
        <div class="acordeon-body">
          ${arr.map(renderItem).join('')}
        </div>
      </div>`;
  }
  $res.innerHTML = html;

  // toggle acorde√≥n
  $res.querySelectorAll('.acordeon-header').forEach(h=>{
    h.addEventListener('click', ()=> h.parentElement.classList.toggle('open'));
  });
}

function renderItem(r){
  const nombre = r.pacienteNombre || r.paciente?.nombre || '‚Äî';
  const dx     = r.diagnostico || '‚Äî';
  const fechaCorta = toDate(r.timestamp).toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit'});
  return `
    <div style="border:1px solid #e0e7f0;border-radius:8px;padding:10px;margin:8px 0;background:#fff">
      <div style="font-weight:600">${escapeHtml(nombre)}</div>
      <div class="sub" style="color:#6b7280;margin:2px 0">Diagn√≥stico: ${escapeHtml(dx)}</div>
      <div class="sub" style="color:#6b7280">Hora: ${fechaCorta}</div>
      <a class="boton ghost" style="margin-top:6px" href="/medico/ver-receta.html?id=${encodeURIComponent(r.id)}">Ver receta</a>
    </div>`;
}

function toDate(ts){
  try{
    if (ts && typeof ts.toDate === 'function') return ts.toDate();
    if (ts && typeof ts.seconds === 'number') return new Date(ts.seconds*1000);
    return new Date(ts);
  }catch{ return new Date(); }
}

function escapeHtml(s=''){
  return String(s).replace(/[&<>"']/g, m=>({ '&':'&nbsp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}
</script>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('btnRegresar');
  if(btn){
    btn.addEventListener('click', ()=>{
      if (history.length > 1) history.back();
      else window.location.href = '/'; // fallback si no hay historial
    });
  }
});
</script>
  
</body>
</html>

