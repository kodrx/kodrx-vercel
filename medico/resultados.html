<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KodRx | Resultados de b√∫squeda</title>

  <!-- Estilos y header globales -->
  <link rel="stylesheet" href="/estilos/global.css" />
  <script src="/componentes/header.js" defer></script>

  <style>
    /* Ajustes m√≠nimos propios de esta p√°gina */
    body { background:#f8f9fc; font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width: 900px; margin: 16px auto; padding: 0 12px; }
    h1 { color:#123f91; text-align:center; margin: 1rem 0 .25rem; }
    .hint { text-align:center; color:#6b7280; margin-bottom: 1rem; }

    .buscador-wrap{ display:flex; justify-content:center; align-items:center; gap:8px; margin: .5rem auto 1rem; max-width: 520px; }
    #buscador{
      flex:1; padding: .65rem 1rem; font-size: 1rem; border-radius: 10px;
      border: 1px solid #d1d5db; outline: none; background:#fff;
    }
    #btnBuscar{ min-width: 110px; }

    .result-list{ max-width: 820px; margin: 0 auto; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding: 12px 14px; margin-bottom:10px; box-shadow:0 1px 3px rgba(0,0,0,.04); }
    .card h3{ margin:.2rem 0 .4rem; font-size:1.05rem; color:#111827; }
    .meta{ font-size:.85rem; color:#6b7280; display:flex; gap:10px; flex-wrap: wrap; }
    .diag{ margin-top:.35rem; color:#374151; }
    .actions{ margin-top:.6rem; display:flex; gap:8px; flex-wrap:wrap; }

    /* Botones (usa tus utilidades globales .btn) */
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.4rem; padding:.55rem .9rem; border-radius:10px; font-weight:700; border:1px solid transparent; cursor:pointer; text-decoration:none; }
    .btn.primary{ background:#0b5bd3; color:#fff; box-shadow:0 6px 16px rgba(11,91,211,.18); }
    .btn.primary:hover{ background:#0a51be; }
    .btn.ghost{ background:#eef2ff; color:#0b1b2b; border-color:#dbe3ff; }
    .btn.ghost:hover{ background:#e6ebff; }

    .empty{ text-align:center; color:#6b7280; padding: 24px 12px; }
    .pill{ display:inline-block; padding:.18rem .5rem; border-radius:999px; background:#eef2ff; color:#123f91; font-size:.75rem; font-weight:700; }
    .warn{ color:#b45309; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Resultados de b√∫squeda</h1>
    <div class="hint" id="queryHint">Buscando‚Ä¶</div>

    <!-- Buscador local para refinar (no cambia la URL) -->
    <div class="buscador-wrap">
      <input id="buscador" type="text" placeholder="Buscar paciente‚Ä¶" />
      <button id="btnBuscar" class="btn primary">Buscar</button>
      <button id="btnVolver" class="btn ghost">Regresar</button>
    </div>

    <div id="alertaAmbito" class="hint" style="display:none">
      <span class="pill">Aviso</span> Mostrando resultados <b>de todos los m√©dicos</b> (no se detect√≥ sesi√≥n/UID).
    </div>

    <div id="resultados" class="result-list"></div>
    <div id="vacio" class="empty" style="display:none">No se encontraron recetas con ese nombre.</div>
  </div>

  <!-- Firebase (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore, collection, query, where, getDocs, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1) Configura e inicializa Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBIjaOe4HcGNDk0xrqen8etBv0RyjyOJHw",
      authDomain: "kodrx-105b9.firebaseapp.com",
      projectId: "kodrx-105b9"
    };
    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const auth = getAuth(app);

    // 2) Utilidades de la p√°gina
    const $ = (sel) => document.querySelector(sel);
    const resultadosEl = $('#resultados');
    const vacioEl      = $('#vacio');
    const hintEl       = $('#queryHint');
    const alertaEl     = $('#alertaAmbito');
    const inputEl      = $('#buscador');

    function fmtFecha(ts){
      try{
        let d = ts;
        if (d?.toDate) d = d.toDate();
        else if (typeof d?.seconds === 'number') d = new Date(d.seconds*1000 + Math.floor((d.nanoseconds||0)/1e6));
        else if (!(d instanceof Date)) d = new Date(d);
        return d.toLocaleString('es-MX',{year:'numeric',month:'long',day:'numeric', hour:'2-digit', minute:'2-digit'});
      }catch{ return '‚Äî'; }
    }

    function cardReceta(r){
      const diag = r.diagnostico || '‚Äî';
      const fecha = fmtFecha(r.timestamp || r.fecha);
      const nombre = r.nombrePaciente || r.pacienteNombre || r.paciente?.nombre || 'Paciente';
      const id = r.id;

      const aVer = document.createElement('a');
      aVer.className = 'btn primary';
      aVer.textContent = 'Ver receta';
      aVer.href = `/medico/ver-receta.html?id=${encodeURIComponent(id)}`;

      
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h3>${nombre}</h3>
        <div class="meta">
          <span>${fecha}</span>
          <span>Diagn√≥stico: <b>${diag}</b></span>
        </div>
        <div class="diag"></div>
      `;
      const diagDiv = card.querySelector('.diag');
      diagDiv.textContent = (r.observaciones && r.observaciones.length > 1)
        ? r.observaciones.slice(0, 140) + (r.observaciones.length > 140 ? '‚Ä¶' : '')
        : '‚Äî';

      const actions = document.createElement('div');
      actions.className = 'actions';
      actions.append(aVer, aAbrir);

      card.append(actions);
      return card;
    }

    function renderLista(arr){
      resultadosEl.innerHTML = '';
      if (!arr || arr.length === 0){
        vacioEl.style.display = 'block';
        return;
      }
      vacioEl.style.display = 'none';
      arr.forEach(r => resultadosEl.appendChild(cardReceta(r)));
    }

    function getQP(){
      const p = new URLSearchParams(location.search);
      return (p.get('q') || '').trim();
    }

    // 3) L√≥gica de b√∫squeda
      // üëâ normaliza para b√∫squeda: min√∫sculas y sin acentos
  const norm = (s) =>
    (s ?? '')
      .toString()
      .toLowerCase()
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu, '');

  // ‚¨áÔ∏è Reemplaza tu funci√≥n buscarRecetas por esta
  async function buscarRecetas(nombre, medicoUid){
    const col = collection(db, 'recetas');
    const needle = norm(nombre);

    // 3.1) intenta restringir por m√©dico
    let docs = [];
    if (medicoUid){
      try{
        const q1 = query(col, where('medicoUid','==', medicoUid), limit(300));
        const snap1 = await getDocs(q1);
        docs = snap1.docs.map(d => ({ id: d.id, ...d.data() }));

        // ‚ö†Ô∏è Fallback: si no hay docs (colecci√≥n legacy sin medicoUid), traemos un lote global
        if (docs.length === 0){
          console.info('[Resultados] Sin datos con medicoUid, haciendo fallback global‚Ä¶');
          const q2 = query(col, limit(500));
          const snap2 = await getDocs(q2);
          docs = snap2.docs.map(d => ({ id: d.id, ...d.data() }));
        }
      }catch(e){
        console.warn('[Resultados] where(medicoUid) fall√≥, fallback global:', e);
        const q2 = query(col, limit(500));
        const snap2 = await getDocs(q2);
        docs = snap2.docs.map(d => ({ id: d.id, ...d.data() }));
      }
    } else {
      // 3.2) sin UID: global directo (con aviso arriba)
      const q = query(col, limit(500));
      const snap = await getDocs(q);
      docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    // 3.3) filtro por nombre en cliente (toma el campo que venga)
    const filtrados = docs.filter(d => {
      const nombreDoc =
        d.nombrePaciente || d.pacienteNombre || d.paciente?.nombre || '';
      return needle ? norm(nombreDoc).includes(needle) : true;
    });

    // 3.4) ordena por fecha desc
    filtrados.sort((a,b)=>{
      const ta = a.timestamp?.seconds ? a.timestamp.seconds*1000 :
                 new Date(a.timestamp || a.fecha || 0).getTime();
      const tb = b.timestamp?.seconds ? b.timestamp.seconds*1000 :
                 new Date(b.timestamp || b.fecha || 0).getTime();
      return (tb||0) - (ta||0);
    });

    return filtrados;
  }

    // 4) Boot
    (async function init(){
      // Muestra la query en la vista
      const q = getQP();
      inputEl.value = q;
      hintEl.textContent = q ? `Resultados para ‚Äú${q}‚Äù` : 'Mostrando resultados';

      // Detecta UID del m√©dico
      let medicoUid = null;
      const localUid = localStorage.getItem('kodrx_medico_uid') || localStorage.getItem('kodrx_doctor_id');
      if (localUid) medicoUid = localUid;

      // Intenta usar auth si est√° logueado
      onAuthStateChanged(auth, async (user)=>{
        try{
          if (user?.uid) medicoUid = user.uid;
          alertaEl.style.display = medicoUid ? 'none' : 'block';
          const data = await buscarRecetas(q, medicoUid);
          renderLista(data);
        }catch(e){
          console.error(e);
          resultadosEl.innerHTML = '';
          vacioEl.style.display = 'block';
          vacioEl.textContent = 'Ocurri√≥ un error al buscar.';
        }
      });

      // Si onAuthStateChanged tarda, hacemos una primera pasada ‚Äúoptimista‚Äù
      setTimeout(async ()=>{
        if (resultadosEl.children.length === 0){ // a√∫n no renderiza
          alertaEl.style.display = medicoUid ? 'none' : 'block';
          const data = await buscarRecetas(q, medicoUid);
          renderLista(data);
        }
      }, 800);
    })();

    // 5) Interacciones
    $('#btnBuscar').addEventListener('click', ()=>{
      const val = inputEl.value.trim();
      if (!val) return;
      // Cambia la URL para poder compartir el resultado
      const url = new URL(location.href);
      url.searchParams.set('q', val);
      location.href = url.toString();
    });
    inputEl.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') $('#btnBuscar').click();
    });
    $('#btnVolver').addEventListener('click', ()=>{
      if (history.length > 1) history.back();
      else location.href = '/medico/historial.html';
    });
  </script>
</body>
</html>
