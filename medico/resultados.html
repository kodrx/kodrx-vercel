<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KodRx | Resultados de búsqueda</title>

  <link rel="stylesheet" href="/estilos/global.css" />
  <script src="/componentes/header.js" defer></script>

  <style>
    body { background:#f8f9fc; font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width: 900px; margin: 16px auto; padding: 0 12px; }
    h1 { color:#123f91; text-align:center; margin: 1rem 0 .25rem; }
    .hint { text-align:center; color:#6b7280; margin-bottom: 1rem; }

    .buscador-wrap{ display:flex; justify-content:center; align-items:center; gap:8px; margin:.5rem auto 1rem; max-width:520px; }
    #buscador{
      flex:1; padding:.65rem 1rem; font-size:1rem; border-radius:10px;
      border:1px solid #d1d5db; outline:none; background:#fff;
    }
    #btnBuscar{ min-width:110px; }
    .result-list{ max-width:820px; margin:0 auto; }

    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.4rem; padding:.55rem .9rem; border-radius:10px; font-weight:700; border:1px solid transparent; cursor:pointer; text-decoration:none; }
    .btn.primary{ background:#0b5bd3; color:#fff; box-shadow:0 6px 16px rgba(11,91,211,.18); }
    .btn.primary:hover{ background:#0a51be; }
    .btn.ghost{ background:#eef2ff; color:#0b1b2b; border-color:#dbe3ff; }
    .btn.ghost:hover{ background:#e6ebff; }
    .btn.flat{ background:#fff; color:#0b1b2b; border-color:#e5e7eb; }

    /* ===== Acordeón ===== */
    .acordeon { background:#fff; border:1px solid #ccc; border-radius:6px; margin-bottom:.75rem; overflow:hidden; transition:all .2s ease; }
    .acordeon-header{
      background:#123f91; color:#fff; padding:.75rem 1rem; cursor:pointer; font-weight:500;
      display:flex; justify-content:space-between; align-items:center; user-select:none;
    }
    .acordeon-header::after{ content:"▼"; font-size:.8rem; transition:transform .2s ease; }
    .acordeon.open .acordeon-header::after{ content:"▲"; }
    .acordeon-body{ display:none; padding:1rem; background:#fff; border-top:1px solid #ddd; }
    .acordeon-body p{ margin:.3rem 0; color:#374151; font-size:.95rem; line-height:1.35; }
    .acordeon.open .acordeon-body{ display:block; }
    .acordeon-body .acciones{ margin-top:.75rem; display:flex; gap:.5rem; }

    .empty{ text-align:center; color:#6b7280; padding:24px 12px; }
    .pill{ display:inline-block; padding:.18rem .5rem; border-radius:999px; background:#eef2ff; color:#123f91; font-size:.75rem; font-weight:700; }

    mark{ background:#fff176; padding:0 .15em; border-radius:3px; }
    .footer-actions{ display:flex; justify-content:center; margin:12px 0 24px; }
    #btnLoadMore[hidden]{ display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Resultados de búsqueda</h1>
    <div class="hint" id="queryHint">Buscando…</div>

    <div class="buscador-wrap">
      <input id="buscador" type="text" placeholder="Buscar paciente…" />
      <button id="btnBuscar" class="btn primary">Buscar</button>
      <button id="btnVolver" class="btn ghost">Regresar</button>
    </div>

    <div id="alertaAmbito" class="hint" style="display:none"></div>

    <div id="resultados" class="result-list"></div>
    <div id="vacio" class="empty" style="display:none">No se encontraron recetas con ese nombre.</div>

    <div class="footer-actions">
      <button id="btnLoadMore" class="btn flat" hidden>Cargar más</button>
    </div>
  </div>

  <!-- Firebase (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, query, where, getDocs, doc, getDoc,
      orderBy, startAfter, limit
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyBIjaOe4HcGNDk0xrqen8etBv0RyjyOJHw",
      authDomain: "kodrx-105b9.firebaseapp.com",
      projectId: "kodrx-105b9"
    };
    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const auth = getAuth(app);

    // --- DOM ---
    const $ = (s) => document.querySelector(s);
    const resultadosEl = $('#resultados');
    const vacioEl      = $('#vacio');
    const hintEl       = $('#queryHint');
    const alertaEl     = $('#alertaAmbito');
    const inputEl      = $('#buscador');
    const btnBuscarEl  = $('#btnBuscar');
    const btnVolverEl  = $('#btnVolver');
    const btnLoadMore  = $('#btnLoadMore');

    // --- Utils ---
    const getQ = () => (new URLSearchParams(location.search).get('q') || '').trim();

    function fmtFecha(ts){
      try{
        let d = ts;
        if (d?.toDate) d = d.toDate();
        else if (typeof d?.seconds === 'number') d = new Date(d.seconds*1000 + Math.floor((d.nanoseconds||0)/1e6));
        else if (!(d instanceof Date)) d = new Date(d);
        return d.toLocaleString('es-MX',{year:'numeric',month:'long',day:'numeric', hour:'2-digit', minute:'2-digit'});
      }catch{ return '—'; }
    }
    function millisFrom(ts){
      if (!ts) return 0;
      if (ts?.toMillis) return ts.toMillis();
      if (typeof ts?.seconds === 'number') return ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6);
      const d = ts instanceof Date ? ts : new Date(ts);
      return isNaN(+d) ? 0 : +d;
    }

    // Sin acentos y lowercase
    const clean = (s) => (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();

    const nombrePacienteDe = (r) => (r.nombrePaciente || r.pacienteNombre || r.paciente?.nombre || '').trim();

    // --- UI: acordeón ---
    function cardReceta(r){
      const diag   = r.diagnostico || '—';
      const fecha  = fmtFecha(r.timestamp || r.fecha);
      const nombre = nombrePacienteDe(r) || 'Paciente';
      const id     = r.id;

      const cont   = document.createElement('div');
      cont.className = 'acordeon';

      const header = document.createElement('div');
      header.className = 'acordeon-header';
      header.innerHTML = `<strong>${nombre}</strong><span style="font-size:.9rem;opacity:.9">${fecha}</span>`;

      const body = document.createElement('div');
      body.className = 'acordeon-body';
      body.innerHTML = `
        <p><strong>Diagnóstico:</strong> ${diag}</p>
        <div class="acciones">
          <a class="btn primary" href="/medico/ver-receta.html?id=${encodeURIComponent(id)}">Ver receta</a>
          <a class="btn ghost" href="/medico/ver-receta.html?id=${encodeURIComponent(id)}" target="_blank" rel="noopener">Abrir en nueva pestaña</a>
        </div>
      `;

      header.addEventListener('click', ()=> cont.classList.toggle('open'));
      cont.appendChild(header);
      cont.appendChild(body);
      return cont;
    }

    // Estado de búsqueda/paginación
    let cedulaMedico   = '';
    let pageSize       = 20;
    let lastDoc        = null;   // último doc de la página para startAfter
    let allFetched     = [];     // caché de todo lo traído (para evitar duplicados)
    let reachedEnd     = false;  // sin más páginas
    let loading        = false;

    // Render + realce + conteo
    function renderLista(arr){
      resultadosEl.innerHTML = '';
      applyRenderAppend(arr, true);
    }

    function applyRenderAppend(arr, replace=false){
      if (replace) resultadosEl.innerHTML = '';

      const term    = getQ();
      const needle  = clean(term);
      const count   = arr.length;

      // Header hint con conteo
      hintEl.textContent = term ? `Resultados (${count}) para: “${term}”` : `Resultados (${count})`;

      if (!count){
        vacioEl.style.display = 'block';
        btnLoadMore.hidden = true;
        return;
      }
      vacioEl.style.display = 'none';

      const hi = (txt) => {
        if (!needle) return txt;
        // resaltado case/acentos-insensible
        const plain = clean(txt);
        const idx = plain.indexOf(needle);
        if (idx === -1) return txt;
        // reconstruimos un <mark> sin romper el original
        const start = idx;
        const end   = idx + needle.length;
        // mapeo aproximado: buscamos el substring original alineado
        // (simplemente repetimos sobre el texto original)
        let i = 0, j = 0, out = '';
        while (i < txt.length && j < plain.length){
          const ch       = txt[i];
          const chPlain  = clean(ch);
          out += ch;
          if (chPlain) j += chPlain.length;
          i++;
        }
        // Fallback simple: usamos RegExp sin acentos (menos preciso),
        // pero práctico para nombres cortos
        return txt.replace(new RegExp(`(${term.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&')})`, 'ig'), '<mark>$1</mark>');
      };

      arr.forEach(r => {
        const card   = cardReceta(r);
        const title  = card.querySelector('.acordeon-header strong');
        if (title) title.innerHTML = hi(title.textContent);
        resultadosEl.appendChild(card);
      });

      // Mostrar/ocultar botón "Cargar más"
      btnLoadMore.hidden = reachedEnd;
    }

    // Lee medicos/{uid} y saca la cédula
    async function getPerfilMedico(uid){
      try{
        const ref  = doc(db, 'medicos', uid);
        const snap = await getDoc(ref);
        if (snap.exists()){
          const p = snap.data();
          return { cedula: (p.cedula || '').trim(), nombre:(p.nombre || '').trim() };
        }
      }catch(e){
        console.warn('[Resultados] No se pudo leer medicos/{uid}:', e);
      }
      return { cedula:'', nombre:'' };
    }

    // Query paginado por cédula + orderBy timestamp desc
    async function fetchPageByCedula(cedula){
      if (!cedula || reachedEnd || loading) return [];
      loading = true;
      try{
        const col  = collection(db, 'recetas');
        let qRef   = query(col, where('medicoCedula','==', cedula), orderBy('timestamp','desc'), limit(pageSize));
        if (lastDoc) qRef = query(col, where('medicoCedula','==', cedula), orderBy('timestamp','desc'), startAfter(lastDoc), limit(pageSize));

        const snap = await getDocs(qRef);
        if (snap.empty){
          reachedEnd = true;
          return [];
        }

        lastDoc = snap.docs[snap.docs.length - 1];
        const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        // Evitar duplicados si el usuario regresa/avanza
        const newOnes = rows.filter(r => !allFetched.find(x => x.id === r.id));
        allFetched = allFetched.concat(newOnes);
        return newOnes;
      }catch(err){
        console.warn('[Resultados] Es posible que falte un índice compuesto (medicoCedula == / timestamp desc).', err);
        // Fallback NO paginado (último recurso): trae todo por cédula sin orderBy
        try{
          const snapAll = await getDocs(query(collection(db,'recetas'), where('medicoCedula','==', cedula)));
          reachedEnd = true;
          lastDoc = null;
          const rowsAll = snapAll.docs.map(d => ({ id: d.id, ...d.data() }));
          // Ordenamos en cliente
          rowsAll.sort((a,b)=> millisFrom(b.timestamp || b.fecha) - millisFrom(a.timestamp || a.fecha));
          // Ajustamos caché
          allFetched = rowsAll;
          return rowsAll;
        }catch(err2){
          console.error('[Resultados] Fallback total también falló:', err2);
          return [];
        }
      }finally{
        loading = false;
      }
    }

    // Carga inicial + aplicar filtro local (sin acentos)
    async function initialLoadAndRender(cedula, term){
      allFetched = [];
      lastDoc    = null;
      reachedEnd = false;

      const first = await fetchPageByCedula(cedula);
      const needle = clean(term);
      const filtered = needle ? first.filter(r => clean(nombrePacienteDe(r)).includes(needle)) : first;

      renderLista(filtered);
    }

    // Cargar más (aplica filtro local y agrega)
    async function loadMoreAndAppend(cedula, term){
      const next = await fetchPageByCedula(cedula);
      const needle = clean(term);
      const filtered = needle ? next.filter(r => clean(nombrePacienteDe(r)).includes(needle)) : next;

      // Mezcla con lo ya mostrado
      const current = Array.from(resultadosEl.children).map(card => card.__rid).filter(Boolean);
      // Renderizar append
      applyRenderAppend(filtered, false);
    }

    // --- Boot ---
    const term = getQ();
    if (inputEl) inputEl.value = term;
    if (hintEl)  hintEl.textContent = term ? `Resultados para: “${term}”` : 'Resultados';

    onAuthStateChanged(auth, async (user) => {
      if (!user){
        if (alertaEl){
          alertaEl.style.display = 'block';
          alertaEl.innerHTML = '<span class="pill">Aviso</span> Inicia sesión para ver tus resultados.';
        }
        renderLista([]);
        return;
      }

      try{
        const perfil = await getPerfilMedico(user.uid);
        cedulaMedico = perfil.cedula;

        if (!cedulaMedico){
          if (alertaEl){
            alertaEl.style.display = 'block';
            alertaEl.innerHTML = '<span class="pill">Aviso</span> No se encontró cédula en tu perfil.';
          }
          renderLista([]);
          return;
        }

        if (alertaEl){
          alertaEl.style.display = 'block';
          alertaEl.innerHTML = '<span class="pill">OK</span> Mostrando solo tus recetas (filtro por cédula).';
        }

        await initialLoadAndRender(cedulaMedico, term || '');
        btnLoadMore.hidden = reachedEnd;
      }catch(e){
        console.warn('[Resultados] Error general:', e);
        renderLista([]);
      }
    });

    // --- UX: navegar con la query, volver, cargar más ---
    btnBuscarEl?.addEventListener('click', ()=>{
      const q = inputEl.value.trim();
      location.href = `/resultados.html?q=${encodeURIComponent(q)}`;
    });
    inputEl?.addEventListener('keydown', (ev)=>{
      if (ev.key === 'Enter'){
        const q = inputEl.value.trim();
        location.href = `/resultados.html?q=${encodeURIComponent(q)}`;
      }
    });
    btnVolverEl?.addEventListener('click', ()=>{
      history.length > 1 ? history.back() : (location.href = '/medico/historial.html');
    });
    btnLoadMore?.addEventListener('click', async ()=>{
      await loadMoreAndAppend(cedulaMedico, getQ());
      btnLoadMore.hidden = reachedEnd;
    });
  </script>
</body>
</html>
