
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Verificador de receta</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>Verificador de receta</h1>
  <input type="text" id="idReceta" placeholder="Ingresa ID o escanea QR" />
  <button onclick="cargarReceta()">Buscar</button>
  <div id="resultado"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBIjaOe4HcGNDk0xrqen8etBv0RyjyOJHw",
      authDomain: "kodrx-105b9.firebaseapp.com",
      projectId: "kodrx-105b9",
      storageBucket: "kodrx-105b9.appspot.com",
      messagingSenderId: "239675098141",
      appId: "1:239675098141:web:152ae3741b0ac79db7f2f4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let datosFarmacia = null;

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const uid = user.uid;
        const docRef = doc(db, "farmacias", uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          datosFarmacia = docSnap.data();
        } else {
          console.error("No se encontraron datos de la farmacia");
        }
      }
    });

    window.cargarReceta = async function () {
      const id = document.getElementById("idReceta").value;
      const docRef = doc(db, "recetas", id);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const receta = docSnap.data();
        const resultado = document.getElementById("resultado");

        resultado.innerHTML = `
          <p><strong>Paciente:</strong> ${receta.nombrePaciente}</p>
          <p><strong>Edad:</strong> ${receta.edad}</p>
          <p><strong>Observaciones:</strong> ${receta.observaciones}</p>
          <p><strong>Médico:</strong> ${receta.medicoNombre || "Desconocido"}</p>
          <p><strong>Estado:</strong> ${receta.estado || "No surtida"}</p>
          <h3>Medicamentos:</h3>
          <ul id="listaMedicamentos"></ul>
          <button onclick="surtirReceta('${id}')">Surtir</button>
        `;

        const lista = document.getElementById("listaMedicamentos");
        receta.medicamentos.forEach((med, index) => {
          const li = document.createElement("li");
          li.innerHTML = `
            <label>
              <input type="checkbox" id="med-${index}" />
              ${med.nombre} - ${med.dosis} - ${med.duracion}
            </label>
          `;
          lista.appendChild(li);
        });
      }
    };

    window.surtirReceta = async function (id) {
      const recetaRef = doc(db, "recetas", id);
      const recetaSnap = await getDoc(recetaRef);
      const receta = recetaSnap.data();

      const medicamentos = receta.medicamentos;
      const seleccionados = [];

      medicamentos.forEach((med, index) => {
        const check = document.getElementById(`med-${index}`);
        if (check && check.checked) {
          seleccionados.push({
            ...med,
            fecha: new Date().toISOString(),
            surtidoPor: datosFarmacia?.nombreFarmacia || "Farmacia no registrada",
            telefono: datosFarmacia?.telefono || "Teléfono no registrado"
          });
        }
      });

      const estado = seleccionados.length === medicamentos.length ? "total" : "parcial";

      await updateDoc(recetaRef, {
        estado: estado,
        surtidoParcial: seleccionados
      });

      alert(`Receta surtida ${estado === "total" ? "totalmente" : "parcialmente"}.`);
    };
  </script>
</body>
</html>
