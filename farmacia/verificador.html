
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verificador de Receta - KodRx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/estilos/global.css" />
  <script src="/componentes/header.js" defer></script>

</head>


<body>
  <div class="kx-wrap">
  <h2 class="kx-title">Verificador de Recetas</h2>

  <!-- scanUI -->
  <section id="scanUI" hidden>
    <div class="kx-card">
      <video id="cam" class="kx-video" autoplay muted playsinline style="width:100%;max-width:420px"></video>
      <div style="margin:10px 0; display:flex; gap:8px; flex-wrap:wrap">
        <button id="btnScan" class="kx-btn kx-btn--brand">Iniciar c√°mara</button>
        <input id="manual" class="kx-input" placeholder="Pega URL o ID" style="flex:1; min-width:200px">
        <button id="btnAbrir" class="kx-btn kx-btn--ghost">Abrir</button>
      </div>
      <input id="fileQR" type="file" accept="image/*" capture="environment" style="display:none">
      <button id="btnFoto" class="kx-btn kx-btn--ghost">Escanear foto</button>
    </div>
  </section>

  <!-- detalleUI -->
  <section id="detalleUI" hidden>
    <div id="detalleReceta" class="kx-card"></div>
  </section>
</div>

</body>
<!-- jsQR local; ponle id para que el loader pueda ‚Äúesperarlo‚Äù -->
<script defer src="/vendor/jsqr.min.js" id="jsqr-lib"></script>


<script>
document.addEventListener('DOMContentLoaded', () => {
  'use strict';

  // ---------- UI b√°sico ----------
  const $ = (s) => document.querySelector(s);
  const video   = $('#cam');
  const btnScan = $('#btnScan');
  const inputMan= $('#manual');
  const btnAbrir= $('#btnAbrir');
  const fileInp = $('#fileQR');
  const btnFoto = $('#btnFoto');
  const cnvOvl  = $('#ovl');

  // Muestra #scanUI si NO hay ?id=; si hay id, muestra #detalleUI (tu l√≥gica luego)
  const idFromURL = new URLSearchParams(location.search).get('id');
  if (idFromURL) {
    $('#detalleUI')?.removeAttribute('hidden');
    $('#scanUI')?.setAttribute('hidden','');
  } else {
    $('#scanUI')?.removeAttribute('hidden');
    $('#detalleUI')?.setAttribute('hidden','');
  }

  if (!video || !btnScan || !fileInp) {
    console.warn('[SCAN] faltan elementos requeridos (#cam, #btnScan, #fileQR)');
    return;
  }

  // ---------- estado ----------
  let _raf = 0, _stream = null, _running = false;

  // ---------- helpers ----------
  const extractId = (txt) => {
    try { const u = new URL(txt); return u.searchParams.get('id') || null; } catch {}
    return /^[A-Za-z0-9_-]{8,}$/.test(String(txt||'')) ? txt : null;
  };

function go(id){
  if (!id){ alert('No se pudo leer el c√≥digo'); return; }
  location.href = `/farmacia/verificador.html?id=${encodeURIComponent(id)}`; // üëà cambia a farmacia
}

  const stopScan = () => {
    _running = false;
    try { cancelAnimationFrame(_raf); } catch {}
    _raf = 0;
    try { if (_stream) { _stream.getTracks().forEach(t=>t.stop()); _stream = null; } } catch {}
  };

  async function ensureJsQR(maxWaitMs = 4000){
    if (window.jsQR) return true;

    const tag = document.getElementById('jsqr-lib');
    if (tag) {
      let waited = 0;
      while (!window.jsQR && waited < maxWaitMs) {
        await new Promise(r=>setTimeout(r,150));
        waited += 150;
      }
      if (window.jsQR) return true;
    }
    // inyecci√≥n defensiva (CSP: mismo host)
    await new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = '/vendor/jsqr.min.js?v=' + Date.now();
      s.onload = res; s.onerror = rej;
      document.head.appendChild(s);
    });
    return !!window.jsQR;
  }

  // ---------- overlay (marco verde de debug) ----------
  function drawOverlayBox(loc){
    const w = video.videoWidth|0, h = video.videoHeight|0;
    if (!w || !h) return;
    cnvOvl.width  = w; cnvOvl.height = h;
    const ctx = cnvOvl.getContext('2d');
    ctx.clearRect(0,0,w,h);
    if (!loc) return;

    const p = loc; // jsQR location
    ctx.strokeStyle = 'lime';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(p.topLeftCorner.x,     p.topLeftCorner.y);
    ctx.lineTo(p.topRightCorner.x,    p.topRightCorner.y);
    ctx.lineTo(p.bottomRightCorner.x, p.bottomRightCorner.y);
    ctx.lineTo(p.bottomLeftCorner.x,  p.bottomLeftCorner.y);
    ctx.closePath();
    ctx.stroke();
  }

  // ---------- loop con jsQR ----------
  function runJsQRLoop(){
    const MAX_W = 640;
    const cnv = document.createElement('canvas');
    const ctx = cnv.getContext('2d', { willReadFrequently: true });

    const step = () => {
      if (!_running) return;
      try {
        const vw = video.videoWidth|0, vh = video.videoHeight|0;
        if (vw && vh) {
          const scale = Math.min(1, MAX_W / vw);
          const w = Math.max(1, (vw * scale) | 0);
          const h = Math.max(1, (vh * scale) | 0);
          if (cnv.width !== w || cnv.height !== h) { cnv.width = w; cnv.height = h; }

          ctx.drawImage(video, 0, 0, w, h);
          const img = ctx.getImageData(0, 0, w, h);

          // intenta ambos (mejor para impresos con brillo)
          const res =
            window.jsQR(img.data, w, h, { inversionAttempts:'attemptBoth' }) ||
            window.jsQR(img.data, w, h, { inversionAttempts:'dontInvert' });

          if (res && res.data) {
            drawOverlayBox(res.location);
            stopScan();
            const id = extractId(res.data) || res.data;
            return go(id);
          } else {
            drawOverlayBox(null);
          }
        }
      } catch(e) { /* siguiente frame */ }
      _raf = requestAnimationFrame(step);
    };

    _running = true;
    _raf = requestAnimationFrame(step);
  }

  // ---------- BarcodeDetector directo sobre <video> ----------
  async function runBarcodeDetector(){
    const det = new window.BarcodeDetector({ formats: ['qr_code'] });

    const step = async () => {
      if (!_running) return;
      try{
        if (video.readyState >= 2){
          // detecta sobre el <video> (iOS-friendly)
          const codes = await det.detect(video);
          if (codes && codes.length){
            stopScan();
            const raw = codes[0].rawValue || '';
            const id  = extractId(raw) || raw;
            return go(id);
          }
        }
      }catch(e){ /* caeremos a jsQR fuera */ }
      _raf = requestAnimationFrame(step);
    };

    _running = true;
    _raf = requestAnimationFrame(step);
  }

  // ---------- arrancar c√°mara ----------
  async function startScan(){
    stopScan();
    try{
      console.log('[SCAN] solicitando c√°mara‚Ä¶');
      const c1 = { video: { facingMode: { exact:'environment' } }, audio:false };
      const c2 = { video: { facingMode: { ideal:'environment' } }, audio:false };
      try { _stream = await navigator.mediaDevices.getUserMedia(c1); }
      catch { _stream = await navigator.mediaDevices.getUserMedia(c2); }

      video.srcObject = _stream;
      video.setAttribute('playsinline','true');
      await video.play().catch(()=>{});
      if (video.readyState < 2 || video.videoWidth === 0){
        await new Promise(res=>{
          const onPlaying = ()=>{ video.removeEventListener('playing', onPlaying); res(); };
          video.addEventListener('playing', onPlaying, { once:true });
        });
      }
      // iOS nudge
      document.addEventListener('touchstart', () => { if (video.paused) video.play().catch(()=>{}); }, { once:true });

      // Primero BD si existe; si no, jsQR asegurado
      if ('BarcodeDetector' in window) {
        console.log('[SCAN] usando BarcodeDetector');
        runBarcodeDetector();
      } else {
        const ok = await ensureJsQR(4000);
        if (!ok) { alert('No se pudo cargar el lector offline (jsQR).'); return; }
        console.log('[SCAN] usando jsQR');
        runJsQRLoop();
      }
    }catch(err){
      console.warn('[SCAN] getUserMedia fail:', err);
      const msg = String(err?.name||err?.message||'');
      if (msg.includes('NotAllowed') || msg.includes('Permission')) {
        alert('No hay permiso de c√°mara.\nAbre el candado ‚Üí C√°mara ‚Üí Permitir. En iPhone: Ajustes > Safari > C√°mara.');
      } else if (msg.includes('NotFound')) {
        alert('No se encontr√≥ c√°mara en este dispositivo.');
      } else {
        alert('No se pudo abrir la c√°mara. Usa ‚ÄúEscanear foto‚Äù.');
      }
      try { fileInp.click(); } catch {}
    }
  }

  // ---------- foto (fallback) ----------
  async function onPickImage(e){
    const file = e.target.files?.[0];
    if (!file) return;
    const ok = await ensureJsQR(4000);
    if (!ok) { alert('No se pudo cargar jsQR.'); return; }

    const img = new Image();
    img.onload = () => {
      const c = document.createElement('canvas');
      c.width = img.naturalWidth; c.height = img.naturalHeight;
      const cx = c.getContext('2d', { willReadFrequently: true });
      cx.drawImage(img, 0, 0);
      const data = cx.getImageData(0, 0, c.width, c.height);
      const res =
        window.jsQR(data.data, c.width, c.height, { inversionAttempts:'attemptBoth' }) ||
        window.jsQR(data.data, c.width, c.height, { inversionAttempts:'dontInvert' });
      if (res && res.data) {
        stopScan();
        const id = extractId(res.data) || res.data;
        go(id);
      } else {
        alert('No se pudo leer el QR de la imagen. Intenta otra foto con mejor luz/enfoque.');
      }
      URL.revokeObjectURL(img.src);
      fileInp.value = '';
    };
    img.onerror = () => { alert('No se pudo abrir la imagen.'); fileInp.value=''; };
    img.src = URL.createObjectURL(file);
  }

  // ---------- abrir manual ----------
  const abrirManual = () => {
    const raw = (inputMan?.value || '').trim();
    const id  = extractId(raw) || raw;
    go(id);
  };

  // ---------- bindings ----------
  btnScan.addEventListener('click', startScan, { capture:true });
  btnFoto.addEventListener('click', () => fileInp.click(), { capture:true });
  fileInp.addEventListener('change', onPickImage, { capture:true });
  btnAbrir && btnAbrir.addEventListener('click', (e)=>{ e.preventDefault(); abrirManual(); }, { capture:true });
  inputMan && inputMan.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') abrirManual(); });

  // Limpieza
  window.addEventListener('pagehide', stopScan);
  window.addEventListener('beforeunload', stopScan);

  // Log √∫til para saber si jsQR ya ven√≠a por el <script defer>
  setTimeout(()=>{ console.log('[SCAN] jsQR presente?', !!window.jsQR); }, 800);
});
</script>

<script>
;(() => {
  'use strict';

  const $ = s => document.querySelector(s);
  const scanUI    = $('#scanUI');
  const detalleUI = $('#detalleUI');
  const host      = $('#detalleReceta');

  // Detectar si hay ?id=
  const ID = new URLSearchParams(location.search).get('id');

  if (!ID) {
    // sin id ‚Üí mostrar lector
    scanUI.hidden = false;
    detalleUI.hidden = true;
    return;
  }

  // con id ‚Üí mostrar detalle
  scanUI.hidden = true;
  detalleUI.hidden = false;
  host.textContent = 'Cargando‚Ä¶';

  // Utils
  const fmtFecha = (ts) => {
    try{
      if (ts && typeof ts.toDate==='function') ts = ts.toDate();
      else if (ts && typeof ts.seconds==='number') ts = new Date(ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6));
      else if (!(ts instanceof Date)) ts = new Date(ts);
      return ts.toLocaleString('es-MX', { year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit' });
    }catch{ return '‚Äî'; }
  };
  const html = (strings, ...vals) => strings.reduce((a,s,i)=>a+s+(vals[i]??''),'');

  // Carga perezosa de Firebase
  async function core(){
    const core = await import('/firebase-init.js');
    const fs   = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
    const au   = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js');
    return { ...core, fs, au };
  }

  // Render del detalle + checklist
  async function render(){
    const { db, auth } = await core();
    const { getDoc, doc } = (await core()).fs;

    // 1) receta
    const snap = await getDoc(doc(db,'recetas',ID));
    if (!snap.exists()){
      host.innerHTML = '<p style="color:#b91c1c">Receta no encontrada.</p>';
      return;
    }
    const r = { id: snap.id, ...snap.data() };

    // 2) farmacia (usuario actual)
    const user = (await core()).auth.currentUser;
    let farmacia = null;
    if (user){
      try{
        const fSnap = await getDoc(doc(db,'farmacias', user.uid));
        if (fSnap.exists()) farmacia = { uid:user.uid, ...fSnap.data() };
      }catch{}
    }

    // 3) UI ‚Äî datos COFEPRIS + checklist
    const meds = Array.isArray(r.medicamentos) ? r.medicamentos : [];
    const surtidosPrev = Array.isArray(r.surtidoParcial) ? r.surtidoParcial : [];
    const yaSurtidos = new Set(surtidosPrev.map(x => (x?.nombre||'') + '||' + (x?.dosis||'')));

   host.innerHTML = `
  <div class="kx-head"><i class="dot"></i><div class="kx-sub">Validaci√≥n m√©dica en blockchain</div></div>
  <h3 style="margin:0 0 6px;font-size:22px;font-weight:800">Paciente: ${r.nombrePaciente ?? '‚Äî'}</h3>

  <div class="kx-pair"><b>Fecha:</b><span>${fmtFecha(r.timestamp)}</span></div>
  <div class="kx-pair"><b>ID:</b><span>${r.id}</span></div>
  <div class="kx-pair"><b>M√©dico:</b><span>${r.medicoNombre ?? '‚Äî'}</span></div>
  <div class="kx-pair"><b>C√©dula:</b><span>${r.medicoCedula ?? '‚Äî'}</span></div>
  <div class="kx-pair"><b>Especialidad:</b><span>${r.medicoEspecialidad ?? '‚Äî'}</span></div>
  <div class="kx-pair"><b>Domicilio consultorio:</b><span>${r.medicoDomicilio ?? '‚Äî'}</span></div>
  <div class="kx-pair"><b>Diagn√≥stico:</b><span>${r.diagnostico ?? '‚Äî'}</span></div>

  <div class="kx-section-title">Medicamentos</div>
  <div id="medList" class="kx-list">
    ${ /* ‚Ä¶tu map de items‚Ä¶ */ meds.map((m,i)=>{
      const key = (m?.nombre||'')+'||'+(m?.dosis||'');
      const ya  = yaSurtidos.has(key);
      const extra = ya ? (()=>{ const s=surtidosPrev.find(x=>((x?.nombre||'')+'||'+(x?.dosis||''))===key)||{};
        const by=s.surtidoPor||'‚Äî', tel=s.telefono||'‚Äî', f=s.fecha?new Date(s.fecha).toLocaleString('es-MX'):'‚Äî';
        return `<div class="kx-surtido-info">Surtido por: ${by} ‚Äî Tel: ${tel} ‚Äî ${f}</div>`;
      })(): '';
      return `
        <label class="kx-item">
          <input type="checkbox" data-index="${i}" ${ya?'checked disabled':''}>
          <b>${m?.nombre||'‚Äî'}</b> ‚Äî ${m?.dosis||'‚Äî'} ¬∑ ${m?.duracion||'‚Äî'}
          ${extra}
        </label>`;
    }).join('')}
  </div>

  <div class="kx-actions">
    <button id="btnSurtir" class="kx-btn kx-btn--brand">Registrar surtido</button>
    <button id="btnImprimir" class="kx-btn kx-btn--ghost"
      onclick="window.open('/medico/ver-receta.html?id=${encodeURIComponent(r.id)}','_blank')">Abrir receta</button>
    <button class="kx-btn kx-btn--ghost" onclick="history.length>1?history.back():location.href='/farmacia/panel.html'">Volver</button>
  </div>
  <div id="msg" class="kx-msg"></div>
`;
    // 4) manejar "Registrar surtido"
    $('#btnSurtir')?.addEventListener('click', async ()=>{
      try{
        if (!farmacia){
          alert('Necesitas iniciar sesi√≥n como farmacia para registrar surtido.');
          return;
        }
        const checks = host.querySelectorAll('#medList input[type="checkbox"]:not(:disabled):checked');
        const seleccionados = Array.from(checks).map(ch => meds[Number(ch.dataset.index)]).filter(Boolean);
        if (!seleccionados.length){
          alert('Selecciona al menos un medicamento para marcar como surtido.');
          return;
        }

        // fusionar con los previos (no duplicar)
        const prev = surtidosPrev.slice();
        const prevKeys = new Set(prev.map(x => (x?.nombre||'')+'||'+(x?.dosis||'')));
        const nuevos = seleccionados
          .filter(m => !prevKeys.has((m?.nombre||'')+'||'+(m?.dosis||'')))
          .map(m => ({
            ...m,
            surtidoPor: (farmacia.nombreFarmacia || farmacia.nombre || 'Farmacia'),
            telefono: farmacia.telefono || '',
            farmaciaUid: farmacia.uid || '',
            fecha: new Date().toISOString()
          }));

        const merged = prev.concat(nuevos);
        const esTotal = merged.length >= meds.length;
        const estado = esTotal ? 'surtida' : 'parcial';

        // write
        const { db } = await core();
        const { updateDoc, doc } = (await core()).fs;
        await updateDoc(doc(db,'recetas',ID), {
          surtidoParcial: merged,
          estado
        });

        $('#msg').textContent = esTotal
          ? 'Surtido total registrado. La receta queda cerrada.'
          : 'Surtido parcial registrado. La receta puede completarse despu√©s.';
        // refrescar la UI (pinta los ya surtidos como disabled)
        render();
      }catch(e){
        console.error('[FAR] update error:', e);
        alert('No se pudo registrar el surtido. Revisa permisos o intenta de nuevo.');
      }
    });
  }

  // boot
  render().catch(err=>{
    console.error('[detalle] error:', err);
    host.innerHTML = '<p style="color:#b91c1c">Ocurri√≥ un error al cargar la receta.</p>';
  });
})();
</script>
