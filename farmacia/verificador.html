
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verificador de Receta - KodRx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/estilos/global.css" />
  <script src="/componentes/header.js" defer></script>

</head>


<body>
  <h2>Verificador de Recetas</h2>

  <!-- Bloque lector (sólo se muestra si NO hay ?id=) -->
  <section id="scanUI" hidden>
    <video id="cam" autoplay muted playsinline style="width:100%;max-width:420px;border-radius:12px"></video>

    <div style="margin:8px 0">
      <button id="btnScan">Iniciar cámara</button>
      <input id="manual" placeholder="Pega URL o ID" style="width:60%">
      <button id="btnAbrir">Abrir</button>
    </div>
    <input id="fileQR" type="file" accept="image/*" capture="environment" style="display:none">
    <button id="btnFoto">Escanear foto</button>
  </section>

  <!-- Bloque detalle receta (sólo si HAY ?id=) -->
  <section id="detalleUI" hidden>
    <div id="detalleReceta">Cargando…</div>
    <!-- aquí va tu checklist/surtido -->
  </section>

  <!-- Lector offline -->
  <script defer src="/vendor/jsqr.min.js"></script>

<!-- Lector offline -->
<script defer src="/vendor/jsqr.min.js"></script>

<script>
(() => {
  // …deja el resto de tu script igual…

  const IS_IOS = /iPad|iPhone|iPod/.test(navigator.userAgent)
    || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

  let _rafId = 0, _stream = null;
  const stopScan = ()=>{
    try{ cancelAnimationFrame(_rafId); }catch{} _rafId=0;
    try{ if (_stream){ _stream.getTracks().forEach(t=>t.stop()); _stream=null; } }catch{}
  };

  // ===== lector con BarcodeDetector (con espera a playing) =====
  async function runWithBarcodeDetector(video){
    console.log('[SCAN] BD: start');
    const det = new window.BarcodeDetector({ formats:['qr_code'] });

    // espera a que el video realmente tenga frames
    if (video.readyState < 2) {
      await new Promise(res => {
        const onPlaying = ()=>{ video.removeEventListener('playing', onPlaying); res(); };
        video.addEventListener('playing', onPlaying, { once:true });
      });
    }

    const loop = async ()=>{
      try{
        if (video.readyState >= 2) {
          const codes = await det.detect(video);
          if (codes && codes.length){
            const raw = codes[0].rawValue || '';
            console.log('[SCAN] BD hit:', raw);
            stopScan(); return go(extractId(raw) || raw);
          }
        }
      }catch(e){
        console.warn('[SCAN] BD fail → fallback jsQR', e);
        stopScan(); return runWithJsQR(video);
      }
      _rafId = requestAnimationFrame(loop);
    };
    _rafId = requestAnimationFrame(loop);
  }

  // ===== lector con jsQR (downscale) =====
  function runWithJsQR(video){
    console.log('[SCAN] jsQR: start');
    const CANVAS_MAX_W = 720; // bajar si el QR está muy cerca; subir si está lejos
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently:true });

    const loop = ()=>{
      try{
        const vw = video.videoWidth, vh = video.videoHeight;
        if (vw && vh){
          // downscale manteniendo aspecto
          const scale = Math.min(1, CANVAS_MAX_W / vw);
          const w = Math.max(1, Math.floor(vw * scale));
          const h = Math.max(1, Math.floor(vh * scale));
          canvas.width = w; canvas.height = h;

          ctx.drawImage(video, 0, 0, w, h);
          const img = ctx.getImageData(0, 0, w, h);
          const res = window.jsQR(img.data, w, h, { inversionAttempts:'dontInvert' });

          // logs de diagnóstico cada ~15 frames
          if ((_rafId % 15) === 0) console.debug('[SCAN] frame', w, 'x', h, 'res?', !!res);

          if (res?.data){
            const raw = res.data;
            console.log('[SCAN] jsQR hit:', raw);
            stopScan(); return go(extractId(raw) || raw);
          }
        }
      }catch(e){ /* ignore y seguir */ }
      _rafId = requestAnimationFrame(loop);
    };
    _rafId = requestAnimationFrame(loop);
  }

  // ===== abrir cámara (con espera a playing + elección motor) =====
  async function startScan(){
    stopScan();
    try{
      const constraints = { video:{ facingMode:{ exact:'environment' } }, audio:false };
      console.log('[SCAN] getUserMedia…');
      _stream = await navigator.mediaDevices.getUserMedia(constraints).catch(async e=>{
        // fallback si exact falla
        console.warn('[SCAN] exact env failed, retry ideal', e?.name);
        return navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
      });

      const video = document.getElementById('cam');
      video.srcObject = _stream;
      video.setAttribute('playsinline','true');
      video.muted = true;

      await video.play().catch(()=>{});
      if (video.paused) {
        await new Promise(res=>{
          const onPlaying=()=>{ video.removeEventListener('playing', onPlaying); res(); };
          video.addEventListener('playing', onPlaying, { once:true });
        });
      }
      // nudge iOS
      document.addEventListener('touchstart', ()=>{ if (video.paused) video.play().catch(()=>{}); }, { once:true });

      // motor
      if (IS_IOS && window.jsQR) {
        runWithJsQR(video);
      } else if ('BarcodeDetector' in window) {
        runWithBarcodeDetector(video);
      } else if (window.jsQR) {
        runWithJsQR(video);
      } else {
        alert('No hay lector disponible en este navegador.');
      }
    }catch(err){
      console.warn('[SCAN] gUM fail:', err);
      const msg = String(err?.name || err?.message || '');
      if (msg.includes('NotAllowedError') || msg.includes('Permission')) {
        alert('No hay permiso para usar la cámara. Revisa el candado (Permisos → Cámara → Permitir). En iPhone: Ajustes > Safari > Cámara → Permitir');
      } else if (msg.includes('NotFoundError')) {
        alert('No se encontró cámara en este dispositivo.');
      } else {
        alert('No se pudo acceder a la cámara. Usa “Escanear foto”.');
      }
      try{ document.getElementById('fileQR')?.click(); }catch{}
    }
  }

  // expón startScan si lo necesitas en otros handlers
  window.__startScanPatched = startScan;

  // re-vincula el botón si no lo hace ya tu script
  document.getElementById('btnScan')?.addEventListener('click', startScan, { capture:true });

})();
</script>

