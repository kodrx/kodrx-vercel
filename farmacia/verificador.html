
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Verificador de receta</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #medicamentos-container { margin-top: 20px; }
    .medicamento { margin-bottom: 10px; }
    #video, canvas { display: block; margin-top: 20px; max-width: 100%; }
  </style>
</head>
<body>
  <h1>Verificador de receta</h1>
  <button onclick="iniciarEscaneo()">Escanear receta con cámara</button>
  <div id="receta-container"></div>
  <div id="medicamentos-container"></div>
  <button onclick="surtirReceta()">Surtir</button>

  <!-- Elementos necesarios para el escaneo -->
  <video id="video" style="display:none;"></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBIjaOe4HcGNDk0xrqen8etBv0RyjyOJHw",
      authDomain: "kodrx-105b9.firebaseapp.com",
      databaseURL: "https://kodrx-105b9-default-rtdb.firebaseio.com",
      projectId: "kodrx-105b9",
      storageBucket: "kodrx-105b9.appspot.com",
      messagingSenderId: "239675098141",
      appId: "1:239675098141:web:152ae3741b0ac79db7f2f4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let datosFarmacia = null;

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const farmaciaRef = doc(db, "farmacias", user.uid);
        const snap = await getDoc(farmaciaRef);
        if (snap.exists()) {
          datosFarmacia = snap.data();
        } else {
          alert("No se encontraron datos de la farmacia.");
        }
      }
    });

    async function mostrarReceta(id) {
      const recetaRef = doc(db, "recetas", id);
      const recetaSnap = await getDoc(recetaRef);
      if (recetaSnap.exists()) {
        const receta = recetaSnap.data();
        document.getElementById("receta-container").innerHTML = `
          <h3>Paciente: ${receta.nombrePaciente}</h3>
          <p>Edad: ${receta.edad}</p>
          <p>Observaciones: ${receta.observaciones}</p>
          <p>Médico: ${receta.medicoNombre || 'Desconocido'}</p>
        `;

        const medsHTML = receta.medicamentos.map((med, idx) => `
          <div class="medicamento">
            <label>
              <input type="checkbox" data-index="${idx}" />
              <strong>${med.nombre}</strong> - ${med.dosis}, ${med.duracion}
            </label>
          </div>
        `).join("");
        document.getElementById("medicamentos-container").innerHTML = medsHTML;
      }
    }

    window.surtirReceta = async () => {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      if (!id) return;

      const recetaRef = doc(db, "recetas", id);
      const recetaSnap = await getDoc(recetaRef);
      if (!recetaSnap.exists()) return;
      const receta = recetaSnap.data();

      const checkboxes = document.querySelectorAll("#medicamentos-container input[type='checkbox']");
      const surtido = [];
      checkboxes.forEach((cb, i) => {
        if (cb.checked) {
          surtido.push({
            ...receta.medicamentos[i],
            fecha: new Date().toISOString(),
            surtidoPor: datosFarmacia?.nombreFarmacia || "Desconocido",
            telefono: datosFarmacia?.telefono || "No disponible"
          });
        }
      });

      const esParcial = surtido.length < receta.medicamentos.length;
      await updateDoc(recetaRef, {
        estado: esParcial ? "parcial" : "completo",
        surtidoParcial: surtido,
        timestamp: serverTimestamp()
      });

      alert("Receta marcada como surtida.");
    };

    window.onload = () => {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      if (id) {
        mostrarReceta(id);
      }
    };
  </script>

  <script>
    function iniciarEscaneo() {
      const video = document.getElementById("video");
      const canvasElement = document.getElementById("canvas");
      const canvas = canvasElement.getContext("2d");

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then((stream) => {
          video.srcObject = stream;
          video.setAttribute("playsinline", true);
          video.play();
          video.style.display = "block";
          requestAnimationFrame(tick);
        });

      function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvasElement.height = video.videoHeight;
          canvasElement.width = video.videoWidth;
          canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
          const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert",
          });
          if (code) {
            window.location.href = `verificador.html?id=${code.data}`;
            return;
          }
        }
        requestAnimationFrame(tick);
      }
    }
  </script>
</body>
</html>
