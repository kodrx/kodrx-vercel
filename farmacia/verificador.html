
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Verificador de receta</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #video, canvas { max-width: 100%; margin-top: 10px; display: none; }
    .medicamento { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Verificador de receta</h1>

  <button onclick="iniciarEscaneo()">ðŸ“· Escanear receta con cÃ¡mara</button>
  <p>O ingresa manualmente el ID de la receta:</p>
  <input type="text" id="manualID" placeholder="ID de receta">
  <button onclick="cargarRecetaManual()">Cargar receta</button>

  <div id="receta-container"></div>
  <div id="medicamentos-container"></div>
  <button id="btn-surtir" onclick="surtirReceta()">ðŸ’Š Surtir</button>

  <video id="video" autoplay></video>
  <canvas id="canvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBIjaOe4HcGNDk0xrqen8etBv0RyjyOJHw",
      authDomain: "kodrx-105b9.firebaseapp.com",
      projectId: "kodrx-105b9",
      storageBucket: "kodrx-105b9.appspot.com",
      messagingSenderId: "239675098141",
      appId: "1:239675098141:web:152ae3741b0ac79db7f2f4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let datosFarmacia = null;
    let recetaActualID = null;
    let recetaCompleta = null;

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const farmaciaRef = doc(db, "farmacias", user.uid);
        const snap = await getDoc(farmaciaRef);
        if (snap.exists()) {
          datosFarmacia = snap.data();
        } else {
          alert("No se encontraron datos de la farmacia.");
        }
      }
    });

    window.cargarRecetaManual = async () => {
      const id = document.getElementById("manualID").value.trim();
      if (id) {
        await mostrarReceta(id);
      }
    };

    async function mostrarReceta(id) {
      const recetaRef = doc(db, "recetas", id);
      const recetaSnap = await getDoc(recetaRef);
      if (recetaSnap.exists()) {
        recetaActualID = id;
        recetaCompleta = recetaSnap.data();

        const receta = recetaCompleta;
        const container = document.getElementById("receta-container");
        container.innerHTML = `
          <h3>Paciente: ${receta.nombrePaciente}</h3>
          <p>Edad: ${receta.edad}</p>
          <p>Observaciones: ${receta.observaciones}</p>
          <p><strong>MÃ©dico:</strong> ${receta.medicoNombre || "No registrado"}</p>
        `;

        if (receta.estado === "total" || receta.estado === "parcial") {
          container.innerHTML += `
            <p style="color:red;"><strong>Esta receta ya fue surtida (${receta.estado}).</strong><br>
            Farmacia: ${receta.surtidoPor || "-"}<br>
            Tel: ${receta.telefono || "-"}</p>`;
        }

        const medsHTML = receta.medicamentos.map((med, idx) => `
          <div class="medicamento">
            <label><input type="checkbox" data-index="${idx}"> ${med.nombre} - ${med.dosis} (${med.duracion})</label>
          </div>
        `).join("");

        document.getElementById("medicamentos-container").innerHTML = medsHTML;
      } else {
        alert("Receta no encontrada.");
      }
    }

    window.surtirReceta = async () => {
      if (!recetaActualID || !recetaCompleta || !datosFarmacia) {
        alert("No hay receta cargada o falta informaciÃ³n.");
        return;
      }

      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      const seleccionados = [];
      recetaCompleta.medicamentos.forEach((med, idx) => {
        if (checkboxes[idx]?.checked) seleccionados.push(med);
      });

      const estado = (seleccionados.length === recetaCompleta.medicamentos.length) ? "total" : "parcial";

      await updateDoc(doc(db, "recetas", recetaActualID), {
        estado,
        surtidoParcial: seleccionados,
        surtidoPor: datosFarmacia.nombreFarmacia,
        telefono: datosFarmacia.telefono,
        timestamp: serverTimestamp()
      });

      alert("Receta actualizada como " + estado);
      window.location.reload();
    };

    window.iniciarEscaneo = () => {
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      video.style.display = "block";

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          video.srcObject = stream;
          video.setAttribute("playsinline", true);
          video.play();
          const interval = setInterval(() => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
              canvas.height = video.videoHeight;
              canvas.width = video.videoWidth;
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              const code = jsQR(imageData.data, imageData.width, imageData.height);
              if (code) {
                clearInterval(interval);
                stream.getTracks().forEach(track => track.stop());
                video.style.display = "none";
                mostrarReceta(code.data.split("=")[1]);
              }
            }
          }, 500);
        });
    };
  </script>
</body>
</html>
