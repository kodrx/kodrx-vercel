
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verificador de Receta - KodRx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/estilos/global.css" />
  <script src="/componentes/header.js" defer></script>

</head>


<body>
  <h2>Verificador de Recetas</h2>

  <!-- Bloque lector (sólo se muestra si NO hay ?id=) -->
  <section id="scanUI" hidden>
    <video id="cam" autoplay muted playsinline style="width:100%;max-width:420px;border-radius:12px"></video>

    <div style="margin:8px 0">
      <button id="btnScan">Iniciar cámara</button>
      <input id="manual" placeholder="Pega URL o ID" style="width:60%">
      <button id="btnAbrir">Abrir</button>
    </div>
    <input id="fileQR" type="file" accept="image/*" capture="environment" style="display:none">
    <button id="btnFoto">Escanear foto</button>
  </section>

  <!-- Bloque detalle receta (sólo si HAY ?id=) -->
  <section id="detalleUI" hidden>
    <div id="detalleReceta">Cargando…</div>
    <!-- aquí va tu checklist/surtido -->
  </section>

  <!-- Lector offline -->
  <script defer src="/vendor/jsqr.min.js"></script>

<!-- Lector offline -->
<script defer src="/vendor/jsqr.min.js"></script>

<script>
;(()=>{'use strict';

  // ======== UI boot ========
  const $ = s => document.querySelector(s);
  const scanUI    = $('#scanUI');
  const detalleUI = $('#detalleUI');
  const video     = $('#cam');
  const btnScan   = $('#btnScan');
  const btnAbrir  = $('#btnAbrir');
  const btnFoto   = $('#btnFoto');
  const inputMan  = $('#manual');
  const fileInput = $('#fileQR');

  // muestra el bloque correcto según ?id
  const idQ = new URLSearchParams(location.search).get('id');
  if (idQ) {
    // aquí puedes cargar la receta y mostrar detalleUI si quieres
    scanUI.hidden    = true;
    detalleUI.hidden = false;
  } else {
    scanUI.hidden    = false;
    detalleUI.hidden = true;
  }

  // ======== helpers ========
  const IS_IOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                 (navigator.platform === 'MacIntel' && navigator.maxTouchPoints>1);

  const extractId = (txt)=>{
    try{ const u = new URL(txt); return u.searchParams.get('id') || null; }catch{}
    return /^[A-Za-z0-9_-]{8,}$/.test(txt) ? txt : null;
  };
  const go = (id)=>{
    if (!id) { alert('No se pudo leer el código'); return; }
    location.href = `/medico/ver-receta.html?id=${encodeURIComponent(id)}`;
  };

  let _rafId = 0, _stream = null;
  const stopScan = ()=>{
    try{ cancelAnimationFrame(_rafId); }catch{}
    _rafId=0;
    try{ if(_stream){ _stream.getTracks().forEach(t=>t.stop()); _stream=null; } }catch{}
  };

  // ======== detectores ========
  async function runWithBarcodeDetector(){
    console.log('[SCAN] BarcodeDetector loop');
    const det = new window.BarcodeDetector({ formats:['qr_code'] });
    const loop = async ()=>{
      try{
        if (video.readyState >= 2){
          const codes = await det.detect(video); // sin createImageBitmap (iOS-friendly)
          if (codes && codes.length){
            const raw = codes[0].rawValue || '';
            const id = extractId(raw) || raw;
            console.log('[SCAN] hit BD:', id);
            stopScan(); return go(id);
          }
        }
      }catch(e){
        console.warn('[SCAN] BD fail, fallback jsQR', e);
        if (window.jsQR){ stopScan(); return runWithJsQR(); }
      }
      _rafId = requestAnimationFrame(loop);
    };
    _rafId = requestAnimationFrame(loop);
  }

  function runWithJsQR(){
    console.log('[SCAN] jsQR loop');
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently:true });
    const loop = ()=>{
      try{
        const w=video.videoWidth, h=video.videoHeight;
        if (w && h){
          canvas.width=w; canvas.height=h;
          ctx.drawImage(video,0,0,w,h);
          const img = ctx.getImageData(0,0,w,h);
          const res = window.jsQR(img.data,w,h,{inversionAttempts:'dontInvert'});
          if (res?.data){
            const id = extractId(res.data) || res.data;
            console.log('[SCAN] hit jsQR:', id);
            stopScan(); return go(id);
          }
        }
      }catch(e){ /* sigue */ }
      _rafId = requestAnimationFrame(loop);
    };
    _rafId = requestAnimationFrame(loop);
  }

  // ======== cámara ========
  async function startScan(){
    stopScan();
    try{
      const constraints = { video:{ facingMode:{ideal:'environment'} }, audio:false };
      console.log('[SCAN] getUserMedia…');
      _stream = await navigator.mediaDevices.getUserMedia(constraints);

      // prepara video (autoplay en iOS necesita muted+playsinline)
      video.srcObject = _stream;
      video.setAttribute('playsinline','true');
      video.muted = true;
      await video.play().catch(()=>{});

      // nudge para iOS por si pausa
      document.addEventListener('touchstart', ()=>{ if (video.paused) video.play().catch(()=>{}); }, {once:true});

      if (IS_IOS && window.jsQR){
        runWithJsQR();
      } else if ('BarcodeDetector' in window){
        runWithBarcodeDetector();
      } else if (window.jsQR){
        runWithJsQR();
      } else {
        alert('No hay lector disponible en este navegador.');
      }
    }catch(err){
      console.warn('[SCAN] getUserMedia fail:', err);
      const msg = String(err?.name || err?.message || '');
      if (msg.includes('NotAllowedError') || msg.includes('Permission')){
        alert('No hay permiso para usar la cámara. Revisa el candado (Permisos → Cámara → Permitir). En iPhone: Ajustes > Safari > Cámara → Permitir');
      } else if (msg.includes('NotFoundError')){
        alert('No se encontró una cámara en este dispositivo.');
      } else {
        alert('No se pudo acceder a la cámara. Usa “Escanear foto”.');
      }
      try{ fileInput?.click(); }catch{}
    }
  }

  // ======== foto (fallback) ========
  async function onPickImage(e){
    const file = e.target.files?.[0];
    if (!file) return;
    if (!window.jsQR){ alert('No se pudo cargar el lector offline (jsQR).'); return; }

    const img = new Image();
    img.onload = ()=>{
      const canvas = document.createElement('canvas');
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      const ctx = canvas.getContext('2d',{willReadFrequently:true});
      ctx.drawImage(img,0,0);
      const data = ctx.getImageData(0,0,canvas.width,canvas.height);
      const res = window.jsQR(data.data, canvas.width, canvas.height, { inversionAttempts:'dontInvert' });
      if (res?.data){
        const id = extractId(res.data) || res.data;
        console.log('[SCAN] hit photo:', id);
        stopScan(); go(id);
      } else {
        alert('No se pudo leer el QR de la imagen.');
      }
      URL.revokeObjectURL(img.src);
    };
    img.onerror = ()=> alert('No se pudo abrir la imagen seleccionada.');
    img.src = URL.createObjectURL(file);
  }

  // ======== bindings ========
  btnScan?.addEventListener('click', startScan);
  btnAbrir?.addEventListener('click', ()=>{
    const v = (inputMan.value||'').trim();
    const id = extractId(v) || v;
    go(id);
  });
  btnFoto?.addEventListener('click', ()=> fileInput?.click());
  fileInput?.addEventListener('change', onPickImage);

  window.addEventListener('pagehide', stopScan);
  window.addEventListener('beforeunload', stopScan);

  console.log('[VERIF] boot OK (scanUI:', !scanUI.hidden, ')');

})();</script>
