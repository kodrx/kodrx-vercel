
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verificador de Receta - KodRx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/estilos/global.css" />
  <script src="/componentes/header.js" defer></script>

</head>


<body>
<section id="scanUI" hidden>
  <video id="cam" autoplay muted playsinline style="width:100%;max-width:420px;border-radius:12px"></video>

  <div style="margin:8px 0">
    <button id="btnScan">Iniciar cámara</button>
    <input id="manual" placeholder="Pega URL o ID" style="width:60%">
    <button id="btnAbrir">Abrir</button>
  </div>

  <input id="fileQR" type="file" accept="image/*" capture="environment" style="display:none">
  <button id="btnFoto">Escanear foto</button>
  <!-- Canvas para overlay de marco verde (debug visual) -->
  <canvas id="ovl" style="display:block;max-width:420px;width:100%;border-radius:12px;margin-top:6px"></canvas>
</section>

<section id="detalleUI" hidden>
  <div id="detalleReceta">Cargando…</div>
</section>
</body>
<!-- jsQR local; ponle id para que el loader pueda “esperarlo” -->
<script defer src="/vendor/jsqr.min.js" id="jsqr-lib"></script>





<script>
(function(){
  'use strict';
  // ====== CONFIG ======
  const MAX_W = 640;       // ancho al que bajamos el frame
  const LOG   = (...a)=>console.log('[SCAN]', ...a);

  // ====== REFS ======
  const $ = s => document.querySelector(s);
  const video   = document.getElementById('cam');
  const btnScan = document.getElementById('btnScan');
  const fileInp = document.getElementById('fileQR');
  const inputMan= document.getElementById('manual');
  const btnAbrir= document.getElementById('btnAbrir');

  if (!video || !btnScan || !fileInp) {
    console.warn('[SCAN] faltan #cam / #btnScan / #fileQR'); 
    return;
  }

  // ====== ESTADO ======
  let stream = null;
  let rafId  = 0;
  let running = false;

  // ====== HELPERS ======
  const extractId = (txt) => {
    try { const u = new URL(txt); return u.searchParams.get('id') || null; } catch {}
    return /^[A-Za-z0-9_-]{8,}$/.test(String(txt||'')) ? txt : null;
  };
  const go = (id) => {
    if (!id) { alert('No se pudo leer el código'); return; }
    location.href = '/farmacia/verificador.html?id=' + encodeURIComponent(id);
  };
  const stopScan = () => {
    running = false;
    try { cancelAnimationFrame(rafId); } catch {}
    rafId = 0;
    try { if (stream) { stream.getTracks().forEach(t=>t.stop()); stream = null; } } catch {}
  };
  async function ensureJsQR(maxWaitMs=4000){
    if (window.jsQR) return true;
    LOG('esperando jsQR…');
    let waited=0;
    while (!window.jsQR && waited < maxWaitMs){
      await new Promise(r=>setTimeout(r,150));
      waited += 150;
    }
    LOG('jsQR presente?', !!window.jsQR);
    return !!window.jsQR;
  }

  // ====== LOOP jsQR ======
  function runJsQRLoop(){
    const cnv = document.createElement('canvas');
    const ctx = cnv.getContext('2d', { willReadFrequently: true });

    // overlay opcional
    const ovl = document.getElementById('ovl');
    const drawBox = (loc)=>{
      if (!ovl) return;
      const w = video.videoWidth|0, h = video.videoHeight|0;
      if (!w||!h) return;
      ovl.width=w; ovl.height=h;
      const c = ovl.getContext('2d');
      c.clearRect(0,0,w,h);
      if (!loc) return;
      c.strokeStyle='lime'; c.lineWidth=3;
      c.beginPath();
      const p=loc;
      c.moveTo(p.topLeftCorner.x, p.topLeftCorner.y);
      c.lineTo(p.topRightCorner.x, p.topRightCorner.y);
      c.lineTo(p.bottomRightCorner.x, p.bottomRightCorner.y);
      c.lineTo(p.bottomLeftCorner.x, p.bottomLeftCorner.y);
      c.closePath(); c.stroke();
    };

    const step = () => {
      if (!running) return;
      try{
        const vw = video.videoWidth|0, vh = video.videoHeight|0;
        if (vw && vh){
          const scale = Math.min(1, MAX_W / vw);
          const w = Math.max(1, (vw*scale)|0);
          const h = Math.max(1, (vh*scale)|0);
          if (cnv.width!==w || cnv.height!==h){ cnv.width=w; cnv.height=h; }

          ctx.drawImage(video, 0, 0, w, h);
          const img = ctx.getImageData(0, 0, w, h);

          // Probar ambos modos (impresos con brillo a veces invierten)
          const res = window.jsQR(img.data, w, h, { inversionAttempts:'attemptBoth' })
                  || window.jsQR(img.data, w, h, { inversionAttempts:'dontInvert' });

          if (res && res.data){
            drawBox(res.location);
            LOG('QR detectado:', res.data);
            stopScan();
            const id = extractId(res.data) || res.data;
            return go(id);
          } else {
            drawBox(null);
          }
        }
      }catch(e){ /* seguir */ }
      rafId = requestAnimationFrame(step);
    };

    running = true;
    rafId = requestAnimationFrame(step);
  }

  // ====== START CAMERA + SCAN ======
  async function startScan(){
    stopScan();
    try{
      LOG('solicitando cámara…');
      const c1 = { video:{ facingMode:{ exact:'environment' } }, audio:false };
      const c2 = { video:{ facingMode:{ ideal:'environment' } }, audio:false };
      try { stream = await navigator.mediaDevices.getUserMedia(c1); }
      catch { stream = await navigator.mediaDevices.getUserMedia(c2); }

      video.srcObject = stream;
      video.setAttribute('playsinline','true'); // iOS
      video.muted = true;

      await video.play().catch(()=>{});
      if (video.readyState < 2 || video.videoWidth === 0){
        await new Promise(res=>{
          const onPlaying = ()=>{ video.removeEventListener('playing', onPlaying); res(); };
          video.addEventListener('playing', onPlaying, { once:true });
        });
      }
      LOG('video ok:', video.videoWidth, 'x', video.videoHeight);

      // iOS “nudge”
      document.addEventListener('touchstart', ()=>{ if (video.paused) video.play().catch(()=>{}); }, { once:true });

      const ok = await ensureJsQR(4000);
      if (!ok){ alert('No se pudo cargar el lector offline (jsQR).'); return; }
      runJsQRLoop();
    }catch(err){
      LOG('getUserMedia fail:', err);
      const msg = String(err?.name||err?.message||'');
      if (msg.includes('NotAllowed') || msg.includes('Permission')){
        alert('No hay permiso de cámara.\nAbre el candado → Cámara → Permitir. En iPhone: Ajustes > Safari > Cámara.');
      } else if (msg.includes('NotFound')) {
        alert('No se encontró cámara en este dispositivo.');
      } else {
        alert('No se pudo abrir la cámara. Usa “Escanear foto”.');
      }
      try { fileInp.click(); } catch {}
    }
  }

  // ====== FALLBACK: FOTO ======
  async function onPickImage(e){
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    const ok = await ensureJsQR(4000);
    if (!ok){ alert('No se pudo cargar jsQR.'); return; }

    const img = new Image();
    img.onload = () => {
      const c = document.createElement('canvas');
      c.width  = img.naturalWidth; c.height = img.naturalHeight;
      const cx = c.getContext('2d', { willReadFrequently:true });
      cx.drawImage(img, 0, 0);
      const data = cx.getImageData(0,0,c.width,c.height);
      const res = window.jsQR(data.data, c.width, c.height, { inversionAttempts:'attemptBoth' })
                || window.jsQR(data.data, c.width, c.height, { inversionAttempts:'dontInvert' });
      if (res && res.data){
        stopScan();
        const id = extractId(res.data) || res.data;
        go(id);
      } else {
        alert('No se pudo leer el QR de la imagen. Intenta otra foto con mejor luz/enfoque.');
      }
      URL.revokeObjectURL(img.src);
      fileInp.value = '';
    };
    img.onerror = ()=>{ alert('No se pudo abrir la imagen.'); fileInp.value=''; };
    img.src = URL.createObjectURL(f);
  }

  // ====== BINDINGS ======
  btnScan.addEventListener('click', startScan, { capture:true });
  fileInp.addEventListener('change', onPickImage, { capture:true });
  btnAbrir && btnAbrir.addEventListener('click', (e)=>{ e.preventDefault(); const raw=(inputMan?.value||'').trim(); go(extractId(raw)||raw); });

  // Limpieza
  window.addEventListener('pagehide',  stopScan);
  window.addEventListener('beforeunload', stopScan);

  // Log útil: verificar que jsQR carga por el <script defer>
  setTimeout(()=> LOG('jsQR presente?', !!window.jsQR), 800);
})();
</script>


<script>
;(() => {
  'use strict';

  const $ = s => document.querySelector(s);
  const scanUI    = $('#scanUI');
  const detalleUI = $('#detalleUI');
  const host      = $('#detalleReceta');

  // Detectar si hay ?id=
  const ID = new URLSearchParams(location.search).get('id');

  if (!ID) {
    // sin id → mostrar lector
    scanUI.hidden = false;
    detalleUI.hidden = true;
    return;
  }

  // con id → mostrar detalle
  scanUI.hidden = true;
  detalleUI.hidden = false;
  host.textContent = 'Cargando…';

  // Utils
  const fmtFecha = (ts) => {
    try{
      if (ts && typeof ts.toDate==='function') ts = ts.toDate();
      else if (ts && typeof ts.seconds==='number') ts = new Date(ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6));
      else if (!(ts instanceof Date)) ts = new Date(ts);
      return ts.toLocaleString('es-MX', { year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit' });
    }catch{ return '—'; }
  };
  const html = (strings, ...vals) => strings.reduce((a,s,i)=>a+s+(vals[i]??''),'');

  // Carga perezosa de Firebase
  async function core(){
    const core = await import('/firebase-init.js');
    const fs   = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
    const au   = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js');
    return { ...core, fs, au };
  }

  // Render del detalle + checklist
  async function render(){
    const { db, auth } = await core();
    const { getDoc, doc } = (await core()).fs;

    // 1) receta
    const snap = await getDoc(doc(db,'recetas',ID));
    if (!snap.exists()){
      host.innerHTML = '<p style="color:#b91c1c">Receta no encontrada.</p>';
      return;
    }
    const r = { id: snap.id, ...snap.data() };

    // 2) farmacia (usuario actual)
    const user = (await core()).auth.currentUser;
    let farmacia = null;
    if (user){
      try{
        const fSnap = await getDoc(doc(db,'farmacias', user.uid));
        if (fSnap.exists()) farmacia = { uid:user.uid, ...fSnap.data() };
      }catch{}
    }

    // 3) UI — datos COFEPRIS + checklist
    const meds = Array.isArray(r.medicamentos) ? r.medicamentos : [];
    const surtidosPrev = Array.isArray(r.surtidoParcial) ? r.surtidoParcial : [];
    const yaSurtidos = new Set(surtidosPrev.map(x => (x?.nombre||'') + '||' + (x?.dosis||'')));

   host.innerHTML = `
  <div class="kx-head"><i class="dot"></i><div class="kx-sub">Validación médica en blockchain</div></div>
  <h3 style="margin:0 0 6px;font-size:22px;font-weight:800">Paciente: ${r.nombrePaciente ?? '—'}</h3>

  <div class="kx-pair"><b>Fecha:</b><span>${fmtFecha(r.timestamp)}</span></div>
  <div class="kx-pair"><b>ID:</b><span>${r.id}</span></div>
  <div class="kx-pair"><b>Médico:</b><span>${r.medicoNombre ?? '—'}</span></div>
  <div class="kx-pair"><b>Cédula:</b><span>${r.medicoCedula ?? '—'}</span></div>
  <div class="kx-pair"><b>Especialidad:</b><span>${r.medicoEspecialidad ?? '—'}</span></div>
  <div class="kx-pair"><b>Domicilio consultorio:</b><span>${r.medicoDomicilio ?? '—'}</span></div>
  <div class="kx-pair"><b>Diagnóstico:</b><span>${r.diagnostico ?? '—'}</span></div>

  <div class="kx-section-title">Medicamentos</div>
  <div id="medList" class="kx-list">
    ${ /* …tu map de items… */ meds.map((m,i)=>{
      const key = (m?.nombre||'')+'||'+(m?.dosis||'');
      const ya  = yaSurtidos.has(key);
      const extra = ya ? (()=>{ const s=surtidosPrev.find(x=>((x?.nombre||'')+'||'+(x?.dosis||''))===key)||{};
        const by=s.surtidoPor||'—', tel=s.telefono||'—', f=s.fecha?new Date(s.fecha).toLocaleString('es-MX'):'—';
        return `<div class="kx-surtido-info">Surtido por: ${by} — Tel: ${tel} — ${f}</div>`;
      })(): '';
      return `
        <label class="kx-item">
          <input type="checkbox" data-index="${i}" ${ya?'checked disabled':''}>
          <b>${m?.nombre||'—'}</b> — ${m?.dosis||'—'} · ${m?.duracion||'—'}
          ${extra}
        </label>`;
    }).join('')}
  </div>

  <div class="kx-actions">
    <button id="btnSurtir" class="kx-btn kx-btn--brand">Registrar surtido</button>
    <button id="btnImprimir" class="kx-btn kx-btn--ghost"
      onclick="window.open('/medico/ver-receta.html?id=${encodeURIComponent(r.id)}','_blank')">Abrir receta</button>
    <button class="kx-btn kx-btn--ghost" onclick="history.length>1?history.back():location.href='/farmacia/panel.html'">Volver</button>
  </div>
  <div id="msg" class="kx-msg"></div>
`;
    // 4) manejar "Registrar surtido"
    $('#btnSurtir')?.addEventListener('click', async ()=>{
      try{
        if (!farmacia){
          alert('Necesitas iniciar sesión como farmacia para registrar surtido.');
          return;
        }
        const checks = host.querySelectorAll('#medList input[type="checkbox"]:not(:disabled):checked');
        const seleccionados = Array.from(checks).map(ch => meds[Number(ch.dataset.index)]).filter(Boolean);
        if (!seleccionados.length){
          alert('Selecciona al menos un medicamento para marcar como surtido.');
          return;
        }

        // fusionar con los previos (no duplicar)
        const prev = surtidosPrev.slice();
        const prevKeys = new Set(prev.map(x => (x?.nombre||'')+'||'+(x?.dosis||'')));
        const nuevos = seleccionados
          .filter(m => !prevKeys.has((m?.nombre||'')+'||'+(m?.dosis||'')))
          .map(m => ({
            ...m,
            surtidoPor: (farmacia.nombreFarmacia || farmacia.nombre || 'Farmacia'),
            telefono: farmacia.telefono || '',
            farmaciaUid: farmacia.uid || '',
            fecha: new Date().toISOString()
          }));

        const merged = prev.concat(nuevos);
        const esTotal = merged.length >= meds.length;
        const estado = esTotal ? 'surtida' : 'parcial';

        // write
        const { db } = await core();
        const { updateDoc, doc } = (await core()).fs;
        await updateDoc(doc(db,'recetas',ID), {
          surtidoParcial: merged,
          estado
        });

        $('#msg').textContent = esTotal
          ? 'Surtido total registrado. La receta queda cerrada.'
          : 'Surtido parcial registrado. La receta puede completarse después.';
        // refrescar la UI (pinta los ya surtidos como disabled)
        render();
      }catch(e){
        console.error('[FAR] update error:', e);
        alert('No se pudo registrar el surtido. Revisa permisos o intenta de nuevo.');
      }
    });
  }

  // boot
  render().catch(err=>{
    console.error('[detalle] error:', err);
    host.innerHTML = '<p style="color:#b91c1c">Ocurrió un error al cargar la receta.</p>';
  });
})();
</script>
