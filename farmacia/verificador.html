
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Verificador de receta</title>
  <script type="module" src="/firebase-init.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #qr-reader { width: 100%; max-width: 400px; margin-bottom: 20px; }
    .receta-box { border: 1px solid #ccc; padding: 15px; margin-top: 15px; }
    .checkbox-medicamento { margin-left: 10px; }
    .farmacia-info { font-size: 0.9em; color: #555; margin-top: 10px; }
  </style>
</head>
<body>

  <h2>Verificador de receta</h2>

  <button onclick="iniciarEscaneo()">üì∑ Escanear receta con c√°mara</button><br><br>
  <input type="text" id="idRecetaInput" placeholder="ID de receta manual">
  <button onclick="verificarRecetaManual()">Verificar</button>

  <div id="qr-reader" style="display:none;"></div>
  <div id="resultado"></div>

  <script type="module">
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const auth = getAuth();
    const db = getFirestore();
    let farmaciaUID = "";
    let datosFarmacia = {};

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        farmaciaUID = user.uid;
        const docRef = doc(db, "farmacias", farmaciaUID);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          datosFarmacia = docSnap.data();
          console.log("Farmacia:", datosFarmacia);
        } else {
          console.error("No se encontraron datos de la farmacia");
        }
      }
    });

    window.iniciarEscaneo = function () {
      document.getElementById("qr-reader").style.display = "block";
      const html5QrCode = new Html5Qrcode("qr-reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          const id = new URLSearchParams(new URL(qrCodeMessage).search).get("id");
          if (id) verificarReceta(id);
          html5QrCode.stop();
        },
        errorMessage => {}
      ).catch(err => console.error("Error al iniciar escaneo:", err));
    };

    window.verificarRecetaManual = () => {
      const id = document.getElementById("idRecetaInput").value.trim();
      if (id) verificarReceta(id);
    };

    async function verificarReceta(id) {
      const docRef = doc(db, "recetas", id);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) {
        document.getElementById("resultado").innerHTML = "<p>‚ùå Receta no encontrada.</p>";
        return;
      }

      const data = docSnap.data();
      const container = document.createElement("div");
      container.className = "receta-box";

      const nombreFarmacia = datosFarmacia.nombreFarmacia || "Desconocido";
      const telefono = datosFarmacia.telefono || "N/A";

      container.innerHTML = `
        <strong>Paciente:</strong> ${data.nombrePaciente} <br>
        <strong>Edad:</strong> ${data.edad} <br>
        <strong>Observaciones:</strong> ${data.observaciones || "Ninguna"} <br>
        <strong>M√©dico:</strong> ${data.medicoNombre || "No disponible"} <br>
        <hr>
        <strong>Medicamentos:</strong><br>
        <div id="medicamentos-lista">
          ${data.medicamentos.map((m, i) => `
            <div>
              <label>
                <input type="checkbox" class="med-checkbox" data-index="${i}" checked>
                ${m.nombre} - ${m.dosis} - ${m.duracion}
              </label>
            </div>`).join('')}
        </div>
        <button onclick="surtirReceta('${id}')">üíä Surtir</button>
        <div class="farmacia-info" id="info-surtido"></div>
      `;

      document.getElementById("resultado").innerHTML = "";
      document.getElementById("resultado").appendChild(container);
    }

    window.surtirReceta = async function(id) {
      const checkboxes = document.querySelectorAll(".med-checkbox");
      const docRef = doc(db, "recetas", id);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return alert("Error: receta no encontrada");

      const receta = docSnap.data();
      const seleccionados = receta.medicamentos.filter((_, i) => checkboxes[i].checked);

      let estado = "total";
      if (seleccionados.length < receta.medicamentos.length) estado = "parcial";

      await updateDoc(docRef, {
        estado: estado,
        surtidoPor: datosFarmacia.nombreFarmacia || "Desconocido",
        telefono: datosFarmacia.telefono || "N/A",
        surtidoParcial: seleccionados.map(m => ({
          ...m,
          fecha: new Date().toISOString(),
          surtidoPor: datosFarmacia.nombreFarmacia || "Desconocido",
          telefono: datosFarmacia.telefono || "N/A"
        }))
      });

      document.getElementById("info-surtido").innerText = `‚úÖ Receta surtida (${estado}) por ${datosFarmacia.nombreFarmacia}, Tel: ${datosFarmacia.telefono}`;
    };
  </script>
</body>
</html>
